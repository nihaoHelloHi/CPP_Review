# æ•°æ®ç»“æž„

## SDS
sdsç›¸æ¯”äºŽcé£Žæ ¼å­—ç¬¦ä¸²çš„æ”¹è¿›:
1. å¯ä»¥åœ¨O(1)æ—¶é—´èŽ·å–å­—ç¬¦ä¸²é•¿åº¦
2. ä¸ä¼šå‘ç”Ÿç¼“å†²åŒºæº¢å‡ºï¼Œé€šè¿‡alloc-sizeæŸ¥çœ‹å‰©ä½™ç©ºé—´
3. ä¸ä»¥â€˜\0â€™ä½œä¸ºç»“æŸç¬¦ï¼Œå¯å­˜æ”¾éŸ³é¢‘ã€å›¾ç‰‡
4. æžè‡´çš„çœç©ºé—´ï¼Œä¸åŒå¤§å°èŒƒå›´çš„å­—ç¬¦ä¸²ä½¿ç”¨ä¸åŒä½æ•°çš„allocå’Œsize
5. äºŒè¿›åˆ¶å®‰å…¨ï¼Œæ‰€æœ‰çš„æ•°æ®éƒ½ä»¥äºŒè¿›åˆ¶æ–°å¼å­˜æ”¾å’Œæ“ä½œï¼Œé¿å…äº†'\0'é—®é¢˜ï¼Œä½¿å¾—SDSå¯ä»¥ä¿å­˜ä»»æ„æ ¼å¼çš„äºŒè¿›åˆ¶æ•°æ®

## List
æ­£å¸¸çš„åŒå‘é“¾è¡¨

## ZIPLIST
**ç”±è¿žç»­å†…å­˜å—ç»„æˆçš„é¡ºåºåž‹æ•°æ®ç»“æž„**ï¼Œæœ‰ç‚¹ç±»ä¼¼äºŽæ•°ç»„ã€‚
![åŽ‹ç¼©é“¾è¡¨](image-44.png)
![ç¼ºç‚¹](image-45.png)

## hashtable
**å¼€é“¾å“ˆå¸Œï¼Œæ¸è¿›å¼rehash**

## intset
æ•´å½¢é›†åˆ
1. æžè‡´çš„çœç©ºé—´ï¼Œå°†intåˆ†ä¸º16ï¼Œ32ï¼Œ64ï¼Œåˆ†åˆ«è¡¨ç¤ºä¸åŒçš„encodingï¼Œç”¨int_8ä½œä¸ºbufï¼Œç›´æŽ¥åº•å±‚æ“ä½œäºŒè¿›åˆ¶
2. å…·æœ‰å‡çº§æ“ä½œï¼Œå½“æ’å…¥çš„æ•°å€¼**ä¸€å®šæ˜¯æœ€å¤§çš„ï¼Œæˆ–æ˜¯æœ€å°çš„**(è¶…è¿‡äº†å½“å‰encodingæ‰€èƒ½è¡¨ç¤ºçš„èŒƒå›´ï¼Œåˆ™è¿›è¡Œå‡çº§)[å‡çº§æ–¹å¼å‚è€ƒ**å†…å­˜æ‹·è´ç®—æ³•é¢˜**]

## ZSET-zskiplist
ä¸ºä»€ä¹ˆä½¿ç”¨è·³è¡¨ï¼Œè€Œä¸æ˜¯avlæˆ–çº¢é»‘æ ‘
![ä½¿ç”¨è·³è¡¨è€Œä¸æ˜¯æœç´¢æ ‘çš„åŽŸå› ](image-46.png)
1. æ›´çœç©ºé—´
2. zrangeæ“ä½œæ›´æ–¹ä¾¿
3. æ›´å®¹æ˜“å®žçŽ°å’Œç»´æŠ¤


# Redisçº¿ç¨‹æ¨¡åž‹
![alt text](image-48.png)
![Redisçº¿ç¨‹æ¨¡åž‹](image-47.png)

## ä¸»çº¿ç¨‹å·¥ä½œæµ
![ä¸»çº¿ç¨‹å·¥ä½œæµ](image-49.png)


# æŒä¹…åŒ–
## AOF
aofä¿å­˜å¿«ï¼ŒåŠ è½½æ…¢ï¼Œå› ä¸ºéœ€è¦è§£æžå‘½ä»¤å¹¶é‡æ‰§
**AOFå†™å›žç£ç›˜æ—¶æœº**
![aofå·¥ä½œæµ](image-50.png)

**AOFé‡å†™æœºåˆ¶**
éšç€å·¥ä½œæ—¶é—´å¢žé•¿ï¼Œaofæ–‡ä»¶å˜å¾—è‡ƒè‚¿ï¼Œè¿™æ—¶å€™ç”±ç³»ç»Ÿè‡ªåŠ¨è§¦å‘ï¼Œæˆ–æ‰‹åŠ¨è§¦å‘ï¼Œæ‰§è¡Œè°ƒç”¨bgrewriteaofï¼Œforkå­è¿›ç¨‹è¿›è¡Œé‡å†™

## RDB
ä¿å­˜æ…¢ï¼ŒåŠ è½½å¿«ï¼Œç›´æŽ¥è½½å…¥æ•°æ®

## æ··åˆæŒä¹…åŒ–
![æ··åˆæŒä¹…åŒ–](image-51.png)
![ä¼˜ç¼ºç‚¹](image-52.png)


# è¿‡æœŸåˆ é™¤
1. å®šæ—¶åˆ é™¤
   - åœ¨è®¾ç½®è¿‡æœŸé”®çš„åŒæ—¶åˆ›å»ºä¸€ä¸ªå®šæ—¶äº‹ä»¶ï¼Œæ—¶é—´åˆ°è¾¾æ—¶è¿›è¡Œåˆ é™¤
   - å¯¹å†…å­˜å‹å¥½ï¼Œå¯ä»¥å°½å¿«é‡Šæ”¾ç©ºé—´ï¼Œä½†å ç”¨cpuå½±å“åžåé‡
   - ![alt text](image-53.png)
2. æ‡’æƒ°åˆ é™¤
   - ä¸ä¸»åŠ¨åˆ é™¤ï¼Œæ¯æ¬¡è®¿é—®æ—¶æ£€æŸ¥æ˜¯å¦è¿‡æœŸï¼Œå¦‚æžœæ˜¯æ‰åˆ é™¤
   - CPUå‹å¥½ï¼Œä½†æ˜¯å ç”¨å†…å­˜
3. å®šæœŸåˆ é™¤
   - æ¯éš”ä¸€æ®µæ—¶é—´æŠ½æŸ¥éƒ¨åˆ†keyï¼Œå°†è¿‡æœŸçš„keyåˆ é™¤
   - ä¸­å’Œäº†å®šæ—¶å’Œæƒ°æ€§åˆ é™¤çš„ä¼˜ç¼ºç‚¹

redisé‡‡ç”¨çš„æ˜¯[**æƒ°æ€§+å®šæœŸ**]çš„åˆ é™¤ç­–ç•¥
**å®šæœŸåˆ é™¤æµç¨‹**
![å®šæœŸåˆ é™¤æµç¨‹](image-54.png)

# å†…å­˜æ·˜æ±°
å½“rediså†…å­˜å ç”¨è¾¾åˆ°ä¸Šé™ï¼Œè¿™æ—¶å€™åˆæœ‰æ–°æ•°æ®å†™å…¥ï¼Œå°±éœ€è¦è¿›è¡Œå†…ç²—æ·˜æ±°é€‰æ‹©
å†…å­˜æ·˜æ±°çš„å‡ ç§æ–¹å¼
1. ä¸è¿›è¡Œå†…å­˜æ·˜æ±°
   - ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“å†…å­˜å ç”¨è¾¾åˆ°ä¸Šé™ï¼Œæ•°æ®åº“æ‹’ç»å†™å…¥
2. è¿›è¡Œæ·˜æ±°
   1. æ·˜æ±°è¿‡æœŸæ•°æ®
      - random, éšæœºæ·˜æ±°è¿‡æœŸæ•°æ®
      - ttlï¼Œ æ·˜æ±°æœ€æ—©è¿‡æœŸçš„
      - lruï¼Œæ·˜æ±°æœ€è¿œæ²¡æœ‰è¢«ä½¿ç”¨çš„
      - lfuï¼Œæ·˜æ±°æœ€å°‘ä½¿ç”¨çš„
   2. åœ¨æ‰€æœ‰æ•°æ®èŒƒå›´ä¸­è¿›è¡Œæ·˜æ±°
      - random
      - lru
      - lfu

![å†…å­˜æ·˜æ±°ç­–ç•¥](image-55.png)


# ä¸»ä»Žå¤åˆ¶
## ä¸»ä»Žå¤åˆ¶æµç¨‹
![alt text](image-56.png)
***ç¬¬ä¸€é˜¶æ®µ--å…¨é‡å¤åˆ¶***
1. ä¸»æœåŠ¡å™¨è°ƒç”¨bgsaveç”ŸæˆRDBæ–‡ä»¶
2. ä¸»æœåŠ¡å™¨å‘é€RDBç»™ä»ŽæœåŠ¡å™¨
3. ä½†æ˜¯åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­**å¯èƒ½æœ‰æ–°çš„å†™å‘½ä»¤**ï¼ŒäºŽæ˜¯ä½¿ç”¨replication bufferå­˜å‚¨æ–°çš„å†™å‘½ä»¤ï¼Œç„¶åŽå°†æ–°å†™å‘½ä»¤å‘é€ç»™ä»ŽæœåŠ¡å™¨

***ç¬¬äºŒé˜¶æ®µ--å‘½ä»¤ä¼ æ’­***
1. åœ¨å…¨é‡å¤åˆ¶ç»“æŸåŽï¼Œä¸»ä»ŽåŒæ–¹**ç»´æŒTCPé•¿è¿žæŽ¥**ï¼Œä¸»æœåŠ¡å™¨å‘ä»ŽæœåŠ¡å™¨å‘é€æ–°çš„å†™å‘½ä»¤

***æ–­è”æ¢å¤--å¢žé‡å¤åˆ¶***
1. ç”±äºŽç½‘ç»œå¼‚å¸¸ï¼Œä¸»ä»Žå¯èƒ½ä¼šæ–­å¼€è¿žæŽ¥
2. è¿™æ—¶ä¸»æœåŠ¡å™¨ä¼šå°†å‘½ä»¤å‘åœ¨**replication backlog bufferçŽ¯å½¢ç¼“å†²åŒº**ï¼ˆæ³¨æ„åŒºåˆ«replication bufferï¼‰ä¸­ï¼ŒåŒæ—¶ç»´æŠ¤ä¸€ä¸ª**offsetå˜é‡**
3. ä»Žæ–°è¿žæŽ¥åŽï¼Œ**ä¸»çš„å†™offset - ä»Žè¯»offset > backlogå¤§å°**ï¼Œå…¨é‡å¤åˆ¶ï¼Œ å¦åˆ™å¢žé‡å¤åˆ¶ã€‚


## replication buffer & replication backlog bufferçš„åŒºåˆ«
åœ¨ Redis **ä¸»ä»Žå¤åˆ¶ï¼ˆReplicationï¼‰** è¿‡ç¨‹ä¸­ï¼Œæ¶‰åŠå¤šä¸ªç¼“å†²åŒºæ¥é«˜æ•ˆåœ°åŒæ­¥æ•°æ®ï¼Œå…¶ä¸­ **Replication Buffer** å’Œ **Replication Backlog Buffer** æ˜¯ä¸¤ä¸ªé‡è¦çš„æ¦‚å¿µã€‚å®ƒä»¬çš„ä½œç”¨å’ŒåŒºåˆ«å¦‚ä¸‹ï¼š

---

### **1. Replication Bufferï¼ˆä¸»ä»ŽåŒæ­¥ç¼“å†²åŒºï¼‰**
**ä½œç”¨**ï¼š  
- ç”¨äºŽ **ä¸»èŠ‚ç‚¹ï¼ˆMasterï¼‰å‘ä»ŽèŠ‚ç‚¹ï¼ˆReplicaï¼‰å‘é€æ•°æ®** çš„ä¸´æ—¶ç¼“å†²åŒºã€‚  
- æ¯ä¸ªä»ŽèŠ‚ç‚¹éƒ½æœ‰**è‡ªå·±ç‹¬ç«‹çš„** Replication Bufferã€‚  
- ä¸»è¦ç”¨äºŽ**å…¨é‡åŒæ­¥ï¼ˆFull Syncï¼‰** æœŸé—´ï¼ŒMaster å‘ Slave å‘é€ RDB æ–‡ä»¶æ—¶çš„ä¸´æ—¶å­˜å‚¨ã€‚

**å·¥ä½œæµç¨‹**ï¼š
1. å½“ä»ŽèŠ‚ç‚¹è¿žæŽ¥åˆ°ä¸»èŠ‚ç‚¹æ—¶ï¼Œä¸»èŠ‚ç‚¹ä¼šç”Ÿæˆä¸€ä¸ª **RDB å¿«ç…§** å¹¶å°†å…¶å­˜å…¥ **Replication Buffer**ã€‚
2. ä¸»èŠ‚ç‚¹é€šè¿‡ **Socket å‘é€ Replication Buffer** çš„æ•°æ®ç»™ä»ŽèŠ‚ç‚¹ã€‚
3. å‘é€å®Œ RDB ä¹‹åŽï¼Œä¸»èŠ‚ç‚¹å¼€å§‹**å®žæ—¶å¤åˆ¶å¢žé‡å‘½ä»¤**ï¼Œä»ç„¶ä¼šåˆ©ç”¨ Replication Buffer å‘é€ç»™å„ä¸ªä»ŽèŠ‚ç‚¹ã€‚

**ç‰¹ç‚¹**ï¼š
- **æ¯ä¸ªä»ŽèŠ‚ç‚¹éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„ Replication Buffer**ï¼ˆå³ï¼šå¦‚æžœæœ‰ 3 ä¸ªä»ŽèŠ‚ç‚¹ï¼ŒMaster å°±ä¼šç»´æŠ¤ 3 ä»½ Replication Bufferï¼‰ã€‚
- **æ•°æ®å®žæ—¶æŽ¨é€**ï¼Œä¸ä¼šä¿å­˜å¾ˆé•¿æ—¶é—´ï¼Œä¸»è¦æ˜¯ç”¨äºŽæµé‡ä¼ è¾“ã€‚

---

### **2. Replication Backlog Bufferï¼ˆå¤åˆ¶ç§¯åŽ‹ç¼“å†²åŒºï¼‰**
**ä½œç”¨**ï¼š  
- **ç”¨äºŽå¢žé‡å¤åˆ¶ï¼ˆPartial Resynchronizationï¼‰**ï¼Œé˜²æ­¢ Slave çŸ­æš‚æ–­è¿žåŽå¿…é¡»é‡æ–°è¿›è¡Œå…¨é‡åŒæ­¥ã€‚
- **æ‰€æœ‰ä»ŽèŠ‚ç‚¹å…±äº«ä¸€ä¸ª** Replication Backlog Bufferï¼Œè€Œä¸æ˜¯æ¯ä¸ª Slave å•ç‹¬æ‹¥æœ‰ä¸€ä¸ªã€‚
- å½“ä»ŽèŠ‚ç‚¹çŸ­æš‚æ–­å¼€åŽé‡æ–°è¿žæŽ¥ï¼ŒMaster å¯åˆ©ç”¨ Backlog Buffer **å¢žé‡åŒæ­¥ä¸¢å¤±çš„æ•°æ®**ï¼Œé¿å…é‡æ–°å‘é€ RDB æ–‡ä»¶ã€‚

**å·¥ä½œæµç¨‹**ï¼š
1. ä¸»èŠ‚ç‚¹åœ¨å†…å­˜ä¸­ç»´æŠ¤ä¸€ä¸ª **Replication Backlog Buffer**ï¼ˆé»˜è®¤ 1MBï¼Œå¯é…ç½®ï¼‰ã€‚
2. **ä¸»èŠ‚ç‚¹å°†æ‰€æœ‰å˜æ›´å‘½ä»¤å†™å…¥ Replication Backlog Buffer**ï¼ŒåŒæ—¶å‘é€ç»™ä»ŽèŠ‚ç‚¹ã€‚
3. **å¦‚æžœæŸä¸ªä»ŽèŠ‚ç‚¹çŸ­æš‚æ–­å¼€**ï¼Œä»ŽèŠ‚ç‚¹ä¼šå¸¦ç€è‡ªå·±çš„ `replication offset` é‡æ–°è¿žæŽ¥ã€‚
4. **ä¸»èŠ‚ç‚¹æ£€æŸ¥ Replication Backlog Buffer**ï¼š
   - **å¦‚æžœä¸¢å¤±çš„æ•°æ®è¿˜åœ¨ç¼“å†²åŒºä¸­**ï¼šç›´æŽ¥å¢žé‡åŒæ­¥ï¼Œé¿å…å…¨é‡åŒæ­¥ã€‚
   - **å¦‚æžœä¸¢å¤±çš„æ•°æ®å·²è¢«è¦†ç›–**ï¼ˆè¶…å‡º backlog çš„å¤§å°ï¼‰ï¼šä»ŽèŠ‚ç‚¹å¿…é¡»æ‰§è¡Œ **å…¨é‡åŒæ­¥**ã€‚

**ç‰¹ç‚¹**ï¼š
- **æ‰€æœ‰ä»ŽèŠ‚ç‚¹å…±äº«åŒä¸€ä¸ª Replication Backlog Buffer**ï¼Œä¸åƒ Replication Buffer é‚£æ ·æ¯ä¸ª Slave å•ç‹¬ç»´æŠ¤ã€‚
- **ç”¨äºŽå¢žé‡åŒæ­¥**ï¼Œå¯ä»¥å‡å°‘å› ç½‘ç»œé—ªæ–­å¯¼è‡´çš„å…¨é‡åŒæ­¥å¼€é”€ã€‚
- **å¤§å°å¯é…ç½®**ï¼ˆ`repl-backlog-size`ï¼‰ï¼Œé»˜è®¤ `1MB`ï¼Œå¦‚æžœæœ‰å¤šä¸ª Slaveï¼Œå»ºè®®é€‚å½“å¢žå¤§ã€‚

---

### **3. ä¸»è¦åŒºåˆ«**
| **å¯¹æ¯”é¡¹**            | **Replication Buffer** | **Replication Backlog Buffer** |
|----------------------|----------------------|------------------------------|
| **ä½œç”¨**            | Master å‘æŸä¸ª Slave å‘é€æ•°æ®çš„ä¸´æ—¶ç¼“å†²åŒº | è®°å½•æœ€è¿‘çš„å˜æ›´å‘½ä»¤ï¼Œæ”¯æŒå¢žé‡åŒæ­¥ |
| **æ˜¯å¦å…±äº«**        | **æ¯ä¸ªä»ŽèŠ‚ç‚¹ç‹¬ç«‹**    | **æ‰€æœ‰ä»ŽèŠ‚ç‚¹å…±äº«**            |
| **ä¸»è¦ç”¨äºŽ**        | **å…¨é‡åŒæ­¥ï¼ˆRDB ä¼ è¾“ï¼‰+ å®žæ—¶å‘½ä»¤æŽ¨é€** | **å¢žé‡åŒæ­¥ï¼ˆPartial Resyncï¼‰** |
| **å­˜å‚¨å†…å®¹**        | RDB æ–‡ä»¶ + å®žæ—¶å‘½ä»¤   | å˜æ›´å‘½ä»¤ï¼ˆå¦‚ `SET`, `DEL`ï¼‰ |
| **å¤§å°å¯é…ç½®**      | ä¸å¯é…ç½®              | `repl-backlog-size`ï¼ˆé»˜è®¤ 1MBï¼‰ |
| **è¿‡æœŸç­–ç•¥**        | åªç”¨äºŽä¸´æ—¶å­˜å‚¨ï¼Œæ•°æ®å‘å‡ºåŽå³é‡Šæ”¾ | å…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰ï¼Œè¶…å‡ºå¤§å°åŽè¦†ç›–æ—§æ•°æ® |

---

### **4. æ€»ç»“**
1. **Replication Buffer**
   - **æ¯ä¸ª Slave æœ‰ç‹¬ç«‹çš„ Buffer**ï¼Œç”¨äºŽ Master å‘é€ RDB æ–‡ä»¶å’Œå®žæ—¶å‘½ä»¤æ•°æ®ã€‚
   - **ä¸»è¦ç”¨äºŽå…¨é‡åŒæ­¥ï¼ˆFull Syncï¼‰**ï¼Œæ•°æ®ä¸ä¼šé•¿æ—¶é—´ä¿å­˜ã€‚

2. **Replication Backlog Buffer**
   - **æ‰€æœ‰ Slave å…±äº«åŒä¸€ä¸ª Buffer**ï¼Œç”¨äºŽå­˜å‚¨æœ€è¿‘çš„å˜æ›´å‘½ä»¤ã€‚
   - **ä¸»è¦ç”¨äºŽå¢žé‡åŒæ­¥ï¼ˆPartial Resyncï¼‰**ï¼Œé¿å…å› çŸ­æš‚æ–­è¿žå¯¼è‡´å…¨é‡åŒæ­¥ã€‚

**ç®€å•ç†è§£**ï¼š
- **Replication Buffer** = **ä¸´æ—¶ç¼“å­˜ï¼Œæ¯ä¸ªä»ŽèŠ‚ç‚¹ç‹¬ç«‹æ‹¥æœ‰ï¼Œä¸»è¦ç”¨äºŽå…¨é‡åŒæ­¥**ã€‚
- **Replication Backlog Buffer** = **å…±äº«çš„çŽ¯å½¢ç¼“å†²åŒºï¼Œä¸»è¦ç”¨äºŽå¢žé‡åŒæ­¥ï¼Œé¿å…å…¨é‡åŒæ­¥çš„æ¶ˆè€—**ã€‚

---

## ä¸»ä»Žæ•°æ®ä¸ä¸€è‡´
å»¶è¿Ÿè¿‡é«˜çš„æ—¶å€™ï¼Œç¦æ­¢ä»ŽæœåŠ¡å™¨è¯»æ“ä½œ
![alt text](image-94.png)

## å¦‚ä½•å‡å°‘ä¸»ä»Žåˆ‡æ¢æ•°æ®ä¸¢å¤±
1. å‡å°‘**å¼‚æ­¥å¤åˆ¶æ•°æ®ä¸¢å¤±**--ä½¿ç”¨min-slaves-max-lag,å½“æ­£å¸¸çš„ä»ŽèŠ‚ç‚¹è¶…è¿‡æœ€å¤§å»¶è¿Ÿçš„æ•°é‡ä¸‹é™åˆ°å¯æŽ¥å—å€¼ä¹‹ä¸‹ï¼Œæ‹’ç»å†™æ“ä½œ
![å¼‚æ­¥å¤åˆ¶æ•°æ®ä¸¢å¤±](image-57.png)

2. å‡å°‘**é›†ç¾¤äº§ç”Ÿè„‘è£‚æ•°æ®ä¸¢å¤±**--ä¸»èŠ‚ç‚¹é™çº§ä¸ºä»ŽèŠ‚ç‚¹å¤åˆ¶æ¸…ç©ºå¯¼è‡´æ•°æ®ä¸¢å¤±
**è„‘è£‚çš„åŽŸå› **ï¼š
![alt text](image-58.png)
**è§£å†³æ–¹æ¡ˆ**ï¼š
![alt text](image-59.png)

## æ³¨æ„åŒºåˆ†ä¸»ä»Žæ•°æ®ä¸ä¸€è‡´å’Œä¸»ä»Žåˆ‡æ¢æ•°æ®ä¸¢å¤±é—®é¢˜

# å“¨å…µ
![å“¨å…µæœºåˆ¶](image-60.png)
ä¸€èˆ¬éœ€è¦ä¸‰ä¸ªå“¨å…µï¼Œ

## å®¢è§‚ä¸‹çº¿å’Œä¸»è§‚ä¸‹çº¿
![alt text](image-62.png)
![alt text](image-63.png)

## é€‰ä¸¾å“¨å…µleaderï¼Œleaderè¿›è¡Œæ•…éšœè½¬ç§»
## æ•…éšœè½¬ç§»æµç¨‹
### 1.é€‰æ–°ä¸»èŠ‚ç‚¹
1. çœ‹ä¼˜å…ˆçº§
2. çœ‹å¤åˆ¶è¿›åº¦
3. çœ‹ID
![é€‰æ–°ä¸»èŠ‚ç‚¹æµç¨‹](image-61.png)
### 2.å°†ä»ŽèŠ‚ç‚¹æŒ‡å‘æ–°ä¸»èŠ‚ç‚¹
### 3.å°†é€šçŸ¥å®¢æˆ·ç«¯ä¸»èŠ‚ç‚¹æ›´æ¢
### 4.æ—§ä¸»èŠ‚ç‚¹å˜æˆä»ŽèŠ‚ç‚¹


## Raftåˆ†å¸ƒå¼ä¸€è‡´æ€§ç®—æ³•
Raftæ˜¯ä¸€ç§**åˆ†å¸ƒå¼ä¸€è‡´æ€§ç®—æ³•**ï¼Œä¸»è¦ç”¨äºŽåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ç¡®ä¿å¤šä¸ªèŠ‚ç‚¹ä¹‹é—´çš„æ•°æ®ä¸€è‡´æ€§ã€‚å®ƒé€šè¿‡ç®€åŒ–è®¾è®¡ï¼ˆç›¸æ¯”Paxosï¼‰å®žçŽ°äº†å¼ºä¸€è‡´æ€§ã€é«˜å¯ç”¨æ€§å’Œå®¹é”™æ€§ï¼Œå¹¿æ³›åº”ç”¨äºŽåˆ†å¸ƒå¼æ•°æ®åº“ã€å…ƒæ•°æ®ç®¡ç†ï¼ˆå¦‚ETCDï¼‰ç­‰åœºæ™¯ã€‚

---

### æ ¸å¿ƒæ¦‚å¿µä¸Žæœºåˆ¶

1. **è§’è‰²åˆ’åˆ†**  
   Raftå°†èŠ‚ç‚¹åˆ†ä¸ºä¸‰ç§è§’è‰²ï¼š
   â€¢ **Leaderï¼ˆé¢†å¯¼è€…ï¼‰**ï¼šå”¯ä¸€å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ï¼Œè´Ÿè´£æ—¥å¿—å¤åˆ¶å’Œå¿ƒè·³ç»´æŒã€‚
   â€¢ **Followerï¼ˆè·Ÿéšè€…ï¼‰**ï¼šè¢«åŠ¨å“åº”Leaderçš„æŒ‡ä»¤ï¼Œå‚ä¸Žé€‰ä¸¾å’Œæ—¥å¿—åŒæ­¥ã€‚
   â€¢ **Candidateï¼ˆå€™é€‰è€…ï¼‰**ï¼šåœ¨Leaderå¤±æ•ˆæ—¶å‘èµ·é€‰ä¸¾çš„ä¸´æ—¶è§’è‰²ã€‚

2. **ä»»æœŸï¼ˆTermï¼‰**  
   æ¯ä¸ªä»»æœŸæ˜¯ä¸€ä¸ªè¿žç»­é€’å¢žçš„ç¼–å·ï¼Œç”¨äºŽæ ‡è¯†é€‰ä¸¾å‘¨æœŸã€‚åŒä¸€ä»»æœŸå†…åªèƒ½æœ‰ä¸€ä¸ªLeaderï¼Œè‹¥é€‰ä¸¾å¤±è´¥åˆ™å¼€å¯æ–°ä»»æœŸã€‚

3. **é¢†å¯¼è€…é€‰ä¸¾**  
   â€¢ **è§¦å‘æ¡ä»¶**ï¼šFolloweråœ¨å¿ƒè·³è¶…æ—¶æœªæ”¶åˆ°Leaderæ¶ˆæ¯æ—¶è½¬å˜ä¸ºCandidateå¹¶å‘èµ·é€‰ä¸¾ã€‚
   â€¢ **æŠ•ç¥¨è§„åˆ™**ï¼šèŠ‚ç‚¹æŠ•ç¥¨ç»™æ—¥å¿—æœ€æ–°ï¼ˆæœ€åŽæ—¥å¿—çš„ç´¢å¼•å’Œä»»æœŸå·æ›´å¤§ï¼‰çš„Candidateï¼ŒèŽ·å¾—åŠæ•°ä»¥ä¸Šé€‰ç¥¨çš„Candidateæˆä¸ºæ–°Leaderã€‚
   â€¢ **éšæœºè¶…æ—¶**ï¼šèŠ‚ç‚¹ç­‰å¾…é€‰ä¸¾çš„æ—¶é—´éšæœºï¼ˆå¦‚150-300msï¼‰ï¼Œé¿å…å¤šä¸ªCandidateåŒæ—¶ç«žäº‰å¯¼è‡´è„‘è£‚ã€‚

4. **æ—¥å¿—å¤åˆ¶**  
   â€¢ **æµç¨‹**ï¼šLeaderå°†å®¢æˆ·ç«¯è¯·æ±‚è½¬åŒ–ä¸ºæ—¥å¿—æ¡ç›®ï¼Œé€šè¿‡**AppendEntries RPC**å‘é€ç»™Followerã€‚å½“è¶…è¿‡åŠæ•°èŠ‚ç‚¹ç¡®è®¤åŽï¼Œæ—¥å¿—æ ‡è®°ä¸ºå·²æäº¤ï¼ˆCommittedï¼‰ï¼Œå¹¶åº”ç”¨åˆ°çŠ¶æ€æœºã€‚
   â€¢ **ä¸€è‡´æ€§æ£€æŸ¥**ï¼šé€šè¿‡æ¯”å¯¹å‰ä¸€æ¡æ—¥å¿—çš„ç´¢å¼•å’Œä»»æœŸå·ï¼Œç¡®ä¿Followeræ—¥å¿—ä¸ŽLeaderä¸€è‡´ã€‚è‹¥å†²çªï¼ŒLeaderå¼ºåˆ¶Followerå¤åˆ¶è‡ªå·±çš„æ—¥å¿—ã€‚

5. **å®‰å…¨æ€§è§„åˆ™**  
   â€¢ **é€‰ä¸¾é™åˆ¶**ï¼šåªæœ‰æ—¥å¿—æœ€æ–°çš„Candidateæ‰èƒ½å½“é€‰Leaderï¼Œé¿å…æ•°æ®ä¸¢å¤±ã€‚
   â€¢ **æäº¤è§„åˆ™**ï¼šä»…å½“å‰ä»»æœŸçš„æ—¥å¿—æ¡ç›®å¯è¢«æäº¤ï¼Œç¡®ä¿å·²æäº¤çš„æ—¥å¿—ä¸ä¼šè¢«è¦†ç›–ã€‚

---

### ä¸Žå…¶ä»–ç®—æ³•çš„å¯¹æ¯”
â€¢ **Paxos**ï¼šRafté€šè¿‡è§’è‰²åˆ’åˆ†å’Œæ˜Žç¡®çš„æµç¨‹ç®€åŒ–äº†Paxosçš„å¤æ‚æ€§ï¼Œæ›´æ˜“ç†è§£å’Œå®žçŽ°ã€‚
â€¢ **ZABï¼ˆZookeeperä½¿ç”¨ï¼‰**ï¼šä¸¤è€…å‡é€šè¿‡Leaderæœºåˆ¶å®žçŽ°ä¸€è‡´æ€§ï¼Œä½†Raftçš„é€‰ä¸¾è§„åˆ™æ›´å¼ºè°ƒæ—¥å¿—å®Œæ•´æ€§ã€‚

---

### åº”ç”¨åœºæ™¯
1. **å…ƒæ•°æ®ç®¡ç†**ï¼šå¦‚ETCDä½¿ç”¨Raftä¿è¯é…ç½®ä¿¡æ¯çš„ä¸€è‡´æ€§ã€‚
2. **åˆ†å¸ƒå¼æ•°æ®åº“**ï¼šå¦‚CockroachDBé€šè¿‡Raftå®žçŽ°å¤šå‰¯æœ¬æ•°æ®åŒæ­¥ã€‚
3. **åˆ†å¸ƒå¼é”ä¸Žäº‹åŠ¡**ï¼šç¡®ä¿è·¨èŠ‚ç‚¹çš„æ“ä½œåŽŸå­æ€§å’Œä¸€è‡´æ€§ã€‚

---

### ä¼˜ç¼ºç‚¹
â€¢ **ä¼˜ç‚¹**ï¼šè®¾è®¡ç®€æ´ã€æ˜“äºŽå·¥ç¨‹åŒ–ï¼›æ”¯æŒçº¿æ€§ä¸€è‡´æ€§ï¼›å®¹é”™æ€§å¼ºï¼ˆåŠæ•°èŠ‚ç‚¹å­˜æ´»å³å¯è¿è¡Œï¼‰ã€‚
â€¢ **ç¼ºç‚¹**ï¼šä¾èµ–å¿ƒè·³æœºåˆ¶ï¼Œç½‘ç»œåˆ†åŒºå¯èƒ½å¯¼è‡´çŸ­æ—¶ä¸å¯ç”¨ï¼›æ—¥å¿—å¼ºåˆ¶è¦†ç›–å¯èƒ½å¢žåŠ åŒæ­¥å¼€é”€ã€‚

---

å¦‚æžœéœ€è¦æ›´æ·±å…¥çš„å®žçŽ°ç»†èŠ‚ï¼ˆå¦‚æ—¥å¿—åŽ‹ç¼©ã€å¿«ç…§æœºåˆ¶ï¼‰æˆ–å…·ä½“æ¡ˆä¾‹åˆ†æžï¼Œå¯ä»¥å‚è€ƒç›¸å…³æŠ€æœ¯æ–‡æ¡£æˆ–æºç å®žçŽ°ã€‚

## Raft no-op
 **Raft No-Opï¼ˆç©ºæ“ä½œï¼‰**
åœ¨ **Raft å…±è¯†ç®—æ³•** ä¸­ï¼Œ**No-Opï¼ˆç©ºæ“ä½œï¼‰** æ˜¯æŒ‡ **Leader å½“é€‰åŽï¼Œå‘æ—¥å¿—ä¸­è¿½åŠ ä¸€ä¸ªä¸æ‰§è¡Œä»»ä½•æ“ä½œçš„å‘½ä»¤**ï¼Œç¡®ä¿è‡ªå·±çš„åˆæ³•æ€§ï¼Œå¹¶è®©é›†ç¾¤çŠ¶æ€ä¿æŒä¸€è‡´ã€‚

---

### **ðŸ“Œ No-Op çš„ä½œç”¨**
å½“ä¸€ä¸ªæ–°çš„ **Leader** å½“é€‰æ—¶ï¼š
1. **ç¡®è®¤è‡ªå·±å·²è¢«å¤§å¤šæ•°èŠ‚ç‚¹æŽ¥å—**
2. **æäº¤ä¸€ä¸ªç©ºæ—¥å¿—æ¡ç›®**ï¼ŒæŽ¨è¿› `commitIndex`ï¼Œç¡®ä¿é›†ç¾¤çš„ä¸€è‡´æ€§
3. **ä¿è¯æ‰€æœ‰ Follower çŸ¥é“æ–°çš„ Leader**
4. **è§£å†³æ½œåœ¨çš„ â€œè„‘è£‚â€ é—®é¢˜**ï¼ˆå¦‚æžœæ—§ Leader å­˜åœ¨ï¼‰

---

### **ðŸ“Œ No-Op çš„æ‰§è¡Œè¿‡ç¨‹**
 **ðŸ›  å…·ä½“æ­¥éª¤**
1. **Leader é€‰ä¸¾æˆåŠŸ**
   - å½“ä¸€ä¸ªèŠ‚ç‚¹èŽ·å¾— **å¤šæ•°é€‰ç¥¨** åŽï¼Œæˆä¸ºæ–°çš„ Leaderã€‚
   
2. **Leader è¿½åŠ  No-Op æ—¥å¿—**
   - é€‰ä¸¾æˆåŠŸåŽï¼ŒLeader ç«‹å³å‘æ—¥å¿—è¿½åŠ ä¸€ä¸ª **No-Opï¼ˆç©ºæ“ä½œï¼‰**ï¼Œå³ä¸€ä¸ª **ä¸åŒ…å«ä¸šåŠ¡é€»è¾‘çš„æ—¥å¿—æ¡ç›®**ã€‚
   - ä¾‹å¦‚ï¼š
     ```
     Term: 5, Index: 10, Command: No-Op
     ```
   
3. **Leader å‘é€ AppendEntries**
   - Leader å‘é€ **AppendEntries RPC** ç»™ Followerï¼Œè¦æ±‚å¤åˆ¶ No-Op æ—¥å¿—ã€‚
   
4. **Follower å¤åˆ¶ & æäº¤**
   - å¦‚æžœå¤šæ•° Follower å¤åˆ¶è¯¥æ—¥å¿—ï¼ŒLeader é€’å¢ž `commitIndex`ï¼Œè®¤ä¸º No-Op å·²æäº¤ã€‚
   - è¿™æ—¶ï¼ŒLeader æ‰ç®—æ­£å¼ **â€œç¨³å®šâ€**ã€‚

---

### **ðŸ“Œ ä¸ºä»€ä¹ˆ Raft éœ€è¦ No-Opï¼Ÿ**
 **1ï¸âƒ£ ç¡®ä¿æ–°çš„ Leader ä¸€è‡´æ€§**
- é€‰ä¸¾åŽï¼Œæ–°çš„ Leader **å¯èƒ½è¿˜æ²¡æäº¤è¿‡æ—¥å¿—**ï¼Œä½†å®ƒå¿…é¡»**å°½å¿«æäº¤ä¸€ä¸ªæ—¥å¿—**ï¼Œç¡®ä¿é›†ç¾¤ä¸ä¼šå›žæ»šåˆ°æ—§ Leader çŠ¶æ€ã€‚
- No-Op è®© Follower **çŸ¥é“å¹¶ç¡®è®¤æ–° Leader çš„ä»»æœŸï¼ˆTermï¼‰**ã€‚

 **2ï¸âƒ£ é˜²æ­¢æ—§ Leader ä½œæ€ª**
- æ—§ Leader **å¯èƒ½è¿˜åœ¨è¿è¡Œ**ï¼Œä½†å®ƒçš„ `Term` è¿‡æœŸäº†ã€‚
- **æ–°çš„ No-Op è®© Follower ç¡®è®¤æ–°çš„ Leaderï¼Œæ‹’ç»æ—§ Leader çš„è¯·æ±‚**ï¼Œé¿å…è„‘è£‚ã€‚

 **3ï¸âƒ£ æé«˜ `commitIndex`ï¼Œä¿è¯å¯ç”¨æ€§**
- **å¦‚æžœæ–°çš„ Leader ä¹‹å‰æ˜¯ Followerï¼Œå¯èƒ½æœ‰æœªæäº¤çš„æ—¥å¿—**ã€‚
- No-Op **æŽ¨è¿› `commitIndex`**ï¼Œç¡®ä¿æœªæäº¤çš„æ—¥å¿—å°½å¿«æäº¤ï¼Œé˜²æ­¢æ•°æ®ä¸ä¸€è‡´ã€‚

---

### **ðŸ“Œ No-Op ç¤ºä¾‹**
 **å‡è®¾ï¼š**
- **Follower Aï¼ˆTerm 4ï¼‰ & Follower Bï¼ˆTerm 4ï¼‰**
- é€‰ä¸¾åŽï¼Œ**C æˆä¸º Leaderï¼ˆTerm 5ï¼‰**

 **æµç¨‹ï¼š**
| æ­¥éª¤ | æ“ä½œ |
|----|----|
| **1** | C å½“é€‰ä¸º Leaderï¼ˆTerm 5ï¼‰ |
| **2** | C è¿½åŠ  `No-Op`ï¼ˆIndex: 10, Term: 5ï¼‰ |
| **3** | C å‘é€ `AppendEntries(No-Op)` ç»™ A & B |
| **4** | A & B å¤åˆ¶ `No-Op` å¹¶è¿”å›ž `ACK` |
| **5** | **C æäº¤ `No-Op`ï¼ˆcommitIndex é€’å¢žï¼‰** |
| **6** | **C ç¡®è®¤è‡ªå·±æ˜¯ç¨³å®šçš„ Leaderï¼Œç»§ç»­å¤„ç†ä¸šåŠ¡è¯·æ±‚** |

---

### **ðŸ“Œ No-Op ä»£ç ç¤ºä¾‹**
å‡è®¾ Raft å®žçŽ°ä¸­ `becomeLeader()` å¤„ç†é¢†å¯¼é€‰ä¸¾ï¼ŒNo-Op é€»è¾‘å¦‚ä¸‹ï¼š
```go
func becomeLeader() {
    // è¿½åŠ  No-Op æ—¥å¿—æ¡ç›®
    logEntry := LogEntry{
        Term:    currentTerm,
        Index:   lastLogIndex + 1,
        Command: nil,  // No-Op
    }
    
    log.append(logEntry)  // è¿½åŠ åˆ°æ—¥å¿—
    
    // å‘é€ AppendEntries RPC è®© Follower å¤åˆ¶
    for _, peer := range peers {
        sendAppendEntries(peer)
    }
    
    // æäº¤ No-Op
    commitIndex = logEntry.Index
}
```

---

### **ðŸ“Œ ç»“è®º**
**Raft No-Op æ˜¯æ–° Leader é€‰ä¸¾æˆåŠŸåŽæ‰§è¡Œçš„ç¬¬ä¸€æ­¥**ï¼Œç”¨äºŽï¼š
âœ… **ç¡®ä¿è‡ªå·±è¢«å¤šæ•°èŠ‚ç‚¹æŽ¥å—**  
âœ… **é˜²æ­¢æ—§ Leader å¹²æ‰°**ï¼ˆé¿å…è„‘è£‚ï¼‰  
âœ… **æŽ¨è¿› `commitIndex`ï¼Œç¡®ä¿æ—¥å¿—ä¸€è‡´æ€§**  

ðŸš€ **è¿™æ ·ï¼Œé›†ç¾¤å°±å¯ä»¥å®‰å…¨åœ°å¤„ç†æ–°çš„å†™è¯·æ±‚ï¼** ðŸ˜Š

## Raftçš„æ—¥å¿—æ˜¯åšä»€ä¹ˆç”¨çš„
åœ¨ **Raft** å…±è¯†ç®—æ³•ä¸­ï¼Œ**æ—¥å¿—**ï¼ˆLogï¼‰æ˜¯ç¡®ä¿ **æ•°æ®ä¸€è‡´æ€§** çš„æ ¸å¿ƒç»„æˆéƒ¨åˆ†ã€‚Raft çš„æ—¥å¿—ä¸ä»…ç”¨æ¥è®°å½•é›†ç¾¤ä¸­çš„æ“ä½œï¼Œè¿˜é€šè¿‡æ—¥å¿—çš„å¤åˆ¶ã€æäº¤å’Œä¸€è‡´æ€§ä¿è¯äº†åˆ†å¸ƒå¼ç³»ç»Ÿä¸­æ‰€æœ‰èŠ‚ç‚¹çš„æ•°æ®åŒæ­¥ä¸Žä¸€è‡´æ€§ã€‚

### **1ï¸âƒ£ Raft æ—¥å¿—çš„ä¸»è¦ä½œç”¨**
Raft çš„æ—¥å¿—ä¸»è¦ç”¨äºŽä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

#### 1. **è®°å½•æ‰€æœ‰æ“ä½œ**
Raft ä¸­çš„æ—¥å¿—è®°å½•äº†ç³»ç»Ÿæ‰€æœ‰éœ€è¦æŒä¹…åŒ–çš„æ“ä½œï¼Œè¿™äº›æ“ä½œé€šå¸¸æ˜¯å¯¹ç³»ç»ŸçŠ¶æ€çš„ä¿®æ”¹ï¼Œæ¯”å¦‚æ•°æ®åº“çš„å†™æ“ä½œã€çŠ¶æ€æœºçš„æ›´æ–°ç­‰ã€‚æ¯æ¡æ—¥å¿—éƒ½æœ‰ä¸¤ä¸ªä¸»è¦éƒ¨åˆ†ï¼š
   - **Termï¼ˆä»»æœŸï¼‰**ï¼šæ—¥å¿—æ˜¯åœ¨å“ªä¸ªé€‰ä¸¾ä»»æœŸä¸‹è¢«åˆ›å»ºçš„ã€‚
   - **Commandï¼ˆå‘½ä»¤ï¼‰**ï¼šæ‰§è¡Œçš„æ“ä½œæˆ–å‘½ä»¤ï¼Œä¾‹å¦‚æ•°æ®åº“çš„å†™å…¥å‘½ä»¤ `SET key value`ã€‚

#### 2. **ç¡®ä¿æ•°æ®ä¸€è‡´æ€§**
Raft ä½¿ç”¨æ—¥å¿—æ¥ç¡®ä¿åœ¨å¤šä¸ªèŠ‚ç‚¹ä¹‹é—´ **æ•°æ®ä¸€è‡´æ€§**ï¼š
   - æ‰€æœ‰èŠ‚ç‚¹ï¼ˆåŒ…æ‹¬ Leader å’Œ Followerï¼‰çš„æ—¥å¿—å¿…é¡»ä¿æŒä¸€è‡´ï¼Œç¡®ä¿åœ¨ä»»æ„æ—¶åˆ»ï¼Œæ‰€æœ‰èŠ‚ç‚¹éƒ½å…·æœ‰ç›¸åŒçš„æ•°æ®è§†å›¾ã€‚
   - æ¯ä¸ªæ—¥å¿—æ¡ç›®éƒ½åŒ…å«ä¸€ä¸ª **ä»»æœŸï¼ˆTermï¼‰**ï¼Œæ ‡è¯†è¯¥æ—¥å¿—å±žäºŽå“ªä¸ªé¢†å¯¼è€…çš„ä»»æœŸï¼Œä»¥æ­¤æ¥é˜²æ­¢æ—¥å¿—çš„ä¸åŒç‰ˆæœ¬ä¹‹é—´çš„å†²çªã€‚

#### 3. **å®žçŽ°æ—¥å¿—å¤åˆ¶å’Œæ•…éšœæ¢å¤**
Raft æ—¥å¿—çš„å¤åˆ¶æœºåˆ¶æ˜¯é›†ç¾¤é«˜å¯ç”¨æ€§çš„å…³é”®ï¼š
   - **Leader è´Ÿè´£æŽ¥æ”¶å®¢æˆ·ç«¯çš„è¯·æ±‚å¹¶ç”Ÿæˆæ–°çš„æ—¥å¿—æ¡ç›®**ï¼Œç„¶åŽå°†è¿™äº›æ—¥å¿—æ¡ç›®å¤åˆ¶åˆ° Follower èŠ‚ç‚¹ã€‚
   - ä¸€æ—¦æ—¥å¿—æ¡ç›®è¢« Leader å’Œå¤§å¤šæ•° Follower èŠ‚ç‚¹å¤åˆ¶ï¼Œæ—¥å¿—å°±è¢« **æäº¤ï¼ˆcommittedï¼‰**ï¼Œå¹¶ä¸”å¯ä»¥åº”ç”¨åˆ°æ¯ä¸ªèŠ‚ç‚¹çš„ **çŠ¶æ€æœº** ä¸­ã€‚
   - å¦‚æžœ Leader æˆ– Follower èŠ‚ç‚¹æ•…éšœï¼ŒRaft ä½¿ç”¨æ—¥å¿—æ¥æ¢å¤èŠ‚ç‚¹çš„çŠ¶æ€ï¼Œä»Žæ•…éšœä¸­æ¢å¤æ—¶å¯ä»¥ä¾æ®ä¸€è‡´çš„æ—¥å¿—æ¡ç›®æ¥ä¿è¯èŠ‚ç‚¹çš„åŒæ­¥ã€‚

---

### **2ï¸âƒ£ æ—¥å¿—æ¡ç›®çš„ç”Ÿå‘½å‘¨æœŸ**
æ¯ä¸ªæ—¥å¿—æ¡ç›®ä»Žç”Ÿæˆåˆ°æäº¤ç»åŽ†ä»¥ä¸‹å‡ ä¸ªé˜¶æ®µï¼š

1. **ç”Ÿæˆæ—¥å¿—æ¡ç›®**
   - å½“å®¢æˆ·ç«¯å‘é€è¯·æ±‚ï¼ˆå¦‚ `SET key value`ï¼‰æ—¶ï¼ŒLeader ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„æ—¥å¿—æ¡ç›®ï¼Œå¹¶å°†å…¶é™„åŠ åˆ°è‡ªå·±çš„æ—¥å¿—ä¸­ã€‚è¿™ä¸ªæ—¥å¿—æ¡ç›®è®°å½•äº†æ“ä½œç±»åž‹å’Œç›¸å…³çš„çŠ¶æ€ï¼ˆå¦‚å‘½ä»¤ `SET`ï¼‰ã€‚

2. **æ—¥å¿—æ¡ç›®å¤åˆ¶åˆ° Follower**
   - Leader ä¼šå°†è¿™ä¸ªæ–°çš„æ—¥å¿—æ¡ç›®é€šè¿‡ **AppendEntries RPC** å‘é€ç»™æ‰€æœ‰çš„ Followerã€‚
   - Follower èŠ‚ç‚¹æ”¶åˆ°æ—¥å¿—åŽä¼šå°†å…¶è¿½åŠ åˆ°è‡ªå·±çš„æ—¥å¿—ä¸­ï¼Œå¹¶è¿”å›žä¸€ä¸ªç¡®è®¤å“åº”ã€‚

3. **æ—¥å¿—æ¡ç›®æäº¤**
   - å½“ Leader æ”¶åˆ°å¤šæ•° Follower èŠ‚ç‚¹çš„ç¡®è®¤åŽï¼Œå®ƒå°±è®¤ä¸ºè¿™ä¸ªæ—¥å¿—æ¡ç›®å·²ç»è¢«**æäº¤**ï¼Œå¹¶å°†å…¶æäº¤ç»™æœ¬åœ°çš„çŠ¶æ€æœºè¿›è¡Œå¤„ç†ã€‚
   - Leader æ›´æ–° `commitIndex`ï¼Œå¹¶é€šè¿‡ **AppendEntries RPC** é€šçŸ¥ Followerï¼Œè¿™äº›èŠ‚ç‚¹ä¹Ÿä¼šå°†è¯¥æ—¥å¿—æ¡ç›®æäº¤åˆ°çŠ¶æ€æœºã€‚

4. **åº”ç”¨åˆ°çŠ¶æ€æœº**
   - ä¸€æ—¦æ—¥å¿—æ¡ç›®è¢«æäº¤ï¼ŒLeader å’Œæ‰€æœ‰ Follower èŠ‚ç‚¹ä¼šåº”ç”¨æ—¥å¿—æ¡ç›®åˆ°è‡ªå·±çš„ **çŠ¶æ€æœº**ï¼ˆå¦‚æ•°æ®åº“æˆ–ç¼“å­˜ï¼‰ä¸­ï¼Œæ‰§è¡Œå¯¹åº”çš„æ“ä½œã€‚
   - ä¾‹å¦‚ï¼Œ`SET key value` å‘½ä»¤ä¼šè¢«åº”ç”¨åˆ°é”®å€¼å­˜å‚¨çš„çŠ¶æ€æœºä¸­ï¼Œæ›´æ–° `key` çš„å€¼ä¸º `value`ã€‚

---

### **3ï¸âƒ£ æ—¥å¿—çš„ä¸€è‡´æ€§ä¿è¯**
Raft ä¿è¯æ—¥å¿—çš„ä¸€è‡´æ€§ï¼Œç¡®ä¿æ—¥å¿—åœ¨æ‰€æœ‰èŠ‚ç‚¹ä¸Šçš„é¡ºåºä¸€è‡´ã€‚ä¸»è¦é€šè¿‡ä»¥ä¸‹å‡ ä¸ªæœºåˆ¶å®žçŽ°ï¼š

#### 1. **æ—¥å¿—åŒ¹é…ï¼ˆLog Matchingï¼‰**
   - Raft çš„æ ¸å¿ƒä¸€è‡´æ€§è§„åˆ™ä¹‹ä¸€æ˜¯ **æ—¥å¿—åŒ¹é…**ï¼Œå³å¦‚æžœä¸¤ä¸ªæ—¥å¿—æ¡ç›®çš„ **ç´¢å¼•å’Œä»»æœŸç›¸åŒ**ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªæ—¥å¿—æ¡ç›®ä¹‹å‰çš„æ‰€æœ‰æ—¥å¿—å¿…é¡»ä¹Ÿç›¸åŒã€‚
   - è¿™ä¸ªä¿è¯ç¡®ä¿äº†æ—¥å¿—çš„ä¸€è‡´æ€§ï¼Œé˜²æ­¢äº†ä¸åŒèŠ‚ç‚¹é—´çš„æ—¥å¿—æ¡ç›®å‘ç”Ÿå†²çªã€‚

#### 2. **æ—¥å¿—å›žæ»šï¼ˆLog Rollbackï¼‰**
   - å½“ Follower çš„æ—¥å¿—ä¸Ž Leader ä¸ä¸€è‡´æ—¶ï¼ŒLeader ä¼šé€šè¿‡æ¯”è¾ƒæ—¥å¿—æ¡ç›®çš„ **ç´¢å¼•å’Œä»»æœŸ**ï¼Œå°†ä¸åŒ¹é…çš„æ—¥å¿—åˆ é™¤ï¼Œå¹¶ä½¿ç”¨ Leader çš„æ—¥å¿—è¦†ç›– Follower ä¸Šçš„å†²çªæ—¥å¿—ã€‚
   - è¿™æ ·ï¼ŒLeader ä¿è¯äº†è‡ªå·±çš„æ—¥å¿—æ˜¯æ­£ç¡®çš„ï¼Œå¹¶ä¸”èƒ½å¤Ÿé€šè¿‡å¤åˆ¶æœºåˆ¶è®© Follower ä¸Ž Leader ä¿æŒä¸€è‡´ã€‚

#### 3. **æ—¥å¿—æäº¤é¡ºåº**
   - Raft é€šè¿‡ `commitIndex` æœºåˆ¶æ¥ç¡®ä¿æ—¥å¿—æäº¤çš„é¡ºåºä¸€è‡´ï¼Œ`commitIndex` ä¿è¯äº†æ‰€æœ‰èŠ‚ç‚¹åœ¨åŒä¸€ä¸ªæ—¶é—´ç‚¹éƒ½æäº¤äº†ç›¸åŒçš„æ—¥å¿—æ¡ç›®ã€‚
   - Leader æäº¤ä¸€ä¸ªæ—¥å¿—æ¡ç›®åŽï¼Œæ‰€æœ‰ Follower éƒ½å¿…é¡»åœ¨æäº¤åŽåŒæ­¥è¯¥æ—¥å¿—æ¡ç›®ã€‚

---

### **4ï¸âƒ£ æ—¥å¿—çš„åº”ç”¨åœºæ™¯**
Raft æ—¥å¿—çš„ä¸»è¦åº”ç”¨åœºæ™¯åŒ…æ‹¬ï¼š

1. **åˆ†å¸ƒå¼æ•°æ®åº“**
   - Raft ç®—æ³•é€šå¸¸ç”¨äºŽåˆ†å¸ƒå¼æ•°æ®åº“ä¸­ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§ã€‚ä¾‹å¦‚ï¼Œå¦‚æžœä¸€ä¸ªå†™æ“ä½œè¢«æäº¤åˆ° Leaderï¼Œå®ƒä¼šè¢«å¤åˆ¶åˆ° Followerï¼Œä¿è¯æ‰€æœ‰å‰¯æœ¬æ•°æ®ä¸€è‡´ã€‚
   - é€šè¿‡ Raft æ—¥å¿—çš„å¤åˆ¶æœºåˆ¶ï¼Œç³»ç»Ÿèƒ½åœ¨ Leader å´©æºƒåŽé€šè¿‡é‡æ–°é€‰ä¸¾ Leader ç»§ç»­æä¾›æœåŠ¡ã€‚

2. **åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿ**
   - ç±»ä¼¼äºŽåˆ†å¸ƒå¼æ•°æ®åº“ï¼Œåˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿã€åˆ†å¸ƒå¼é”®å€¼å­˜å‚¨ç­‰ç³»ç»Ÿä¹Ÿä½¿ç”¨ Raft æ—¥å¿—æ¥ä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚
   - ç³»ç»Ÿæ¯æ¬¡å†™å…¥æ“ä½œéƒ½ä¼šé€šè¿‡æ—¥å¿—è®°å½•ï¼Œå¹¶åœ¨é›†ç¾¤ä¸­ä¿æŒä¸€è‡´ã€‚

3. **å¾®æœåŠ¡é—´çš„çŠ¶æ€åŒæ­¥**
   - åœ¨å¾®æœåŠ¡æž¶æž„ä¸­ï¼ŒRaft å¯ä»¥å¸®åŠ©ä¸åŒæœåŠ¡ä¹‹é—´åŒæ­¥çŠ¶æ€ã€‚ä¾‹å¦‚ï¼Œå½“ä¸€ä¸ªæœåŠ¡æ›´æ–°äº†çŠ¶æ€ï¼ŒRaft æ—¥å¿—ä¼šå°†è¿™ä¸€æ“ä½œå¤åˆ¶åˆ°å…¶ä»–æœåŠ¡ï¼Œç¡®ä¿å®ƒä»¬çš„çŠ¶æ€ä¸€è‡´ã€‚

---

### **æ€»ç»“ï¼šRaft æ—¥å¿—çš„ä½œç”¨**
- **æ•°æ®ä¸€è‡´æ€§**ï¼šRaft çš„æ—¥å¿—æ˜¯ç¡®ä¿åˆ†å¸ƒå¼ç³»ç»Ÿä¸­æ‰€æœ‰èŠ‚ç‚¹æ•°æ®ä¸€è‡´çš„å…³é”®ã€‚
- **æ“ä½œè®°å½•**ï¼šRaft çš„æ—¥å¿—è®°å½•äº†æ‰€æœ‰å¯¹ç³»ç»ŸçŠ¶æ€çš„æ“ä½œï¼ŒåŒ…æ‹¬è¯»å†™æ“ä½œç­‰ã€‚
- **æ•…éšœæ¢å¤**ï¼šRaft é€šè¿‡æ—¥å¿—å¤åˆ¶ä¸Žæäº¤æœºåˆ¶ï¼Œåœ¨ Leader å´©æºƒæ—¶å¯ä»¥æ¢å¤ç³»ç»ŸçŠ¶æ€ã€‚
- **ä¿è¯é¡ºåºä¸€è‡´æ€§**ï¼šRaft æ—¥å¿—ä¿è¯äº†æ—¥å¿—çš„é¡ºåºä¸€è‡´æ€§ï¼Œç¡®ä¿æ‰€æœ‰èŠ‚ç‚¹æŒ‰ç…§ç›¸åŒé¡ºåºåº”ç”¨æ“ä½œã€‚

Raft ç®—æ³•é€šè¿‡æ—¥å¿—çš„ç®¡ç†å’Œå¤åˆ¶ï¼Œç¡®ä¿åˆ†å¸ƒå¼ç³»ç»Ÿä¸­èŠ‚ç‚¹é—´çš„ä¸€è‡´æ€§å’Œé«˜å¯ç”¨æ€§ã€‚

# ç¼“å­˜é›ªå´©ã€å‡»ç©¿ã€ç©¿é€
![alt text](image-64.png)
## é›ªå´©
> redis**å¤§é‡æ•°æ®åŒæ—¶è¿‡æœŸ**æˆ–è€…redis**å®•æœº**ï¼Œå¯¼è‡´ç›´æŽ¥è®¿é—®æ•°æ®åº“
> 
![alt text](image-65.png)
è§£å†³æ–¹æ¡ˆï¼š
***é’ˆå¯¹å¤§é‡æ•°æ®åŒæ—¶è¿‡æœŸ***ï¼š
1. ç»™è¿‡æœŸ+**ä¸Šéšæœºæ•°**ï¼Œä¸è®©æ•°æ®åŒæ—¶è¿‡æœŸ
2. æ•°æ®åº“è®¿é—®**ä¸Šäº’æ–¥é”**ï¼ŒåŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªè¯·æ±‚æž„å»ºç¼“å­˜
3. **ä¸è®¾ç½®è¿‡æœŸæ—¶é—´**ï¼Œè€Œæ˜¯è®©**åŽå°è‡ªåŠ¨å®šæ—¶æ›´æ–°ç¼“å­˜æ•°æ®**--é€šè¿‡**æ¶ˆæ¯é˜Ÿåˆ—**é€šçŸ¥ç¼“å­˜æ›´æ–°

***é’ˆå¯¹rediså®•æœº***
1. æœåŠ¡ç†”æ–­--æ‹’ç»è®¿é—®ç›´åˆ°redisæ¢å¤
2. è¯·æ±‚é™æµ
3. æž„å»ºé«˜å¯é é«˜å¯ç”¨é›†ç¾¤

## å‡»ç©¿
> **çƒ­ç‚¹æ•°æ®è¿‡æœŸ**

è§£å†³æ–¹æ¡ˆä¸Žé›ªå´©ç±»ä¼¼ï¼Œ**ä¸Šäº’æ–¥é”æˆ–æ˜¯ä¸è®¾ç½®è¿‡æœŸæ—¶é—´**

## ç©¿é€
> **è®¿é—®çš„æ•°æ®æ—¢ä¸åœ¨redisä¹Ÿä¸åœ¨æ•°æ®åº“ä¸­**
> å‘ç”ŸåŽŸå› ï¼šä¸šåŠ¡è¯¯åˆ é™¤ï¼Œé»‘å®¢æ”»å‡»
> ![alt text](image-66.png)

è§£å†³æ–¹æ¡ˆï¼š
1. è¯·æ±‚é™æµ
2. ç¼“å­˜ç©ºå€¼æˆ–é»˜è®¤å€¼
3. è®¾ç½®å¸ƒéš†è¿‡æ»¤å™¨--å“ˆå¸Œä¸å­˜åœ¨ä¸€å®šä¸å­˜åœ¨
![å¸ƒéš†è¿‡æ»¤å™¨](image-67.png)

## æ€»ç»“
![alt text](image-68.png)

# å¦‚ä½•ä¿è¯ç¼“å­˜ä¸€è‡´æ€§

## æ›´æ–°ç¼“å­˜å’Œæ•°æ®åº“
### 1.å…ˆæ›´æ–°æ•°æ®åº“ï¼ŒåŽæ›´æ–°ç¼“å­˜
![å…ˆæ›´æ–°æ•°æ®åº“ï¼ŒåŽæ›´æ–°ç¼“å­˜](image-96.png)

### 2.å…ˆæ›´æ–°ç¼“å­˜ï¼ŒåŽæ›´æ–°æ•°æ®åº“
![å…ˆæ›´æ–°ç¼“å­˜ï¼ŒåŽæ›´æ–°æ•°æ®åº“](image-97.png)

## æ›´æ–°æ•°æ®åº“åˆ ç¼“å­˜
### 1.å…ˆåˆ é™¤ç¼“å­˜ï¼ŒåŽæ›´æ–°æ•°æ®åº“
ä»ç„¶ä¼šå‘ç”Ÿä¸ä¸€è‡´é—®é¢˜
![å…ˆåˆ é™¤ç¼“å­˜ï¼ŒåŽæ›´æ–°æ•°æ®åº“](image-98.png)

### 2.å…ˆæ›´æ–°æ•°æ®åº“ï¼ŒåŽåˆ é™¤ç¼“å­˜
ç”±äºŽæ›´æ–°ç¼“å­˜é€Ÿåº¦è¿œé«˜äºŽæ›´æ–°æ•°æ®åº“é€Ÿåº¦ï¼Œæ‰€ä»¥**ä¸å¤ªå¯èƒ½å‡ºçŽ°**ä¸‹é¢é—®é¢˜â€”â€”**ç¼“å­˜å†™å›žé€Ÿåº¦æ…¢äºŽæ•°æ®åº“æ›´æ–°é€Ÿåº¦**ï¼ŒåŒæ—¶**åŠ ä¸Šè¿‡æœŸæ—¶é—´**
![alt text](image-99.png)

> ä½†æ˜¯ï¼Œé—®é¢˜å‡ºåœ¨**åˆ é™¤ç¼“å­˜æ“ä½œå¤±æ•ˆäº†**ï¼Œä»ç„¶ä¼šå¯¼è‡´ç”¨æˆ·æŸ¥è¯¢åˆ°æ›´æ–°çš„æ—¶é—´å»¶ç¼“ï¼Œå¯¼è‡´ç”¨æˆ·ä½“éªŒä¸‹é™
> äºŽæ˜¯åŠ å…¥é‡è¯•æœºåˆ¶ï¼Œå½“åˆ é™¤å¤±è´¥æ—¶ï¼Œå†æ¬¡æ‰§è¡Œåˆ é™¤ï¼Œå¦‚æžœé‡è¯•è¶…è¿‡ä¸€å®šæ¬¡æ•°ï¼Œåˆ™å‘ä¸šåŠ¡å±‚æŠ¥é”™ã€‚


# lua & äº‹åŠ¡
## lua & äº‹åŠ¡ çš„åŒºåˆ«
å¾ˆå¥½ç†è§£çš„é—®é¢˜ï¼Œæˆ‘ä»¬æ¥é€šä¿—åœ°è®²è®²ï¼š

---

### ðŸŒŸ ä»€ä¹ˆæ˜¯ Lua è„šæœ¬ï¼Ÿ

Redis æ”¯æŒé€šè¿‡å†…ç½®çš„ **Lua è„šæœ¬** æ¥æ‰§è¡Œä¸€æ®µåŽŸå­æ“ä½œã€‚ç®€å•è¯´ï¼Œå°±æ˜¯ä½ å¯ä»¥æŠŠä¸€å † Redis å‘½ä»¤å†™æˆä¸€ä¸ª Lua è„šæœ¬ï¼Œä¸€æ¬¡æ€§å‘ç»™ Redis æœåŠ¡å™¨æ‰§è¡Œã€‚

- æ‰§è¡Œæ˜¯ **åŽŸå­çš„**ï¼šRedis ä¼šä¸€æ¬¡æ€§æ‰§è¡Œæ•´æ®µè„šæœ¬ï¼ŒæœŸé—´ä¸ä¼šè¢«å…¶ä»–å‘½ä»¤æ‰“æ–­ã€‚
- ä½¿ç”¨ `EVAL` æˆ– `EVALSHA` å‘½ä»¤è¿è¡Œè„šæœ¬ã€‚

**ä¸¾ä¸ªä¾‹å­ï¼š**
```lua
-- æ£€æŸ¥é”®æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æžœå­˜åœ¨å°±è¿”å›žå€¼ï¼Œå¦åˆ™è®¾ç½®é»˜è®¤å€¼
local val = redis.call('GET', KEYS[1])
if not val then
    redis.call('SET', KEYS[1], ARGV[1])
    return ARGV[1]
end
return val
```
è¿™æ®µè„šæœ¬çš„æ„æ€æ˜¯ï¼š**åªæœ‰åœ¨ key ä¸å­˜åœ¨çš„æ—¶å€™ï¼Œæ‰åŽ»è®¾ç½®å®ƒçš„å€¼ã€‚**  
è¿™ä¸ªé€»è¾‘ç”¨å¤šä¸ªå‘½ä»¤å®žçŽ°å®¹æ˜“æœ‰å¹¶å‘é—®é¢˜ï¼Œä½† Lua è„šæœ¬ä¸­æ˜¯**ä¸€æ¬¡æ€§æ‰§è¡Œ**çš„ã€‚

---

### ðŸ”„ é‚£å’Œ Redis äº‹åŠ¡ï¼ˆMULTI/EXECï¼‰æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

| å¯¹æ¯”é¡¹         | Lua è„šæœ¬                                | Redis äº‹åŠ¡ï¼ˆMULTI/EXECï¼‰                  |
|----------------|-----------------------------------------|-------------------------------------------|
| åŽŸå­æ€§         | **å®Œå…¨åŽŸå­æ‰§è¡Œ**                        | å‘½ä»¤é˜Ÿåˆ—æäº¤åŽæ‰æ‰§è¡Œï¼Œ**æ‰§è¡Œæ˜¯åŽŸå­çš„** |
| äº‹åŠ¡å¤±è´¥å¤„ç†   | ä¸€å‡ºé”™æ•´ä¸ªè„šæœ¬å¤±è´¥                      | æŸæ¡å‘½ä»¤å¤±è´¥ä¸ä¼šè‡ªåŠ¨å›žæ»š                 |
| å¹¶å‘æŽ§åˆ¶       | æ— éœ€ WATCHï¼Œå¯å¤©ç„¶é˜²æ­¢å¹¶å‘å†²çª          | éœ€æ­é… `WATCH` å®žçŽ°ä¹è§‚é”                |
| çµæ´»æ€§         | æ”¯æŒæ¡ä»¶åˆ¤æ–­ï¼ˆå¦‚ `if`, `for`ï¼‰ç­‰é€»è¾‘    | åªèƒ½ä¸²è¡Œå‘å‘½ä»¤ï¼Œ**ä¸æ”¯æŒæ¡ä»¶æŽ§åˆ¶æµ**     |
| æ€§èƒ½           | åªéœ€ä¸€æ¬¡ç½‘ç»œäº¤äº’                        | å¤šæ¬¡å‘½ä»¤ + ä¸€æ¬¡æäº¤ï¼ˆæ›´å¤šç½‘ç»œäº¤äº’ï¼‰       |
| ä½¿ç”¨åœºæ™¯       | å¤æ‚é€»è¾‘ã€å¸¦åˆ¤æ–­/å¾ªçŽ¯ã€å¼ºä¸€è‡´æ€§         | ç®€å•å‘½ä»¤æ‰¹é‡æäº¤                          |

---

### âœ… æ€»ç»“ä¸€å¥è¯ï¼š

> **Lua è„šæœ¬ = å¸¦é€»è¾‘åˆ¤æ–­çš„ã€ä¸€æ¬¡æ€§ã€åŽŸå­æ€§çš„å¤šå‘½ä»¤æ“ä½œï¼Œæ˜¯æ›´å¼ºå¤§çš„äº‹åŠ¡æ›¿ä»£å“ã€‚**

---

### ðŸ”§ å®žé™…åº”ç”¨åœºæ™¯

- åŽŸå­æ‰£å‡åº“å­˜ã€é™æµè®¡æ•°
- åˆ†å¸ƒå¼é”çš„å®‰å…¨é‡Šæ”¾
- é˜²æ­¢ç¼“å­˜å‡»ç©¿ï¼ˆåŒæŸ¥æœºåˆ¶å°è£…æˆ Lua è„šæœ¬ï¼‰
- å¤š Key çš„æ‰¹é‡è®¾ç½®/åˆ¤æ–­æ“ä½œ

---

å¦‚æžœä½ ç”¨äº‹åŠ¡å¤„ç†ä¸€äº›éœ€è¦å¼ºä¸€è‡´å’Œå¹¶å‘æŽ§åˆ¶çš„é€»è¾‘ï¼Œå¾ˆå®¹æ˜“ä¼šå†™å¾—éº»çƒ¦è€Œä¸”ä¸ç¨³ï¼Œè¿™æ—¶å€™ç”¨ Lua è„šæœ¬å°±èƒ½å†™å¾—åˆç®€æ´åˆå®‰å…¨ã€‚

ä½ æœ‰æ²¡æœ‰æŸä¸ªå…·ä½“çš„ä¸šåŠ¡åœºæ™¯ï¼Œæˆ‘ä»¬å¯ä»¥è¯•ç€å†™ä¸ª Lua æ¥æ¼”ç¤ºï¼Ÿ


## ä¸ºä»€ä¹ˆåˆ†å¸ƒå¼é”ä½¿ç”¨luaè€Œä¸æ˜¯äº‹åŠ¡
è¿™ä¸ªé—®é¢˜éžå¸¸å…³é”®ï¼Œå¾ˆå¤šäººä»¥ä¸º Redis æœ‰äº†äº‹åŠ¡ï¼ˆ`MULTI/EXEC`ï¼‰å°±å¯ä»¥å®žçŽ°åŽŸå­æ€§æ“ä½œï¼Œä½†å…¶å®ž **åœ¨åˆ†å¸ƒå¼é”åœºæ™¯ä¸­ï¼ŒLua è„šæœ¬æ‰æ˜¯çœŸæ­£çš„çŽ‹è€…**ã€‚æˆ‘ä»¬æ¥é€šä¿—åˆé€å½»åœ°è§£é‡Šä¸€ä¸‹â€”â€”

---

### ðŸŽ¯ ç»“è®ºå…ˆè¡Œï¼š

> **å› ä¸º Lua è„šæœ¬åœ¨ Redis ä¸­æ˜¯åŽŸå­æ‰§è¡Œçš„ï¼Œè€Œäº‹åŠ¡ï¼ˆ`MULTI/EXEC`ï¼‰ä¸æ˜¯åŽŸå­æ“ä½œï¼Œä¹Ÿä¸èƒ½ä¸­é—´åˆ¤æ–­æ¡ä»¶ã€‚**

---

### ðŸ” ä¸ºä»€ä¹ˆäº‹åŠ¡ä¸é€‚åˆåˆ†å¸ƒå¼é”ï¼Ÿ

Redis çš„äº‹åŠ¡æ˜¯è¿™æ ·çš„ï¼š

```bash
WATCH key
MULTI
SET key value EX 30 NX
EXEC
```

çœ‹èµ·æ¥å¥½åƒæ˜¯â€œå…ˆç›‘è§†ï¼Œå†åŠ é”â€ï¼Œä½†å®ƒçš„é—®é¢˜æœ‰å‡ ä¸ªè‡´å‘½ç‚¹ï¼š

#### âŒ 1. å¤šæ­¥å‘½ä»¤ï¼Œä¸æ˜¯åŽŸå­æ“ä½œ

- `WATCH`ã€`MULTI`ã€`SET`ã€`EXEC` æ˜¯**å¤šä¸ªå‘½ä»¤**
- è¿™äº›å‘½ä»¤æ˜¯**åˆ†å¼€å‘é€çš„**ï¼Œä¸­é—´å¯èƒ½è¢«å…¶ä»–å®¢æˆ·ç«¯æ’é˜Ÿ
- æ¯”å¦‚ä½  WATCH ä¹‹åŽï¼Œè¿˜æ²¡æ¥å¾—åŠ SETï¼Œå¦ä¸€ä¸ªå®¢æˆ·ç«¯å·²ç»æ”¹äº† keyï¼Œä½ çš„äº‹åŠ¡å°±ä¼šå¤±è´¥

è€Œ Lua è„šæœ¬ï¼š
- æ‰€æœ‰å‘½ä»¤æ˜¯ä¸€æ¬¡æ€§å‘é€ã€ä¸€æ¬¡æ€§æ‰§è¡Œçš„
- **åŽŸå­æ€§å¼ºï¼Œè¿‡ç¨‹ä¸å¯ä¸­æ–­**

---

#### âŒ 2. äº‹åŠ¡ä¸­ä¸èƒ½åšæ¡ä»¶åˆ¤æ–­ï¼ˆä¾‹å¦‚åˆ¤æ–­é”æ˜¯å¦ä¸ºè‡ªå·±æŒæœ‰ï¼‰

ä¸¾ä¸ªä¾‹å­ï¼šä½ é‡Šæ”¾é”çš„æ—¶å€™è¦åˆ¤æ–­æ˜¯ä¸æ˜¯ä½ åŠ çš„è¿™æŠŠé”ï¼š

```lua
-- Lua è„šæœ¬å¯ä»¥è¿™ä¹ˆå†™ï¼š
if redis.call("get", KEYS[1]) == ARGV[1] then
    return redis.call("del", KEYS[1])
else
    return 0
end
```

ä½ è¦åœ¨äº‹åŠ¡é‡Œè¿™æ ·å†™å°±ä¸è¡Œï¼Œå› ä¸º Redis çš„äº‹åŠ¡åªæ˜¯â€œå‘½ä»¤é˜Ÿåˆ—â€ï¼Œä¸èƒ½åœ¨é˜Ÿåˆ—é‡Œåšåˆ¤æ–­ã€‚

---

### âœ… Lua è„šæœ¬çš„ä¼˜åŠ¿

| ç‰¹æ€§               | Lua è„šæœ¬ | MULTI/EXEC |
|--------------------|----------|------------|
| åŽŸå­æ€§              | âœ… åŽŸå­   | âŒ éžåŽŸå­   |
| æ¡ä»¶åˆ¤æ–­            | âœ… æ”¯æŒ   | âŒ ä¸æ”¯æŒ   |
| ä¸€æ¬¡æ€§æ‰§è¡Œ          | âœ… æ˜¯     | âŒ åˆ†æ­¥æ‰§è¡Œ |
| é˜²æ­¢å¹¶å‘ç«žäº‰        | âœ… å¥½     | âŒ å¯èƒ½å¤±è´¥ |

---

### ðŸ§  ä¸¾ä¸ªåˆ†å¸ƒå¼é”å¸¸è§æ“ä½œçš„ä¾‹å­

#### âœ… åŠ é”ï¼ˆå¸¦è¿‡æœŸæ—¶é—´ + åŽŸå­æ€§ï¼‰ï¼š

```lua
-- å¦‚æžœ key ä¸å­˜åœ¨ï¼Œè®¾ç½®å€¼å¹¶è®¾ç½®è¿‡æœŸæ—¶é—´
if redis.call("SETNX", KEYS[1], ARGV[1]) == 1 then
    redis.call("PEXPIRE", KEYS[1], ARGV[2])
    return 1
else
    return 0
end
```

ä½ ç”¨äº‹åŠ¡æ ¹æœ¬æ²¡æ³•åšåˆ°è¿™ä¸€ç‚¹ï¼š**åˆ¤æ–­æ˜¯å¦æˆåŠŸ + è®¾ç½®è¿‡æœŸæ—¶é—´å¿…é¡»æ˜¯åŽŸå­çš„**ï¼Œå¦åˆ™æœ‰ç«žæ€æ¡ä»¶ã€‚

---

#### âœ… é‡Šæ”¾é”ï¼ˆç¡®ä¿åªåˆ é™¤è‡ªå·±åŠ çš„é”ï¼‰ï¼š

```lua
if redis.call("GET", KEYS[1]) == ARGV[1] then
    return redis.call("DEL", KEYS[1])
else
    return 0
end
```

---

### ðŸš« å¦‚æžœä½ ä¸ç”¨ Luaï¼Œé£Žé™©æ˜¯ä»€ä¹ˆï¼Ÿ

1. å¯èƒ½åœ¨ SET åŽï¼Œæ¥ä¸åŠ EXPIREï¼Œå°±å®•æœº â†’ é”æ°¸ä¸é‡Šæ”¾ï¼ˆæ­»é”ï¼‰
2. åˆ é™¤é”æ—¶æ²¡åˆ¤æ–­å½’å±žï¼Œå¯èƒ½æŠŠåˆ«äººçš„é”åˆ æŽ‰
3. å¹¶å‘æ“ä½œä¸­æ–­äº‹åŠ¡ï¼ŒEXEC å¤±è´¥ï¼Œä½†ä½ ä¸çŸ¥é“æ˜¯å¦éƒ¨åˆ†æ‰§è¡Œäº†ï¼ˆä¸å¯é ï¼‰

---

### âœ… æ‰€ä»¥æ€»ç»“ä¸€å¥è¯ï¼š

> åˆ†å¸ƒå¼é”ç”¨ Lua è„šæœ¬ï¼Œæ˜¯å› ä¸ºå®ƒ**çœŸæ­£æ”¯æŒåŽŸå­æ€§æ“ä½œå’Œæ¡ä»¶åˆ¤æ–­**ï¼Œæ¯” Redis çš„äº‹åŠ¡æœºåˆ¶æ›´åŠ å¯é ï¼Œæ˜¯ Redis å®˜æ–¹æŽ¨èçš„æ ‡å‡†æ–¹å¼ã€‚

---

å¦‚æžœä½ æƒ³ï¼Œæˆ‘å¯ä»¥ç›´æŽ¥å¸®ä½ å†™ä¸€ä¸ªæ ‡å‡†çš„ Lua è„šæœ¬å®žçŽ°çš„åŠ é” + è§£é”é€»è¾‘ï¼Œè¿˜èƒ½æ”¯æŒç»­æœŸã€å¤±è´¥é‡è¯•ï¼Œè¦ä¸è¦æ¥ä¸€ä¸ªå®žæˆ˜ç‰ˆæœ¬ï¼Ÿ



# watchä¹è§‚é”
å¾ˆå¥½ï¼Œè¿™ä¸ªé—®é¢˜æ˜¯ç†è§£ Redis äº‹åŠ¡æœºåˆ¶çš„å…³é”®ã€‚ä¸‹é¢æˆ‘ä»¬æ¥é€šä¿—åˆé€å½»åœ°è§£é‡Šä¸€ä¸‹ `WATCH` çš„ä½œç”¨ã€åŽŸç†ä»¥åŠå®ƒåœ¨äº‹åŠ¡ä¸­çš„æ„ä¹‰ã€‚

---

### ðŸ” ä»€ä¹ˆæ˜¯ `WATCH`ï¼Ÿ

`WATCH` æ˜¯ Redis æä¾›çš„ä¸€ä¸ª **ä¹è§‚é”æœºåˆ¶**ï¼Œç”¨äºŽ**ç›‘è§†ä¸€ä¸ªæˆ–å¤šä¸ªé”®**çš„å€¼æ˜¯å¦åœ¨äº‹åŠ¡æ‰§è¡Œå‰è¢«å…¶ä»–å®¢æˆ·ç«¯ä¿®æ”¹ã€‚

> ä¸€å¥è¯è§£é‡Šï¼š`WATCH` å¯ä»¥è®©ä½ åœ¨ Redis ä¸­å®žçŽ°ç±»ä¼¼â€œå…ˆè¯»åŽå†™â€çš„ä¹è§‚é”åœºæ™¯ï¼Œé˜²æ­¢å¹¶å‘ä¿®æ”¹æ—¶å‡ºçŽ°æ•°æ®ä¸ä¸€è‡´ã€‚

---

### ðŸ§  å®ƒæ˜¯æ€Žä¹ˆå·¥ä½œçš„ï¼Ÿ

1. **å®¢æˆ·ç«¯ A** æ‰§è¡Œ `WATCH key1`
2. Redis ä¼šç›‘è§† `key1`ï¼Œè®°å½•å½“å‰ç‰ˆæœ¬
3. æŽ¥ç€å®¢æˆ·ç«¯ A æ‰§è¡Œ `MULTI` å¼€å¯äº‹åŠ¡
4. å†æ‰§è¡Œäº‹åŠ¡ä¸­ä¸€ç³»åˆ—å‘½ä»¤ï¼ˆè¿™äº›å‘½ä»¤å…ˆå…¥é˜Ÿï¼Œä¸æ‰§è¡Œï¼‰
5. æœ€åŽæ‰§è¡Œ `EXEC` æäº¤äº‹åŠ¡ï¼š

   - å¦‚æžœ **äº‹åŠ¡æäº¤å‰ `key1` æ²¡æœ‰è¢«åˆ«çš„å®¢æˆ·ç«¯æ”¹åŠ¨è¿‡**ï¼Œé‚£ä¹ˆäº‹åŠ¡æ­£å¸¸æ‰§è¡Œã€‚
   - å¦‚æžœ **äº‹åŠ¡æäº¤å‰ `key1` è¢«åˆ«çš„å®¢æˆ·ç«¯ä¿®æ”¹äº†**ï¼Œ`EXEC` ä¼šè¿”å›ž `nil`ï¼Œè¡¨ç¤ºäº‹åŠ¡å¤±è´¥ï¼Œ**ä¸ä¼šæ‰§è¡Œäº‹åŠ¡é‡Œçš„ä»»ä½•å‘½ä»¤**ã€‚

---

### ðŸ“¦ ä¸¾ä¸ªé€šä¿—ä¾‹å­

æ¯”å¦‚ä½ æƒ³å®žçŽ°ä¸€ä¸ªä½™é¢æ‰£æ¬¾æ“ä½œï¼š

```shell
WATCH user:balance
balance = GET user:balance
if balance >= 100:
    MULTI
    DECRBY user:balance 100
    EXEC
else:
    UNWATCH
```

è¿™ä¸ªè¿‡ç¨‹ç›¸å½“äºŽä½ è¿™æ ·æ€è€ƒé€»è¾‘ï¼š

> â€œæˆ‘å…ˆçœ‹çœ‹ä½ è¿˜æœ‰å¤šå°‘é’±ï¼Œæˆ‘å¦‚æžœå†³å®šè¦æ‰£é’±ï¼Œè¿™æœŸé—´ä½ ä¸èƒ½å·å·æŠŠé’±æ”¹æŽ‰ï¼Œä¸ç„¶æˆ‘å°±ä¸æ‰£äº†ï¼â€

å¦‚æžœè¿™ä¸ªè¿‡ç¨‹ä¸­æœ‰å…¶ä»–å®¢æˆ·ç«¯ä¿®æ”¹äº† `user:balance`ï¼Œäº‹åŠ¡å°±ä¼šè‡ªåŠ¨å¤±è´¥ï¼Œé¿å…é”™è¯¯æ‰£æ¬¾ã€‚

---

### âœ… ä¸ºä»€ä¹ˆè¦åœ¨äº‹åŠ¡ä¸­ä½¿ç”¨ `WATCH`ï¼Ÿ

å› ä¸º Redis çš„äº‹åŠ¡ï¼ˆ`MULTI/EXEC`ï¼‰å¹¶**ä¸æ˜¯ä¼ ç»Ÿæ„ä¹‰ä¸Šçš„äº‹åŠ¡**ï¼Œå®ƒå¹¶ä¸æä¾›ï¼š

- è‡ªåŠ¨å›žæ»šæœºåˆ¶
- å¹¶å‘å†²çªæ£€æµ‹

æ‰€ä»¥ä¸ºäº†ä¿éšœäº‹åŠ¡æ‰§è¡Œçš„å®‰å…¨æ€§ã€æ­£ç¡®æ€§ï¼ŒRedis æä¾›äº† `WATCH` æœºåˆ¶æ¥è®©ä½ æ‰‹åŠ¨æŽ§åˆ¶å¹¶å‘å†²çªçš„å¤„ç†ã€‚

---

### ðŸ” `WATCH` æ˜¯â€œä¹è§‚é”â€ï¼Œé‚£å’Œâ€œæ‚²è§‚é”â€åŒºåˆ«æ˜¯ï¼Ÿ

| ç±»åž‹     | å«ä¹‰                            | Redis ä¸­è¡¨çŽ°       |
|----------|---------------------------------|--------------------|
| ä¹è§‚é”   | å‡è®¾å†²çªå°‘ï¼Œå…ˆæ‰§è¡Œæ“ä½œå†æ ¡éªŒ    | `WATCH + EXEC`     |
| æ‚²è§‚é”   | å‡è®¾å†²çªå¤šï¼Œæ‰§è¡Œå‰å°±ä¸Šé”é˜»å¡žæ“ä½œ | Redis ä¸æ”¯æŒåŽŸç”Ÿæ‚²è§‚é”ï¼Œåªèƒ½æ¨¡æ‹Ÿ |

---

### ðŸ”“ å¦‚æžœä½ ä¸ä½¿ç”¨ `WATCH` ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ

ä½ å°±ä¸èƒ½ä¿è¯åœ¨è¯»å– key å¹¶åŸºäºŽè¿™ä¸ªå€¼åšäº‹åŠ¡æ“ä½œçš„æœŸé—´ï¼Œè¿™ä¸ªå€¼æ²¡æœ‰è¢«åˆ«äººæ”¹åŠ¨â€”â€”å¯èƒ½ä¼šå¯¼è‡´**å¹¶å‘å®‰å…¨é—®é¢˜**ï¼Œæ¯”å¦‚ï¼š

- å¤šä¸ªå®¢æˆ·ç«¯åŒæ—¶æ‰£æ¬¾ï¼Œç»“æžœæ‰£äº†ä¸¤æ¬¡ï¼›
- ä¸¤ä¸ªå®¢æˆ·ç«¯åŒæ—¶æ›´æ–°ç›¸åŒæ•°æ®ï¼Œæœ€åŽè¦†ç›–äº†å½¼æ­¤çš„ä¿®æ”¹ã€‚

---

### ðŸ§  å°æ€»ç»“ä¸€å¥è¯ï¼š

> `WATCH` æ˜¯ Redis æä¾›çš„ä¹è§‚é”æœºåˆ¶ï¼Œ**ç”¨äºŽåœ¨äº‹åŠ¡å‰ç›‘æŽ§å…³é”®æ•°æ®æ˜¯å¦è¢«å…¶ä»–å®¢æˆ·ç«¯ä¿®æ”¹è¿‡**ï¼Œä¿è¯äº‹åŠ¡çš„å¯é æ€§å’Œä¸€è‡´æ€§ã€‚

---

å¦‚æžœä½ æœ‰ç‰¹å®šçš„ä¸šåŠ¡åœºæ™¯ï¼Œæˆ‘ä¹Ÿå¯ä»¥å¸®ä½ æ¨¡æ‹Ÿä¸€ä¸‹åŠ  `WATCH` å’Œä¸åŠ  `WATCH` çš„åŒºåˆ«ï¼Œæœ‰æ—¶å€™ä¸€çœ‹å°±æ‡‚äº†~è¦ä¸è¦æ¥ä¸€ä¸ªï¼Ÿ


# åˆ†å¸ƒå¼é”
redisåˆ†å¸ƒå¼é”setnx
### **ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼é”ï¼Ÿ**
**åˆ†å¸ƒå¼é”** æ˜¯ä¸€ç§ç¡®ä¿åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼ŒåŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªå®¢æˆ·ç«¯èƒ½å¤Ÿè®¿é—®æŸä¸ªèµ„æºæˆ–æ‰§è¡ŒæŸä¸ªæ“ä½œçš„æœºåˆ¶ã€‚å®ƒçš„ç›®çš„æ˜¯åœ¨åˆ†å¸ƒå¼çŽ¯å¢ƒä¸‹æŽ§åˆ¶å¹¶å‘è®¿é—®å…±äº«èµ„æºï¼Œé˜²æ­¢ç«žäº‰æ¡ä»¶å’Œæ•°æ®ä¸ä¸€è‡´ã€‚

åœ¨å•æœºçŽ¯å¢ƒä¸­ï¼Œé€šå¸¸ä½¿ç”¨æ“ä½œç³»ç»Ÿæä¾›çš„é”ï¼ˆå¦‚äº’æ–¥é” `mutex`ï¼‰æ¥ä¿è¯çº¿ç¨‹ä¹‹é—´çš„äº’æ–¥ã€‚ä½†åœ¨åˆ†å¸ƒå¼çŽ¯å¢ƒä¸­ï¼Œç”±äºŽå„ä¸ªæœåŠ¡æˆ–èŠ‚ç‚¹å¯èƒ½è¿è¡Œåœ¨ä¸åŒçš„æœºå™¨ä¸Šï¼Œä¼ ç»Ÿçš„é”æ— æ³•ç›´æŽ¥ä½¿ç”¨ï¼Œå› æ­¤éœ€è¦ä¸€ç§è·¨å¤šå°æœºå™¨çš„é”æœºåˆ¶æ¥ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§å’Œèµ„æºçš„ç‹¬å è®¿é—®ã€‚

### **åˆ†å¸ƒå¼é”çš„åº”ç”¨åœºæ™¯**
åˆ†å¸ƒå¼é”å¹¿æ³›åº”ç”¨äºŽéœ€è¦æŽ§åˆ¶å¹¶å‘å’Œä¿è¯æ•°æ®ä¸€è‡´æ€§çš„åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§çš„åº”ç”¨åœºæ™¯ï¼š

#### 1. **é˜²æ­¢æ•°æ®é‡å¤å¤„ç†**
   - **ä¾‹å¦‚ï¼š** ç”¨æˆ·æ”¯ä»˜ã€è®¢å•åˆ›å»ºç­‰åœºæ™¯ã€‚åœ¨ä¸€ä¸ªè®¢å•ç³»ç»Ÿä¸­ï¼Œå¤šä¸ªå®¢æˆ·ç«¯å¯èƒ½ä¼šåŒæ—¶è¯·æ±‚åˆ›å»ºç›¸åŒçš„è®¢å•ï¼Œä½¿ç”¨åˆ†å¸ƒå¼é”å¯ä»¥ç¡®ä¿åœ¨å¤šä¸ªè¯·æ±‚ä¸­ï¼Œåªæœ‰ä¸€ä¸ªè¯·æ±‚èƒ½å¤ŸæˆåŠŸåˆ›å»ºè®¢å•ï¼Œé˜²æ­¢é‡å¤æ”¯ä»˜æˆ–è®¢å•åˆ›å»ºã€‚

#### 2. **é™æµæŽ§åˆ¶**
   - **ä¾‹å¦‚ï¼š** åœ¨é«˜å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œå¯èƒ½éœ€è¦å¯¹æŽ¥å£è¿›è¡Œé™æµï¼ˆæ¯”å¦‚ç”µå•†ç§’æ€æ´»åŠ¨ï¼‰ï¼Œç¡®ä¿ç³»ç»Ÿä¸ä¼šè¢«çž¬é—´å¤§é‡è¯·æ±‚åŽ‹åž®ã€‚åˆ†å¸ƒå¼é”å¯ä»¥å¸®åŠ©æŽ§åˆ¶é™æµçš„é€»è¾‘ï¼Œé˜²æ­¢å¤šä¸ªå®žä¾‹åŒæ—¶è¿›è¡Œç›¸åŒçš„é™æµæ“ä½œã€‚

#### 3. **èµ„æºç‹¬å **
   - **ä¾‹å¦‚ï¼š** æŸäº›èµ„æºï¼ˆæ¯”å¦‚æ‰“å°æœºã€APIæŽ¥å£ç­‰ï¼‰éœ€è¦å¤šä¸ªå®¢æˆ·ç«¯äº’æ–¥è®¿é—®ï¼Œå¯ä»¥é€šè¿‡åˆ†å¸ƒå¼é”ç¡®ä¿èµ„æºçš„ç‹¬å ä½¿ç”¨ã€‚

#### 4. **ä»»åŠ¡è°ƒåº¦**
   - **ä¾‹å¦‚ï¼š** åœ¨åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦ç³»ç»Ÿä¸­ï¼Œåˆ†å¸ƒå¼é”å¯ä»¥ç¡®ä¿æŸä¸ªä»»åŠ¡ä¸ä¼šè¢«å¤šä¸ªèŠ‚ç‚¹åŒæ—¶æ‰§è¡Œã€‚æ¯”å¦‚ï¼Œæ‰¹å¤„ç†ä»»åŠ¡ã€å®šæ—¶ä»»åŠ¡ç­‰ï¼Œåªèƒ½ç”±ä¸€ä¸ªèŠ‚ç‚¹æ‰§è¡Œï¼Œé¿å…é‡å¤æ‰§è¡Œã€‚

#### 5. **æŽ§åˆ¶å…±äº«çŠ¶æ€**
   - **ä¾‹å¦‚ï¼š** åœ¨åˆ†å¸ƒå¼ç¼“å­˜ä¸­ï¼Œå¤šä¸ªèŠ‚ç‚¹å¯èƒ½ä¼šè®¿é—®æˆ–æ›´æ–°åŒä¸€ä»½å…±äº«æ•°æ®ï¼Œåˆ†å¸ƒå¼é”å¯ä»¥é¿å…åœ¨å¹¶å‘æƒ…å†µä¸‹å‘ç”Ÿæ•°æ®ç«žæ€ã€‚

### **åˆ†å¸ƒå¼é”çš„å®žçŽ°æ–¹æ³•**

åˆ†å¸ƒå¼é”çš„å®žçŽ°éœ€è¦ä¿è¯ä»¥ä¸‹å‡ ä¸ªå…³é”®ç‰¹ç‚¹ï¼š
- **äº’æ–¥æ€§**ï¼šåœ¨åŒä¸€æ—¶åˆ»ï¼Œåªå…è®¸ä¸€ä¸ªå®¢æˆ·ç«¯æŒæœ‰é”ï¼Œå…¶ä»–å®¢æˆ·ç«¯æ— æ³•èŽ·å–ã€‚
- **å¯é æ€§**ï¼šåœ¨å‡ºçŽ°æ•…éšœçš„æƒ…å†µä¸‹ï¼Œé”èƒ½å¤Ÿæ­£ç¡®é‡Šæ”¾ï¼Œé¿å…æ­»é”ã€‚
- **é«˜å¯ç”¨æ€§**ï¼šåˆ†å¸ƒå¼é”å¿…é¡»ä¿è¯åœ¨ç½‘ç»œæˆ–èŠ‚ç‚¹æ•…éšœçš„æƒ…å†µä¸‹ä»ç„¶èƒ½å¤Ÿä¿æŒç³»ç»Ÿçš„ç¨³å®šè¿è¡Œã€‚

#### 1. **åŸºäºŽ Redis å®žçŽ°åˆ†å¸ƒå¼é”**
Redis æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„å†…å­˜æ•°æ®åº“ï¼Œé€šå¸¸ç”¨äºŽå®žçŽ°åˆ†å¸ƒå¼é”ã€‚å¸¸ç”¨çš„ Redis åˆ†å¸ƒå¼é”å®žçŽ°æ–¹æ³•æ˜¯é€šè¿‡ `SETNX` å‘½ä»¤ï¼ˆSET if Not eXistsï¼‰å’Œ `EXPIRE` å‘½ä»¤æ¥ç¡®ä¿é”çš„åŽŸå­æ€§å’Œè‡ªåŠ¨è¿‡æœŸã€‚

##### **å®žçŽ°æ­¥éª¤ï¼š**
1. **å°è¯•èŽ·å–é”**ï¼šä½¿ç”¨ `SETNX` å‘½ä»¤å°è¯•åˆ›å»ºä¸€ä¸ªç‰¹å®šçš„é”é”®ï¼ˆ`lock_key`ï¼‰ã€‚
   ```bash
   SETNX lock_key "locked_value"
   ```
   - å¦‚æžœ `lock_key` ä¸å­˜åœ¨ï¼Œè¿”å›ž 1ï¼ˆæˆåŠŸèŽ·å–é”ï¼‰ï¼Œå¹¶è®¾ç½®è¯¥é”®çš„å€¼ã€‚
   - å¦‚æžœ `lock_key` å·²å­˜åœ¨ï¼Œè¿”å›ž 0ï¼ˆé”è¢«å…¶ä»–å®¢æˆ·ç«¯æŒæœ‰ï¼‰ã€‚

2. **è®¾ç½®è¿‡æœŸæ—¶é—´**ï¼šä¸ºäº†é˜²æ­¢æ­»é”ï¼Œè®¾ç½®é”çš„è¿‡æœŸæ—¶é—´ã€‚
   ```bash
   EXPIRE lock_key 10
   ```
   - é”åœ¨ 10 ç§’åŽè‡ªåŠ¨é‡Šæ”¾ï¼Œå³ä½¿å®¢æˆ·ç«¯æ²¡æœ‰æ˜¾å¼é‡Šæ”¾é”ã€‚

3. **é‡Šæ”¾é”**ï¼šé‡Šæ”¾é”æ—¶ï¼Œè¦ç¡®ä¿åªæœ‰æŒæœ‰é”çš„å®¢æˆ·ç«¯æ‰èƒ½é‡Šæ”¾å®ƒã€‚
   ```lua
   if redis.call("GET", KEYS[1]) == ARGV[1] then
       return redis.call("DEL", KEYS[1])
   else
       return 0
   end
   ```
   - å¦‚æžœ `lock_key` çš„å€¼æ˜¯å½“å‰å®¢æˆ·ç«¯çš„ IDï¼ˆ`ARGV[1]`ï¼‰ï¼Œåˆ™åˆ é™¤è¯¥é”®ï¼Œé‡Šæ”¾é”ã€‚

#### 2. **åŸºäºŽ Zookeeper å®žçŽ°åˆ†å¸ƒå¼é”**
Zookeeper æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼åè°ƒå·¥å…·ï¼Œå¯ä»¥é€šè¿‡å®ƒå®žçŽ°åˆ†å¸ƒå¼é”ã€‚Zookeeper é€šè¿‡ **ä¸´æ—¶èŠ‚ç‚¹** å’Œ **æœ‰åºèŠ‚ç‚¹** å®žçŽ°é”çš„æœºåˆ¶ã€‚

##### **å®žçŽ°æ­¥éª¤ï¼š**
1. **åˆ›å»ºä¸´æ—¶æœ‰åºèŠ‚ç‚¹**ï¼šå®¢æˆ·ç«¯åœ¨ Zookeeper ä¸­åˆ›å»ºä¸€ä¸ªæœ‰åºçš„ä¸´æ—¶èŠ‚ç‚¹ï¼ˆå¦‚ `/lock/lock-0001`ï¼‰ã€‚
   - æ¯ä¸ªå®¢æˆ·ç«¯åœ¨ Zookeeper ä¸Šåˆ›å»ºä¸€ä¸ªå”¯ä¸€çš„èŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹åå¸¦æœ‰é€’å¢žçš„åºå·ã€‚

2. **ç›‘å¬å‰ä¸€ä¸ªèŠ‚ç‚¹**ï¼šå®¢æˆ·ç«¯é€šè¿‡ç›‘å¬è¯¥èŠ‚ç‚¹å‰ä¸€ä¸ªæœ‰åºèŠ‚ç‚¹çš„å˜åŒ–æ¥åˆ¤æ–­æ˜¯å¦å¯ä»¥èŽ·å–é”ã€‚
   - å®¢æˆ·ç«¯æ£€æŸ¥å®ƒè‡ªå·±åˆ›å»ºçš„èŠ‚ç‚¹æ˜¯å¦æ˜¯æœ€å°çš„èŠ‚ç‚¹ï¼Œè‹¥æ˜¯ï¼Œåˆ™è¡¨ç¤ºæˆåŠŸèŽ·å–é”ã€‚

3. **èŽ·å–é”**ï¼šå®¢æˆ·ç«¯æˆåŠŸèŽ·å¾—æœ€å°èŠ‚ç‚¹ï¼ˆè¡¨ç¤ºå¯ä»¥è®¿é—®èµ„æºï¼‰ï¼Œå¹¶é€šè¿‡ä¸´æ—¶èŠ‚ç‚¹ç¡®ä¿å®¢æˆ·ç«¯æ–­å¼€è¿žæŽ¥åŽé”ä¼šè‡ªåŠ¨é‡Šæ”¾ã€‚

4. **é‡Šæ”¾é”**ï¼šå®¢æˆ·ç«¯å®Œæˆä»»åŠ¡åŽï¼Œåˆ é™¤å®ƒè‡ªå·±çš„ä¸´æ—¶èŠ‚ç‚¹ï¼Œä»Žè€Œé‡Šæ”¾é”ã€‚

#### 3. **åŸºäºŽæ•°æ®åº“å®žçŽ°åˆ†å¸ƒå¼é”**
å¯ä»¥é€šè¿‡åœ¨æ•°æ®åº“ä¸­ä½¿ç”¨æŸä¸ªå”¯ä¸€çš„æ ‡è¯†ï¼ˆå¦‚æ•°æ®åº“è¡¨ä¸­çš„ä¸€è¡Œï¼‰æ¥å®žçŽ°åˆ†å¸ƒå¼é”ã€‚å¸¸è§åšæ³•æ˜¯é€šè¿‡æ›´æ–°æ•°æ®åº“ä¸­çš„ä¸€è¡Œæ¥è¡¨ç¤ºé”çš„æŒæœ‰ã€‚

##### **å®žçŽ°æ­¥éª¤ï¼š**
1. **å°è¯•èŽ·å–é”**ï¼šåœ¨æ•°æ®åº“ä¸­æ’å…¥ä¸€æ¡è®°å½•ï¼ˆä¾‹å¦‚ï¼š`INSERT INTO locks (lock_key, locked) VALUES ('lock_key', 'locked')`ï¼‰ï¼Œå¦‚æžœæ’å…¥æˆåŠŸï¼Œåˆ™è¡¨ç¤ºèŽ·å–äº†é”ã€‚
2. **è®¾ç½®è¿‡æœŸæ—¶é—´**ï¼šå¯ä»¥é€šè¿‡æ•°æ®åº“çš„è¿‡æœŸæœºåˆ¶æˆ–å®šæœŸåˆ·æ–°æ¥ç¡®ä¿é”åœ¨ä¸€å®šæ—¶é—´åŽé‡Šæ”¾ã€‚
3. **é‡Šæ”¾é”**ï¼šé€šè¿‡åˆ é™¤è®°å½•æˆ–æ›´æ–°è®°å½•æ¥é‡Šæ”¾é”ã€‚

#### 4. **åŸºäºŽ Redisson å®žçŽ°åˆ†å¸ƒå¼é”**
**Redisson** æ˜¯ä¸€ä¸ªåŸºäºŽ Redis çš„åˆ†å¸ƒå¼é”æ¡†æž¶ï¼Œå®ƒå°è£…äº† Redis çš„é”æœºåˆ¶ï¼Œæä¾›äº†æ›´é«˜çº§çš„åŠŸèƒ½ï¼Œä¾‹å¦‚ **é”çš„è‡ªåŠ¨ç»­æœŸ**ã€**å…¬å¹³é”**ã€**å¯é‡å…¥é”** ç­‰ã€‚

##### **å®žçŽ°æ­¥éª¤ï¼š**
1. **åˆ›å»º Redisson å®¢æˆ·ç«¯**ï¼šé€šè¿‡ Redisson æä¾›çš„ API åˆ›å»ºé”ã€‚
2. **èŽ·å–é”**ï¼šé€šè¿‡ Redisson çš„ `RLock` æŽ¥å£æ¥èŽ·å–é”ï¼Œå¹¶ä¸”å¯ä»¥è®¾ç½®é”çš„è¿‡æœŸæ—¶é—´ã€‚
   ```java
   RLock lock = redisson.getLock("lock_key");
   lock.lock(10, TimeUnit.SECONDS);  // é”å®š 10 ç§’
   ```
3. **é‡Šæ”¾é”**ï¼šåœ¨ä»»åŠ¡å®ŒæˆåŽè°ƒç”¨ `unlock()` æ–¹æ³•é‡Šæ”¾é”ã€‚

---

### **æ€»ç»“**
- **åˆ†å¸ƒå¼é”** æ˜¯ç”¨äºŽåˆ†å¸ƒå¼ç³»ç»Ÿä¸­æŽ§åˆ¶èµ„æºå¹¶å‘è®¿é—®çš„ä¸€ç§æœºåˆ¶ï¼Œç¡®ä¿åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªå®¢æˆ·ç«¯èƒ½è®¿é—®æŸä¸ªèµ„æºæˆ–æ‰§è¡ŒæŸä¸ªæ“ä½œã€‚
- **åº”ç”¨åœºæ™¯**ï¼šé˜²æ­¢é‡å¤å¤„ç†ã€é™æµæŽ§åˆ¶ã€èµ„æºç‹¬å ã€ä»»åŠ¡è°ƒåº¦å’ŒæŽ§åˆ¶å…±äº«çŠ¶æ€ç­‰ã€‚
- **å®žçŽ°æ–¹æ³•**ï¼š
  - **Redis**ï¼šé€šè¿‡ `SETNX` + `EXPIRE` å®žçŽ°åˆ†å¸ƒå¼é”ã€‚
  - **Zookeeper**ï¼šé€šè¿‡ä¸´æ—¶æœ‰åºèŠ‚ç‚¹å®žçŽ°åˆ†å¸ƒå¼é”ã€‚
  - **æ•°æ®åº“**ï¼šé€šè¿‡åœ¨æ•°æ®åº“ä¸­æ’å…¥è®°å½•å®žçŽ°é”ã€‚
  - **Redisson**ï¼šåŸºäºŽ Redis çš„åˆ†å¸ƒå¼é”æ¡†æž¶ï¼Œæä¾›æ›´å¤šé«˜çº§åŠŸèƒ½ã€‚ 

åˆ†å¸ƒå¼é”çš„å®žçŽ°éœ€è¦ä¿è¯ **åŽŸå­æ€§ã€å¯é æ€§å’Œé«˜å¯ç”¨æ€§**ï¼Œå¹¶æ ¹æ®å…·ä½“çš„éœ€æ±‚é€‰æ‹©ä¸åŒçš„å®žçŽ°æ–¹æ¡ˆã€‚


# åˆ†å¸ƒå¼é”çš„å®žçŽ°
## luaâ€”â€”setnx & expire
å¥½çš„ï¼Œæˆ‘æ¥ç»™ä½ é€šä¿—åœ°è§£é‡Šä¸€ä¸‹**åˆ†å¸ƒå¼é”**æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚åˆ†å¸ƒå¼é”çš„ç›®æ ‡æ˜¯ä¿è¯åœ¨**åˆ†å¸ƒå¼ç³»ç»Ÿä¸­**ï¼Œå¤šä¸ªæœåŠ¡èŠ‚ç‚¹ä¹‹é—´**å¯¹å…±äº«èµ„æº**çš„è®¿é—®æ˜¯äº’æ–¥çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåªæœ‰ä¸€ä¸ªæœåŠ¡å¯ä»¥åœ¨æŸä¸€æ—¶åˆ»è®¿é—®èµ„æºï¼Œå…¶ä»–æœåŠ¡å¿…é¡»ç­‰å¾…ã€‚

### 1. **ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼é”ï¼Ÿ**

åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œé€šå¸¸æœ‰å¤šä¸ªæœåŠ¡å™¨åœ¨åŒæ—¶è¿è¡Œï¼Œå®ƒä»¬å…±äº«ä¸€äº›èµ„æºï¼ˆæ¯”å¦‚æ•°æ®åº“ã€ç¼“å­˜ã€æ–‡ä»¶ç­‰ï¼‰ã€‚å½“å¤šä¸ªèŠ‚ç‚¹åŒæ—¶è¯·æ±‚ä¸€ä¸ªå…±äº«èµ„æºæ—¶ï¼Œå¦‚æžœæ²¡æœ‰æŽ§åˆ¶è®¿é—®ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ã€è„æ•°æ®æˆ–èµ„æºå†²çªçš„æƒ…å†µã€‚

åˆ†å¸ƒå¼é”çš„ä½œç”¨å°±æ˜¯æŽ§åˆ¶è¿™äº›èŠ‚ç‚¹å¯¹å…±äº«èµ„æºçš„è®¿é—®ï¼Œä½¿å¾—æ¯æ¬¡åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹èƒ½å¤Ÿè®¿é—®è¯¥èµ„æºã€‚

---

### 2. **åˆ†å¸ƒå¼é”çš„å®žçŽ°æ–¹æ³•**

åˆ†å¸ƒå¼é”æœ‰å¤šç§å®žçŽ°æ–¹å¼ï¼Œæœ€å¸¸è§çš„æ–¹å¼æ˜¯é€šè¿‡ Redis æ¥å®žçŽ°ã€‚Redis æ˜¯ä¸€ä¸ªé«˜æ•ˆçš„å†…å­˜æ•°æ®åº“ï¼Œæ”¯æŒé«˜å¹¶å‘çš„æ“ä½œï¼Œéžå¸¸é€‚åˆç”¨æ¥å®žçŽ°åˆ†å¸ƒå¼é”ã€‚è¿™é‡Œä»¥ Redis ä¸ºä¾‹ï¼Œè®²è§£å®ƒæ˜¯å¦‚ä½•å®žçŽ°åˆ†å¸ƒå¼é”çš„ã€‚

#### 2.1 **åŸºäºŽ Redis çš„åˆ†å¸ƒå¼é”ï¼ˆSETNX å‘½ä»¤ï¼‰**

Redis æä¾›äº†ä¸€ä¸ªéžå¸¸ç®€å•çš„å‘½ä»¤ `SETNX`ï¼ˆSET if Not Existsï¼‰ï¼Œå®ƒç”¨äºŽè®¾ç½®ä¸€ä¸ªé”®ï¼ˆkeyï¼‰çš„å€¼ï¼Œåªæœ‰å½“è¿™ä¸ªé”®ä¸å­˜åœ¨æ—¶æ‰èƒ½æˆåŠŸã€‚åŸºäºŽè¿™ä¸ªå‘½ä»¤ï¼Œæˆ‘ä»¬å¯ä»¥å®žçŽ°ä¸€ä¸ªåˆ†å¸ƒå¼é”ã€‚

**åŸºæœ¬åŽŸç†ï¼š**
1. **å°è¯•èŽ·å–é”**ï¼š
   - æ¯ä¸ªè¯·æ±‚éƒ½ä¼šå°è¯•é€šè¿‡ Redis è®¾ç½®ä¸€ä¸ªå”¯ä¸€çš„é”é”®ï¼ˆä¾‹å¦‚ `lock:user123`ï¼‰ã€‚
   - è¿™ä¸ªé”é”®çš„å€¼å¯ä»¥æ˜¯ä¸€ä¸ª**å”¯ä¸€æ ‡è¯†ç¬¦**ï¼Œæ¯”å¦‚å½“å‰èŠ‚ç‚¹çš„ `UUID` æˆ–è€…å½“å‰æ—¶é—´æˆ³ç­‰ã€‚

2. **æˆåŠŸèŽ·å–é”**ï¼š
   - å¦‚æžœ `SETNX` è¿”å›žæˆåŠŸï¼Œè¯´æ˜Žæ²¡æœ‰å…¶ä»–èŠ‚ç‚¹èŽ·å–é”ï¼Œè¿™æ—¶å½“å‰èŠ‚ç‚¹æˆåŠŸèŽ·å–äº†é”ï¼Œå¯ä»¥è®¿é—®å…±äº«èµ„æºã€‚
   
3. **é”çš„é‡Šæ”¾**ï¼š
   - è®¿é—®å®Œå…±äº«èµ„æºåŽï¼Œå½“å‰èŠ‚ç‚¹ä¼šåˆ é™¤ Redis ä¸­çš„é”é”®ï¼Œä»Žè€Œé‡Šæ”¾é”ã€‚
   - å¦‚æžœé”æ²¡æœ‰é‡Šæ”¾ï¼Œå…¶ä»–èŠ‚ç‚¹å°±æ— æ³•èŽ·å¾—é”ã€‚

4. **é”çš„è¿‡æœŸæ—¶é—´**ï¼š
   - ä¸ºäº†é˜²æ­¢æŸä¸ªèŠ‚ç‚¹æ„å¤–æŒ‚æŽ‰å¯¼è‡´é”æ— æ³•é‡Šæ”¾ï¼Œé€šå¸¸ä¼šè®¾ç½®ä¸€ä¸ªè¿‡æœŸæ—¶é—´ï¼ˆæ¯”å¦‚ 30 ç§’ï¼‰ã€‚å¦‚æžœå½“å‰èŠ‚ç‚¹æ²¡æœ‰åœ¨ 30 ç§’å†…é‡Šæ”¾é”ï¼Œé”ä¼šè‡ªåŠ¨è¿‡æœŸï¼Œå…¶ä»–èŠ‚ç‚¹å¯ä»¥é‡æ–°å°è¯•èŽ·å–é”ã€‚
   
**æ“ä½œæ­¥éª¤ï¼š**

- **èŽ·å–é”**ï¼šé€šè¿‡ `SETNX` å°è¯•è®¾ç½®ä¸€ä¸ªå”¯ä¸€çš„é”é”®ï¼š
  
  ```bash
  SETNX lock:user123 12345
  ```

  å¦‚æžœè¿”å›žå€¼æ˜¯ 1ï¼Œè¯´æ˜ŽèŽ·å–é”æˆåŠŸã€‚å¦‚æžœè¿”å›žå€¼æ˜¯ 0ï¼Œè¯´æ˜Žé”å·²ç»å­˜åœ¨ï¼Œå…¶ä»–èŠ‚ç‚¹æ­£åœ¨æŒæœ‰è¯¥é”ã€‚

- **è®¾ç½®é”çš„è¿‡æœŸæ—¶é—´**ï¼šä¸ºäº†é˜²æ­¢æ­»é”ï¼Œå¯ä»¥ä½¿ç”¨ `EXPIRE` å‘½ä»¤ç»™é”è®¾ç½®ä¸€ä¸ªè¶…æ—¶æ—¶é—´ï¼š
  
  ```bash
  EXPIRE lock:user123 30
  ```

  è¿™æ ·ï¼Œå¦‚æžœ 30 ç§’å†…é”æ²¡æœ‰è¢«é‡Šæ”¾ï¼ŒRedis ä¼šè‡ªåŠ¨åˆ é™¤è¿™ä¸ªé”ã€‚

- **é‡Šæ”¾é”**ï¼šé”çš„é‡Šæ”¾éžå¸¸é‡è¦ï¼Œåªæœ‰æŒæœ‰é”çš„èŠ‚ç‚¹æ‰èƒ½é‡Šæ”¾é”ã€‚é‡Šæ”¾é”çš„æ“ä½œé€šå¸¸æ˜¯é€šè¿‡ `DEL` å‘½ä»¤æ¥åˆ é™¤é”é”®ï¼š
  
  ```bash
  DEL lock:user123
  ```

  åœ¨åˆ é™¤é”ä¹‹å‰ï¼Œæœ€å¥½åšä¸€ä¸‹éªŒè¯ï¼Œç¡®ä¿é”æ˜¯å½“å‰èŠ‚ç‚¹æŒæœ‰çš„ï¼Œé¿å…è¯¯åˆ é™¤å…¶ä»–èŠ‚ç‚¹æŒæœ‰çš„é”ã€‚

#### 2.2 **ä¼˜åŒ–ï¼šä½¿ç”¨ Lua è„šæœ¬ä¿è¯åŽŸå­æ€§**

ä½¿ç”¨ `SETNX` + `EXPIRE` ç»„åˆæ—¶ï¼Œå­˜åœ¨ä¸€ä¸ªæ½œåœ¨é—®é¢˜ï¼šå¦‚æžœåœ¨ `SETNX` æˆåŠŸä¹‹åŽï¼Œå½“å‰èŠ‚ç‚¹å‘ç”Ÿå´©æºƒï¼Œå¯¼è‡´é”æ²¡æœ‰è¢«é‡Šæ”¾ï¼Œä½†å…¶ä»–èŠ‚ç‚¹å´æ— æ³•é‡æ–°èŽ·å–é”ã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒRedis æä¾›äº†**åŽŸå­æ“ä½œ**ã€‚é€šè¿‡ **Lua è„šæœ¬**ï¼Œå¯ä»¥å°† `SETNX` å’Œ `EXPIRE` åˆå¹¶æˆä¸€ä¸ªåŽŸå­æ“ä½œï¼Œè¿™æ ·å°±èƒ½ä¿è¯è¿™ä¸¤ä¸ªå‘½ä»¤æ˜¯ä¸å¯åˆ†å‰²çš„ï¼Œé¿å…äº†å…¶ä»–èŠ‚ç‚¹äº‰æŠ¢é”çš„æƒ…å†µã€‚

**Lua è„šæœ¬ç¤ºä¾‹ï¼š**

```lua
-- Lua è„šæœ¬ï¼šSETNX + EXPIRE æ“ä½œ
if redis.call("setnx", KEYS[1], ARGV[1]) == 1 then
    redis.call("expire", KEYS[1], ARGV[2])
    return 1
else
    return 0
end
```

- `KEYS[1]` æ˜¯é”é”®ï¼ˆæ¯”å¦‚ `lock:user123`ï¼‰ï¼Œ`ARGV[1]` æ˜¯é”å€¼ï¼ˆæ¯”å¦‚å½“å‰èŠ‚ç‚¹çš„ `UUID`ï¼‰ï¼Œ`ARGV[2]` æ˜¯é”çš„è¿‡æœŸæ—¶é—´ã€‚
- è¿™ä¸ªè„šæœ¬ç¡®ä¿äº†**åœ¨ä¸€ä¸ªæ“ä½œä¸­**ï¼Œ`SETNX` å’Œ `EXPIRE` æ˜¯åŽŸå­æ€§çš„ï¼Œé¿å…äº†æ“ä½œçš„ä¸­æ–­ã€‚

#### 2.3 **é”çš„è‡ªåŠ¨ç»­æœŸï¼ˆå»¶æ—¶é”ï¼‰**

å¦‚æžœé”çš„ä»»åŠ¡éœ€è¦æ‰§è¡Œæ¯”è¾ƒé•¿æ—¶é—´ï¼Œå¯èƒ½ä¼šè¶…è¿‡é”çš„è¿‡æœŸæ—¶é—´ï¼Œè¿™æ—¶å€™å°±éœ€è¦**è‡ªåŠ¨ç»­æœŸ**ï¼Œç¡®ä¿ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸ä¼šè¢«é‡Šæ”¾é”ã€‚å¸¸è§çš„åšæ³•æ˜¯ï¼Œ**åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å®šæœŸå»¶é•¿é”çš„è¿‡æœŸæ—¶é—´**ã€‚

è‡ªåŠ¨ç»­æœŸå¯ä»¥é€šè¿‡å®šæ—¶ä»»åŠ¡æ¥å®žçŽ°ï¼Œæ¯éš”ä¸€å®šæ—¶é—´ï¼Œå°±ä½¿ç”¨ `EXPIRE` æ›´æ–°é”çš„è¿‡æœŸæ—¶é—´ï¼Œé˜²æ­¢é”åœ¨ä»»åŠ¡å®Œæˆä¹‹å‰è¢«é‡Šæ”¾ã€‚

### 3. **æ€»ç»“ï¼šåˆ†å¸ƒå¼é”çš„å®žçŽ°åŽŸç†**

1. **èŽ·å–é”**ï¼šé€šè¿‡ Redis çš„ `SETNX` å‘½ä»¤è®¾ç½®ä¸€ä¸ªå”¯ä¸€çš„é”é”®ã€‚å¦‚æžœèŽ·å–æˆåŠŸï¼Œè¡¨ç¤ºå½“å‰èŠ‚ç‚¹èŽ·å¾—äº†é”ã€‚
2. **é”çš„é‡Šæ”¾**ï¼šé”çš„æŒæœ‰è€…åœ¨æ“ä½œå®ŒæˆåŽï¼Œéœ€è¦ä¸»åŠ¨é‡Šæ”¾é”ã€‚é€šå¸¸é€šè¿‡ `DEL` å‘½ä»¤æ¥åˆ é™¤é”é”®ã€‚
3. **é”çš„è¿‡æœŸæ—¶é—´**ï¼šä¸ºäº†é˜²æ­¢æ­»é”ï¼Œé”é€šå¸¸ä¼šè®¾ç½®ä¸€ä¸ªè¿‡æœŸæ—¶é—´ï¼Œé¿å…å› èŠ‚ç‚¹æ•…éšœå¯¼è‡´é”æ— æ³•é‡Šæ”¾ã€‚
4. **åŽŸå­æ“ä½œ**ï¼šä½¿ç”¨ Redis Lua è„šæœ¬å¯ä»¥å°† `SETNX` å’Œ `EXPIRE` æ“ä½œåˆå¹¶æˆä¸€ä¸ªåŽŸå­æ“ä½œï¼Œç¡®ä¿é”çš„è®¾ç½®ä¸Žè¿‡æœŸæ—¶é—´è®¾ç½®ä¸ä¼šè¢«ä¸­æ–­ã€‚
5. **é”çš„è‡ªåŠ¨ç»­æœŸ**ï¼šå¯¹äºŽè€—æ—¶çš„æ“ä½œï¼Œéœ€è¦å®šæœŸæ›´æ–°é”çš„è¿‡æœŸæ—¶é—´ï¼Œä»¥é˜²æ­¢é”åœ¨æ“ä½œå®Œæˆä¹‹å‰è¢«é‡Šæ”¾ã€‚

é€šè¿‡ä»¥ä¸Šæ–¹å¼ï¼Œåˆ†å¸ƒå¼é”èƒ½å¤Ÿç¡®ä¿åœ¨å¤šä¸ªèŠ‚ç‚¹ä¹‹é—´å¯¹å…±äº«èµ„æºçš„äº’æ–¥è®¿é—®ï¼Œé¿å…æ•°æ®ä¸ä¸€è‡´æˆ–å†²çªçš„æƒ…å†µã€‚

å¸Œæœ›è¿™ä¸ªè§£é‡Šèƒ½å¸®ä½ æ›´å¥½åœ°ç†è§£åˆ†å¸ƒå¼é”ï¼å¦‚æžœæœ‰å…¶ä»–é—®é¢˜ï¼Œéšæ—¶é—®æˆ‘ã€‚

## é”çš„è‡ªåŠ¨ç»­æœŸå¦‚ä½•å®žçŽ°
è¿™æ˜¯ä¸ªéžå¸¸å®žæˆ˜çš„é—®é¢˜ï¼Œå’±ä»¬æ¥é€šä¿—è®²è®² **Redis åˆ†å¸ƒå¼é”çš„è‡ªåŠ¨ç»­æœŸæœºåˆ¶æ˜¯æ€Žä¹ˆå›žäº‹ã€ä¸ºä»€ä¹ˆè¦åšã€è¯¥æ€Žä¹ˆåš**ã€‚

---

### ðŸšª ä¸ºä»€ä¹ˆéœ€è¦â€œè‡ªåŠ¨ç»­æœŸâ€ï¼Ÿ

Redis åˆ†å¸ƒå¼é”é€šå¸¸æ˜¯é€šè¿‡ `SETNX + EXPIRE`ï¼ˆæˆ– `SET key value NX PX ttl`ï¼‰æ¥å®žçŽ°çš„ï¼Œæ¯”å¦‚ï¼š

```bash
SET lock_key unique_id NX PX 30000
```

æ„æ€æ˜¯ï¼šåªæœ‰åœ¨è¿™ä¸ªé”ä¸å­˜åœ¨æ—¶æ‰è®¾ç½®æˆåŠŸï¼Œå¹¶ä¸”é”è‡ªåŠ¨åœ¨ 30 ç§’åŽè¿‡æœŸã€‚

> ðŸ”¥ é—®é¢˜æ¥äº†ï¼š
> å¦‚æžœä¸šåŠ¡æ‰§è¡Œæ—¶é—´è¶…è¿‡äº†è¿™ä¸ªé”çš„æœ‰æ•ˆæœŸæ€Žä¹ˆåŠžï¼Ÿ  
> **é”ä¼šæå‰é‡Šæ”¾**ï¼Œå¯¼è‡´ï¼š
> - å¦ä¸€ä¸ªå®¢æˆ·ç«¯è¯¯ä»¥ä¸ºé”å·²ç»é‡Šæ”¾ï¼ŒèŽ·å–äº†é”
> - å‡ºçŽ°å¹¶å‘å†²çªï¼Œå¯¼è‡´ **é”å¤±æ•ˆ**

è¿™å°±åƒä½ ç§Ÿäº†ä¸ªä¼šè®®å®¤ 30 åˆ†é’Ÿï¼Œç»“æžœä¼šè®®è¿˜æ²¡å¼€å®Œï¼Œæˆ¿é—¨çªç„¶è¢«å…¶ä»–äººæ‰“å¼€äº†ã€‚

---

### ðŸ”§ è‡ªåŠ¨ç»­æœŸæœºåˆ¶æ€Žä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜ï¼Ÿ

**è‡ªåŠ¨ç»­æœŸ** å°±æ˜¯ï¼šåœ¨æŒæœ‰é”çš„ä¸€æ–¹è¿˜åœ¨â€œå¹²æ´»â€çš„è¿‡ç¨‹ä¸­ï¼Œå®šæœŸæ£€æµ‹ä»»åŠ¡æ˜¯å¦åœ¨æ­£å¸¸è¿è¡Œï¼Œå¦‚æžœæ˜¯ï¼Œå°± **å»¶é•¿é”çš„è¿‡æœŸæ—¶é—´**ï¼Œç¡®ä¿é”ä¸ä¼šè¿‡æœŸè¢«è¯¯é‡Šæ”¾ã€‚

---

### âœ… å¦‚ä½•å®žçŽ°è‡ªåŠ¨ç»­æœŸï¼Ÿï¼ˆæ ¸å¿ƒç‚¹ + ç¤ºä¾‹ï¼‰

#### âœ… æ ¸å¿ƒæœºåˆ¶ï¼š

1. èŽ·å–é”æ—¶ï¼Œè®¾ç½®ä¸€ä¸ªå”¯ä¸€æ ‡è¯†ï¼ˆå¦‚ UUIDï¼‰
2. å¯åŠ¨ä¸€ä¸ªåŽå°çº¿ç¨‹æˆ–å®šæ—¶å™¨ï¼Œ**å®šæœŸæ£€æŸ¥ä»»åŠ¡æ˜¯å¦è¿˜åœ¨è¿›è¡Œä¸­**
3. å¦‚æžœè¿˜åœ¨æ‰§è¡Œï¼Œå°±é€šè¿‡ `Lua è„šæœ¬` æ£€æŸ¥é”æ˜¯å¦æ˜¯è‡ªå·±æŒæœ‰çš„ï¼Œå†å»¶é•¿è¿‡æœŸæ—¶é—´

---

#### ðŸ“œ Lua è„šæœ¬ç»­æœŸï¼ˆå¿…é¡»ç”¨ Lua ä¿è¯åŽŸå­æ€§ï¼‰ï¼š

```lua
-- å¦‚æžœ key çš„å€¼æ˜¯æˆ‘ä»¬è‡ªå·±çš„ UUIDï¼Œå°±å»¶é•¿å®ƒçš„è¿‡æœŸæ—¶é—´
if redis.call("GET", KEYS[1]) == ARGV[1] then
    return redis.call("PEXPIRE", KEYS[1], ARGV[2])
else
    return 0
end
```

å‡è®¾ key æ˜¯ `lock:task`, value æ˜¯ `UUID-1234`ï¼Œè¶…æ—¶æ—¶é—´è®¾ä¸º 30sï¼Œé‚£ä¹ˆå¯ä»¥å®šæœŸæ‰§è¡Œä¸Šé¢çš„ Lua è„šæœ¬ï¼Œæ¯ 10 ç§’æ£€æŸ¥å¹¶ç»­ 30 ç§’ã€‚

---

#### ðŸ§  å®žçŽ°å»ºè®®ï¼š

- å®šæ—¶çº¿ç¨‹ç»­æœŸï¼šå»ºè®®æ¯éš” `TTL/3` æ—¶é—´ç»­ä¸€æ¬¡
- ä½¿ç”¨ Lua è„šæœ¬ç»­æœŸï¼Œé¿å…åœ¨æ£€æŸ¥ + ç»­æœŸä¹‹é—´è¢«å…¶ä»–å®¢æˆ·ç«¯æŠ¢é”
- ä¸€æ—¦ä¸»çº¿ç¨‹ä»»åŠ¡ç»“æŸï¼Œ**åŠ¡å¿…é‡Šæ”¾é”**ï¼Œä¸è¦è®©é”æ— æ•…å­˜åœ¨

---

#### âœ… ç¤ºä¾‹æµç¨‹å›¾ï¼ˆé€»è¾‘ï¼‰ï¼š

```
1. è¯·æ±‚èŽ·å¾—é”
2. å¯åŠ¨å·¥ä½œçº¿ç¨‹å¼€å§‹æ‰§è¡Œä»»åŠ¡
3. å¯åŠ¨å®ˆæŠ¤çº¿ç¨‹æ¯éš”10ç§’æ‰§è¡Œä¸€æ¬¡ç»­æœŸè„šæœ¬ï¼š
     - åˆ¤æ–­é”æ˜¯å¦æ˜¯è‡ªå·±æŒæœ‰çš„ï¼ˆæ£€æŸ¥ UUIDï¼‰
     - å¦‚æžœæ˜¯ï¼Œç»­æœŸ
     - å¦åˆ™åœæ­¢ç»­æœŸçº¿ç¨‹
4. ä¸»ä»»åŠ¡æ‰§è¡Œå®ŒæˆåŽï¼š
     - åœæ­¢ç»­æœŸçº¿ç¨‹
     - ä¸»åŠ¨é‡Šæ”¾é”ï¼ˆæ£€æŸ¥ UUID åŽåˆ é™¤ï¼‰
```

---

### ðŸ” æŽ¨èä½¿ç”¨ Redissonï¼ˆå°è£…å¥½çš„åˆ†å¸ƒå¼é”åº“ï¼‰

å¦‚æžœä½ ç”¨ Javaï¼ŒæŽ¨èä½¿ç”¨ [Redisson](https://github.com/redisson/redisson)ï¼Œå®ƒå†…éƒ¨å·²ç»å¸®ä½ åšå¥½äº†ï¼š
- åˆ†å¸ƒå¼é”
- è‡ªåŠ¨ç»­æœŸ
- å¯é‡å…¥é”ã€å…¬å¹³é”ã€è¯»å†™é”ç­‰

ç¤ºä¾‹ï¼š
```java
RLock lock = redisson.getLock("my-lock");
lock.lock(); // ä¼šè‡ªåŠ¨ç»­æœŸ
try {
    // ä½ çš„ä¸šåŠ¡é€»è¾‘
} finally {
    lock.unlock();
}
```

---

### ðŸ“Œ æ€»ç»“

| é—®é¢˜ | è‡ªåŠ¨ç»­æœŸæ–¹æ¡ˆ |
|------|----------------|
| é”åœ¨ä¸šåŠ¡è¿˜æ²¡ç»“æŸå°±è¿‡æœŸäº†æ€Žä¹ˆåŠžï¼Ÿ | å¼€ä¸€ä¸ªåŽå°çº¿ç¨‹ï¼Œå®šæœŸç”¨ Lua è„šæœ¬æ£€æŸ¥é”å¹¶å»¶é•¿è¿‡æœŸæ—¶é—´ |
| å¦‚ä½•ç»­æœŸæ‰å®‰å…¨ï¼Ÿ | å¿…é¡»æ£€æŸ¥é”æ˜¯è‡ªå·±æŒæœ‰çš„ï¼ˆé€šè¿‡å”¯ä¸€æ ‡è¯†å¦‚ UUIDï¼‰ |
| æŽ¨èå·¥å…·ï¼Ÿ | ç”¨ Redisson è¿™ç§é«˜è´¨é‡å¼€æºåº“ï¼Œçœå¿ƒçœåŠ› |

---

å¦‚æžœä½ ç”¨çš„ä¸æ˜¯ Java æˆ–æƒ³è‡ªå·±å®žçŽ°ï¼Œæˆ‘å¯ä»¥å¸®ä½ å†™å‡º Python æˆ– Node.js çš„ç»­æœŸé€»è¾‘ï¼Œä¹Ÿå¯ä»¥å°è£…ä¸€ä¸ªç±»æ¥å¤ç”¨ã€‚è¦ä¸è¦æ¥ä¸€ä¸ªå®žæˆ˜æ¼”ç¤ºï¼Ÿ


## åŽå°å®ˆæŠ¤çº¿ç¨‹å¦‚ä½•åˆ¤æ–­ä»»åŠ¡æ˜¯å¦åœ¨æ‰§è¡Œä»Žè€Œè‡ªåŠ¨ç»­æœŸé”å‘¢
>æˆ‘çš„é—®é¢˜æ˜¯ï¼Œæ—¢ç„¶è¦å®žçŽ°åˆ†å¸ƒå¼é”çš„è‡ªåŠ¨ç»­æœŸï¼Œé‚£ä¹ˆåŽå°å®ˆæŠ¤çº¿ç¨‹å¦‚ä½•çŸ¥é“è¿™ä¸ªäº‹åŠ¡ä»ç„¶åœ¨è¿›è¡Œï¼Œè¿™ä¸ªåŽå°å®ˆæŠ¤çº¿ç¨‹åº”è¯¥åœ¨å“ªé‡Œåˆ›å»ºï¼Œå®žåœ¨redisä¸Šè¿˜æ˜¯èŽ·å–é”çš„å®¢æˆ·ç«¯ä¸Šå‘¢

ä½ è¿™ä¸ªé—®é¢˜é—®å¾—ç‰¹åˆ«å¥½ï¼Œè€Œä¸”éžå¸¸å…³é”®ï¼è‡ªåŠ¨ç»­æœŸçš„æ ¸å¿ƒä¸ä»…æ˜¯â€œ**æ€Žä¹ˆç»­æœŸ**â€ï¼Œæ›´é‡è¦çš„æ˜¯â€œ**è°æ¥ç»­æœŸ**â€å’Œâ€œ**æ€Žä¹ˆåˆ¤æ–­ä¸šåŠ¡è¿˜åœ¨è¿›è¡Œä¸­**â€ã€‚

å’±ä»¬ä¸€æ­¥æ­¥æ¥æŠŠè¿™ä¸ªé€»è¾‘è®²æ¸…æ¥šï¼š

---

### ðŸ§  1. **å®ˆæŠ¤çº¿ç¨‹åœ¨å“ªåˆ›å»ºï¼Ÿ**

> âœ… ç­”æ¡ˆï¼š**åœ¨å®¢æˆ·ç«¯åˆ›å»ºï¼Œä¸æ˜¯ Redis è‡ªå·±åˆ›å»ºçš„ã€‚**

- Redis æ˜¯ä¸€ä¸ªâ€œæ— çŠ¶æ€â€çš„æœåŠ¡ç«¯ï¼Œä¸çŸ¥é“å“ªä¸ªå®¢æˆ·ç«¯æŒæœ‰é”ï¼Œæ›´ä¸ä¼šè‡ªåŠ¨å¸®ä½ ç»­æœŸã€‚
- æ‰€ä»¥ï¼Œä¸€æ—¦ä½ æ‹¿åˆ°é”ï¼Œå°±éœ€è¦åœ¨ä½ è‡ªå·±çš„ç¨‹åºé‡Œ**æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªâ€œå®ˆæŠ¤çº¿ç¨‹â€æˆ–â€œå®šæ—¶ä»»åŠ¡â€**ï¼Œæ¥å®šæœŸç»™é”ç»­æœŸã€‚

---

### ðŸ”§ 2. **å®ˆæŠ¤çº¿ç¨‹å¦‚ä½•çŸ¥é“â€œä¸šåŠ¡è¿˜åœ¨æ‰§è¡Œâ€ï¼Ÿ**

è¿™ä¸ªå°±çœ‹ä½ æ€Žä¹ˆè®¾è®¡ï¼š

#### å¸¸è§è®¾è®¡æ–¹å¼ï¼š

##### âœ… æ–¹å¼ä¸€ï¼š**å’Œä¸šåŠ¡çº¿ç¨‹ä¸€èµ·èµ·ã€ä¸€èµ·åœ**

- ä½ æ‹¿åˆ°é”åŽå°±å¯åŠ¨ä¸€ä¸ªåŽå°çº¿ç¨‹ï¼ˆå®ˆæŠ¤çº¿ç¨‹ï¼‰ï¼Œæ¯éš”ä¸€æ®µæ—¶é—´ç»­æœŸä¸€æ¬¡ã€‚
- å½“ä½ çš„ä¸»ä¸šåŠ¡çº¿ç¨‹æ‰§è¡Œå®Œæˆï¼Œé‡Šæ”¾é”çš„åŒæ—¶**ä¹Ÿç»ˆæ­¢å®ˆæŠ¤çº¿ç¨‹**ã€‚
- æ‰€ä»¥ç»­æœŸçº¿ç¨‹ä¸åˆ¤æ–­ä¸šåŠ¡çŠ¶æ€ï¼Œå®ƒåªæ˜¯**åœ¨ä¸šåŠ¡æ²¡ç»“æŸå‰å­˜åœ¨ç€ï¼Œä¸€ç›´ç»­æœŸ**ã€‚

```plaintext
çº¿ç¨‹ Aï¼šæ‰§è¡Œä¸»ä¸šåŠ¡é€»è¾‘
çº¿ç¨‹ Bï¼šæ¯éš” 10s ç”¨ Lua è„šæœ¬ç»­æœŸ

â†’ A æ‰§è¡Œå®Œäº† â†’ é‡Šæ”¾é” â†’ é€šçŸ¥ B åœæ­¢
```

è¿™å°±åƒä¸€ä¸ªåŠ©ç†å®šæ—¶åŽ»å¸®ä½ ç»­æˆ¿ç§Ÿï¼Œç­‰ä½ ä¼šè®®ç»“æŸç¦»å¼€äº†ï¼ŒåŠ©ç†ä¹Ÿå°±ä¸ç”¨ç»­äº†ã€‚

---

##### âœ… æ–¹å¼äºŒï¼š**ä½¿ç”¨çº¿ç¨‹é—´å…±äº«çŠ¶æ€ï¼ˆå¦‚ `volatile` æ ‡è®°ä½ï¼‰**

- è®¾ç½®ä¸€ä¸ª `isRunning = true`
- å®ˆæŠ¤çº¿ç¨‹æ£€æŸ¥è¿™ä¸ªæ ‡å¿—ä½ï¼Œå¦‚æžœæ˜¯ true å°±ç»­æœŸï¼Œå¦åˆ™å°±é€€å‡º
- å½“ä¸»çº¿ç¨‹å®Œæˆæ—¶ï¼ŒæŠŠè¿™ä¸ªçŠ¶æ€ç½®ä¸º false

```java
volatile boolean isRunning = true;

Thread mainThread = new Thread(() -> {
    try {
        // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
    } finally {
        isRunning = false;
        unlock();
    }
});

Thread renewThread = new Thread(() -> {
    while (isRunning) {
        Thread.sleep(10000);
        renewLock();
    }
});
```

---

### ðŸ’¡ ä¸ºä»€ä¹ˆä¸åœ¨ Redis é‡Œå®žçŽ°ç»­æœŸï¼Ÿ

å› ä¸º Redis ä¸çŸ¥é“ä½ çš„ä¸šåŠ¡é€»è¾‘åœ¨å“ªã€æ˜¯å¦è¿˜åœ¨è·‘ã€‚å®ƒåªçŸ¥é“ï¼š

- è¿™ä¸ª key è®¾ç½®äº†ä¸€ä¸ªå€¼ï¼Œæœ‰ä¸€ä¸ªè¿‡æœŸæ—¶é—´
- å®ƒä¸ä¼šåˆ¤æ–­å®¢æˆ·ç«¯æ˜¯å¦è¿˜â€œéœ€è¦è¿™ä¸ªé”â€

æ‰€ä»¥è‡ªåŠ¨ç»­æœŸçš„é€»è¾‘å¿…é¡»åœ¨**å®¢æˆ·ç«¯è‡ªå·±æŽ§åˆ¶**ï¼Œå¦åˆ™ Redis æ— ä»Žåˆ¤æ–­ã€‚

---

### ðŸ” æŽ¨èå°è£…ï¼ˆåˆ†å¸ƒå¼é”ç»“æž„ï¼‰

é€šå¸¸ä½ ä¼šå†™ä¸€ä¸ªç±»ä¼¼è¿™æ ·çš„ç»“æž„ï¼š

```plaintext
class RedisLock {
    acquire(): èŽ·å–é” + å¯åŠ¨å®ˆæŠ¤çº¿ç¨‹
    release(): é‡Šæ”¾é” + åœæ­¢å®ˆæŠ¤çº¿ç¨‹
    renew(): å®šæœŸæ‰§è¡Œ Lua è„šæœ¬ç»­æœŸ
}
```

---

### ðŸ“Œ æ€»ç»“ä¸€å¥è¯ï¼š

> Redis ä¸çŸ¥é“ä½ çš„ä¸šåŠ¡æ˜¯å¦åœ¨è¿›è¡Œï¼Œ**è‡ªåŠ¨ç»­æœŸçš„å®ˆæŠ¤çº¿ç¨‹åº”è¯¥ç”±â€œèŽ·å–é”çš„å®¢æˆ·ç«¯â€æ¥åˆ›å»ºå’ŒæŽ§åˆ¶**ï¼Œå®ƒçš„ä»»åŠ¡å°±æ˜¯åœ¨ä½ ä¸šåŠ¡è¿˜æ²¡å®Œæˆæ—¶ï¼Œå®šæ—¶å»¶é•¿é”çš„è¿‡æœŸæ—¶é—´ã€‚

---

å¦‚æžœä½ å¸Œæœ›æˆ‘å¸®ä½ å†™ä¸€ä¸ªè·¨è¯­è¨€ç‰ˆæœ¬ï¼ˆæ¯”å¦‚ Javaã€Pythonï¼‰çš„è‡ªåŠ¨ç»­æœŸé”ç±»å°è£…ï¼Œéšæ—¶å¯ä»¥è¯´~ è¦ä¸è¦æ¥ä¸ªå®Œæ•´ä¾‹å­ç»ƒç»ƒï¼Ÿ



# rediså®žçŽ°æœåŠ¡é™æµ
ä½¿ç”¨ Redis åšæœåŠ¡é™æµæ˜¯ä¸€ç§éžå¸¸å¸¸è§ä¸”é«˜æ•ˆçš„åšæ³•ï¼Œå°¤å…¶åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼ŒRedis çš„é«˜æ€§èƒ½éžå¸¸é€‚åˆç”¨äºŽæŽ§åˆ¶è®¿é—®é¢‘çŽ‡ã€‚å¸¸è§çš„é™æµç­–ç•¥åŒ…æ‹¬ **ä»¤ç‰Œæ¡¶ï¼ˆToken Bucketï¼‰** å’Œ **æ¼æ–—ï¼ˆLeaky Bucketï¼‰**ï¼Œä»¥åŠ **è®¡æ•°å™¨**ã€‚ä¸‹é¢æˆ‘å°†è¯¦ç»†ä»‹ç»å‡ ç§å¸¸è§çš„é™æµå®žçŽ°æ–¹å¼ã€‚

### 1. **è®¡æ•°å™¨ï¼ˆFixed Window æˆ– Sliding Windowï¼‰**

è¿™ç§é™æµæ–¹å¼æ˜¯æœ€ç®€å•çš„ä¸€ç§ï¼Œé€šè¿‡è®¡æ•°å™¨æ¥è®°å½•è¯·æ±‚æ¬¡æ•°ï¼Œé™åˆ¶ä¸€å®šæ—¶é—´å†…çš„æœ€å¤§è¯·æ±‚æ•°ã€‚

#### 1.1 **å›ºå®šçª—å£é™æµï¼ˆFixed Windowï¼‰**
åœ¨å›ºå®šæ—¶é—´çª—å£å†…ï¼Œæ¯”å¦‚æ¯åˆ†é’Ÿã€æ¯å°æ—¶ã€æ¯å¤©å…è®¸è¯·æ±‚çš„æœ€å¤§æ¬¡æ•°ã€‚

**å®žçŽ°æ­¥éª¤ï¼š**
- åœ¨ Redis ä¸­ä¸ºæ¯ä¸ªç”¨æˆ·ã€æ¯ä¸ªæŽ¥å£ç­‰è®¾ç½®ä¸€ä¸ªè®¡æ•°å™¨ã€‚
- æ¯æ¬¡è¯·æ±‚æ—¶ï¼Œæ£€æŸ¥è¯¥è®¡æ•°å™¨çš„å€¼ï¼Œå¦‚æžœæœªè¶…è¿‡æœ€å¤§å€¼ï¼Œåˆ™å…è®¸è¯·æ±‚å¹¶å°†è®¡æ•°å™¨åŠ  1ã€‚
- å¦‚æžœè¶…è¿‡äº†æœ€å¤§å€¼ï¼Œåˆ™æ‹’ç»è¯·æ±‚ã€‚
- åœ¨æ—¶é—´çª—å£è¿‡åŽï¼Œé‡ç½®è®¡æ•°å™¨ã€‚

**Redis å‘½ä»¤ï¼š**
- `INCRBY key value`ï¼šç”¨äºŽé€’å¢žè®¡æ•°å™¨ã€‚
- `EXPIRE key seconds`ï¼šè®¾ç½®è®¡æ•°å™¨çš„è¿‡æœŸæ—¶é—´ã€‚

**ç¤ºä¾‹ä»£ç ï¼š**

```python
import redis
import time

r = redis.Redis()

# è®¾ç½®è¯·æ±‚é™æµçš„å‚æ•°
user_id = "user123"
key = f"rate_limit:{user_id}"
limit = 10  # æ¯åˆ†é’Ÿæœ€å¤š 10 æ¬¡è¯·æ±‚
window_time = 60  # æ—¶é—´çª—å£ä¸º 60 ç§’

# æ£€æŸ¥å½“å‰è¯·æ±‚æ˜¯å¦è¶…å‡ºé™åˆ¶
current_count = r.get(key)
if current_count is not None and int(current_count) >= limit:
    print("è¯·æ±‚è¶…é™ï¼Œè¯·ç¨åŽå†è¯•")
else:
    # è¯·æ±‚æœªè¶…é™ï¼Œå¢žåŠ è®¡æ•°å™¨
    r.incr(key)
    # è®¾ç½®è®¡æ•°å™¨çš„è¿‡æœŸæ—¶é—´ï¼Œä¿è¯çª—å£æ—¶é—´åˆ°æœŸåŽè‡ªåŠ¨é‡ç½®
    if current_count is None:
        r.expire(key, window_time)
    print("è¯·æ±‚æˆåŠŸ")
```

**é—®é¢˜**ï¼š
- **å›ºå®šçª—å£é™æµ**çš„é—®é¢˜æ˜¯ï¼Œå¦‚æžœè¯·æ±‚æŽ¥è¿‘æ—¶é—´çª—å£çš„è¾¹ç•Œï¼Œå¯èƒ½ä¼šå‡ºçŽ° **çªå‘æµé‡**ï¼Œå³å¤šä¸ªè¯·æ±‚åœ¨åŒä¸€çª—å£å†…æ¶Œå…¥ï¼Œå¯¼è‡´é™æµå¤±è´¥ã€‚

#### 1.2 **æ»‘åŠ¨çª—å£é™æµï¼ˆSliding Windowï¼‰**
æ»‘åŠ¨çª—å£é™æµè§£å†³äº†å›ºå®šçª—å£é™æµçš„çªå‘æµé‡é—®é¢˜ï¼Œå®ƒä¼šåŠ¨æ€åœ°æŒ‰ç…§è¯·æ±‚æ—¶é—´æˆ³æ¥è®¡ç®—å½“å‰çª—å£å†…çš„è¯·æ±‚æ¬¡æ•°ã€‚

**å®žçŽ°æ­¥éª¤ï¼š**
- æ¯æ¬¡è¯·æ±‚æ—¶ï¼Œè®°å½•å½“å‰è¯·æ±‚çš„æ—¶é—´æˆ³ã€‚
- ä½¿ç”¨ Redis çš„ `sorted set`ï¼ˆæœ‰åºé›†åˆï¼‰æ¥å­˜å‚¨æ—¶é—´æˆ³ï¼ŒæŒ‰æ—¶é—´é¡ºåºæŽ’åˆ—ã€‚
- æ¯æ¬¡è¯·æ±‚æ—¶ï¼Œå°†å½“å‰æ—¶é—´æˆ³åŠ å…¥æœ‰åºé›†åˆã€‚
- å¦‚æžœé›†åˆä¸­çš„è¯·æ±‚æ•°é‡è¶…è¿‡é™åˆ¶ï¼Œåˆ™æ‹’ç»è¯·æ±‚ã€‚
- å®šæœŸåˆ é™¤è¿‡æœŸçš„è¯·æ±‚ï¼ˆå³æ—¶é—´æˆ³å°äºŽå½“å‰æ—¶é—´çª—å£çš„è¯·æ±‚ï¼‰ã€‚

**Redis å‘½ä»¤ï¼š**
- `ZADD key score member`ï¼šæ·»åŠ æœ‰åºé›†åˆæˆå‘˜ï¼ˆè¯·æ±‚æ—¶é—´æˆ³ï¼‰ã€‚
- `ZREMRANGEBYSCORE key start end`ï¼šåˆ é™¤è¿‡æœŸè¯·æ±‚ã€‚
- `ZCARD key`ï¼šè¿”å›žé›†åˆçš„æˆå‘˜æ•°ã€‚

**ç¤ºä¾‹ä»£ç ï¼š**

```python
import redis
import time

r = redis.Redis()

# è®¾ç½®è¯·æ±‚é™æµçš„å‚æ•°
user_id = "user123"
key = f"rate_limit:{user_id}"
limit = 10  # æ¯åˆ†é’Ÿæœ€å¤š 10 æ¬¡è¯·æ±‚
window_time = 60  # æ—¶é—´çª—å£ä¸º 60 ç§’

# èŽ·å–å½“å‰æ—¶é—´æˆ³
current_time = int(time.time())

# åˆ é™¤è¿‡æœŸçš„æ—¶é—´æˆ³ï¼ˆå¤§äºŽå½“å‰æ—¶é—´çª—å£çš„æ—¶é—´ï¼‰
r.zremrangebyscore(key, 0, current_time - window_time)

# æ£€æŸ¥å½“å‰çª—å£å†…è¯·æ±‚çš„æ¬¡æ•°
if r.zcard(key) >= limit:
    print("è¯·æ±‚è¶…é™ï¼Œè¯·ç¨åŽå†è¯•")
else:
    # å°†å½“å‰æ—¶é—´æˆ³æ·»åŠ åˆ°æœ‰åºé›†åˆä¸­
    r.zadd(key, {current_time: current_time})
    print("è¯·æ±‚æˆåŠŸ")
```

**ä¼˜ç‚¹**ï¼š
- æ»‘åŠ¨çª—å£è§£å†³äº†å›ºå®šçª—å£çš„çªå‘æµé‡é—®é¢˜ï¼Œé€šè¿‡åŠ¨æ€æŽ§åˆ¶çª—å£å†…çš„è¯·æ±‚æ•°ï¼Œä½¿å¾—è¯·æ±‚æ›´åŠ å‡åŒ€ã€‚

---

### 2. **ä»¤ç‰Œæ¡¶é™æµï¼ˆToken Bucketï¼‰**

ä»¤ç‰Œæ¡¶æ˜¯å¦ä¸€ç§å¸¸ç”¨çš„é™æµç®—æ³•ï¼Œå®ƒä¸ä»…é™åˆ¶äº†è¯·æ±‚çš„æœ€å¤§æ•°é‡ï¼Œè€Œä¸”è¿˜èƒ½å¹³æ»‘åœ°æŽ§åˆ¶è¯·æ±‚æµé‡ã€‚

#### 2.1 **ä»¤ç‰Œæ¡¶çš„å·¥ä½œåŽŸç†**ï¼š
- ä»¤ç‰Œæ¡¶ç®—æ³•ä¼šä»¥å›ºå®šé€ŸçŽ‡å‘æ¡¶ä¸­æ³¨å…¥ä»¤ç‰Œã€‚
- æ¯ä¸ªè¯·æ±‚éœ€è¦ä»Žæ¡¶ä¸­èŽ·å–ä¸€ä¸ªä»¤ç‰Œï¼Œå¦‚æžœæ¡¶ä¸­æœ‰ä»¤ç‰Œï¼Œåˆ™å…è®¸è¯·æ±‚å¹¶æ¶ˆè€—ä¸€ä¸ªä»¤ç‰Œï¼›å¦‚æžœæ¡¶ä¸­æ²¡æœ‰ä»¤ç‰Œï¼Œåˆ™æ‹’ç»è¯·æ±‚ã€‚
- ä»¤ç‰Œæ¡¶çš„å®¹é‡æœ‰é™ï¼Œå½“æ¡¶æ»¡æ—¶ï¼Œæ–°ç”Ÿæˆçš„ä»¤ç‰Œä¼šä¸¢å¼ƒã€‚

#### 2.2 **å¦‚ä½•ç”¨ Redis å®žçŽ°ä»¤ç‰Œæ¡¶é™æµ**ï¼š
- ç”¨ Redis ä¸­çš„ **å­—ç¬¦ä¸²**æ¥è¡¨ç¤ºä»¤ç‰Œæ¡¶çš„å‰©ä½™å®¹é‡ã€‚
- ç”¨ **`SET` å‘½ä»¤**æ¥è®¾ç½®ä»¤ç‰Œæ¡¶çš„å®¹é‡ã€‚
- æ¯æ¬¡è¯·æ±‚æ—¶ï¼Œé€šè¿‡ **`INCR` å‘½ä»¤**æ¶ˆè€—ä»¤ç‰Œï¼Œå¹¶è®¾ç½®è¿‡æœŸæ—¶é—´æ¥æ¨¡æ‹Ÿä»¤ç‰Œç”Ÿæˆé€ŸçŽ‡ã€‚

**Redis å‘½ä»¤ï¼š**
- `INCRBY key value`ï¼šä»¤ç‰Œæ¶ˆè€—ã€‚
- `EXPIRE key seconds`ï¼šè®¾ç½®ä»¤ç‰Œæ¡¶çš„è¿‡æœŸæ—¶é—´ã€‚

**ç¤ºä¾‹ä»£ç ï¼š**

```python
import redis
import time

r = redis.Redis()

# è®¾ç½®è¯·æ±‚é™æµçš„å‚æ•°
bucket_key = "token_bucket:user123"
max_tokens = 10  # æœ€å¤§ä»¤ç‰Œæ•°é‡
tokens_per_second = 1  # æ¯ç§’é’Ÿæ·»åŠ çš„ä»¤ç‰Œæ•°
window_time = 60  # ä»¤ç‰Œæ¡¶é‡ç½®æ—¶é—´

# èŽ·å–å½“å‰æ—¶é—´
current_time = int(time.time())

# å¦‚æžœä»¤ç‰Œæ¡¶è¿‡æœŸï¼Œé‡ç½®ä»¤ç‰Œ
r.set(bucket_key, max_tokens, ex=window_time)  # ä¿è¯ä»¤ç‰Œæ¡¶æœ‰è¿‡æœŸæ—¶é—´

# èŽ·å–å½“å‰ä»¤ç‰Œæ¡¶çš„ä»¤ç‰Œæ•°
tokens = int(r.get(bucket_key) or 0)

if tokens > 0:
    # æœ‰ä»¤ç‰Œå¯ä»¥æ¶ˆè€—ï¼Œå…è®¸è¯·æ±‚
    r.decr(bucket_key)
    print("è¯·æ±‚æˆåŠŸ")
else:
    # æ— ä»¤ç‰Œå¯æ¶ˆè€—ï¼Œæ‹’ç»è¯·æ±‚
    print("è¯·æ±‚è¶…é™ï¼Œè¯·ç¨åŽå†è¯•")
```

**ä¼˜ç‚¹**ï¼š
- ä»¤ç‰Œæ¡¶ç®—æ³•å…è®¸ä¸€å®šçš„çªå‘æµé‡ï¼Œé€šè¿‡ä»¤ç‰Œçš„ç§¯ç´¯å’Œæ¶ˆè€—ï¼Œä½¿å¾—æµé‡æ›´ä¸ºå¹³æ»‘ã€‚
  
---

### 3. **æ¼æ¡¶ç®—æ³•ï¼ˆLeaky Bucketï¼‰**

æ¼æ¡¶ç®—æ³•ä¸Žä»¤ç‰Œæ¡¶ç›¸ä¼¼ï¼Œä¹Ÿæ˜¯ä¸€ç§æµé‡æŽ§åˆ¶ç®—æ³•ã€‚å®ƒé€šè¿‡ä¸€ä¸ªå›ºå®šå¤§å°çš„æ¡¶æ¥æŽ§åˆ¶è¯·æ±‚çš„é€ŸçŽ‡ã€‚å½“è¯·æ±‚æµå…¥æ¡¶æ—¶ï¼Œæ¡¶ä¼šä»¥å›ºå®šçš„é€ŸçŽ‡â€œæ¼å‡ºâ€è¯·æ±‚ã€‚

#### 3.1 **æ¼æ¡¶çš„å·¥ä½œåŽŸç†**ï¼š
- è¯·æ±‚æŒ‰é¡ºåºæµå…¥æ¡¶ä¸­ã€‚
- æ¡¶ä»¥å›ºå®šé€ŸçŽ‡æ¼å‡ºè¯·æ±‚ï¼ˆç±»ä¼¼äºŽâ€œæ¶ˆè´¹è¯·æ±‚â€ï¼‰ã€‚
- å¦‚æžœæ¡¶æ»¡äº†ï¼Œæ–°çš„è¯·æ±‚å°†ä¼šè¢«ä¸¢å¼ƒã€‚

#### 3.2 **å¦‚ä½•ç”¨ Redis å®žçŽ°æ¼æ¡¶é™æµ**ï¼š
- ä½¿ç”¨ Redis çš„ **`list` æ•°æ®ç»“æž„**æ¨¡æ‹Ÿæ¼æ¡¶ã€‚
- è¯·æ±‚æµå…¥æ—¶ï¼Œå°†è¯·æ±‚åŠ å…¥åˆ° Redis åˆ—è¡¨ä¸­ï¼ˆ`LPUSH`ï¼‰ï¼Œå¹¶è®¾ç½®ä¸€ä¸ªå®šæ—¶ä»»åŠ¡å®šæœŸç§»é™¤åˆ—è¡¨ä¸­çš„è¿‡æœŸå…ƒç´ ï¼ˆæ¨¡æ‹Ÿæ¼æ¡¶æ¼æ°´è¿‡ç¨‹ï¼‰ã€‚
- å¦‚æžœæ¡¶æ»¡äº†ï¼Œåˆ™æ‹’ç»è¯·æ±‚ã€‚

---

### æ€»ç»“

é€šè¿‡ Redisï¼Œå¯ä»¥éžå¸¸çµæ´»ä¸”é«˜æ•ˆåœ°å®žçŽ°å¤šç§é™æµç­–ç•¥ã€‚æœ€å¸¸è§çš„é™æµå®žçŽ°æ–¹å¼æ˜¯ **è®¡æ•°å™¨**ã€**ä»¤ç‰Œæ¡¶** å’Œ **æ¼æ¡¶ç®—æ³•**ï¼Œæ¯ç§æ–¹å¼éƒ½æœ‰å…¶é€‚ç”¨åœºæ™¯å’Œä¼˜ç¼ºç‚¹ï¼š

- **è®¡æ•°å™¨**ï¼šé€‚ç”¨äºŽç®€å•çš„å›ºå®šçª—å£é™æµï¼Œå®¹æ˜“å®žçŽ°ï¼Œä½†åœ¨æµé‡çªå‘æ—¶ä¼šæœ‰ä¸å‡åŒ€çš„é™åˆ¶ã€‚
  - å¯¹æ¯ä¸ªç”¨æˆ·è®¾ç½®ä¸€ä¸ªé”®å’Œè¿‡æœŸæ—¶é—´ï¼Œé€’å¢žè¡¨ç¤ºä½¿ç”¨æ¬¡æ•°
- **æ—¶é—´çª—å£**ï¼š
  - ä½¿ç”¨zsetæ»‘åŠ¨äº‹ä»¶çª—å£ï¼Œæ¯æ¬¡è¯·æ±‚æ’å…¥ä¸€ä¸ªæ—¶é—´æˆ³ï¼Œè¶…è¿‡zsetä¸Šé™æ‹’ç»æœåŠ¡
  - æ»‘åŠ¨äº‹ä»¶çª—å£ï¼Œå°†çª—å£å¼€å§‹ç‚¹ä¹‹åŽçš„æ—¶é—´æˆ³åˆ é™¤ï¼Œä½¿æ–°çš„è¯·æ±‚å¯ä»¥è¢«æŽ¥å—
- **ä»¤ç‰Œæ¡¶**ï¼šé€‚ç”¨äºŽæŽ§åˆ¶è¯·æ±‚é€ŸçŽ‡ï¼Œèƒ½å¤Ÿå¹³æ»‘è¯·æ±‚æµé‡ï¼Œé€‚åˆæµé‡è¾ƒä¸ºçªå‘çš„åœºæ™¯ã€‚
  - æ¯éš”å›ºå®šäº‹ä»¶äº§ç”Ÿä¸€å—ä»¤ç‰Œï¼Œä»¤ç‰Œæ¶ˆè€—å®Œæ‹’ç»æœåŠ¡ï¼Œä»¤ç‰Œå †ç§¯å¯åº”å¯¹çªå‘æµé‡
- **æ¼æ¡¶ç®—æ³•**ï¼šé€‚åˆäºŽæµé‡æŽ§åˆ¶æ¯”è¾ƒä¸¥æ ¼çš„åœºæ™¯ï¼Œèƒ½å¤Ÿå¹³æ»‘æµé‡ï¼Œé˜²æ­¢è¯·æ±‚è¿‡å¿«ã€‚
  - ä½¿ç”¨listå­˜å‚¨è¯·æ±‚ï¼Œè®¾ç½®å®šæ—¶ä»»åŠ¡ä»Žlistä¸­èŽ·å–è¯·æ±‚ï¼Œæ¡¶æ»¡äº†æ‹’ç»è¯·æ±‚

æ ¹æ®å…·ä½“çš„ä¸šåŠ¡éœ€æ±‚ï¼Œå¯ä»¥é€‰æ‹©åˆé€‚çš„é™æµç®—æ³•ï¼Œå¹¶ä¸”çµæ´»ä½¿ç”¨ Redis æ¥å­˜å‚¨å’Œç®¡ç†é™æµçŠ¶æ€ï¼Œç¡®ä¿é«˜æ•ˆå’Œå¯æ‰©å±•æ€§ã€‚


# redisçš„ä¸»æµä½¿ç”¨åœºæ™¯
Redis æ˜¯ä¸€ç§é«˜æ€§èƒ½çš„å†…å­˜æ•°æ®åº“ï¼Œå¹¿æ³›åº”ç”¨äºŽå„ç§åœºæ™¯ã€‚ç”±äºŽå…¶æžé«˜çš„è¯»å†™æ€§èƒ½ï¼Œå®ƒåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿã€ç¼“å­˜ã€æ¶ˆæ¯é˜Ÿåˆ—ç­‰é¢†åŸŸéƒ½æœ‰å¹¿æ³›åº”ç”¨ã€‚ä¸‹é¢æˆ‘å°†ä¸ºä½ ä»‹ç»å‡ ä¸ª Redis çš„ä¸»æµä½¿ç”¨åœºæ™¯åŠå…¶å®žçŽ°å®žä¾‹ã€‚

## ä¸»æµä½¿ç”¨åœºæ™¯çš„å®žçŽ°
### 1. **ç¼“å­˜ç³»ç»Ÿ**

Redis å¸¸è¢«ä½œä¸ºç¼“å­˜ç³»ç»Ÿï¼Œå¸®åŠ©å‡å°‘æ•°æ®åº“çš„è´Ÿè½½å¹¶åŠ é€Ÿæ•°æ®è¯»å–ã€‚å°¤å…¶åœ¨è®¿é—®é¢‘ç¹ã€æ•°æ®å˜åŒ–ä¸é¢‘ç¹çš„åœºæ™¯ä¸­ï¼Œä½¿ç”¨ Redis ä½œä¸ºç¼“å­˜å¯ä»¥æ˜¾è‘—æé«˜åº”ç”¨æ€§èƒ½ã€‚

#### 1.1 **åœºæ™¯ï¼šç½‘ç«™å†…å®¹ç¼“å­˜**

å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªæ–°é—»ç½‘ç«™ï¼Œæ¯æ¬¡ç”¨æˆ·è¯·æ±‚é¡µé¢æ—¶ï¼ŒåŽç«¯ä¼šæŸ¥è¯¢æ•°æ®åº“èŽ·å–å†…å®¹ï¼Œå¦‚æžœæ²¡æœ‰ç¼“å­˜æœºåˆ¶ï¼Œæ¯æ¬¡è¯·æ±‚éƒ½ä¼šå¯¹æ•°æ®åº“è¿›è¡Œè®¿é—®ï¼Œå¯¼è‡´æ•°æ®åº“åŽ‹åŠ›è¿‡å¤§ã€‚ä½¿ç”¨ Redis å¯ä»¥å°†æ•°æ®åº“æŸ¥è¯¢ç»“æžœç¼“å­˜èµ·æ¥ï¼Œä¸‹æ¬¡ç”¨æˆ·è¯·æ±‚ç›¸åŒå†…å®¹æ—¶ï¼Œç›´æŽ¥ä»Ž Redis ä¸­èŽ·å–ï¼Œé¿å…äº†é¢‘ç¹çš„æ•°æ®åº“æŸ¥è¯¢ã€‚

**å®žçŽ°æ­¥éª¤ï¼š**
- é¦–å…ˆæŸ¥è¯¢ Redis ä¸­æ˜¯å¦å­˜åœ¨ç¼“å­˜ã€‚
- å¦‚æžœå­˜åœ¨ï¼Œç›´æŽ¥è¿”å›žç¼“å­˜å†…å®¹ã€‚
- å¦‚æžœä¸å­˜åœ¨ï¼Œä»Žæ•°æ®åº“èŽ·å–æ•°æ®å¹¶ç¼“å­˜åˆ° Redisã€‚

```python
import redis
import time

r = redis.Redis()

def get_news_article(article_id):
    # æž„é€ ç¼“å­˜é”®
    cache_key = f"news_article:{article_id}"

    # å…ˆæŸ¥è¯¢ç¼“å­˜
    cached_article = r.get(cache_key)
    if cached_article:
        print("Cache hit!")
        return cached_article.decode("utf-8")
    
    # å¦‚æžœç¼“å­˜æ²¡æœ‰ï¼ŒæŸ¥è¯¢æ•°æ®åº“
    print("Cache miss, fetching from DB...")
    article_data = fetch_article_from_db(article_id)

    # å°†æ•°æ®ç¼“å­˜åˆ° Redisï¼Œå¹¶è®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆæ¯”å¦‚ 10 åˆ†é’Ÿï¼‰
    r.setex(cache_key, 600, article_data)
    return article_data

def fetch_article_from_db(article_id):
    # æ¨¡æ‹Ÿä»Žæ•°æ®åº“èŽ·å–æ•°æ®
    time.sleep(1)  # æ¨¡æ‹Ÿæ•°æ®åº“å»¶è¿Ÿ
    return f"Article {article_id} content"
```

**ä¼˜ç‚¹**ï¼š
- æžå¤§åœ°å‡å°‘äº†æ•°æ®åº“è®¿é—®çš„é¢‘çŽ‡ï¼Œæå‡äº†å“åº”é€Ÿåº¦ã€‚
- æä¾›é«˜æ•ˆçš„æ•°æ®è¯»å–æœåŠ¡ã€‚

---

### 2. **ä¼šè¯ç®¡ç†ï¼ˆSession Managementï¼‰**

Redis è¿˜å¸¸ç”¨äºŽç®¡ç†ä¼šè¯æ•°æ®ï¼Œå°¤å…¶åœ¨éœ€è¦é«˜å¹¶å‘çš„ web åº”ç”¨ä¸­ï¼ŒRedis æä¾›äº†å¿«é€Ÿçš„è¯»å†™èƒ½åŠ›ï¼Œé€‚åˆå­˜å‚¨ç”¨æˆ·çš„ä¼šè¯ä¿¡æ¯ã€‚

#### 2.1 **åœºæ™¯ï¼šWeb åº”ç”¨çš„ä¼šè¯å­˜å‚¨**

åœ¨å¾ˆå¤š Web åº”ç”¨ä¸­ï¼Œéœ€è¦ä¿å­˜ç”¨æˆ·çš„ç™»å½•çŠ¶æ€ï¼ˆä¾‹å¦‚ï¼štokenã€ç”¨æˆ·ä¿¡æ¯ç­‰ï¼‰ã€‚é€šå¸¸æˆ‘ä»¬ä¼šä½¿ç”¨ Redis æ¥å­˜å‚¨è¿™äº›ä¼šè¯æ•°æ®ï¼Œå› ä¸ºå®ƒçš„è¯»å†™é€Ÿåº¦éžå¸¸å¿«ï¼Œä¸”æ”¯æŒæ•°æ®è¿‡æœŸåŠŸèƒ½ã€‚

**å®žçŽ°æ­¥éª¤ï¼š**
- å½“ç”¨æˆ·ç™»å½•æ—¶ï¼Œå°†ç”¨æˆ·ä¿¡æ¯å­˜å‚¨åˆ° Redis ä¸­ï¼Œå¹¶ä¸ºå…¶åˆ†é…ä¸€ä¸ªå”¯ä¸€çš„ session IDã€‚
- åœ¨åŽç»­çš„è¯·æ±‚ä¸­ï¼Œé€šè¿‡ session ID æ¥éªŒè¯ç”¨æˆ·èº«ä»½ã€‚

```python
import redis

r = redis.Redis()

def create_session(user_id):
    # åˆ›å»ºä¸€ä¸ªå”¯ä¸€çš„ session ID
    session_id = f"session:{user_id}"

    # å°†ç”¨æˆ·ä¿¡æ¯å­˜å‚¨åˆ° Redis ä¸­
    r.set(session_id, f"user:{user_id} info", ex=3600)  # è¿‡æœŸæ—¶é—´ä¸º 1 å°æ—¶
    return session_id

def get_session(session_id):
    # èŽ·å– session ä¿¡æ¯
    session_info = r.get(session_id)
    if session_info:
        return session_info.decode("utf-8")
    else:
        return None
```

**ä¼˜ç‚¹**ï¼š
- Redis æä¾›äº†å¿«é€Ÿçš„å­˜å–é€Ÿåº¦ï¼Œä¿è¯ä¼šè¯ç®¡ç†çš„é«˜æ•ˆæ€§ã€‚
- é€šè¿‡è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œå¯ä»¥è‡ªåŠ¨æ¸…ç†è¿‡æœŸä¼šè¯ï¼Œé¿å…å­˜å‚¨æµªè´¹ã€‚

---

### 3. **å‘å¸ƒ/è®¢é˜…ï¼ˆPub/Subï¼‰**

Redis çš„å‘å¸ƒ/è®¢é˜…åŠŸèƒ½å¯ä»¥å®žçŽ°å¤šå¯¹å¤šçš„æ¶ˆæ¯ä¼ é€’ç³»ç»Ÿï¼Œé€‚ç”¨äºŽå®žæ—¶æ¶ˆæ¯æŽ¨é€ã€é€šçŸ¥ç³»ç»Ÿç­‰åœºæ™¯ã€‚

#### 3.1 **åœºæ™¯ï¼šå®žæ—¶é€šçŸ¥ç³»ç»Ÿ**

åœ¨ä¸€äº›å®žæ—¶æ¶ˆæ¯æŽ¨é€ç³»ç»Ÿä¸­ï¼ŒRedis æä¾›çš„å‘å¸ƒ/è®¢é˜…æ¨¡å¼éžå¸¸æœ‰ç”¨ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªç¤¾äº¤ç½‘ç»œåº”ç”¨å¯ä»¥é€šè¿‡ Redis æ¥å®žæ—¶æŽ¨é€ç”¨æˆ·æ¶ˆæ¯ã€é€šçŸ¥ç­‰ã€‚

**å®žçŽ°æ­¥éª¤ï¼š**
- å‘å¸ƒæ–¹é€šè¿‡ `PUBLISH` å‘½ä»¤å‘æŒ‡å®šé¢‘é“å‘é€æ¶ˆæ¯ã€‚
- è®¢é˜…æ–¹é€šè¿‡ `SUBSCRIBE` å‘½ä»¤è®¢é˜…æŸä¸ªé¢‘é“ï¼Œå®žæ—¶æŽ¥æ”¶æ¶ˆæ¯ã€‚

```python
import redis

r = redis.Redis()

# è®¢é˜…æ–¹
def subscribe_channel(channel_name):
    pubsub = r.pubsub()
    pubsub.subscribe(channel_name)
    
    # ç­‰å¾…æŽ¥æ”¶æ¶ˆæ¯
    for message in pubsub.listen():
        print(message['data'])

# å‘å¸ƒæ–¹
def publish_message(channel_name, message):
    r.publish(channel_name, message)

# ç¤ºä¾‹ï¼šè®¢é˜…ä¸€ä¸ªæ¶ˆæ¯é¢‘é“
# subscribe_channel("news_channel")

# ç¤ºä¾‹ï¼šå‘å¸ƒä¸€æ¡æ¶ˆæ¯
# publish_message("news_channel", "New article published!")
```

**ä¼˜ç‚¹**ï¼š
- æ”¯æŒå®žæ—¶æ¶ˆæ¯æŽ¨é€ï¼Œé€‚åˆå³æ—¶é€šè®¯ã€å®žæ—¶é€šçŸ¥ç­‰åº”ç”¨ã€‚
- å¯ä»¥æ”¯æŒå¤šç§æ¶ˆæ¯çš„å¹¿æ’­å’Œåˆ†å‘ã€‚

---

### 4. **åˆ†å¸ƒå¼é”ï¼ˆDistributed Lockï¼‰**

åˆ†å¸ƒå¼é”æ˜¯ä¸€ç§ç¡®ä¿åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¤šä¸ªå®¢æˆ·ç«¯è¯·æ±‚å…±äº«èµ„æºæ—¶ï¼Œèƒ½å¤Ÿä¿è¯åªæœ‰ä¸€ä¸ªå®¢æˆ·ç«¯èƒ½è®¿é—®èµ„æºçš„æœºåˆ¶ã€‚

#### 4.1 **åœºæ™¯ï¼šé˜²æ­¢å¤šçº¿ç¨‹/å¤šè¿›ç¨‹åŒæ—¶è®¿é—®æŸä¸ªèµ„æº**

å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªæŠ¢è´­ç³»ç»Ÿï¼Œå¤šä¸ªç”¨æˆ·åœ¨åŒä¸€æ—¶é—´è¯·æ±‚è´­ä¹°åŒä¸€ä¸ªå•†å“ï¼Œè¿™æ—¶å€™å¦‚æžœä¸åŠ é”ï¼Œå¯èƒ½ä¼šå¯¼è‡´åº“å­˜æ•°æ®ä¸ä¸€è‡´ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Redis æ¥å®žçŽ°åˆ†å¸ƒå¼é”ï¼Œç¡®ä¿æ¯æ¬¡åªæœ‰ä¸€ä¸ªç”¨æˆ·èƒ½æ“ä½œåº“å­˜ã€‚

**å®žçŽ°æ­¥éª¤ï¼š**
- ä½¿ç”¨ Redis çš„ `SETNX` å‘½ä»¤ï¼ˆ`SET if Not Exists`ï¼‰æ¥å°è¯•èŽ·å–é”ã€‚
- é”å®šåŽæ‰§è¡Œæ“ä½œï¼Œå®ŒæˆåŽé‡Šæ”¾é”ã€‚

```python
import redis
import time

r = redis.Redis()

def acquire_lock(lock_key, timeout=10):
    # å°è¯•è®¾ç½®é”
    return r.setnx(lock_key, "locked")  # è¿”å›ž 1 è¡¨ç¤ºèŽ·å–æˆåŠŸ

def release_lock(lock_key):
    # åˆ é™¤é”
    r.delete(lock_key)

def purchase_item():
    lock_key = "product_lock"
    
    if acquire_lock(lock_key):
        print("Lock acquired, proceeding with purchase...")
        
        # æ‰§è¡ŒæŠ¢è´­é€»è¾‘
        time.sleep(2)  # æ¨¡æ‹Ÿå¤„ç†æ—¶é—´
        print("Purchase completed.")
        
        release_lock(lock_key)  # é‡Šæ”¾é”
    else:
        print("Unable to acquire lock, please try again later.")
```

**ä¼˜ç‚¹**ï¼š
- ä¿è¯åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªå®¢æˆ·ç«¯èƒ½æ“ä½œæŸä¸ªèµ„æºï¼Œé¿å…å¹¶å‘å†²çªã€‚
- é«˜æ•ˆä¸”ç®€å•ï¼Œé€šè¿‡ Redis çš„åŽŸå­æ“ä½œä¿è¯é”çš„æ­£ç¡®æ€§ã€‚

---

### 5. **æŽ’è¡Œæ¦œï¼ˆLeaderboardsï¼‰**

Redis çš„æœ‰åºé›†åˆï¼ˆ`ZSET`ï¼‰éžå¸¸é€‚åˆå®žçŽ°æŽ’è¡Œæ¦œåŠŸèƒ½ã€‚å®ƒæ”¯æŒæ ¹æ®åˆ†æ•°å¯¹å…ƒç´ è¿›è¡ŒæŽ’åºï¼Œé€‚åˆåšå®žæ—¶çš„æŽ’åã€è¯„åˆ†ç³»ç»Ÿç­‰ã€‚

#### 5.1 **åœºæ™¯ï¼šæ¸¸æˆæŽ’è¡Œæ¦œ**

åœ¨æ¸¸æˆä¸­ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦å®žæ—¶å±•ç¤ºçŽ©å®¶çš„å¾—åˆ†æŽ’è¡Œã€‚é€šè¿‡ Redis çš„æœ‰åºé›†åˆï¼Œèƒ½å¤Ÿé«˜æ•ˆåœ°èŽ·å–å‰ N åçŽ©å®¶ã€‚

**å®žçŽ°æ­¥éª¤ï¼š**
- å°†çŽ©å®¶çš„å¾—åˆ†ä½œä¸ºåˆ†æ•°ï¼ŒçŽ©å®¶çš„ ID ä½œä¸ºå…ƒç´ ï¼Œå­˜å‚¨åˆ° Redis çš„æœ‰åºé›†åˆä¸­ã€‚
- å¯ä»¥ä½¿ç”¨ `ZREVRANGE` å‘½ä»¤èŽ·å–æŽ’åå‰ N çš„çŽ©å®¶ã€‚

```python
import redis

r = redis.Redis()

def add_score(player_id, score):
    r.zadd("game_leaderboard", {player_id: score})

def get_top_players():
    return r.zrevrange("game_leaderboard", 0, 10, withscores=True)

# ç¤ºä¾‹ï¼šç»™çŽ©å®¶æ·»åŠ åˆ†æ•°
add_score("player1", 100)
add_score("player2", 200)

# èŽ·å–å‰ 10 åçŽ©å®¶
top_players = get_top_players()
for player, score in top_players:
    print(f"Player: {player.decode('utf-8')}, Score: {score}")
```

**ä¼˜ç‚¹**ï¼š
- Redis æœ‰åºé›†åˆçš„å†…å­˜å­˜å‚¨å’ŒæŽ’åºèƒ½åŠ›ï¼Œä½¿å¾—æŽ’è¡Œæ¦œæ“ä½œéžå¸¸é«˜æ•ˆã€‚
- æ”¯æŒæŽ’åæŸ¥è¯¢ã€å‰ N åèŽ·å–ç­‰æ“ä½œï¼Œæ»¡è¶³å®žæ—¶æ›´æ–°çš„éœ€æ±‚ã€‚

---

### æ€»ç»“

Redis æ˜¯ä¸€ç§éžå¸¸å¼ºå¤§çš„å·¥å…·ï¼Œé€‚ç”¨äºŽå¤šç§åœºæ™¯ã€‚å®ƒçš„é«˜æ€§èƒ½å’Œä¸°å¯Œçš„æ•°æ®ç»“æž„ï¼Œä½¿å¾—å®ƒåœ¨ç¼“å­˜ã€ä¼šè¯ç®¡ç†ã€å®žæ—¶æŽ¨é€ã€åˆ†å¸ƒå¼é”ã€æŽ’è¡Œæ¦œç­‰åœºæ™¯ä¸­å¾—åˆ°äº†å¹¿æ³›åº”ç”¨ã€‚é€šè¿‡ Redisï¼Œå¯ä»¥æ˜¾è‘—æé«˜ç³»ç»Ÿçš„å“åº”é€Ÿåº¦ï¼Œé™ä½Žæ•°æ®åº“çš„åŽ‹åŠ›ï¼Œç¡®ä¿ç³»ç»Ÿçš„é«˜å¯ç”¨æ€§ã€‚

è¿™äº›åªæ˜¯ Redis åº”ç”¨çš„ä¸€äº›ç¤ºä¾‹ï¼Œå®žé™…ä½¿ç”¨ä¸­ï¼Œä½ å¯ä»¥æ ¹æ®ä¸šåŠ¡éœ€æ±‚çµæ´»ç»„åˆå’Œæ‰©å±• Redis çš„åŠŸèƒ½ã€‚

## æŽ’è¡Œæ¦œç”¨æˆ·æ•°é‡æžå¤§çš„åœºæ™¯



