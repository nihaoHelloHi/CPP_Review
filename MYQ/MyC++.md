# c++ç¼–è¯‘é“¾æ¥æµç¨‹
## ç¼–è¯‘é“¾æ¥æµç¨‹
### ç¼–è¯‘å‘½ä»¤

```bash
g++ hello.cpp -o hello
```

è¿™ä¸€æ­¥åšäº†å¾ˆå¤šäº‹ï¼š

| é˜¶æ®µ         | å·¥å…·           | ä½œç”¨                       |
|--------------|----------------|----------------------------|
| é¢„å¤„ç†       | `cpp`          | å±•å¼€ `#include` ç­‰å®æŒ‡ä»¤   |
| ç¼–è¯‘         | `cc1plus`      | æŠŠ C++ è½¬æˆæ±‡ç¼–             |
| æ±‡ç¼–         | `as`           | æŠŠæ±‡ç¼–è½¬æˆç›®æ ‡æ–‡ä»¶ `.o`    |
| é“¾æ¥         | `ld`           | æŠŠç›®æ ‡æ–‡ä»¶å’Œåº“é“¾æ¥ä¸º `ELF` å¯æ‰§è¡Œæ–‡ä»¶ |

---
C++ çš„ **ç¼–è¯‘é“¾æ¥æµç¨‹** æ˜¯å°†æºä»£ç å˜æˆå¯æ‰§è¡Œæ–‡ä»¶çš„å…¨è¿‡ç¨‹ï¼Œé€šå¸¸åˆ†ä¸ºå››ä¸ªä¸»è¦é˜¶æ®µï¼š

---

### ğŸ”§ ä¸€ã€é¢„å¤„ç†ï¼ˆPreprocessingï¼‰

å‘½ä»¤ï¼š`g++ -E main.cpp -o main.i`

#### åšäº†ä»€ä¹ˆï¼š
- å±•å¼€ `#include` æ–‡ä»¶
- æ›¿æ¢å®å®šä¹‰ `#define`
- å¤„ç†æ¡ä»¶ç¼–è¯‘ `#ifdef`ã€`#ifndef` ç­‰

#### ç¤ºä¾‹ï¼š
```cpp
#include <iostream>
#define PI 3.14
```
â¡ï¸ ä¼šå˜æˆå±•å¼€åçš„æ–‡æœ¬ï¼ˆæ’å…¥ `<iostream>` çš„å†…å®¹ï¼Œå®æ›¿æ¢ä¸º `3.14`ï¼‰

---

### ğŸ”¨ äºŒã€ç¼–è¯‘ï¼ˆCompilationï¼‰

å‘½ä»¤ï¼š`g++ -S main.i -o main.s`

#### åšäº†ä»€ä¹ˆï¼š
- å°† **é¢„å¤„ç†åçš„ä»£ç ** è½¬æ¢ä¸º **æ±‡ç¼–ä»£ç **
- è¯­æ³•åˆ†æ + è¯­ä¹‰åˆ†æ + ç”Ÿæˆä¸­é—´ä»£ç  + ä¼˜åŒ– + æ±‡ç¼–ä»£ç ç”Ÿæˆ

#### ç¤ºä¾‹ï¼š
```cpp
int main() {
    return 0;
}
```
â¡ï¸ ç¼–è¯‘å™¨ä¼šç”Ÿæˆ `.s` æ±‡ç¼–æ–‡ä»¶ï¼Œå¯¹åº” `main` å‡½æ•°çš„æ±‡ç¼–å®ç°ã€‚

---

### ğŸ§± ä¸‰ã€æ±‡ç¼–ï¼ˆAssemblingï¼‰

å‘½ä»¤ï¼š`g++ -c main.s -o main.o`

#### åšäº†ä»€ä¹ˆï¼š
- å°†æ±‡ç¼–ä»£ç  `.s` è½¬ä¸ºæœºå™¨ç ï¼Œç”Ÿæˆç›®æ ‡æ–‡ä»¶ `.o`
- æœºå™¨ç è¿˜ä¸æ˜¯æœ€ç»ˆç¨‹åºï¼Œé‡Œé¢çš„å‡½æ•°åœ°å€ã€å˜é‡åœ°å€è¿˜æ˜¯**ç›¸å¯¹çš„æˆ–æœªè§£æçš„**

---

### ğŸ”— å››ã€é“¾æ¥ï¼ˆLinkingï¼‰

å‘½ä»¤ï¼š`g++ main.o -o main`

#### åšäº†ä»€ä¹ˆï¼š
- æŠŠå¤šä¸ª `.o` æ–‡ä»¶ã€**åº“æ–‡ä»¶**ï¼ˆå¦‚ `libstdc++`ï¼‰åˆå¹¶æˆä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶
- è§£æå‡½æ•°è°ƒç”¨ã€å˜é‡å¼•ç”¨ç­‰ç¬¦å·
- è¡¥å…¨åœ°å€ï¼Œç”Ÿæˆæœ€ç»ˆå¯æ‰§è¡Œçš„ ELF æ–‡ä»¶ï¼ˆLinux ä¸‹ï¼‰

#### ä¼šå¤„ç†çš„é—®é¢˜ï¼š
- å¤šä¸ª `.cpp` æ–‡ä»¶ä¸­çš„å‡½æ•°è°ƒç”¨
- åº“å‡½æ•°çš„è¿æ¥ï¼Œå¦‚ `std::cout`ã€`malloc` ç­‰
- æ£€æŸ¥é‡å®šä¹‰ã€æœªå®šä¹‰å¼•ç”¨ç­‰é”™è¯¯

---

### ğŸ§  æ€»ç»“ä¸€å¼ å›¾ï¼š

```text
main.cpp
   â†“   é¢„å¤„ç†ï¼ˆå±•å¼€å¤´æ–‡ä»¶ï¼‰
main.i
   â†“   ç¼–è¯‘ï¼ˆç”Ÿæˆæ±‡ç¼–ï¼‰
main.s
   â†“   æ±‡ç¼–ï¼ˆç”Ÿæˆç›®æ ‡æ–‡ä»¶ï¼‰
main.o
   â†“   é“¾æ¥ï¼ˆåˆå¹¶ç¬¦å·åœ°å€ï¼‰
mainï¼ˆå¯æ‰§è¡Œæ–‡ä»¶ï¼‰
```

---

### ğŸ¯ å¸¸è§é”™è¯¯ç¤ºä¾‹

| é”™è¯¯ | å‡ºç°é˜¶æ®µ | è¯´æ˜ |
|------|---------|------|
| è¯­æ³•é”™è¯¯ | ç¼–è¯‘é˜¶æ®µ | æ¯”å¦‚æ¼å†™åˆ†å· |
| undefined reference to `foo()` | é“¾æ¥é˜¶æ®µ | æ‰¾ä¸åˆ°å‡½æ•°å®šä¹‰ |
| multiple definition of `var` | é“¾æ¥é˜¶æ®µ | å¤šä¸ª `.cpp` ä¸­å®šä¹‰äº†åŒåå…¨å±€å˜é‡ |

---

å¦‚æœä½ æƒ³äº†è§£é“¾æ¥å™¨å¦‚ä½•å¤„ç†å¤šä¸ª `.o` æ–‡ä»¶æˆ–å¦‚ä½•ä½¿ç”¨ `static`ã€`extern` æ§åˆ¶ç¬¦å·çš„é“¾æ¥ä½œç”¨åŸŸï¼Œä¹Ÿå¯ä»¥ç»§ç»­é—®æˆ‘ ğŸ˜

## .oæ–‡ä»¶ ELFï¼ˆExecutable and Linkable Formatï¼‰
å¥½é—®é¢˜ï¼æˆ‘ä»¬æ¥æ·±å…¥èŠä¸€èŠç¼–è¯‘åçš„ `.o` æ–‡ä»¶æ ¼å¼â€”â€”**ELFï¼ˆExecutable and Linkable Formatï¼‰**ï¼Œè¿™æ˜¯ Linux ç­‰ç±» Unix ç³»ç»Ÿä¸‹çš„æ ‡å‡†å¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼ã€‚

---

### âœ… ä»€ä¹ˆæ˜¯ ELFï¼Ÿ

**ELFï¼ˆExecutable and Linkable Formatï¼‰** æ˜¯ä¸€ç§ç”¨äºè¡¨ç¤ºå¯æ‰§è¡Œæ–‡ä»¶ã€ç›®æ ‡æ–‡ä»¶ï¼ˆ`.o`ï¼‰ã€å…±äº«åº“ï¼ˆ`.so`ï¼‰ä»¥åŠæ ¸å¿ƒè½¬å‚¨ï¼ˆcore dumpï¼‰çš„é€šç”¨æ–‡ä»¶æ ¼å¼ã€‚

åœ¨ C++ ç¼–è¯‘è¿‡ç¨‹ä¸­ï¼Œ`.cpp` æºæ–‡ä»¶è¢«ç¼–è¯‘ä¸º `.o` å¯¹è±¡æ–‡ä»¶ï¼Œæ ¼å¼å°±æ˜¯ ELFã€‚

---

### ğŸ“¦ ELF çš„åŸºæœ¬ç»“æ„

ä¸€ä¸ª ELF æ–‡ä»¶ï¼ˆæ¯”å¦‚ `.o` æ–‡ä»¶ï¼‰ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

```
+------------------+
| ELF Header       |
+------------------+
| Section Headers  | <--- æè¿°å„ä¸ªæ®µçš„ä¿¡æ¯
+------------------+
| .text section    | <--- ä»£ç æ®µï¼ˆæœºå™¨æŒ‡ä»¤ï¼‰
+------------------+
| .data section    | <--- å·²åˆå§‹åŒ–çš„å…¨å±€å˜é‡
+------------------+
| .bss section     | <--- æœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡ï¼ˆä¸ä¼šå®é™…å ç©ºé—´ï¼‰
+------------------+
| .rodata section  | <--- åªè¯»æ•°æ®ï¼ˆå¸¸é‡å­—ç¬¦ä¸²ç­‰ï¼‰
+------------------+
| .symtab section  | <--- ç¬¦å·è¡¨ï¼ˆå˜é‡ã€å‡½æ•°åç­‰ï¼‰
+------------------+
| .rel/.rela       | <--- é‡å®šä½è¡¨ï¼ˆé“¾æ¥æ—¶ä½¿ç”¨ï¼‰
+------------------+
| .debug section   | <--- è°ƒè¯•ä¿¡æ¯ï¼ˆå¦‚æœä¿ç•™äº†ï¼‰
+------------------+
```

---

### ğŸ” å¸¸è§ `.o` ä¸­çš„å‡ ä¸ªé‡è¦æ®µï¼ˆSectionsï¼‰

| æ®µå       | ä½œç”¨ |
|------------|------|
| `.text`    | å­˜å‚¨ç¨‹åºçš„**æœºå™¨ä»£ç **ï¼ˆå‡½æ•°ä½“ç­‰ï¼‰ |
| `.data`    | å·²åˆå§‹åŒ–çš„å…¨å±€/é™æ€å˜é‡ |
| `.bss`     | æœªåˆå§‹åŒ–çš„å…¨å±€/é™æ€å˜é‡ï¼ˆè¿è¡Œæ—¶ä¸ºå…¶åˆ†é…å†…å­˜ï¼‰ |
| `.rodata`  | å¸¸é‡æ•°æ®ï¼ˆå¦‚å­—ç¬¦ä¸²å­—é¢é‡ï¼‰ |
| `.symtab`  | ç¬¦å·è¡¨ï¼šè®°å½•å˜é‡ã€å‡½æ•°ç­‰çš„ç¬¦å·åŠå…¶ä½ç½® |
| `.rel.text` æˆ– `.rela.text` | æè¿° `.text` æ®µä¸­çš„**å¾…é“¾æ¥ç¬¦å·** |
| `.debug_*` | GCC æˆ– clang åœ¨å¼€å¯ `-g` é€‰é¡¹æ—¶ç”Ÿæˆçš„è°ƒè¯•ä¿¡æ¯ |

---

### ğŸ“ ELF æ–‡ä»¶ vs é“¾æ¥å™¨ vs å¯æ‰§è¡Œæ–‡ä»¶

- `.o` æ˜¯ ELF æ ¼å¼çš„**ä¸­é—´ç›®æ ‡æ–‡ä»¶**ï¼ˆä¸æ˜¯å®Œæ•´å¯æ‰§è¡Œç¨‹åºï¼‰
- å¤šä¸ª `.o` æ–‡ä»¶ä¼šåœ¨é“¾æ¥æ—¶è¢« `ld` é“¾æ¥ä¸ºä¸€ä¸ªå®Œæ•´çš„ ELF å¯æ‰§è¡Œæ–‡ä»¶æˆ– `.so` å…±äº«åº“
- é“¾æ¥å®Œæˆåä»ç„¶æ˜¯ ELFï¼Œä½†ç»“æ„æ›´å¤æ‚ï¼ˆå«æ®µè¡¨ + ç¨‹åºå¤´è¡¨ï¼‰

---

### ğŸ› ï¸ å·¥å…·æŸ¥çœ‹ ELF æ–‡ä»¶

ä½ å¯ä»¥ç”¨ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹ `.o` æ–‡ä»¶çš„ ELF ä¿¡æ¯ï¼š

```bash
readelf -a test.o      # æŸ¥çœ‹å…¨éƒ¨ä¿¡æ¯
readelf -S test.o      # æŸ¥çœ‹ section è¡¨
nm test.o              # æŸ¥çœ‹ç¬¦å·è¡¨
objdump -d test.o      # åæ±‡ç¼–ä»£ç æ®µ
```

---

### ğŸ’¡ å°ç»“

| é¡¹ | å†…å®¹ |
|----|------|
| `.o` æ–‡ä»¶æ ¼å¼ | ELFï¼ˆExecutable and Linkable Formatï¼‰ |
| åŒ…å«å†…å®¹ | ä»£ç ã€æ•°æ®ã€ç¬¦å·è¡¨ã€é‡å®šä½ä¿¡æ¯ã€è°ƒè¯•ä¿¡æ¯ç­‰ |
| ä½œç”¨ | æä¾›ä¸­é—´ä»£ç ä¾›é“¾æ¥å™¨ç»„åˆä¸ºæœ€ç»ˆç¨‹åº |
| å¯è¯»å·¥å…· | `readelf`ã€`nm`ã€`objdump` ç­‰ |

å¦‚æœä½ æƒ³ï¼Œæˆ‘å¯ä»¥å¸¦ä½ æ‰‹åŠ¨åˆ†æä¸€ä¸ª `.o` æ–‡ä»¶ç”Ÿæˆçš„ ELF ç»“æ„ï¼Œæ¥ä¸ªå°å®æˆ˜ä¹Ÿä¸é”™ ğŸ˜



# C++11æ–°ç‰¹æ€§
![alt text](image-102.png)

# å·¦å€¼ & å³å€¼ & å¼•ç”¨ & ç§»åŠ¨ & å®Œç¾è½¬å‘
![alt text](image-100.png)
![alt text](image-101.png)

ç§»åŠ¨è¯­ä¹‰å°±æ˜¯å°†èµ„æºçš„æ‰€æœ‰æƒè¿›è¡Œè½¬è®©ï¼Œè€Œä¸æ˜¯å¯¹å…¶è¿›è¡Œæ‹·è´ï¼Œæå‡ç¨‹åºçš„æ€§èƒ½

å®Œç¾è½¬å‘å…¶å®å°±æ˜¯åˆ©ç”¨å¼•ç”¨æŠ˜å ï¼Œå‡†ç¡®çš„ä¼ é€’å‚æ•°çš„å€¼ç±»åˆ«(å·¦å€¼æˆ–å³å€¼)ï¼Œé¿å…å‚æ•°ä¼ é€’è¿‡ç¨‹ä¸­å‘ç”Ÿå¤šä½™çš„æ‹·è´æˆ–ç§»åŠ¨æ„é€ 
```cpp
void PrintV(int &t) {
    cout << "lvalue" << endl;
}

void PrintV(int &&t) {
    cout << "rvalue" << endl;
}

template<typename T>
void Test(T &&t) {
    PrintV(t);
    PrintV(std::forward<T>(t));

    PrintV(std::move(t));
}

int main() {
    Test(1); // lvalue rvalue rvalue
    int a = 1;
    Test(a); // lvalue lvalue rvalue
    Test(std::forward<int>(a)); // lvalue rvalue rvalue
    Test(std::forward<int&>(a)); // lvalue lvalue rvalue
    Test(std::forward<int&&>(a)); // lvalue rvalue rvalue
    return 0;
}

```

# åˆ—è¡¨åˆå§‹åŒ–
- é¿å…ç±»å‹çª„åŒ–ï¼Œé˜²æ­¢å› éšå¼è½¬åŒ–å‘ç”Ÿçš„ç²¾åº¦ä¸¢å¤±(float->int)
- å¯¹äºå®¹å™¨ï¼Œå¯ä»¥æ¥å—ä»»æ„çš„åˆå§‹åŒ–é•¿åº¦
- å¯ä»¥ç›´æ¥ç”¨èšåˆç±»å‹å¦‚structçš„åˆå§‹åŒ–ï¼Œ

## STLåˆ—è¡¨åˆå§‹åŒ–åŸç†
### **`std::vector<int> arr = {1,2};` åˆ—è¡¨åˆå§‹åŒ–çš„åº•å±‚è¿‡ç¨‹**
åœ¨ C++11 ä¹‹åï¼Œ`std::vector` å¯ä»¥ä½¿ç”¨ **åˆ—è¡¨åˆå§‹åŒ–** è¿›è¡Œåˆå§‹åŒ–ï¼Œä¾‹å¦‚ï¼š
```cpp
std::vector<int> arr = {1, 2};
```
å…¶åº•å±‚æ¶‰åŠå¤šä¸ªæ­¥éª¤ï¼Œä¸‹é¢è¯¦ç»†è§£æå…¶æ•´ä¸ªè¿‡ç¨‹ã€‚

---

### **1. è§£æ `std::vector<int> arr = {1,2};`**
ç¼–è¯‘å™¨çœ‹åˆ° `{1, 2}` æ—¶ï¼Œä¼šå°è¯•åŒ¹é… `std::vector` æä¾›çš„ **æ„é€ å‡½æ•°**ã€‚
C++11 çš„ `std::vector` æä¾›äº†ä¸€ä¸ª **`std::initializer_list<T>` æ„é€ å‡½æ•°**ï¼š
```cpp
explicit vector(std::initializer_list<T> init, 
                const Allocator& alloc = Allocator());
```
ç”±äº `{1,2}` æ˜¯ `std::initializer_list<int>` ç±»å‹ï¼Œå› æ­¤ **åŒ¹é…è¿™ä¸ªæ„é€ å‡½æ•°**ï¼Œå¹¶æ‰§è¡Œï¼š

```cpp
std::vector<int> arr(std::initializer_list<int>{1,2});
```

---

### **2. `std::initializer_list<int>` çš„åº•å±‚**
`std::initializer_list<T>` æ˜¯ä¸€ä¸ª **è½»é‡çº§çš„ä»£ç†å¯¹è±¡**ï¼Œå®ƒå¹¶ä¸ä¼šå­˜å‚¨æ•°æ®ï¼Œè€Œæ˜¯æŒ‡å‘ä¸€æ®µä¸´æ—¶æ•°ç»„ã€‚å…¶å®ç°ç±»ä¼¼ï¼š
```cpp
template <typename T>
class initializer_list {
private:
    const T* array;  // æŒ‡å‘æ•°æ®çš„æŒ‡é’ˆ
    size_t size;     // æ•°æ®å¤§å°
public:
    constexpr initializer_list(const T* first, size_t sz) : array(first), size(sz) {}
    
    constexpr const T* begin() const { return array; }
    constexpr const T* end() const { return array + size; }
    constexpr size_t size() const { return size; }
};

```
å¯¹äº `{1,2}`ï¼Œç¼–è¯‘å™¨ä¼šåˆ›å»ºä¸€ä¸ª `std::initializer_list<int>`ï¼Œå¹¶å­˜æ”¾ `1,2` åˆ°ä¸€ä¸ª **ä¸´æ—¶æ•°ç»„**ï¼ˆé€šå¸¸å­˜æ”¾åœ¨æ ˆæˆ–é™æ€å­˜å‚¨åŒºï¼‰ã€‚

---

### **3. `std::vector` æ„é€ è¿‡ç¨‹**
 **(1) `std::vector` è§£æ `std::initializer_list<T>`**
è¿›å…¥ `std::vector` çš„æ„é€ å‡½æ•°ï¼š
```cpp
template <typename T, typename Allocator = std::allocator<T>>
class vector {
public:
    explicit vector(std::initializer_list<T> init, const Allocator& alloc = Allocator()) {
        size_t n = init.size();
        start = allocate(n);  // åˆ†é… n ä¸ªå…ƒç´ çš„å†…å­˜
        finish = start;
        end_of_storage = start + n;
        std::uninitialized_copy(init.begin(), init.end(), start);  // å¤åˆ¶æ•°æ®
    }
};
```
 **(2) `allocate(n)` åˆ†é…å†…å­˜**
é»˜è®¤ `std::allocator<T>` è´Ÿè´£å†…å­˜åˆ†é…ï¼š
```cpp
T* allocate(size_t n) {
    return static_cast<T*>(::operator new(n * sizeof(T)));
}
```
å¦‚æœ `n=2`ï¼Œåˆ™ `allocate(2)` ä¼šè°ƒç”¨ `operator new(2 * sizeof(int))`ï¼Œåˆ†é… **è¶³å¤Ÿå­˜å‚¨ 2 ä¸ª `int` çš„å †ç©ºé—´**ã€‚

 **(3) `std::uninitialized_copy` å¤åˆ¶æ•°æ®**
```cpp
T* uninitialized_copy(const T* first, const T* last, T* dest) {
    while (first != last) {
        new (dest) T(*first);  // åœ¨ç›®æ ‡åœ°å€ä¸Šè°ƒç”¨æ„é€ å‡½æ•°
        ++dest;
        ++first;
    }
    return dest;
}
```
è¿™é‡Œçš„ `new (dest) T(*first);` **ä½¿ç”¨äº† placement new**ï¼Œå®ƒä¸ä¼šé‡æ–°åˆ†é…å†…å­˜ï¼Œè€Œæ˜¯åœ¨ `dest` æŒ‡å‘çš„åœ°å€ä¸Šæ„é€ å¯¹è±¡ã€‚  
æ‰§è¡Œå®Œåï¼Œ`arr` å†…éƒ¨çš„æ•°æ®å­˜å‚¨å˜ä¸ºï¼š
```
start ---> [1] [2] (end_of_storage)
```
è¡¨ç¤º `std::vector<int>` ç°åœ¨å­˜å‚¨äº† `{1,2}`ã€‚

---

### **4. å˜é‡ `arr` ä½œç”¨åŸŸç»“æŸï¼Œææ„é‡Šæ”¾å†…å­˜**
å½“ `arr` ä½œç”¨åŸŸç»“æŸï¼Œè°ƒç”¨ `std::vector` çš„ææ„å‡½æ•°ï¼š
```cpp
~vector() {
    for (T* p = start; p != finish; ++p) {
        p->~T();  // è°ƒç”¨ææ„å‡½æ•°
    }
    ::operator delete(start);  // é‡Šæ”¾å †å†…å­˜
}
```
ç”±äº `int` æ²¡æœ‰å¤æ‚ææ„é€»è¾‘ï¼Œå› æ­¤ `p->~T();` æ²¡æœ‰å½±å“ï¼Œä½† `::operator delete(start);` é‡Šæ”¾äº†å †å†…å­˜ã€‚

---

### **æ€»ç»“**
å¯¹äº `std::vector<int> arr = {1,2};`ï¼š
1. **åˆ›å»º `std::initializer_list<int>`**ï¼ŒæŒ‡å‘ `{1,2}` è¿™ä¸ªä¸´æ—¶æ•°ç»„ã€‚
2. **è°ƒç”¨ `std::vector(std::initializer_list<T>)` æ„é€ å‡½æ•°**ï¼Œç¡®å®šå­˜å‚¨å¤§å°ã€‚
3. **è°ƒç”¨ `allocate(n)` åˆ†é… `n` ä¸ª `int` çš„å †å†…å­˜**ã€‚
4. **è°ƒç”¨ `std::uninitialized_copy` å¤åˆ¶ `{1,2}` åˆ°å †å†…å­˜**ã€‚
5. **ææ„æ—¶è°ƒç”¨ `operator delete` é‡Šæ”¾å†…å­˜**ã€‚

è¿™ä¸ªè¿‡ç¨‹ç¡®ä¿ `std::vector` **é«˜æ•ˆç®¡ç†å†…å­˜ï¼Œå¹¶æ”¯æŒåŠ¨æ€æ‰©å±•**ã€‚



# æ™ºèƒ½æŒ‡é’ˆ
C++11 åŠä»¥åçš„æ ‡å‡†åº“æä¾›äº†ä¸‰ç§æ™ºèƒ½æŒ‡é’ˆï¼š  

- **`std::unique_ptr`** â€”â€” ç‹¬å æ‰€æœ‰æƒï¼Œä¸èƒ½å¤åˆ¶ï¼Œæ”¯æŒç§»åŠ¨è¯­ä¹‰ã€‚  
- **`std::shared_ptr`** â€”â€” å…±äº«æ‰€æœ‰æƒï¼Œä½¿ç”¨å¼•ç”¨è®¡æ•°ç®¡ç†èµ„æºã€‚  
- **`std::weak_ptr`** â€”â€” å¼±å¼•ç”¨ï¼Œä¸å½±å“ `std::shared_ptr` çš„å¼•ç”¨è®¡æ•°ï¼Œé˜²æ­¢å¾ªç¯å¼•ç”¨ã€‚  

---

## **1. `std::unique_ptr` API**
`std::unique_ptr` æ˜¯ç‹¬å æ‰€æœ‰æƒçš„æ™ºèƒ½æŒ‡é’ˆï¼Œä¸€ä¸ª `std::unique_ptr` åªèƒ½æœ‰ä¸€ä¸ªå®ä¾‹ç®¡ç†å¯¹è±¡ã€‚

### **æ„é€  & èµ‹å€¼**
```cpp
std::unique_ptr<int> p1(new int(42));    // ç›´æ¥åˆå§‹åŒ–
std::unique_ptr<int> p2 = std::make_unique<int>(42); // æ¨èï¼šä½¿ç”¨ make_unique åˆ›å»º
std::unique_ptr<int[]> p3 = std::make_unique<int[]>(10); // åˆ›å»ºåŠ¨æ€æ•°ç»„

std::unique_ptr<int> p4 = std::move(p1);  // p1 è½¬ç§»ç»™ p4ï¼Œp1 å˜ä¸ºç©º
```

### **è®¿é—®èµ„æº**
```cpp
int val = *p2;  // è§£å¼•ç”¨
int* rawPtr = p2.get();  // è·å–åŸç”ŸæŒ‡é’ˆ
```

### **é‡Šæ”¾èµ„æº**
```cpp
p2.reset();  // é‡Šæ”¾å¯¹è±¡ï¼Œp2 å˜ä¸ºç©º
p2.reset(new int(99));  // é‡Šæ”¾æ—§èµ„æºï¼Œåˆ†é…æ–°å¯¹è±¡
p3.release();  // é‡Šæ”¾æ‰€æœ‰æƒï¼Œè¿”å›åŸç”ŸæŒ‡é’ˆï¼ˆéœ€è¦æ‰‹åŠ¨ deleteï¼‰
```

### **æ£€æŸ¥çŠ¶æ€**
```cpp
if (p2) { std::cout << "p2 is not empty\n"; }
```

---

## **2. `std::shared_ptr` API**
`std::shared_ptr` é€šè¿‡å¼•ç”¨è®¡æ•°å…±äº«èµ„æºï¼Œå¤šä¸ª `shared_ptr` å¯ç®¡ç†åŒä¸€å¯¹è±¡ã€‚

### **æ„é€  & èµ‹å€¼**
```cpp
std::shared_ptr<int> p1(new int(42));  // ç›´æ¥åˆ›å»ºï¼ˆä¸æ¨èï¼‰
std::shared_ptr<int> p2 = std::make_shared<int>(42); // æ¨èï¼šæ›´é«˜æ•ˆ
std::shared_ptr<int> p3 = p2;  // å…±äº«æ‰€æœ‰æƒï¼Œå¼•ç”¨è®¡æ•° +1
std::shared_ptr<int[]> p4 = std::make_shared<int[]>(10); // åˆ›å»ºåŠ¨æ€æ•°ç»„
```

### **è®¿é—®èµ„æº**
```cpp
int val = *p2;  // è§£å¼•ç”¨
int* rawPtr = p2.get();  // è·å–åŸç”ŸæŒ‡é’ˆ
```

### **é‡Šæ”¾èµ„æº**
```cpp
p2.reset();  // é‡Šæ”¾å¯¹è±¡ï¼Œp2 å˜ä¸ºç©ºï¼Œå¼•ç”¨è®¡æ•° -1
p2.reset(new int(99));  // é‡Šæ”¾æ—§èµ„æºï¼Œåˆ†é…æ–°å¯¹è±¡
```

### **è·å–å¼•ç”¨è®¡æ•°**
```cpp
std::cout << "Use count: " << p2.use_count() << std::endl;
```

### **æ£€æŸ¥çŠ¶æ€**
```cpp
if (p2) { std::cout << "p2 is not empty\n"; }
```

---

## **3. `std::weak_ptr` API**
`std::weak_ptr` æ˜¯ `std::shared_ptr` çš„å¼±å¼•ç”¨ï¼Œä¸å¢åŠ å¼•ç”¨è®¡æ•°ï¼Œç”¨äºé˜²æ­¢å¾ªç¯å¼•ç”¨ã€‚

### **åˆ›å»º & èµ‹å€¼**
```cpp
std::shared_ptr<int> sp = std::make_shared<int>(42);
std::weak_ptr<int> wp = sp;  // wp ä¸å¢åŠ å¼•ç”¨è®¡æ•°
```

### **è®¿é—®èµ„æº**
```cpp
if (auto locked = wp.lock()) {  // å°è¯•è·å– shared_ptr
    std::cout << *locked << std::endl;
}
```

### **æ£€æŸ¥çŠ¶æ€**
```cpp
if (!wp.expired()) { std::cout << "Resource still exists\n"; }
```

### **è·å–å¼•ç”¨è®¡æ•°**
```cpp
std::cout << "Use count: " << wp.use_count() << std::endl;
```

---
### **`std::weak_ptr::lock()` çš„åŸç†**
`std::weak_ptr::lock()` ç”¨äºå°è¯•è·å– `std::shared_ptr`ï¼Œå¦‚æœèµ„æºä»ç„¶æœ‰æ•ˆï¼ˆå³ `use_count > 0`ï¼‰ï¼Œåˆ™è¿”å›ä¸€ä¸ªæ–°çš„ `std::shared_ptr`ï¼Œå¦åˆ™è¿”å›ä¸€ä¸ªç©ºçš„ `shared_ptr`ã€‚

---

### **åº•å±‚å®ç°**
`std::weak_ptr` å†…éƒ¨æŒæœ‰ä¸€ä¸ª **æ§åˆ¶å—ï¼ˆControl Blockï¼‰**ï¼Œè¯¥æ§åˆ¶å—åŒ…å«ï¼š
- **å¼•ç”¨è®¡æ•°ï¼ˆuse_countï¼‰**: è®°å½•å½“å‰æœ‰å¤šå°‘ä¸ª `shared_ptr` å…±äº«è¯¥èµ„æºã€‚
- **å¼±å¼•ç”¨è®¡æ•°ï¼ˆweak_countï¼‰**: è®°å½•æœ‰å¤šå°‘ä¸ª `weak_ptr` æŒæœ‰å¯¹èµ„æºçš„è§‚å¯Ÿã€‚

`lock()` çš„åŸç†æ˜¯ï¼š
1. æ£€æŸ¥ `use_count` æ˜¯å¦å¤§äº `0`ï¼ˆèµ„æºæ˜¯å¦ä»ç„¶è¢« `shared_ptr` ç®¡ç†ï¼‰ã€‚
2. å¦‚æœ `use_count > 0`ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„ `shared_ptr`ï¼Œå¼•ç”¨è®¡æ•° +1ï¼Œå¹¶è¿”å›è¿™ä¸ª `shared_ptr`ã€‚
3. å¦‚æœ `use_count == 0`ï¼Œè¿”å›ä¸€ä¸ªç©ºçš„ `shared_ptr`ï¼Œè¡¨ç¤ºèµ„æºå·²ç»é‡Šæ”¾ã€‚

---

### **ç¤ºä¾‹ä»£ç **
```cpp
#include <iostream>
#include <memory>

int main() {
    std::shared_ptr<int> sp = std::make_shared<int>(42);
    std::weak_ptr<int> wp = sp;  // weak_ptr è§‚å¯Ÿ sp

    std::cout << "Use count before lock: " << wp.use_count() << std::endl;

    if (auto locked = wp.lock()) {  // è·å– shared_ptr
        std::cout << "Locked value: " << *locked << std::endl;
    } else {
        std::cout << "Resource expired" << std::endl;
    }

    sp.reset();  // é‡Šæ”¾ shared_ptrï¼Œèµ„æºè¢«é‡Šæ”¾

    if (auto locked = wp.lock()) {  // å†æ¬¡å°è¯• lock
        std::cout << "Locked value: " << *locked << std::endl;
    } else {
        std::cout << "Resource expired" << std::endl;
    }

    return 0;
}
```

**è¾“å‡º**
```
Use count before lock: 1
Locked value: 42
Resource expired
```

---

### **lock() çš„åº•å±‚å·¥ä½œæµç¨‹**
1. **æ£€æŸ¥ `use_count` æ˜¯å¦å¤§äº 0**ï¼š
   - `std::weak_ptr` è®¿é—®æ§åˆ¶å—ï¼Œæ£€æŸ¥ `use_count`ã€‚
   - å¦‚æœ `use_count == 0`ï¼Œåˆ™è¿”å›ä¸€ä¸ªç©ºçš„ `shared_ptr`ï¼Œè¡¨ç¤ºèµ„æºå·²é‡Šæ”¾ã€‚

2. **å¦‚æœ `use_count > 0`ï¼Œåˆ›å»ºæ–°çš„ `shared_ptr`**ï¼š
   - `shared_ptr` é€’å¢ `use_count`ï¼Œç¡®ä¿èµ„æºä¸è¢«é‡Šæ”¾ã€‚
   - è¿”å›æ–°çš„ `shared_ptr`ï¼Œä¿è¯è®¿é—®èµ„æºæ—¶ä¸ä¼šå‘ç”Ÿæœªå®šä¹‰è¡Œä¸ºã€‚

---

### **lock() é˜²æ­¢æ‚¬ç©ºæŒ‡é’ˆ**
å¦‚æœ `std::weak_ptr` ç›´æ¥ä½¿ç”¨ `get()` è·å–åŸç”ŸæŒ‡é’ˆï¼š
```cpp
int* rawPtr = wp.get();  // å¯èƒ½ä¼šè®¿é—®å·²é‡Šæ”¾çš„å¯¹è±¡
```
ä½† `lock()` **ç¡®ä¿äº†èµ„æºä»ç„¶å­˜åœ¨**ï¼Œé¿å…æ‚¬ç©ºæŒ‡é’ˆï¼š
```cpp
if (auto sp = wp.lock()) {
    // å®‰å…¨è®¿é—®èµ„æº
}
```

---

### **æ€»ç»“**
- `lock()` é€šè¿‡ `use_count` æ£€æŸ¥èµ„æºæ˜¯å¦ä»ç„¶æœ‰æ•ˆã€‚
- å¦‚æœ `use_count > 0`ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„ `shared_ptr` å¹¶è¿”å›ï¼Œç¡®ä¿èµ„æºä¸ä¼šè¢«é‡Šæ”¾ã€‚
- å¦‚æœ `use_count == 0`ï¼Œè¿”å›ç©ºçš„ `shared_ptr`ï¼Œé˜²æ­¢è®¿é—®å·²é‡Šæ”¾çš„èµ„æºã€‚
- `lock()` æœºåˆ¶é¿å…äº† `get()` å¯èƒ½å¯¼è‡´çš„æ‚¬ç©ºæŒ‡é’ˆé—®é¢˜ã€‚

---
âœ… **å»ºè®®**
- **æ°¸è¿œä½¿ç”¨ `lock()` è·å– `std::shared_ptr`ï¼Œä¸è¦ç›´æ¥ç”¨ `get()`ã€‚**
- **åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œ`lock()` ä¹Ÿèƒ½ä¿è¯ `shared_ptr` çš„å®‰å…¨æ€§ï¼Œè€Œ `get()` å¯èƒ½å¯¼è‡´èµ„æºè®¿é—®å†²çªã€‚**

## **æ€»ç»“**
| API | `std::unique_ptr` | `std::shared_ptr` | `std::weak_ptr` |
|------|------------------|------------------|------------------|
| `make_xxx<T>()` | âœ… æ¨è `make_unique` | âœ… æ¨è `make_shared` | âŒ ä¸èƒ½åˆ›å»º |
| `get()` | âœ… è·å–åŸç”ŸæŒ‡é’ˆ | âœ… è·å–åŸç”ŸæŒ‡é’ˆ | âœ… è·å–åŸç”ŸæŒ‡é’ˆ |
| `reset()` | âœ… é‡Šæ”¾èµ„æº | âœ… é‡Šæ”¾èµ„æº | âŒ æ— å½±å“ |
| `release()` | âœ… é‡Šæ”¾æ‰€æœ‰æƒ | âŒ ä¸æ”¯æŒ | âŒ ä¸æ”¯æŒ |
| `use_count()` | âŒ ä¸æ”¯æŒ | âœ… è·å–å¼•ç”¨è®¡æ•° | âœ… è·å–å¼•ç”¨è®¡æ•° |
| `lock()` | âŒ ä¸æ”¯æŒ | âŒ ä¸æ”¯æŒ | âœ… è½¬æ¢ä¸º `shared_ptr` |
| `expired()` | âŒ ä¸æ”¯æŒ | âŒ ä¸æ”¯æŒ | âœ… æ£€æŸ¥æ˜¯å¦ä¸ºç©º |
| `operator* / ->` | âœ… è®¿é—®å¯¹è±¡ | âœ… è®¿é—®å¯¹è±¡ | âŒ éœ€è¦ `lock()` |

âœ… **å»ºè®®**
- **å°½é‡ä½¿ç”¨ `std::make_unique` å’Œ `std::make_shared` åˆ›å»ºå¯¹è±¡**
- **é¿å… `std::shared_ptr` ç›´æ¥ç®¡ç† `new` åˆ†é…çš„å¯¹è±¡ï¼Œå¯èƒ½ä¼šå¯¼è‡´ä¸¤æ¬¡ `delete`**
- **ä½¿ç”¨ `std::weak_ptr` é˜²æ­¢ `std::shared_ptr` å¾ªç¯å¼•ç”¨**

## share_from_this
é¢è¯•å®˜å¯èƒ½é—®ä½ çš„é—®é¢˜å¯èƒ½ä¸ **`shared_ptr` å’Œ `this` æŒ‡é’ˆ** ç›¸å…³ï¼Œé€šå¸¸æ¶‰åŠ **æ™ºèƒ½æŒ‡é’ˆç®¡ç†å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸ** ä»¥åŠ **é¿å… `shared_ptr` è¯¯ç”¨çš„é—®é¢˜**ã€‚ä»¥ä¸‹æ˜¯å‡ ä¸ªå¯èƒ½çš„é—®é¢˜ï¼Œä»¥åŠå¯¹åº”çš„è§£ç­”å’Œé™·é˜±ã€‚

---

### **é—®é¢˜ 1ï¼šèƒ½å¦åœ¨ç±»çš„æˆå‘˜å‡½æ•°ä¸­ä½¿ç”¨ `shared_ptr` æŒ‡å‘ `this`ï¼Ÿ**
 **é”™è¯¯ç¤ºä¾‹**
```cpp
#include <iostream>
#include <memory>

class A {
public:
    void foo() {
        std::shared_ptr<A> pThis(this);  // âŒ ç›´æ¥ç”¨ this æ„é€  shared_ptr
    }
};

int main() {
    std::shared_ptr<A> p = std::make_shared<A>();
    p->foo();
}
```
 **ä¸ºä»€ä¹ˆè¿™æ ·åšæ˜¯é”™è¯¯çš„ï¼Ÿ**
- **ä¼šå¯¼è‡´ double deleteï¼ˆåŒé‡é‡Šæ”¾ï¼‰**ï¼š
  - `make_shared<A>()` ä¼šåˆ†é…ä¸€å—å†…å­˜æ¥å­˜å‚¨ `A` å¯¹è±¡ï¼Œå¹¶ä¸” `p` ç®¡ç†è¿™å—å†…å­˜ã€‚
  - `foo()` é‡Œ `std::shared_ptr<A> pThis(this);` **åˆåˆ›å»ºäº†ä¸€ä¸ª `shared_ptr`ï¼Œä½†å®ƒå’Œ `p` æ˜¯ç‹¬ç«‹çš„**ï¼Œæ²¡æœ‰å…±äº«å¼•ç”¨è®¡æ•°ã€‚
  - `p` å’Œ `pThis` **åˆ†åˆ«è®¤ä¸ºè‡ªå·±ç‹¬å ç®¡ç† `A`ï¼Œå½“ `p` å’Œ `pThis` é‡Šæ”¾æ—¶ï¼Œä¼šå¯¼è‡´ `A` è¢« `delete` ä¸¤æ¬¡**ï¼Œå¼•å‘ **æœªå®šä¹‰è¡Œä¸º**ã€‚

---

### **é—®é¢˜ 2ï¼šå¦‚ä½•åœ¨æˆå‘˜å‡½æ•°ä¸­å®‰å…¨è·å– `shared_ptr`ï¼Ÿ**
**âœ… æ­£ç¡®æ–¹å¼ï¼šä½¿ç”¨ `std::enable_shared_from_this`**
```cpp
#include <iostream>
#include <memory>

class A : public std::enable_shared_from_this<A> {  // ç»§æ‰¿ enable_shared_from_this
public:
    std::shared_ptr<A> getSharedPtr() {
        return shared_from_this();  // âœ… æ­£ç¡®æ–¹å¼ï¼Œè·å–å·²æœ‰çš„ shared_ptr
    }
};

int main() {
    std::shared_ptr<A> p = std::make_shared<A>();
    std::shared_ptr<A> p2 = p->getSharedPtr();  // å…±äº« p çš„å¼•ç”¨è®¡æ•°
    std::cout << "å¼•ç”¨è®¡æ•°: " << p.use_count() << std::endl;  // è¾“å‡º 2
}
```
 **ä¸ºä»€ä¹ˆ `enable_shared_from_this` å¯ä»¥é¿å…é—®é¢˜ï¼Ÿ**
- `enable_shared_from_this` å†…éƒ¨ç»´æŠ¤äº† `shared_ptr`ï¼Œ**`shared_from_this()` è¿”å›çš„æ˜¯å·²æœ‰çš„ `shared_ptr`**ï¼Œä¸ä¼šé‡å¤åˆ›å»ºæ–°çš„ `shared_ptr`ï¼Œä¹Ÿå°±ä¸ä¼šå¯¼è‡´ `delete` ä¸¤æ¬¡çš„é—®é¢˜ã€‚

---

### **é—®é¢˜ 3ï¼šå¦‚æœ `A` ä¸æ˜¯ `shared_ptr` åˆ›å»ºçš„ï¼Œè¿˜èƒ½ `shared_from_this()` å—ï¼Ÿ**
```cpp
A a;
std::shared_ptr<A> p = a.getSharedPtr();  // âŒ é”™è¯¯ï¼Œæœªå®šä¹‰è¡Œä¸º
```
å¦‚æœ `A` å¯¹è±¡ä¸æ˜¯ç”¨ `std::shared_ptr` ç®¡ç†çš„ï¼ˆæ¯”å¦‚ `A a;` æ˜¯æ ˆå¯¹è±¡ï¼‰ï¼Œè°ƒç”¨ `shared_from_this()` ä¼šå¯¼è‡´ **æœªå®šä¹‰è¡Œä¸º**ï¼Œå› ä¸º `shared_from_this()` éœ€è¦ä¾èµ– `shared_ptr` çš„å¼•ç”¨è®¡æ•°ï¼Œè€Œæ™®é€šå¯¹è±¡æ²¡æœ‰è¿™ä¸ªæœºåˆ¶ã€‚

âœ… **æ­£ç¡®åšæ³•**ï¼š
```cpp
std::shared_ptr<A> p = std::make_shared<A>();
std::shared_ptr<A> p2 = p->getSharedPtr();  // å®‰å…¨
```

---

### **é—®é¢˜ 4ï¼šä¸ºä»€ä¹ˆ `enable_shared_from_this` ä¸èƒ½å’Œ `std::make_shared` ä»¥å¤–çš„æ–¹æ³•ä¸€èµ·ä½¿ç”¨ï¼Ÿ**
å‡è®¾ä½  **æ‰‹åŠ¨ new** ä¸€ä¸ª `A`ï¼Œç„¶åç”¨ `shared_ptr` ç®¡ç†å®ƒï¼š
```cpp
A* rawPtr = new A();  
std::shared_ptr<A> p1(rawPtr);  // âŒ
std::shared_ptr<A> p2 = rawPtr->getSharedPtr();  // âŒ æœªå®šä¹‰è¡Œä¸º
```
- `p1` è®¤ä¸ºè‡ªå·±æ˜¯å”¯ä¸€æ‹¥æœ‰ `A` çš„ `shared_ptr`ã€‚
- `rawPtr->getSharedPtr()` è¯•å›¾è®¿é—® `shared_ptr` çš„å¼•ç”¨è®¡æ•°ï¼Œä½†å®ƒä¸çŸ¥é“ `p1` å­˜åœ¨ï¼Œå¯¼è‡´ **æœªå®šä¹‰è¡Œä¸º**ã€‚
- **è§£å†³æ–¹æ¡ˆï¼šæ°¸è¿œä½¿ç”¨ `std::make_shared<A>()` åˆ›å»ºå¯¹è±¡**ã€‚

---

### **æ€»ç»“**
 **âŒ é”™è¯¯åšæ³•**
1. **ä¸è¦åœ¨ç±»çš„æˆå‘˜å‡½æ•°ä¸­ç›´æ¥ `shared_ptr<A>(this);`**ï¼Œä¼šå¯¼è‡´ **double delete**ã€‚
2. **ä¸è¦æ‰‹åŠ¨ `new A` å†åˆ›å»º `shared_ptr<A>`**ï¼Œç„¶åè°ƒç”¨ `shared_from_this()`ï¼Œä¼š **æœªå®šä¹‰è¡Œä¸º**ã€‚

 **âœ… æ­£ç¡®åšæ³•**
1. **å¦‚æœç±»éœ€è¦ `shared_ptr` ç®¡ç†è‡ªå·±ï¼Œç»§æ‰¿ `std::enable_shared_from_this<T>`**ã€‚
2. **ç”¨ `shared_from_this()` è·å– `shared_ptr`**ï¼Œè€Œä¸æ˜¯ `shared_ptr<A>(this)`ã€‚
3. **å¿…é¡»ä½¿ç”¨ `std::make_shared<A>()` åˆ›å»ºå¯¹è±¡**ï¼Œç¡®ä¿ `enable_shared_from_this` å†…éƒ¨ç®¡ç†çš„ `weak_ptr` ç»‘å®šåˆ° `shared_ptr`ã€‚

**é¢è¯•å®˜é—® `shared_ptr` å’Œ `this` æŒ‡é’ˆï¼Œå¤§æ¦‚ç‡æ˜¯è€ƒå¯Ÿ `enable_shared_from_this` åŠå…¶é”™è¯¯ç”¨æ³•ã€‚å¸Œæœ›è¿™èƒ½å¸®ä½ å›å¿†èµ·æ¥ï¼** ğŸš€


## ä¸ºä»€ä¹ˆshare_from_thisä¸€å®šè¦æ­é…make_sharedè¿›è¡Œä½¿ç”¨

---

### **ğŸŒŸ `enable_shared_from_this<T>` + `make_shared<T>()` çš„å·¥ä½œæœºåˆ¶**
1. **`make_shared<T>()` åˆ›å»º `shared_ptr<T>`**ï¼š
   - åˆ†é…ä¸€ä¸ª **`T` å¯¹è±¡** å’Œ **æ§åˆ¶å—**ï¼ˆåŒ…å«å¼•ç”¨è®¡æ•°ï¼‰ã€‚
   - è®© `shared_ptr<T>` ç®¡ç† `T` å¯¹è±¡ï¼Œå¹¶ **åˆå§‹åŒ– `enable_shared_from_this<T>::_Wptr`** ä½¿å…¶æŒ‡å‘æ§åˆ¶å—ã€‚

2. **`shared_from_this()` è·å– `shared_ptr<T>`**ï¼š
   - ç›´æ¥ä½¿ç”¨ `_Wptr` ç”Ÿæˆ `shared_ptr<T>`ï¼Œ**ç¡®ä¿æ‰€æœ‰ `shared_ptr` å…±äº«ç›¸åŒçš„æ§åˆ¶å—**ã€‚

---

#### **ğŸš€ å…·ä½“ç¤ºä¾‹**
```cpp
#include <iostream>
#include <memory>

class A : public std::enable_shared_from_this<A> {
public:
    std::shared_ptr<A> getSharedPtr() {
        return shared_from_this();  // âœ… ç›´æ¥ä» _Wptr è·å– shared_ptr
    }

    ~A() {
        std::cout << "A::~A() called" << std::endl;
    }
};

int main() {
    // âœ… `make_shared<A>()` è®© `shared_ptr` å’Œ `enable_shared_from_this` å…±äº«æ§åˆ¶å—
    std::shared_ptr<A> p1 = std::make_shared<A>();

    // âœ… å…±äº«ç›¸åŒçš„æ§åˆ¶å—
    std::shared_ptr<A> p2 = p1->getSharedPtr();

    std::cout << "p1.use_count() = " << p1.use_count() << std::endl;  // 2
}
```
**è¾“å‡º**
```
p1.use_count() = 2
A::~A() called
```

---

#### **ğŸ” `enable_shared_from_this<T>` å…³é”®æœºåˆ¶**
1. `make_shared<A>()` **åˆ›å»º `A` å’Œæ§åˆ¶å—**ï¼Œå¹¶è®© `p1` ç®¡ç†å®ƒï¼š
   - `p1` **è®°å½•äº†æ§åˆ¶å—çš„å¼•ç”¨è®¡æ•°**ã€‚
   - `p1` **åˆå§‹åŒ– `enable_shared_from_this<A>::_Wptr`** æŒ‡å‘æ§åˆ¶å—ã€‚

2. `p1->getSharedPtr()` è°ƒç”¨ `shared_from_this()`ï¼š
   - `shared_from_this()` é€šè¿‡ `_Wptr` åˆ›å»º **æ–°çš„ `shared_ptr`ï¼ˆp2ï¼‰**ã€‚
   - `p1` å’Œ `p2` **å…±äº«ç›¸åŒçš„æ§åˆ¶å—**ï¼Œ`use_count()` å¢åŠ ã€‚

3. ä½œç”¨ï¼š
   - **é¿å… `double delete`**ï¼ˆå¤šä¸ª `shared_ptr` æŒ‡å‘åŒä¸€å¯¹è±¡ä½†æœ‰ä¸åŒæ§åˆ¶å—ï¼‰ã€‚
   - **ç¡®ä¿æ‰€æœ‰ `shared_ptr` å…±äº«ç›¸åŒçš„æ§åˆ¶å—**ã€‚

---

### **ğŸš¨ å¦‚æœç›´æ¥ `new` è€Œä¸æ˜¯ `make_shared`ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ**
é”™è¯¯ç¤ºä¾‹ï¼š
```cpp
A* rawPtr = new A();  
std::shared_ptr<A> p1(rawPtr);  // âŒ ç›´æ¥ç”¨ rawPtr åˆ›å»º shared_ptr
std::shared_ptr<A> p2 = rawPtr->getSharedPtr();  // âŒ æœªå®šä¹‰è¡Œä¸ºï¼ˆUBï¼‰
```
#### **âŒ è¿™é‡Œçš„é—®é¢˜**
1. `p1` æ²¡æœ‰é€šçŸ¥ `enable_shared_from_this<A>`ï¼Œæ‰€ä»¥ `_Wptr` ä¸ºç©ºã€‚
2. `rawPtr->getSharedPtr()` è®¿é—®æœªåˆå§‹åŒ–çš„ `_Wptr`ï¼Œå¯¼è‡´ **UBï¼ˆæœªå®šä¹‰è¡Œä¸ºï¼‰**ã€‚

âœ… **æ­£ç¡®åšæ³•**
```cpp
std::shared_ptr<A> p1 = std::make_shared<A>();  // âœ… ç¡®ä¿ `_Wptr` è¢«æ­£ç¡®åˆå§‹åŒ–
std::shared_ptr<A> p2 = p1->getSharedPtr();     // âœ… å®‰å…¨è·å– shared_ptr
```

---

### **ğŸ”” ç»“è®º**
1. **`enable_shared_from_this<T>` ä¾èµ– `make_shared<T>()` è¿›è¡Œåˆå§‹åŒ–**ï¼š
   - åªæœ‰ `make_shared<T>()` **èƒ½æ­£ç¡®åˆå§‹åŒ– `_Wptr`**ï¼Œä½¿ `shared_from_this()` å¯ç”¨ã€‚

2. **`shared_from_this()` ç›´æ¥é€šè¿‡ `_Wptr` ç”Ÿæˆ `shared_ptr<T>`**ï¼š
   - ç¡®ä¿ **æ‰€æœ‰ `shared_ptr` å…±äº«åŒä¸€æ§åˆ¶å—**ï¼Œé¿å… `double delete` å’Œ `use-after-free`ã€‚

3. **é”™è¯¯ï¼šç›´æ¥ `new T()` å†åˆ›å»º `shared_ptr<T>`**ï¼š
   - `enable_shared_from_this<T>::_Wptr` ä¸ä¼šåˆå§‹åŒ–ï¼Œå¯¼è‡´ `shared_from_this()` **è¡Œä¸ºæœªå®šä¹‰ï¼ˆUBï¼‰**ã€‚

âœ… **æ­£ç¡®åšæ³•ï¼šå§‹ç»ˆä½¿ç”¨ `std::make_shared<T>()` åˆ›å»ºå¯¹è±¡ï¼** ğŸš€

## share_from_thisçš„åº•å±‚å®ç°


## é¢è¯•é¢˜
### æ™ºèƒ½æŒ‡é’ˆæœ‰å“ªäº›ï¼Œæœ‰ä»€ä¹ˆåŒºåˆ«
- **`std::unique_ptr`** â€”â€” ç‹¬å æ‰€æœ‰æƒï¼Œä¸èƒ½å¤åˆ¶ï¼Œæ”¯æŒç§»åŠ¨è¯­ä¹‰ã€‚  
- **`std::shared_ptr`** â€”â€” å…±äº«æ‰€æœ‰æƒï¼Œä½¿ç”¨å¼•ç”¨è®¡æ•°ç®¡ç†èµ„æºã€‚  
- **`std::weak_ptr`** â€”â€” å¼±å¼•ç”¨ï¼Œä¸å½±å“ `std::shared_ptr` çš„å¼•ç”¨è®¡æ•°ï¼Œé˜²æ­¢å¾ªç¯å¼•ç”¨ã€‚ 
> **use_countå’Œweak_countçš„åŒºåˆ«**
>> åœ¨å…±äº«æŒ‡é’ˆä¸­æœ‰ä¸€ä¸ª**æ§åˆ¶å—**å’ŒæŒ‡å‘èµ„æºçš„æŒ‡é’ˆï¼Œæ§åˆ¶å—ä¸­åŒ…å«use_countä»¥åŠweak_countï¼Œåˆ†åˆ«æŒ‡æŒ‡å‘èµ„æºçš„å…±äº«æŒ‡é’ˆçš„æ•°é‡ä»¥åŠæŒ‡å‘è¯¥èµ„æºçš„å¼±æŒ‡é’ˆçš„æ•°é‡ï¼Œ**å› ä¸ºå¼±æŒ‡é’ˆéœ€è¦é€šè¿‡use_countåˆ¤æ–­èµ„æºæ˜¯å¦è¿˜å­˜åœ¨**(æ‰€ä»¥å¯¹è±¡é‡Šæ”¾åæ§åˆ¶å—ä¸ä¸€å®šé‡Šæ”¾)ï¼Œweak_countå’Œuse_countå…±åŒå†³å®šäº†æ§åˆ¶å—ä½•æ—¶é‡Šæ”¾ï¼Œuse_countå†³å®šå¯¹è±¡ä½•æ—¶é‡Šæ”¾


### makeshareå’Œshareptr(new)ç›¸æ¯”æœ‰ä»€ä¹ˆå¥½å¤„
åœ¨ C++11 åŠä¹‹åçš„æ ‡å‡†ä¸­ï¼Œ`std::make_shared` å’Œ `std::shared_ptr<T>(new T)` éƒ½å¯ä»¥ç”¨äºåˆ›å»º `std::shared_ptr`ï¼Œä½† `std::make_shared` åœ¨**æ€§èƒ½**å’Œ**å®‰å…¨æ€§**æ–¹é¢éƒ½æœ‰æ˜æ˜¾çš„ä¼˜åŠ¿ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä¼šä»**åº•å±‚å®ç°çš„è§’åº¦**è¯¦ç»†åˆ†æä¸¤è€…çš„åŒºåˆ«ï¼Œå¹¶è§£é‡Šä¸ºä»€ä¹ˆ `std::make_shared` æ›´åŠ æ¨èã€‚


---

 **1. `std::shared_ptr<T>(new T)` çš„åº•å±‚å®ç°**
 **åˆ›å»ºè¿‡ç¨‹**
```cpp
std::shared_ptr<int> sp(new int(10));
```
- `new int(10)` åœ¨**å †ä¸Š**åˆ†é…ä¸€å—å†…å­˜æ¥å­˜å‚¨ `int` ç±»å‹çš„å¯¹è±¡ `10`ã€‚
- `std::shared_ptr` **å•ç‹¬**åˆ†é…**æ§åˆ¶å—ï¼ˆcontrol blockï¼‰**ï¼Œç”¨äºç®¡ç†å¼•ç”¨è®¡æ•°ã€‚

 **å†…å­˜å¸ƒå±€**
åœ¨ `std::shared_ptr<int>(new int(10))` çš„æƒ…å†µä¸‹ï¼Œåˆ†é…äº†ä¸¤å—ç‹¬ç«‹çš„å †å†…å­˜ï¼š
1. **å¯¹è±¡æœ¬èº«ï¼ˆintï¼‰**
2. **æ§åˆ¶å—**ï¼ˆåŒ…å« `use_count` è®¡æ•°å™¨ç­‰å…ƒæ•°æ®ï¼‰

```plaintext
å †å†…å­˜åˆ†é…ç¤ºæ„ï¼š
+------------------+
|   new int(10)   |   <--- æŒ‡é’ˆç®¡ç†çš„å¯¹è±¡
+------------------+

+----------------------+
|  æ§åˆ¶å— (ref count) |  <--- å…±äº«æŒ‡é’ˆçš„å¼•ç”¨è®¡æ•°
+----------------------+
```
**é—®é¢˜**ï¼š
- **é¢å¤–çš„å †å†…å­˜å¼€é”€**ï¼š`new int(10)` å’Œ `control block` æ˜¯åˆ†å¼€åˆ†é…çš„ï¼Œå¯¼è‡´**ä¸¤æ¬¡åˆ†é…ï¼ˆmallocï¼‰**ã€‚
- **å¼‚å¸¸å®‰å…¨æ€§é—®é¢˜**ï¼š
  - å¦‚æœ `new int(10)` æˆåŠŸï¼Œä½† `shared_ptr` çš„æ„é€ è¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸ï¼ˆæ¯”å¦‚ `bad_alloc`ï¼‰ï¼Œå¯¹è±¡ä¸ä¼šè¢«æ­£ç¡®é‡Šæ”¾ï¼Œå¯¼è‡´**å†…å­˜æ³„æ¼**ã€‚

---

 **2. `std::make_shared<T>` çš„åº•å±‚å®ç°**
 **åˆ›å»ºè¿‡ç¨‹**
```cpp
std::shared_ptr<int> sp = std::make_shared<int>(10);
```
- `std::make_shared` **ä¸€æ¬¡æ€§åˆ†é…** ä¸€æ•´å—**è¿ç»­çš„å †å†…å­˜**ï¼ŒåŒæ—¶å­˜æ”¾ï¼š
  - **æ§åˆ¶å—**
  - **T ç±»å‹çš„å¯¹è±¡ï¼ˆint 10ï¼‰**
- é¿å…äº† `new T` å’Œ `control block` **åˆ†å¼€åˆ†é…**çš„æƒ…å†µã€‚

 **å†…å­˜å¸ƒå±€**
åœ¨ `std::make_shared<int>(10)` çš„æƒ…å†µä¸‹ï¼š
```plaintext
å †å†…å­˜åˆ†é…ç¤ºæ„ï¼š
+----------------------+
|  æ§åˆ¶å— (ref count)  |  <--- å…±äº«æŒ‡é’ˆçš„å¼•ç”¨è®¡æ•°
|----------------------|
|     new int(10)     |  <--- æŒ‡é’ˆç®¡ç†çš„å¯¹è±¡
+----------------------+
```
**ä¼˜ç‚¹**ï¼š
- **å‡å°‘äº†å†…å­˜åˆ†é…æ¬¡æ•°**ï¼ˆåªè¿›è¡Œä¸€æ¬¡ `malloc`ï¼‰
- **æé«˜äº† CPU ç¼“å­˜å±€éƒ¨æ€§**ï¼ˆæ§åˆ¶å—å’Œå¯¹è±¡åœ¨åŒä¸€å—å†…å­˜ä¸­ï¼‰
- **å¼‚å¸¸å®‰å…¨**ï¼ˆæ•´ä¸ª `make_shared` è¿‡ç¨‹è¦ä¹ˆæˆåŠŸåˆ›å»º `shared_ptr`ï¼Œè¦ä¹ˆä¸ä¼šæ³„éœ²å†…å­˜ï¼‰

---

 **3. `std::make_shared<T>` vs. `std::shared_ptr<T>(new T)` å¯¹æ¯”**
| å¯¹æ¯”é¡¹ | `std::shared_ptr<T>(new T)` | `std::make_shared<T>` |
|--------|------------------------------|------------------------|
| **å†…å­˜åˆ†é…** | 2 æ¬¡ (`new T` å’Œ `malloc` æ§åˆ¶å—) | 1 æ¬¡ï¼ˆåˆå¹¶å¯¹è±¡å’Œæ§åˆ¶å—ï¼‰ |
| **æ€§èƒ½** | æ…¢ï¼ˆå¤šæ¬¡åˆ†é… & è®¿é—®ï¼‰ | å¿«ï¼ˆå‡å°‘ `malloc` & å†…å­˜å±€éƒ¨æ€§å¥½ï¼‰ |
| **å®‰å…¨æ€§** | å¯èƒ½å¯¼è‡´å¼‚å¸¸å¼•å‘çš„å†…å­˜æ³„æ¼ | **å¼‚å¸¸å®‰å…¨** |
| **CPU ç¼“å­˜æ•ˆç‡** | å·®ï¼ˆå¯¹è±¡å’Œæ§åˆ¶å—ä¸è¿ç»­ï¼‰ | **å¥½ï¼ˆå¯¹è±¡å’Œæ§åˆ¶å—è¿ç»­å­˜å‚¨ï¼‰** |

---

 **4. `make_shared` çš„é—®é¢˜**
è™½ç„¶ `std::make_shared` ä¼˜åŠ¿æ˜æ˜¾ï¼Œä½†å®ƒ**ä¹Ÿæœ‰ä¸€äº›é™åˆ¶**ï¼š
1. **æ— æ³•ä½¿ç”¨è‡ªå®šä¹‰ deleter**
   - `std::shared_ptr<T>` å…è®¸ç”¨æˆ·ä¼ å…¥ä¸€ä¸ªè‡ªå®šä¹‰çš„åˆ é™¤å™¨ï¼Œä¾‹å¦‚ï¼š
     ```cpp
     std::shared_ptr<int> sp(new int(10), [](int* p) { delete p; std::cout << "Deleted\n"; });
     ```
   - ä½† `std::make_shared` **ä¸æ”¯æŒ** è‡ªå®šä¹‰ deleterï¼Œå› ä¸º `make_shared` ä¸€æ¬¡æ€§åˆ†é…çš„å†…å­˜å¿…é¡»ç”±æ ‡å‡†çš„ `delete` é‡Šæ”¾ã€‚

2. **å¯¹è±¡ç”Ÿå‘½å‘¨æœŸå— `shared_ptr` ç®¡ç†**
   - ç”±äº `make_shared` å°†å¯¹è±¡å’Œæ§åˆ¶å—æ”¾åœ¨ä¸€èµ·ï¼Œ**ä¸èƒ½å°†å¯¹è±¡çš„è£¸æŒ‡é’ˆ `delete`**ï¼Œå¦åˆ™ä¼šå¯¼è‡´æœªå®šä¹‰è¡Œä¸ºï¼š
     ```cpp
     auto sp = std::make_shared<int>(10);
     int* p = sp.get();
     delete p;  // âŒ é”™è¯¯ï¼ç ´åäº† shared_ptr ç®¡ç†çš„å†…å­˜
     ```

3. **é€‚ç”¨äºå°å¯¹è±¡ï¼Œä¸é€‚åˆå¤§å¯¹è±¡**
   - å¦‚æœ `T` æ˜¯ä¸€ä¸ªéå¸¸å¤§çš„å¯¹è±¡ï¼Œæ¯”å¦‚ `std::vector<int>`ï¼Œ`std::make_shared<T>` å¯èƒ½å¯¼è‡´**å¤§å—å†…å­˜åˆ†é…**ï¼Œä¸å¦‚ `shared_ptr<T>(new T)` æ›´çµæ´»ã€‚

---

**5. ä»£ç ç¤ºä¾‹**
 **æ€§èƒ½å¯¹æ¯”**
```cpp
#include <iostream>
#include <memory>
#include <chrono>

struct Big {
    int data[1000];
};

int main() {
    constexpr int ITERATIONS = 100000;

    auto start1 = std::chrono::high_resolution_clock::now();
    for (int i = 0; i < ITERATIONS; i++) {
        std::shared_ptr<Big> sp1(new Big);  // ä¸¤æ¬¡ malloc
    }
    auto end1 = std::chrono::high_resolution_clock::now();
    std::cout << "shared_ptr(new T) è€—æ—¶: " 
              << std::chrono::duration_cast<std::chrono::microseconds>(end1 - start1).count()
              << " å¾®ç§’" << std::endl;

    auto start2 = std::chrono::high_resolution_clock::now();
    for (int i = 0; i < ITERATIONS; i++) {
        std::shared_ptr<Big> sp2 = std::make_shared<Big>();  // ä¸€æ¬¡ malloc
    }
    auto end2 = std::chrono::high_resolution_clock::now();
    std::cout << "make_shared è€—æ—¶: " 
              << std::chrono::duration_cast<std::chrono::microseconds>(end2 - start2).count()
              << " å¾®ç§’" << std::endl;
}
```
**é¢„æœŸè¾“å‡ºï¼ˆä¸åŒæœºå™¨å¯èƒ½æœ‰æ‰€ä¸åŒï¼‰ï¼š**
```plaintext
shared_ptr(new T) è€—æ—¶: 1500000 å¾®ç§’
make_shared è€—æ—¶: 1000000 å¾®ç§’
```
**ç»“æœï¼š`std::make_shared` å¤§çº¦å¿« 30%-50%ï¼**

---

**6. ç»“è®º**
 **ä»€ä¹ˆæ—¶å€™ä½¿ç”¨ `make_shared`ï¼Ÿ**
âœ… **ä¼˜å…ˆä½¿ç”¨ `make_shared`**ï¼Œé™¤éï¼š
- **éœ€è¦è‡ªå®šä¹‰ deleter**ï¼ˆåªèƒ½ç”¨ `shared_ptr<T>(new T, deleter)`ï¼‰
- **T æ˜¯ä¸ªå¤§å¯¹è±¡**ï¼Œå¸Œæœ› `T` å’Œ `æ§åˆ¶å—` åˆ†å¼€åˆ†é…
- **éœ€è¦æ›´çµæ´»çš„å¯¹è±¡ç”Ÿå‘½å‘¨æœŸæ§åˆ¶**

---

 **æœ€ä½³å®è·µ**
| æ¨èæ–¹å¼ | ä½¿ç”¨åœºæ™¯ |
|----------|--------------------------|
| `std::make_shared<T>(args...)` | **é»˜è®¤é€‰æ‹©ï¼Œæ€§èƒ½æ›´å¥½ï¼Œå‡å°‘ `malloc`** |
| `std::shared_ptr<T>(new T)` | éœ€è¦**è‡ªå®šä¹‰ deleter** æˆ– `T` **å¾ˆå¤§** |

**ğŸ’¡ ç»“è®ºï¼š** `std::make_shared` æ›´é«˜æ•ˆã€æ›´å®‰å…¨ï¼Œåº”å½“æ˜¯**é»˜è®¤é€‰æ‹©**ï¼


### shared_ptræ˜¯çº¿ç¨‹å®‰å…¨çš„å—
å¼•ç”¨è®¡æ•°çš„æ›´æ–°é‡‡ç”¨çš„æ˜¯atomicåŸå­æ“ä½œï¼Œå¯¹äºå¼•ç”¨è®¡æ•°æ¥è¯´æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œ
ä½†æ˜¯å¯¹äºæ‰€ç®¡ç†çš„èµ„æºæ¥è¯´ä¸æ˜¯ï¼Œå¯èƒ½ä¼šå‘ç”Ÿå¤šä¸ªçº¿ç¨‹åŒæ—¶æ›´æ–°èµ„æºï¼Œä»è€Œäº§ç”Ÿç«äº‰

### ä½¿ç”¨atomicå®ç°shared_ptr
å®ç°æ€è·¯
1. å¼•ç”¨è®¡æ•°ï¼š shared_ptr éœ€è¦ä¸€ä¸ªå¼•ç”¨è®¡æ•°æ¥è¿½è¸ªå½“å‰æœ‰å¤šå°‘ä¸ª shared_ptr æŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡ã€‚è¿™ä¸ªå¼•ç”¨è®¡æ•°éœ€è¦åœ¨å¤šä¸ªçº¿ç¨‹é—´å…±äº«ï¼Œå› æ­¤å¿…é¡»ä½¿ç”¨åŸå­æ“ä½œï¼ˆä¾‹å¦‚ std::atomicï¼‰æ¥è¿›è¡Œé€’å¢å’Œé€’å‡ã€‚

2. èµ„æºç®¡ç†ï¼š shared_ptr çš„å·¥ä½œæ˜¯ç¡®ä¿å®ƒç®¡ç†çš„å¯¹è±¡åœ¨ä¸å†éœ€è¦æ—¶è¢«æ­£ç¡®é”€æ¯ã€‚ä¸ºæ­¤ï¼Œéœ€è¦è·Ÿè¸ªå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸï¼Œé€šå¸¸é€šè¿‡ææ„å‡½æ•°æ¥é‡Šæ”¾èµ„æºã€‚

3. ææ„å’Œæ‹·è´æ„é€ ï¼š åœ¨æ‹·è´ä¸€ä¸ª shared_ptr æ—¶ï¼Œéœ€è¦é€’å¢å¼•ç”¨è®¡æ•°ã€‚é”€æ¯ shared_ptr æ—¶ï¼Œéœ€è¦é€’å‡å¼•ç”¨è®¡æ•°ï¼Œå¹¶åœ¨å¼•ç”¨è®¡æ•°ä¸ºé›¶æ—¶é”€æ¯å¯¹è±¡ã€‚

4. åŸå­å¼•ç”¨è®¡æ•°ï¼š ä½¿ç”¨ std::atomic æ¥ç¡®ä¿å¼•ç”¨è®¡æ•°çš„é€’å¢å’Œé€’å‡æ˜¯åŸå­æ“ä½œï¼Œé¿å…ç«æ€æ¡ä»¶ã€‚
```cpp
#include <iostream>
#include <atomic>
#include <memory>

template <typename T>
class atomic_shared_ptr {
public:
    // æ„é€ å‡½æ•°
    explicit atomic_shared_ptr(T* ptr = nullptr)
        : ptr_(ptr), count_(new std::atomic<int>(1)) {}

    // æ‹·è´æ„é€ å‡½æ•°
    atomic_shared_ptr(const atomic_shared_ptr& other)
        : ptr_(other.ptr_), count_(other.count_) {
        // å¢åŠ å¼•ç”¨è®¡æ•°
        count_->fetch_add(1, std::memory_order_relaxed);
    }

    // ç§»åŠ¨æ„é€ å‡½æ•°
    atomic_shared_ptr(atomic_shared_ptr&& other) noexcept
        : ptr_(other.ptr_), count_(other.count_) {
        other.ptr_ = nullptr;
        other.count_ = nullptr;
    }

    // ææ„å‡½æ•°
    ~atomic_shared_ptr() {
        if (count_ && count_->fetch_sub(1, std::memory_order_acq_rel) == 1) {
            delete ptr_;
            delete count_;
        }
    }

    // é‡è½½èµ‹å€¼æ“ä½œç¬¦
    atomic_shared_ptr& operator=(const atomic_shared_ptr& other) {
        if (this != &other) {
            // é‡Šæ”¾å½“å‰èµ„æº
            if (count_->fetch_sub(1, std::memory_order_acq_rel) == 1) {
                delete ptr_;
                delete count_;
            }

            // å¤åˆ¶æ•°æ®
            ptr_ = other.ptr_;
            count_ = other.count_;
            count_->fetch_add(1, std::memory_order_relaxed);
        }
        return *this;
    }

    // é‡è½½ç§»åŠ¨èµ‹å€¼æ“ä½œç¬¦
    atomic_shared_ptr& operator=(atomic_shared_ptr&& other) noexcept {
        if (this != &other) {
            // é‡Šæ”¾å½“å‰èµ„æº
            if (count_->fetch_sub(1, std::memory_order_acq_rel) == 1) {
                delete ptr_;
                delete count_;
            }

            // ç§»åŠ¨æ•°æ®
            ptr_ = other.ptr_;
            count_ = other.count_;
            other.ptr_ = nullptr;
            other.count_ = nullptr;
        }
        return *this;
    }

    // è·å–åº•å±‚æŒ‡é’ˆ
    T* get() const { return ptr_; }

    // è·å–å¼•ç”¨è®¡æ•°
    int use_count() const { return count_->load(std::memory_order_acquire); }

private:
    T* ptr_;  // è¢«ç®¡ç†çš„æŒ‡é’ˆ
    std::atomic<int>* count_;  // å¼•ç”¨è®¡æ•°
};

int main() {
    atomic_shared_ptr<int> sp1(new int(42));

    // æ‹·è´æ„é€ 
    atomic_shared_ptr<int> sp2 = sp1;
    std::cout << "use_count after copy: " << sp2.use_count() << std::endl;

    // ç§»åŠ¨æ„é€ 
    atomic_shared_ptr<int> sp3 = std::move(sp1);
    std::cout << "use_count after move: " << sp3.use_count() << std::endl;

    return 0;
}

```



## æ™ºèƒ½æŒ‡é’ˆæ˜¯å¦æ˜¯çº¿ç¨‹å®‰å…¨çš„
è¿™æ˜¯ä¸€ä¸ªéå¸¸å…³é”®çš„é—®é¢˜ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­ä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆæ—¶ã€‚

---

### âœ… ç®€è¦ç»“è®ºï¼š  
**C++ æ ‡å‡†åº“çš„æ™ºèƒ½æŒ‡é’ˆå¹¶ä¸æ˜¯å®Œå…¨çº¿ç¨‹å®‰å…¨çš„ã€‚**

---

### ğŸ” åˆ†ç±»å‹åˆ†ææ™ºèƒ½æŒ‡é’ˆçš„çº¿ç¨‹å®‰å…¨æ€§

#### 1. `std::unique_ptr`
- **ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚**
- `unique_ptr` ä¸æ”¯æŒæ‹·è´ï¼Œä»…æ”¯æŒç§»åŠ¨ã€‚
- **å¤šä¸ªçº¿ç¨‹ä¹‹é—´ä¸èƒ½å…±äº«ä¸€ä¸ª `unique_ptr` å®ä¾‹**ã€‚
- ä½¿ç”¨æ—¶å¿…é¡»**ç¡®ä¿å”¯ä¸€æ‹¥æœ‰æƒ**åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­ã€‚

â—å¦‚æœä¸¤ä¸ªçº¿ç¨‹è¯•å›¾å¯¹åŒä¸€ä¸ª `unique_ptr` è¿›è¡Œè¯»å†™ï¼ˆæ¯”å¦‚ä¸€ä¸ªçº¿ç¨‹ resetï¼Œå¦ä¸€ä¸ªçº¿ç¨‹è®¿é—®ï¼‰ï¼Œå°±æ˜¯**æ•°æ®ç«äº‰**ï¼Œç»“æœæ˜¯æœªå®šä¹‰è¡Œä¸ºã€‚

---

#### 2. `std::shared_ptr`
- **å…±äº«æ‰€æœ‰æƒæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚**
- **å¼•ç”¨è®¡æ•°çš„å¢åŠ å’Œå‡å°‘æ“ä½œæ˜¯åŸå­æ“ä½œï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰**ï¼Œè¿™æ˜¯ç”±åº•å±‚ç”¨ `std::atomic` æˆ–å¹³å°åŸå­æ“ä½œå®ç°çš„ã€‚

##### âœ… çº¿ç¨‹å®‰å…¨çš„éƒ¨åˆ†ï¼š
```cpp
std::shared_ptr<T> p1 = std::make_shared<T>();
std::shared_ptr<T> p2 = p1; // å¤šçº¿ç¨‹ä¸­æ‹·è´ shared_ptr æ˜¯å®‰å…¨çš„
```

##### âŒ ä¸å®‰å…¨çš„éƒ¨åˆ†ï¼š
å¤šä¸ªçº¿ç¨‹**åŒæ—¶è®¿é—®æˆ–ä¿®æ”¹åŒä¸€ä¸ª shared_ptr å¯¹è±¡æœ¬èº«**æ˜¯ä¸å®‰å…¨çš„ï¼š
```cpp
// é”™è¯¯ç¤ºä¾‹ï¼šä¸¤ä¸ªçº¿ç¨‹æ“ä½œåŒä¸€ä¸ª shared_ptr å®ä¾‹ï¼ˆéå‰¯æœ¬ï¼‰
std::shared_ptr<T> global_ptr;

void thread1() {
    global_ptr.reset(); // ä¿®æ”¹æŒ‡é’ˆ
}

void thread2() {
    global_ptr->foo(); // ä½¿ç”¨æŒ‡é’ˆ
}
```

ğŸ’¥ è¿™é‡Œä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå› ä¸ºå¤šä¸ªçº¿ç¨‹è®¿é—®äº† **åŒä¸€ä¸ª shared_ptr å¯¹è±¡**ï¼Œè€Œä¸æ˜¯å®ƒçš„å‰¯æœ¬ã€‚è¦å®‰å…¨å°±åº”è¯¥æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä»½è‡ªå·±çš„æ‹·è´ã€‚

---

### â“ ä¸ºä»€ä¹ˆä¸æ˜¯å®Œå…¨çº¿ç¨‹å®‰å…¨ï¼Ÿ

#### å…³é”®ç‚¹åœ¨äºï¼š

- `shared_ptr` çš„ **å¼•ç”¨è®¡æ•°æœºåˆ¶æ˜¯çº¿ç¨‹å®‰å…¨çš„**
- **å¯¹ shared_ptr æœ¬èº«çš„æ“ä½œï¼ˆå¦‚ resetã€swapã€operator->ï¼‰ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„**

ğŸ”§ è¿™æ˜¯å› ä¸ºï¼š
- å¼•ç”¨è®¡æ•°ä½¿ç”¨äº†åŸå­æ“ä½œï¼ˆæ¯”å¦‚ `fetch_add`, `fetch_sub`ï¼‰
- ä½† shared_ptr æœ¬èº«ä¸æ˜¯åŸå­ç±»å‹ï¼Œä¸ä¿æŠ¤å…¶æˆå‘˜ï¼ˆæ¯”å¦‚æ‰˜ç®¡æŒ‡é’ˆæœ¬èº«ï¼‰

---

### âœ… å¦‚ä½•ä¿è¯çº¿ç¨‹å®‰å…¨åœ°ä½¿ç”¨ shared_ptrï¼Ÿ

1. **æ¯ä¸ªçº¿ç¨‹æŒæœ‰ shared_ptr çš„å‰¯æœ¬**ï¼ˆæ‹·è´ shared_ptrï¼‰
2. å¦‚æœå¤šä¸ªçº¿ç¨‹è¦æ“ä½œåŒä¸€ä¸ª shared_ptr å¯¹è±¡ï¼Œéœ€è¦å¤–éƒ¨åŠ é”ä¿æŠ¤
3. å¯ä»¥ä½¿ç”¨ `std::atomic<std::shared_ptr<T>>`ï¼ˆC++20 ä¹‹å‰æ˜¯å¹³å°æ‰©å±•ï¼‰å®ç°çº¿ç¨‹å®‰å…¨çš„å…±äº«æ›´æ–°

---

### ğŸ§  æ€»ç»“

| æ™ºèƒ½æŒ‡é’ˆç±»å‹ | æ‹¥æœ‰æƒçº¿ç¨‹å®‰å…¨ | æŒ‡é’ˆæ“ä½œçº¿ç¨‹å®‰å…¨ | è¯´æ˜ |
|--------------|----------------|------------------|------|
| `unique_ptr` | âŒ å¦           | âŒ å¦             | ä¸å¯å…±äº«ï¼Œéœ€å•çº¿ç¨‹ä½¿ç”¨ |
| `shared_ptr` | âœ… æ˜¯ï¼ˆå¼•ç”¨è®¡æ•°ï¼‰ | âŒ å¦ï¼ˆå¯¹è±¡æ“ä½œï¼‰  | æ‹·è´ä½¿ç”¨å®‰å…¨ï¼Œå…±äº«å®ä¾‹éœ€åŠ é” |
| `weak_ptr`   | âœ… æ˜¯           | âŒ å¦             | å¯å®‰å…¨æå‡ä¸º shared_ptrï¼Œä½†æ“ä½œè‡ªèº«ä¸å®‰å…¨ |

---

å¦‚æœä½ æœ‰å…·ä½“çš„å¤šçº¿ç¨‹ä½¿ç”¨åœºæ™¯æˆ–æƒ³çœ‹çœ‹æ€ä¹ˆæ­£ç¡®ä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆå†™ä¸ªçº¿ç¨‹å®‰å…¨çš„ä¾‹å­ï¼Œæˆ‘ä¹Ÿå¯ä»¥å¸®ä½ å†™ä¸€ä»½ä»£ç ï¼è¦ä¸è¦ï¼Ÿ


# å¼•ç”¨å’ŒæŒ‡é’ˆ
 **ğŸ“Œ C++ ä¸­å¼•ç”¨ï¼ˆreferenceï¼‰å’ŒæŒ‡é’ˆï¼ˆpointerï¼‰çš„åŒºåˆ«**
å¼•ç”¨ (`&`) å’ŒæŒ‡é’ˆ (`*`) éƒ½ç”¨äºé—´æ¥è®¿é—®å¯¹è±¡ï¼Œä½†å®ƒä»¬åœ¨è¯­æ³•ã€ç‰¹æ€§å’Œä½¿ç”¨åœºæ™¯ä¸Šæœ‰å¾ˆå¤šåŒºåˆ«ã€‚

---

## **1ï¸âƒ£ è¯­æ³•å’Œå®šä¹‰**
| ç‰¹æ€§  | **æŒ‡é’ˆ (Pointer)** | **å¼•ç”¨ (Reference)** |
|------|------------------|------------------|
| **å®šä¹‰** | `int* p = &a;` | `int& r = a;` |
| **è®¿é—®** | é€šè¿‡ `*p` è®¿é—®å¯¹è±¡ | ç›´æ¥ä½¿ç”¨ `r` è®¿é—®å¯¹è±¡ |
| **åˆå§‹åŒ–** | å¯ä»¥åˆå§‹åŒ–ä¸ºç©º (`nullptr`) | **å¿…é¡»åˆå§‹åŒ–** |
| **é‡æ–°ç»‘å®š** | `p = &b;` (æŒ‡å‘æ–°çš„åœ°å€) | **ä¸èƒ½é‡æ–°ç»‘å®š**ï¼Œä¸€ç›´æŒ‡å‘ `a` |
| **æ˜¯å¦æ˜¯å¯¹è±¡æœ¬èº«** | åªæ˜¯å­˜å‚¨åœ°å€çš„å˜é‡ | åªæ˜¯ `a` çš„åˆ«å |

âœ… **ç¤ºä¾‹**
```cpp
int a = 10;
int* p = &a;  // æŒ‡é’ˆ
int& r = a;   // å¼•ç”¨

std::cout << *p << " " << r << std::endl;  // è¾“å‡º 10 10
```

---

## **2ï¸âƒ£ æ˜¯å¦å¿…é¡»åˆå§‹åŒ–**
| ç‰¹æ€§  | **æŒ‡é’ˆ (Pointer)** | **å¼•ç”¨ (Reference)** |
|------|------------------|------------------|
| **æ˜¯å¦å¿…é¡»åˆå§‹åŒ–** | å¯ä»¥å£°æ˜ä½†ä¸åˆå§‹åŒ– | **å¿…é¡»åˆå§‹åŒ–** |
| **æ˜¯å¦å¯ä»¥æŒ‡å‘ `nullptr`** | å¯ä»¥æŒ‡å‘ `nullptr` | âŒ ä¸èƒ½ä¸º `nullptr` |

âœ… **ç¤ºä¾‹**
```cpp
int* p;  // âœ… åˆæ³•ï¼Œä½†æŒ‡å‘æœªçŸ¥åœ°å€ï¼Œå¯èƒ½æ˜¯é‡æŒ‡é’ˆ
int& r;  // âŒ é”™è¯¯ï¼Œå¼•ç”¨å¿…é¡»åˆå§‹åŒ–
```

---

## **3ï¸âƒ£ èƒ½å¦é‡æ–°ç»‘å®š**
| ç‰¹æ€§  | **æŒ‡é’ˆ (Pointer)** | **å¼•ç”¨ (Reference)** |
|------|------------------|------------------|
| **æ˜¯å¦å¯ä»¥æ›´æ”¹æ‰€æŒ‡å¯¹è±¡** | âœ… å¯ä»¥æŒ‡å‘æ–°å¯¹è±¡ (`p = &b;`) | âŒ ä¸èƒ½é‡æ–°ç»‘å®š (`r` ç»‘å®šåä¸èƒ½æ”¹) |

âœ… **ç¤ºä¾‹**
```cpp
int a = 10, b = 20;

int* p = &a;  // æŒ‡é’ˆæŒ‡å‘ a
p = &b;       // âœ… å¯ä»¥é‡æ–°æŒ‡å‘ b

int& r = a;   // å¼•ç”¨ç»‘å®š a
r = b;        // âŒ r è¿˜æ˜¯æŒ‡å‘ aï¼Œåªæ˜¯ä¿®æ”¹äº† a çš„å€¼
```
ğŸ“Œ **å¼•ç”¨åªæ˜¯ä¸€ä¸ªåˆ«åï¼Œä¸æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„å˜é‡**ã€‚

---

## **4ï¸âƒ£ æŒ‡å‘å¸¸é‡**
| ç‰¹æ€§  | **æŒ‡é’ˆ (Pointer)** | **å¼•ç”¨ (Reference)** |
|------|------------------|------------------|
| `const` ä¿®é¥°å¯¹è±¡ | `const int* p;` (æŒ‡å‘ `const` å¯¹è±¡) | `const int& r;` |
| `const` ä¿®é¥°æŒ‡é’ˆ | `int* const p;` (æŒ‡é’ˆæœ¬èº« `const`) | âŒ ä¸é€‚ç”¨ |

âœ… **ç¤ºä¾‹**
```cpp
const int a = 10;
const int* p = &a;  // âœ… æŒ‡é’ˆæŒ‡å‘å¸¸é‡
const int& r = a;   // âœ… å¼•ç”¨ç»‘å®šå¸¸é‡

*p = 20;  // âŒ é”™è¯¯ï¼Œä¸èƒ½ä¿®æ”¹ a
r = 20;   // âŒ é”™è¯¯ï¼Œä¸èƒ½ä¿®æ”¹ a
```

---

## **5ï¸âƒ£ å†…å­˜å ç”¨**
| ç‰¹æ€§  | **æŒ‡é’ˆ (Pointer)** | **å¼•ç”¨ (Reference)** |
|------|------------------|------------------|
| **å ç”¨å†…å­˜** | **æŒ‡é’ˆå­˜å‚¨åœ°å€ï¼Œå ç”¨ 4/8 å­—èŠ‚** | **å¼•ç”¨é€šå¸¸ä¸å é¢å¤–ç©ºé—´**ï¼ˆå¯èƒ½å®ç°ä¸Šä¸æŒ‡é’ˆç›¸åŒï¼‰ |

âœ… **ç¤ºä¾‹**
```cpp
int a = 10;
int* p = &a;
int& r = a;

std::cout << sizeof(p) << std::endl;  // 8 (64 ä½ç³»ç»Ÿ)
std::cout << sizeof(r) << std::endl;  // 4 (é€šå¸¸å’Œ a ä¸€æ ·)
```
ğŸ“Œ **æŒ‡é’ˆæœ‰è‡ªå·±çš„å­˜å‚¨ç©ºé—´ï¼Œå¼•ç”¨é€šå¸¸åªæ˜¯ä¸€ä¸ªåˆ«åï¼Œä¸é¢å¤–å å†…å­˜**ã€‚

---

## **6ï¸âƒ£ é€‚ç”¨åœºæ™¯**
| åœºæ™¯ | **ä½¿ç”¨æŒ‡é’ˆ (Pointer)** | **ä½¿ç”¨å¼•ç”¨ (Reference)** |
|------|------------------|------------------|
| **åŠ¨æ€å†…å­˜åˆ†é…** | `new`/`delete` éœ€è¦æŒ‡é’ˆ | âŒ ä¸èƒ½ä½¿ç”¨ `new`/`delete` |
| **å¯å˜å¯¹è±¡** | éœ€è¦åŠ¨æ€ç»‘å®šå¯¹è±¡ | ç»‘å®šåä¸å¯å˜ |
| **å‚æ•°ä¼ é€’** | éœ€è¦ä¼  `nullptr` æˆ–å¯å˜æŒ‡å‘ | ä¼ é€’å¯¹è±¡çš„åˆ«å |

âœ… **ç¤ºä¾‹**
```cpp
void modifyPointer(int* p) { *p = 20; }
void modifyReference(int& r) { r = 30; }

int main() {
    int a = 10;
    modifyPointer(&a);    // ä¼ é€’åœ°å€
    modifyReference(a);   // ä¼ é€’å¼•ç”¨
}
```
ğŸ“Œ **å‡½æ•°å‚æ•°ä¼ å¼•ç”¨ï¼Œé¿å…æ‹·è´ï¼Œæé«˜æ€§èƒ½**ã€‚

---

## **7ï¸âƒ£ ç©ºæŒ‡é’ˆ vs. æ— æ•ˆå¼•ç”¨**
| ç‰¹æ€§  | **æŒ‡é’ˆ (Pointer)** | **å¼•ç”¨ (Reference)** |
|------|------------------|------------------|
| **å¯ä»¥æ˜¯ `nullptr` å—ï¼Ÿ** | âœ… å¯ä»¥ | âŒ ä¸èƒ½ |
| **å¯èƒ½æˆä¸ºæ‚¬ç©ºï¼Ÿ** | âœ… å¯èƒ½ (æŒ‡å‘é‡Šæ”¾çš„å†…å­˜) | âœ… å¯èƒ½ (æŒ‡å‘æ— æ•ˆå¯¹è±¡) |

âœ… **ç¤ºä¾‹**
```cpp
int* p = nullptr;  // âœ… åˆæ³•
int& r = *p;       // âŒ æœªå®šä¹‰è¡Œä¸ºï¼ˆUBï¼‰
```
ğŸ“Œ **å¼•ç”¨ä¸èƒ½æ˜¯ `nullptr`ï¼Œå¦åˆ™æ˜¯æœªå®šä¹‰è¡Œä¸º**ã€‚

---

## **ğŸ¯ æ€»ç»“**
| ç‰¹æ€§  | **æŒ‡é’ˆ (Pointer)** | **å¼•ç”¨ (Reference)** |
|------|------------------|------------------|
| **å¿…é¡»åˆå§‹åŒ–** | âŒ ä¸æ˜¯å¿…é¡»çš„ | âœ… å¿…é¡»åˆå§‹åŒ– |
| **å¯å¦é‡æ–°ç»‘å®š** | âœ… å¯ä»¥æ›´æ”¹æŒ‡å‘çš„å¯¹è±¡ | âŒ ä¸èƒ½é‡æ–°ç»‘å®š |
| **æ˜¯å¦å¯ `nullptr`** | âœ… å¯ä»¥ | âŒ ä¸èƒ½ |
| **æ˜¯å¦å å†…å­˜** | âœ… å ç”¨åœ°å€ç©ºé—´ | âŒ ä¸€èˆ¬ä¸å å†…å­˜ |
| **ç”¨äºåŠ¨æ€åˆ†é…** | âœ… éœ€è¦ `new/delete` | âŒ ä¸èƒ½ä½¿ç”¨ |
| **ç”¨äºä¼ å‚** | âœ… ä¼ åœ°å€ | âœ… ä¼ å¼•ç”¨ï¼ˆæ•ˆç‡æ›´é«˜ï¼‰ |
| **æ˜¯å¦å¯ä»¥æŒ‡å‘ `const`** | âœ… å¯ä»¥æŒ‡å‘ `const` | âœ… å¯ä»¥å¼•ç”¨ `const` |

---

## **ğŸ¯ ä»€ä¹ˆæ—¶å€™ç”¨å¼•ç”¨ vs. æŒ‡é’ˆï¼Ÿ**
âœ… **ä½¿ç”¨å¼•ç”¨**
- ä¼ é€’å‡½æ•°å‚æ•°æ—¶ï¼Œå‡å°‘æ‹·è´ï¼Œæé«˜æ€§èƒ½ `void func(const std::string& s);`
- ç¡®ä¿ç»‘å®šåä¸ä¼šæ›´æ”¹å¯¹è±¡
- é€‚ç”¨äº `RAII`ï¼ˆèµ„æºç®¡ç†ï¼‰

âœ… **ä½¿ç”¨æŒ‡é’ˆ**
- éœ€è¦ `nullptr` ä½œä¸ºæ— æ•ˆå€¼
- éœ€è¦åŠ¨æ€åˆ†é…å¯¹è±¡ (`new` / `delete`)
- éœ€è¦ä¿®æ”¹æŒ‡å‘çš„å¯¹è±¡ (`p = &b;`)

---

**ğŸ“Œ è®°ä½ï¼š**
1. **å¼•ç”¨æ›´å®‰å…¨**ï¼Œå› ä¸ºå®ƒä¸èƒ½ä¸º `nullptr`ï¼Œä¸”ç»‘å®šåä¸èƒ½æ›´æ”¹ã€‚
2. **æŒ‡é’ˆæ›´çµæ´»**ï¼Œå¯ä»¥æŒ‡å‘ `nullptr`ï¼Œä¹Ÿå¯ä»¥é‡æ–°æŒ‡å‘æ–°å¯¹è±¡ã€‚
3. **æ€§èƒ½ä¸Šï¼Œå¼•ç”¨é€šå¸¸æ¯”æŒ‡é’ˆæ›´å¿«**ï¼Œå› ä¸ºå®ƒé¿å…äº†é—´æ¥è®¿é—®ã€‚

è¿™æ ·ï¼Œé¢è¯•æ—¶å°±èƒ½æ¸…æ™°åœ°å›ç­”äº†ï¼ğŸ¯ğŸ’¡



# æ¨¡æ¿ç¼–ç¨‹
C++ **æ¨¡æ¿ç¼–ç¨‹**ï¼ˆTemplate Programmingï¼‰æ˜¯ä¸€ç§**ç¼–è¯‘æœŸå¤šæ€**æŠ€æœ¯ï¼Œå¹¿æ³›ç”¨äº**æ³›å‹ç¼–ç¨‹ï¼ˆGeneric Programmingï¼‰**ã€**å…ƒç¼–ç¨‹ï¼ˆTemplate Metaprogramming, TMPï¼‰**ï¼Œä»¥åŠ**STLï¼ˆæ ‡å‡†æ¨¡æ¿åº“ï¼‰**ç­‰é¢†åŸŸã€‚  

---
## **ğŸ“Œ ç›®å½•**
### 1ï¸âƒ£ **æ¨¡æ¿åŸºç¡€**
   - **å‡½æ•°æ¨¡æ¿**
   - **ç±»æ¨¡æ¿**
   - **æ¨¡æ¿çš„æ˜¾å¼/éšå¼å®ä¾‹åŒ–**
   - **æ¨¡æ¿çš„é»˜è®¤å‚æ•°**
   - **æ¨¡æ¿çš„ç‰¹åŒ–**
   - **æ¨¡æ¿çš„éƒ¨åˆ†ç‰¹åŒ–**
   - **æ¨¡æ¿åˆ«å (`using`)**
   - **å¯å˜å‚æ•°æ¨¡æ¿ (`Variadic Templates`)**
---
### 2ï¸âƒ£ **é«˜çº§æ¨¡æ¿æŠ€å·§**
   - **æ¨¡æ¿é€’å½’**
   - **SFINAEï¼ˆSubstitution Failure Is Not An Errorï¼‰**
   - **ç±»å‹èƒå– (`Type Traits`)**
   - **å®Œç¾è½¬å‘ (`std::forward`)**
   - **CRTPï¼ˆCuriously Recurring Template Patternï¼‰**
   - **ä¾èµ–åç§° (`dependent names`)**
   - **æ¨¡æ¿åç‰¹åŒ– vs. é‡è½½**
   - **æ¨¡æ¿å‚æ•°æ¨å¯¼è§„åˆ™**
---
### 3ï¸âƒ£ **æ¨¡æ¿å…ƒç¼–ç¨‹ï¼ˆTMPï¼‰**
   - **ç¼–è¯‘æœŸå¸¸é‡è®¡ç®—**
   - **ç¼–è¯‘æœŸ `if` è¯­å¥ (`std::enable_if`)**
   - **ç¼–è¯‘æœŸå¾ªç¯**
   - **é€’å½’æ¨¡æ¿**
   - **æ¨¡æ¿å…ƒç¼–ç¨‹ä¸ `constexpr`**
   - **C++17 `if constexpr`**
---
### 4ï¸âƒ£ **æ¨¡æ¿çš„åº•å±‚å®ç°**
   - **æ¨¡æ¿çš„å®ä¾‹åŒ–æœºåˆ¶**
   - **æ¨¡æ¿ä¸é“¾æ¥**
   - **æ¨¡æ¿çš„ ODRï¼ˆOne Definition Ruleï¼‰**
   - **ç¼–è¯‘å™¨å¯¹æ¨¡æ¿çš„ä¼˜åŒ–**
   - **æ¨¡æ¿ä»£ç è†¨èƒ€**
---

---

## **1ï¸âƒ£ æ¨¡æ¿åŸºç¡€**

### **âœ… å‡½æ•°æ¨¡æ¿**
**æ³›å‹å‡½æ•°**ï¼Œå¯ä»¥æ”¯æŒä¸åŒç±»å‹ï¼š
```cpp
template <typename T>
T add(T a, T b) {
    return a + b;
}

int main() {
    std::cout << add(3, 5) << "\n";      // int
    std::cout << add(3.2, 5.1) << "\n";  // double
}
```
ğŸ“Œ **å…³é”®ç‚¹**
- `T` æ˜¯**æ¨¡æ¿å‚æ•°**ï¼Œå¯ç”¨äºè¡¨ç¤ºä»»æ„ç±»å‹ã€‚
- `add<int>(3, 5)` **æ˜¾å¼æŒ‡å®šç±»å‹**ã€‚
- `add(3, 5)` **è‡ªåŠ¨æ¨å¯¼ç±»å‹**ã€‚

---

### **âœ… ç±»æ¨¡æ¿**
ç”¨äºå®šä¹‰**æ³›å‹ç±»**ï¼š
```cpp
template <typename T>
class Box {
private:
    T value;
public:
    Box(T v) : value(v) {}
    T get() { return value; }
};

int main() {
    Box<int> intBox(10);
    std::cout << intBox.get() << std::endl; // 10

    Box<std::string> strBox("Hello");
    std::cout << strBox.get() << std::endl; // Hello
}
```
ğŸ“Œ **å…³é”®ç‚¹**
- `Box<int>`ï¼šå®ä¾‹åŒ– `T = int` ç‰ˆæœ¬ã€‚
- `Box<std::string>`ï¼šå®ä¾‹åŒ– `T = std::string` ç‰ˆæœ¬ã€‚

---

### **âœ… æ¨¡æ¿çš„é»˜è®¤å‚æ•°**
```cpp
template <typename T = int>
class DefaultBox {
public:
    T value;
    DefaultBox(T v) : value(v) {}
};

int main() {
    DefaultBox<> a(42);  // é»˜è®¤ä¸º int
    DefaultBox<double> b(3.14);
}
```

---

### **âœ… æ˜¾å¼/éšå¼å®ä¾‹åŒ–**
```cpp
template <typename T>
T square(T x) {
    return x * x;
}

int main() {
    std::cout << square(5);       // éšå¼å®ä¾‹åŒ–ï¼ŒT æ¨å¯¼ä¸º int
    std::cout << square<double>(2.5);  // æ˜¾å¼å®ä¾‹åŒ–
}
```

---

### **âœ… æ¨¡æ¿ç‰¹åŒ–**
#### **å®Œå…¨ç‰¹åŒ–**
```cpp
template <typename T>
class Printer {
public:
    void print(T value) {
        std::cout << "Generic: " << value << std::endl;
    }
};

// é’ˆå¯¹ int è¿›è¡Œç‰¹åŒ–
template <>
class Printer<int> {
public:
    void print(int value) {
        std::cout << "Specialized for int: " << value << std::endl;
    }
};
```

#### **éƒ¨åˆ†ç‰¹åŒ–**
```cpp
template <typename T1, typename T2>
class Pair {};

// é’ˆå¯¹ `Pair<T, int>` è¿›è¡Œéƒ¨åˆ†ç‰¹åŒ–
template <typename T>
class Pair<T, int> {};
```

---

### **âœ… å¯å˜å‚æ•°æ¨¡æ¿**
```cpp
template<typename... Args>
void print(Args... args) {
    (std::cout << ... << args) << std::endl;
}

int main() {
    print(1, 2, "hello", 3.14);
}
```
ğŸ“Œ **C++11 å¼•å…¥ `...`ï¼Œæ”¯æŒä»»æ„ä¸ªå‚æ•°ï¼**

---

## **2ï¸âƒ£ é«˜çº§æ¨¡æ¿æŠ€å·§**

### **âœ… SFINAE**
```cpp
template<typename T>
auto func(T t) -> decltype(t.begin()) { // åªæœ‰ t.begin() å­˜åœ¨æ—¶ï¼Œæ­¤å‡½æ•°æ‰æœ‰æ•ˆ
    return t.begin();
}
```
ğŸ“Œ **SFINAE å…è®¸ç¼–è¯‘å™¨åœ¨æ¨¡æ¿åŒ¹é…å¤±è´¥æ—¶ä¸æŠ¥é”™ï¼Œè€Œæ˜¯å°è¯•å…¶ä»–å€™é€‰æ¨¡æ¿ã€‚**

---

### **âœ… CRTPï¼ˆCuriously Recurring Template Patternï¼‰**
```cpp
template <typename Derived>
class Base {
public:
    void interface() {
        static_cast<Derived*>(this)->implementation();
    }
};

class Derived : public Base<Derived> {
public:
    void implementation() {
        std::cout << "Implementation in Derived\n";
    }
};

int main() {
    Derived d;
    d.interface();
}
```
ğŸ“Œ **CRTP å…è®¸åŸºç±»è°ƒç”¨æ´¾ç”Ÿç±»çš„æ–¹æ³•ï¼Œæé«˜ç¼–è¯‘æœŸä¼˜åŒ–èƒ½åŠ›ï¼**

---

### **âœ… å®Œç¾è½¬å‘**
```cpp
template <typename T>
void wrapper(T&& arg) {
    anotherFunction(std::forward<T>(arg));
}
```
ğŸ“Œ **`std::forward<T>(arg)` ä½¿ `arg` æ—¢èƒ½æ¥æ”¶å·¦å€¼ï¼Œåˆèƒ½æ¥æ”¶å³å€¼ï¼ˆå®Œç¾è½¬å‘ï¼‰ã€‚**

---

## **3ï¸âƒ£ æ¨¡æ¿å…ƒç¼–ç¨‹ï¼ˆTMPï¼‰**
```cpp
template<int N>
struct Factorial {
    static const int value = N * Factorial<N - 1>::value;
};

template<>
struct Factorial<0> {
    static const int value = 1;
};

int main() {
    std::cout << Factorial<5>::value; // 120
}
```
ğŸ“Œ **é€’å½’æ¨¡æ¿è®¡ç®— `5!`ï¼Œå®ç°ç¼–è¯‘æœŸè®¡ç®—ï¼**

---

## **4ï¸âƒ£ æ¨¡æ¿çš„åº•å±‚å®ç°**

### **âœ… ODRï¼ˆOne Definition Ruleï¼‰**
æ¨¡æ¿ä»£ç åœ¨å¤šä¸ª `.cpp` æ–‡ä»¶ä¸­å¯èƒ½ä¼šå¼•å‘**é“¾æ¥é”™è¯¯**ï¼Œå› ä¸ºå®ƒä»¬éœ€è¦**å®ä¾‹åŒ–**ï¼š
```cpp
// header file: foo.h
template <typename T>
void foo(T value);

// source file: foo.cpp
#include "foo.h"
template <typename T>
void foo(T value) {}

// ä½¿ç”¨æ—¶ï¼š
// main.cpp
#include "foo.h"
foo(10);  // å¯èƒ½å¯¼è‡´é“¾æ¥é”™è¯¯
```
ğŸ“Œ **è§£å†³æ–¹æ¡ˆ**
- **å°†æ¨¡æ¿å®šä¹‰æ”¾å…¥å¤´æ–‡ä»¶** (`.h`)
- **ä½¿ç”¨æ˜¾å¼å®ä¾‹åŒ–** (`template class Foo<int>;`)

---

## **æ€»ç»“**
C++ **æ¨¡æ¿ç¼–ç¨‹**æä¾›äº†**æ³›å‹ç¼–ç¨‹ã€æ¨¡æ¿ç‰¹åŒ–ã€æ¨¡æ¿å…ƒç¼–ç¨‹ï¼ˆTMPï¼‰ã€å®Œç¾è½¬å‘ç­‰å¼ºå¤§ç‰¹æ€§**ï¼Œä½¿å¾— C++ ä»£ç æ›´åŠ **çµæ´»ã€å¯å¤ç”¨ã€é«˜æ•ˆ**ã€‚ğŸš€

# è™šå‡½æ•°
## è™šå‡½æ•°çš„å†…å­˜åˆ†å¸ƒ
```cpp
class A {
  public:
    virtual void v_a(){}
    virtual ~A(){}
    int64_t _m_a;
};

int main(){
    A* a = new A();
    return 0;
}
```
å¯¹äºè¿™æ®µä»£ç ï¼Œ
å¦‚ä»¥ä¸Šä»£ç æ‰€ç¤ºï¼Œåœ¨C++ä¸­å®šä¹‰ä¸€ä¸ªå¯¹è±¡ Aï¼Œé‚£ä¹ˆåœ¨å†…å­˜ä¸­çš„åˆ†å¸ƒå¤§æ¦‚æ˜¯å¦‚ä¸‹å›¾è¿™ä¸ªæ ·å­ã€‚

- é¦–å…ˆåœ¨ä¸»å‡½æ•°çš„**æ ˆå¸§ä¸Šæœ‰ä¸€ä¸ª A ç±»å‹çš„æŒ‡é’ˆ**æŒ‡å‘å †é‡Œé¢åˆ†é…å¥½çš„å¯¹è±¡ A å®ä¾‹ã€‚
å¯¹è±¡ **A å®ä¾‹çš„å¤´éƒ¨æ˜¯ä¸€ä¸ª vtable æŒ‡é’ˆ**ï¼Œç´§æ¥ç€æ˜¯ A å¯¹è±¡æŒ‰ç…§å£°æ˜é¡ºåºæ’åˆ—çš„æˆå‘˜å˜é‡ã€‚ï¼ˆå½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œä¾¿å¯ä»¥é€šè¿‡å®ä¾‹å¯¹è±¡çš„åœ°å€ï¼Œå¾—åˆ°è¯¥å®ä¾‹çš„è™šå‡½æ•°è¡¨ï¼Œä»è€Œè·å–å…¶å‡½æ•°æŒ‡é’ˆã€‚ï¼‰
- **vtable æŒ‡é’ˆæŒ‡å‘çš„æ˜¯ä»£ç æ®µä¸­çš„ A ç±»å‹çš„è™šå‡½æ•°è¡¨ä¸­çš„ç¬¬ä¸€ä¸ªè™šå‡½æ•°èµ·å§‹åœ°å€**ã€‚
è™šå‡½æ•°è¡¨çš„ç»“æ„å…¶å®æ˜¯æœ‰ä¸€ä¸ªå¤´éƒ¨çš„ï¼Œå«åš vtable_prefix ï¼Œç´§æ¥ç€æ˜¯æŒ‰ç…§å£°æ˜é¡ºåºæ’åˆ—çš„è™šå‡½æ•°ã€‚
- æ³¨æ„åˆ°è¿™é‡Œæœ‰**ä¸¤ä¸ªè™šææ„å‡½æ•°**ï¼Œå› ä¸ºå¯¹è±¡æœ‰ä¸¤ç§æ„é€ æ–¹å¼ï¼Œ**æ ˆæ„é€ å’Œå †æ„é€ **ï¼Œæ‰€ä»¥å¯¹åº”çš„ï¼Œå¯¹è±¡ä¼šæœ‰ä¸¤ç§ææ„æ–¹å¼ï¼Œå…¶ä¸­å †ä¸Šå¯¹è±¡çš„ææ„å’Œæ ˆä¸Šå¯¹è±¡çš„ææ„ä¸åŒä¹‹å¤„åœ¨äºï¼Œ**æ ˆå†…å­˜çš„ææ„ä¸éœ€è¦æ‰§è¡Œ delete å‡½æ•°ï¼Œä¼šè‡ªåŠ¨è¢«å›æ”¶**ã€‚
- typeinfo **å­˜å‚¨ç€ A çš„ç±»åŸºç¡€ä¿¡æ¯**ï¼Œ**åŒ…æ‹¬çˆ¶ç±»ä¸ç±»åç§°**ï¼ŒC++å…³é”®å­— typeid è¿”å›çš„å°±æ˜¯è¿™ä¸ªå¯¹è±¡ã€‚
- typeinfo ä¹Ÿæ˜¯ä¸€ä¸ªç±»ï¼Œå¯¹äºæ²¡æœ‰çˆ¶ç±»çš„ A æ¥è¯´ï¼Œå½“å‰ tinfo æ˜¯ class_type_info ç±»å‹çš„ï¼Œä»è™šå‡½æ•°æŒ‡é’ˆæŒ‡å‘çš„vtable èµ·å§‹ä½ç½®å¯ä»¥çœ‹å‡ºã€‚
![alt text](image-168.png)
![alt text](image-169.png)

## è™šè¡¨ä¸­çš„RTTI(Run-Time Type Information)æ˜¯ä»€ä¹ˆï¼Œä»€ä¹ˆæ—¶å€™ç”¨åˆ°RTTI
è™šå‡½æ•°è¡¨é¦–éƒ¨é€šå¸¸åŒ…å«â€‹**â€‹ç±»å‹ä¿¡æ¯æŒ‡é’ˆ**â€‹â€‹ï¼Œç”¨äºæ”¯æŒ**è¿è¡Œæ—¶ç±»å‹è¯†åˆ«RTTI**å’Œ**dynamic_cast**æ“ä½œï¼š

- è¯¥æŒ‡é’ˆæŒ‡å‘ç±»çš„â€‹â€‹ç±»å‹æè¿°ç»“æ„â€‹â€‹ï¼ˆå¦‚ç±»å‹åç§°ã€ç»§æ‰¿å…³ç³»ç­‰ï¼‰ï¼›
- è¿™ä¸€è®¾è®¡å…è®¸åœ¨è¿è¡Œæ—¶åŠ¨æ€åˆ¤æ–­å¯¹è±¡çš„å®é™…ç±»å‹ã€‚

è™šå‡½æ•°è¡¨ï¼ˆvtableï¼‰ä¸­é™¤äº†è™šå‡½æ•°æŒ‡é’ˆå¤–ï¼Œè¿˜å¯èƒ½åŒ…å« **RTTIï¼ˆRun-Time Type Informationï¼Œè¿è¡Œæ—¶ç±»å‹ä¿¡æ¯ï¼‰**ï¼Œå®ƒæ˜¯ç”¨æ¥æ”¯æŒ C++ **ç±»å‹è¯†åˆ«ä¸ç±»å‹å®‰å…¨** çš„æœºåˆ¶ã€‚

ä¸‹é¢æˆ‘æ¥è¯¦ç»†è®²è§£ï¼š

---

### ğŸ”¹ ä»€ä¹ˆæ˜¯ RTTIï¼Ÿ

RTTI æ˜¯ C++ æä¾›çš„ä¸€ç§æœºåˆ¶ï¼Œç”¨äºåœ¨ç¨‹åºè¿è¡Œæ—¶è¯†åˆ«å¯¹è±¡çš„çœŸå®ç±»å‹ã€‚

å®ƒæ”¯æŒçš„åŠŸèƒ½ä¸»è¦æœ‰ä¸¤ä¸ªï¼š

1. **`typeid` è¿ç®—ç¬¦**ï¼šè·å–å¯¹è±¡çš„å®é™…ç±»å‹ã€‚
2. **`dynamic_cast` è¿ç®—ç¬¦**ï¼šç”¨äºå®‰å…¨åœ°è¿›è¡Œå¤šæ€ç±»å‹è½¬æ¢ã€‚

è¿™äº›åŠŸèƒ½éƒ½ä¾èµ–äº RTTIã€‚

---

### ğŸ”¹ RTTI åœ¨è™šè¡¨ä¸­çš„ä½ç½®

åœ¨ä¸€ä¸ªå¯ç”¨äº†è™šå‡½æ•°çš„ç±»ä¸­ï¼Œç¼–è¯‘å™¨ä¼šä¸ºæ¯ä¸ªç±»ç”Ÿæˆä¸€å¼ è™šå‡½æ•°è¡¨ï¼ˆvtableï¼‰ï¼Œå¹¶åœ¨æ¯ä¸ªå¯¹è±¡ä¸­æ·»åŠ ä¸€ä¸ªæŒ‡å‘è¿™å¼ è¡¨çš„æŒ‡é’ˆï¼ˆvptrï¼‰ã€‚

è™šè¡¨ä¸­é€šå¸¸åŒ…å«å¦‚ä¸‹å†…å®¹ï¼š

```
[0] pointer to RTTIï¼ˆtype_infoå¯¹è±¡æŒ‡é’ˆï¼‰
[1] pointer to virtual function 1
[2] pointer to virtual function 2
...
```

> RTTI æŒ‡é’ˆï¼ˆtype_info çš„åœ°å€ï¼‰é€šå¸¸å°±å­˜å‚¨åœ¨è™šè¡¨çš„èµ·å§‹ä½ç½®ï¼ˆæˆ–é™„è¿‘çš„ä½ç½®ï¼Œå…·ä½“å’Œç¼–è¯‘å™¨å®ç°æœ‰å…³ï¼‰ã€‚

å½“ä½ åœ¨è¿è¡Œæ—¶è°ƒç”¨ `typeid(obj)` æˆ– `dynamic_cast`ï¼Œç¼–è¯‘å™¨ä¼šåˆ©ç”¨ `vptr` æŸ¥æ‰¾è™šè¡¨ï¼Œç„¶åè®¿é—® RTTI ä¿¡æ¯è¿›è¡Œç±»å‹åˆ¤æ–­æˆ–è½¬æ¢ã€‚

---

### ğŸ”¹ ä¸¾ä¸ªä¾‹å­

```cpp
#include <iostream>
#include <typeinfo>

class Base {
public:
    virtual void foo() {}
};

class Derived : public Base {
public:
    void foo() override {}
};

int main() {
    Base* b = new Derived;
    std::cout << typeid(*b).name() << std::endl;  // è¾“å‡º Derived çš„ç±»å‹å
    delete b;
}
```

- è¿™é‡Œ `typeid(*b)` ä¼šä» `b` æŒ‡å‘çš„å¯¹è±¡ä¸­é€šè¿‡ `vptr` è®¿é—®å…¶è™šè¡¨ï¼›
- è™šè¡¨ä¸­å«æœ‰ RTTI ä¿¡æ¯ï¼›
- ç„¶åç”¨ RTTI æ¥åˆ¤æ–­å®é™…ç±»å‹æ˜¯ `Derived`ã€‚

---

### ğŸ”¹ æ²¡æœ‰è™šå‡½æ•°æ—¶è¿˜ä¼šæœ‰ RTTI å—ï¼Ÿ

ä¸ä¼šï¼  
åªæœ‰åŒ…å«è™šå‡½æ•°çš„ç±»å¯¹è±¡æ‰ä¼šå«æœ‰ `vptr`ï¼Œä¹Ÿæ‰ä¼šé™„å¸¦ RTTI ä¿¡æ¯ã€‚  
æ²¡æœ‰è™šå‡½æ•°æ—¶ï¼Œ`typeid` å’Œ `dynamic_cast` åªèƒ½åœ¨ç¼–è¯‘æ—¶èµ·ä½œç”¨ï¼Œè¿è¡Œæ—¶æ— æ³•åˆ†è¾¨çœŸå®ç±»å‹ã€‚

---

### ğŸ”¹ æ€»ç»“

| é¡¹ç›®            | è¯´æ˜ |
|-----------------|------|
| RTTI ä½ç½®       | åœ¨ vtable çš„å¼€å¤´æˆ–ç‰¹å®šä½ç½® |
| åŠŸèƒ½æ”¯æŒ        | typeid å’Œ dynamic_cast |
| ä¾èµ–æ¡ä»¶        | å¿…é¡»æœ‰è™šå‡½æ•°ï¼ˆå³å¤šæ€ç±»ï¼‰ |
| æœ¬è´¨            | ä¸€ä¸ªæŒ‡å‘ `type_info` çš„æŒ‡é’ˆï¼Œè®°å½•ç±»çš„ç±»å‹ä¿¡æ¯ |

---



## è™šå‡½æ•°å®ç°åŸç†
- ä¸€èˆ¬ç»§æ‰¿æ—¶ï¼Œå­ç±»çš„è™šå‡½æ•°è¡¨ä¸­å…ˆå°†çˆ¶ç±»è™šå‡½æ•°æ”¾åœ¨å‰ï¼Œå†æ”¾è‡ªå·±çš„è™šå‡½æ•°æŒ‡é’ˆã€‚
- å¦‚æœå­ç±»è¦†ç›–äº†çˆ¶ç±»çš„è™šå‡½æ•°ï¼Œå°†è¢«æ”¾åˆ°äº†è™šè¡¨ä¸­åŸæ¥çˆ¶ç±»è™šå‡½æ•°çš„ä½ç½®ã€‚
- åœ¨å¤šç»§æ‰¿çš„æƒ…å†µä¸‹ï¼Œæ¯ä¸ªçˆ¶ç±»éƒ½æœ‰è‡ªå·±çš„è™šè¡¨ï¼Œ**å­ç±»çš„æˆå‘˜å‡½æ•°è¢«æ”¾åˆ°äº†ç¬¬ä¸€ä¸ªçˆ¶ç±»çš„è¡¨ä¸­**ã€‚ä¹Ÿå°±æ˜¯è¯´å½“ç±»åœ¨å¤šé‡ç»§æ‰¿ä¸­æ—¶ï¼Œå…¶å®ä¾‹å¯¹è±¡çš„å†…å­˜ç»“æ„å¹¶**ä¸åªè®°å½•ä¸€ä¸ªè™šå‡½æ•°è¡¨æŒ‡é’ˆ**ã€‚åŸºç±»ä¸­æœ‰å‡ ä¸ªå­˜åœ¨è™šå‡½æ•°ï¼Œåˆ™å­ç±»å°±ä¼šä¿å­˜å‡ ä¸ªè™šå‡½æ•°è¡¨æŒ‡é’ˆ
```cpp
class A{
private:
    uint64_t a;
public:
    virtual void A_a(){std::cout << __func__;}
};
class C{
private:
    uint64_t c;
public:
    virtual void C_a(){std::cout << __func__;}
};

class D:public A,public C{
private:
    uint64_t d;
public:
    virtual void D_a(){std::cout << __func__;}
};
```
![alt text](image-170.png)

## è™šå‡½æ•°åº”ç”¨çš„æ³¨æ„äº‹é¡¹

### å†…è”å‡½æ•° (inline)
è™šå‡½æ•°ç”¨äºå®ç°è¿è¡Œæ—¶çš„å¤šæ€ï¼Œæˆ–è€…ç§°ä¸ºæ™šç»‘å®šæˆ–åŠ¨æ€ç»‘å®šã€‚è€Œå†…è”å‡½æ•°ç”¨äºæé«˜æ•ˆç‡ã€‚å†…è”å‡½æ•°çš„åŸç†æ˜¯ï¼Œåœ¨ç¼–è¯‘æœŸé—´ï¼Œå¯¹è°ƒç”¨å†…è”å‡½æ•°çš„åœ°æ–¹çš„ä»£ç æ›¿æ¢æˆå‡½æ•°ä»£ç ã€‚å†…è”å‡½æ•°å¯¹äºç¨‹åºä¸­éœ€è¦é¢‘ç¹ä½¿ç”¨å’Œè°ƒç”¨çš„å°å‡½æ•°éå¸¸æœ‰ç”¨ã€‚é»˜è®¤åœ°ï¼Œç±»ä¸­å®šä¹‰çš„æ‰€æœ‰å‡½æ•°ï¼Œ**é™¤äº†è™šå‡½æ•°ä¹‹å¤–ï¼Œä¼šéšå¼åœ°æˆ–è‡ªåŠ¨åœ°å½“æˆå†…è”å‡½æ•°**(æ³¨æ„ï¼šå†…è”åªæ˜¯å¯¹äºç¼–è¯‘å™¨çš„ä¸€ä¸ªå»ºè®®ï¼Œç¼–è¯‘å™¨å¯ä»¥è‡ªå·±å†³å®šæ˜¯å¦è¿›è¡Œå†…è”).
æ— è®ºä½•æ—¶ï¼Œ**ä½¿ç”¨åŸºç±»æŒ‡é’ˆæˆ–å¼•ç”¨æ¥è°ƒç”¨è™šå‡½æ•°ï¼Œå®ƒéƒ½ä¸èƒ½ä¸ºå†…è”å‡½æ•°(å› ä¸ºè°ƒç”¨å‘ç”Ÿåœ¨è¿è¡Œæ—¶)**ã€‚ä½†æ˜¯ï¼Œæ— è®ºä½•æ—¶ï¼Œä½¿ç”¨ç±»çš„å¯¹è±¡(ä¸æ˜¯æŒ‡é’ˆæˆ–å¼•ç”¨)æ¥è°ƒç”¨æ—¶ï¼Œå¯ä»¥å½“åšæ˜¯å†…è”ï¼Œå› ä¸ºç¼–è¯‘å™¨åœ¨ç¼–è¯‘æ—¶ç¡®åˆ‡çŸ¥é“å¯¹è±¡æ˜¯å“ªä¸ªç±»çš„ã€‚

### é™æ€æˆå‘˜å‡½æ•° (static)
staticæˆå‘˜ä¸å±äºä»»ä½•ç±»å¯¹è±¡æˆ–ç±»å®ä¾‹ï¼Œæ‰€ä»¥å³ä½¿ç»™æ­¤å‡½æ•°åŠ ä¸Švirutalä¹Ÿæ˜¯æ²¡æœ‰ä»»ä½•æ„ä¹‰çš„ã€‚æ­¤å¤–é™æ€ä¸éé™æ€æˆå‘˜å‡½æ•°ä¹‹é—´æœ‰ä¸€ä¸ªä¸»è¦çš„åŒºåˆ«ï¼Œé‚£å°±æ˜¯é™æ€æˆå‘˜å‡½æ•°æ²¡æœ‰thisæŒ‡é’ˆï¼Œä»è€Œå¯¼è‡´ä¸¤è€…è°ƒç”¨æ–¹å¼ä¸åŒã€‚è™šå‡½æ•°ä¾é vptrå’Œvtableæ¥å¤„ç†ã€‚vptræ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œåœ¨ç±»çš„æ„é€ å‡½æ•°ä¸­åˆ›å»ºç”Ÿæˆï¼Œå¹¶ä¸”åªèƒ½ç”¨thisæŒ‡é’ˆæ¥è®¿é—®å®ƒï¼Œå› ä¸ºå®ƒæ˜¯ç±»çš„ä¸€ä¸ªæˆå‘˜ï¼Œå¹¶ä¸”vptræŒ‡å‘ä¿å­˜è™šå‡½æ•°åœ°å€çš„vtableã€‚è™šå‡½æ•°çš„è°ƒç”¨å…³ç³»ï¼šthis -> vptr -> vtable ->virtual functionï¼Œ**å¯¹äºé™æ€æˆå‘˜å‡½æ•°ï¼Œå®ƒæ²¡æœ‰thisæŒ‡é’ˆï¼Œæ‰€ä»¥æ— æ³•è®¿é—®vptr**. è¿™å°±æ˜¯ä¸ºä½•staticå‡½æ•°ä¸èƒ½ä¸ºvirtualã€‚

### æ„é€ å‡½æ•° (constructor)
è™šå‡½æ•°åŸºäºè™šè¡¨vtableï¼ˆå†…å­˜ç©ºé—´ï¼‰ï¼Œæ„é€ å‡½æ•° (constructor) å¦‚æœæ˜¯virtualçš„ï¼Œè°ƒç”¨æ—¶ä¹Ÿéœ€è¦æ ¹æ®vtableå¯»æ‰¾ï¼Œä½†æ˜¯constructoræ˜¯virtualçš„æƒ…å†µä¸‹æ˜¯æ‰¾ä¸åˆ°çš„ï¼Œå› ä¸ºconstructorè‡ªå·±æœ¬èº«éƒ½ä¸å­˜åœ¨äº†ï¼Œåˆ›å»ºä¸åˆ°classçš„å®ä¾‹ï¼Œæ²¡æœ‰å®ä¾‹classçš„æˆå‘˜ï¼ˆé™¤äº†public static/protected static for friend class/functionsï¼Œå…¶ä½™æ— è®ºæ˜¯å¦virtualï¼‰éƒ½ä¸èƒ½è¢«è®¿é—®äº†ã€‚æ­¤å¤–æ„é€ å‡½æ•°ä¸ä»…ä¸èƒ½æ˜¯è™šå‡½æ•°ã€‚è€Œä¸”åœ¨æ„é€ å‡½æ•°ä¸­è°ƒç”¨è™šå‡½æ•°ï¼Œå®é™…æ‰§è¡Œçš„æ˜¯çˆ¶ç±»çš„å¯¹åº”å‡½æ•°ï¼Œå› ä¸ºè‡ªå·±è¿˜æ²¡æœ‰æ„é€ å¥½,å¤šæ€æ˜¯è¢«disableçš„ã€‚

### ææ„å‡½æ•° (deconstructor)
å¯¹äºå¯èƒ½ä½œä¸ºåŸºç±»çš„ç±»çš„ææ„å‡½æ•°è¦æ±‚å°±æ˜¯virtualçš„ã€‚**å› ä¸ºå¦‚æœä¸æ˜¯virtualçš„ï¼Œæ´¾ç”Ÿç±»ææ„çš„æ—¶å€™è°ƒç”¨çš„æ˜¯åŸºç±»çš„ææ„å‡½æ•°ï¼Œè€ŒåŸºç±»çš„ææ„å‡½æ•°åªè¦å¯¹åŸºç±»éƒ¨åˆ†è¿›è¡Œææ„ï¼Œä»è€Œå¯èƒ½å¯¼è‡´æ´¾ç”Ÿç±»éƒ¨åˆ†å‡ºç°å†…å­˜æ³„æ¼é—®é¢˜ã€‚**

### çº¯è™šå‡½æ•°
ææ„å‡½æ•°å¯ä»¥æ˜¯çº¯è™šçš„ï¼Œä½†çº¯è™šææ„å‡½æ•°å¿…é¡»æœ‰å®šä¹‰ä½“ï¼Œå› ä¸ºææ„å‡½æ•°çš„è°ƒç”¨æ˜¯åœ¨å­ç±»ä¸­éšå«çš„ã€‚


# ç±»å’Œç»§æ‰¿
## thisæŒ‡é’ˆçš„æ¥æº
**`this` æŒ‡é’ˆçš„æ¥æºæ˜¯ç¼–è¯‘å™¨åœ¨è°ƒç”¨æˆå‘˜å‡½æ•°æ—¶è‡ªåŠ¨å°†å½“å‰å¯¹è±¡çš„åœ°å€ä¼ é€’ç»™å‡½æ•°ã€‚**
`this` æŒ‡é’ˆæ˜¯ C++ ä¸­çš„ä¸€ä¸ªéšå¼æŒ‡é’ˆï¼Œç”¨äºæŒ‡å‘å½“å‰å¯¹è±¡çš„åœ°å€ã€‚å®ƒç”±ç¼–è¯‘å™¨åœ¨è°ƒç”¨æˆå‘˜å‡½æ•°æ—¶è‡ªåŠ¨ä¼ é€’ç»™è¯¥å‡½æ•°ï¼Œä¸éœ€è¦ç¨‹åºå‘˜æ˜¾å¼ä¼ é€’ã€‚`this` æŒ‡é’ˆçš„æ¥æºå’Œä½œç”¨å¯ä»¥ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢æ¥ç†è§£ï¼š

### 1. **éšå¼å‚æ•°ä¼ é€’**
`this` æŒ‡é’ˆæ˜¯æˆå‘˜å‡½æ•°çš„éšå¼å‚æ•°ã€‚æ¯å½“æˆ‘ä»¬è°ƒç”¨ä¸€ä¸ªæˆå‘˜å‡½æ•°æ—¶ï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨å°†å½“å‰å¯¹è±¡çš„åœ°å€ä¼ é€’ç»™è¯¥å‡½æ•°ï¼Œå¹¶é€šè¿‡ `this` æŒ‡é’ˆåœ¨å‡½æ•°ä½“å†…ä½¿ç”¨ã€‚å¯¹äºéé™æ€æˆå‘˜å‡½æ•°æ¥è¯´ï¼Œ`this` æ€»æ˜¯éšå¼ä¼ é€’ç»™å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ã€‚

ä¾‹å¦‚ï¼Œè€ƒè™‘ä¸‹é¢çš„ç±»å®šä¹‰å’Œæˆå‘˜å‡½æ•°ï¼š

```cpp
class MyClass {
public:
    int value;
    
    void setValue(int v) {
        // ä½¿ç”¨ this æŒ‡é’ˆè®¿é—®å½“å‰å¯¹è±¡çš„æˆå‘˜
        this->value = v;
    }
};
```

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ`this->value` è®¿é—®äº†å½“å‰å¯¹è±¡çš„ `value` æˆå‘˜å˜é‡ã€‚`this` æŒ‡é’ˆæŒ‡å‘å½“å‰å¯¹è±¡ï¼Œå› æ­¤é€šè¿‡ `this` æŒ‡é’ˆå¯ä»¥è®¿é—®è¯¥å¯¹è±¡çš„æˆå‘˜ã€‚

### 2. **`this` æŒ‡é’ˆçš„ç±»å‹**
`this` æŒ‡é’ˆçš„ç±»å‹æ˜¯ `T*`ï¼Œå…¶ä¸­ `T` æ˜¯å½“å‰ç±»çš„ç±»å‹ï¼Œè¡¨ç¤ºæŒ‡å‘å½“å‰å¯¹è±¡çš„æŒ‡é’ˆã€‚ä¾‹å¦‚ï¼Œåœ¨ç±» `MyClass` ä¸­ï¼Œ`this` æŒ‡é’ˆçš„ç±»å‹ä¸º `MyClass*`ã€‚

- å¯¹äºå¸¸æˆå‘˜å‡½æ•°ï¼ˆ`const` æˆå‘˜å‡½æ•°ï¼‰ï¼Œ`this` æŒ‡é’ˆçš„ç±»å‹æ˜¯ `const T*`ï¼Œå³æŒ‡å‘å¸¸é‡çš„æŒ‡é’ˆï¼Œä¸èƒ½ä¿®æ”¹å¯¹è±¡çš„çŠ¶æ€ã€‚
- å¯¹äºéé™æ€æˆå‘˜å‡½æ•°ï¼Œ`this` æŒ‡é’ˆçš„ç±»å‹å§‹ç»ˆæŒ‡å‘å½“å‰å¯¹è±¡ã€‚

### 3. **`this` æŒ‡é’ˆçš„æ¥æº**
å½“è°ƒç”¨æˆå‘˜å‡½æ•°æ—¶ï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨å°†å½“å‰å¯¹è±¡çš„åœ°å€ä½œä¸ºå‚æ•°ä¼ é€’ç»™è¯¥æˆå‘˜å‡½æ•°ã€‚è¿™ä¸ªåœ°å€å°±æ˜¯ `this` æŒ‡é’ˆçš„å€¼ã€‚**å› æ­¤ï¼Œ`this` æŒ‡é’ˆçš„æ¥æºæ˜¯ç¼–è¯‘å™¨åœ¨è°ƒç”¨æˆå‘˜å‡½æ•°æ—¶è‡ªåŠ¨å°†å½“å‰å¯¹è±¡çš„åœ°å€ä¼ é€’ç»™å‡½æ•°ã€‚**

ä¾‹å¦‚ï¼š
```cpp
MyClass obj;
obj.setValue(5);
```
åœ¨è¿™é‡Œï¼Œ`obj` æ˜¯ä¸€ä¸ª `MyClass` ç±»å‹çš„å¯¹è±¡ã€‚å½“è°ƒç”¨ `obj.setValue(5)` æ—¶ï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨å°† `obj` çš„åœ°å€ä½œä¸º `this` æŒ‡é’ˆä¼ é€’ç»™ `setValue` å‡½æ•°ã€‚

### 4. **`this` æŒ‡é’ˆçš„ç‰¹ç‚¹**
- **ä¸å¯ä¿®æ”¹**ï¼š`this` æŒ‡é’ˆæ˜¯ä¸€ä¸ªå¸¸é‡æŒ‡é’ˆï¼Œæ„å‘³ç€ä½ ä¸èƒ½ä¿®æ”¹å®ƒçš„å€¼ã€‚ä½ ä¸èƒ½è®© `this` æŒ‡é’ˆæŒ‡å‘å…¶ä»–å¯¹è±¡ã€‚
- **å­˜åœ¨äºéé™æ€æˆå‘˜å‡½æ•°ä¸­**ï¼š`this` æŒ‡é’ˆåªåœ¨ç±»çš„éé™æ€æˆå‘˜å‡½æ•°ä¸­æœ‰æ•ˆã€‚å¯¹äºé™æ€æˆå‘˜å‡½æ•°ï¼Œ`this` æŒ‡é’ˆå¹¶ä¸å­˜åœ¨ï¼Œå› ä¸ºé™æ€æˆå‘˜å‡½æ•°ä¸ä¾èµ–äºå¯¹è±¡çš„å®ä¾‹ã€‚
- **æŒ‡å‘å½“å‰å¯¹è±¡**ï¼š`this` æŒ‡é’ˆæ€»æ˜¯æŒ‡å‘è°ƒç”¨æˆå‘˜å‡½æ•°çš„å¯¹è±¡ã€‚å®ƒåœ¨æ¯ä¸ªå¯¹è±¡çš„æˆå‘˜å‡½æ•°ä¸­éƒ½æ˜¯å”¯ä¸€çš„ã€‚

### 5. **`this` æŒ‡é’ˆçš„åº”ç”¨**
`this` æŒ‡é’ˆçš„åº”ç”¨åœºæ™¯åŒ…æ‹¬ï¼š
- **é“¾å¼è°ƒç”¨**ï¼šæˆ‘ä»¬å¯ä»¥é€šè¿‡è¿”å› `*this` æ¥å®ç°é“¾å¼è°ƒç”¨ï¼Œå…è®¸è¿ç»­è°ƒç”¨æˆå‘˜å‡½æ•°ã€‚
  
  ä¾‹å¦‚ï¼š
  ```cpp
  class MyClass {
  public:
      int value;

      MyClass& setValue(int v) {
          this->value = v;
          return *this; // è¿”å›å½“å‰å¯¹è±¡ï¼Œä»¥ä¾¿é“¾å¼è°ƒç”¨
      }
  };
  
  MyClass obj;
  obj.setValue(10).setValue(20); // é“¾å¼è°ƒç”¨
  ```

- **ä¸ `const` é…åˆä½¿ç”¨**ï¼šåœ¨å¸¸æˆå‘˜å‡½æ•°ä¸­ï¼Œ`this` æ˜¯ä¸€ä¸ªæŒ‡å‘å¸¸é‡çš„æŒ‡é’ˆï¼Œå¯ä»¥ç¡®ä¿ä¸ä¿®æ”¹å½“å‰å¯¹è±¡çš„çŠ¶æ€ã€‚

  ä¾‹å¦‚ï¼š
  ```cpp
  class MyClass {
  public:
      int value;

      int getValue() const {
          return this->value;
      }
  };
  ```

### 6. **`this` æŒ‡é’ˆçš„å¸¸è§è¯¯åŒº**
- **`this` ä¸èƒ½ç”¨äºé™æ€æˆå‘˜å‡½æ•°**ï¼šé™æ€æˆå‘˜å‡½æ•°å±äºç±»æœ¬èº«è€Œä¸æ˜¯ä»»ä½•å¯¹è±¡ï¼Œå› æ­¤æ²¡æœ‰ `this` æŒ‡é’ˆã€‚
  
  ```cpp
  class MyClass {
  public:
      static void staticFunction() {
          // ç¼–è¯‘é”™è¯¯ï¼šé™æ€æˆå‘˜å‡½æ•°æ²¡æœ‰ `this` æŒ‡é’ˆ
          this->value = 10;
      }
  };
  ```

- **`this` ä¸èƒ½ä¸º `nullptr`**ï¼š`this` æ€»æ˜¯æŒ‡å‘ä¸€ä¸ªæœ‰æ•ˆçš„å¯¹è±¡ï¼Œå®ƒä¸ä¼šä¸º `nullptr`ã€‚å› ä¸ºå®ƒæ€»æ˜¯æŒ‡å‘è°ƒç”¨æˆå‘˜å‡½æ•°çš„é‚£ä¸ªå¯¹è±¡ã€‚

### 7. **æ€»ç»“**
- `this` æŒ‡é’ˆæ˜¯ä¸€ä¸ªéšå¼çš„æŒ‡é’ˆï¼ŒæŒ‡å‘å½“å‰å¯¹è±¡ï¼Œé€šå¸¸åœ¨éé™æ€æˆå‘˜å‡½æ•°ä¸­ä½¿ç”¨ã€‚
- å®ƒçš„ç±»å‹æ˜¯ `T*`ï¼Œå…¶ä¸­ `T` æ˜¯å½“å‰ç±»çš„ç±»å‹ï¼Œå¯¹äºå¸¸æˆå‘˜å‡½æ•°ï¼Œ`this` æ˜¯ `const T*` ç±»å‹ã€‚
- `this` æŒ‡é’ˆçš„æ¥æºæ˜¯ç¼–è¯‘å™¨åœ¨è°ƒç”¨æˆå‘˜å‡½æ•°æ—¶è‡ªåŠ¨ä¼ é€’å½“å‰å¯¹è±¡çš„åœ°å€ã€‚
- é€šè¿‡ `this` æŒ‡é’ˆï¼Œæˆ‘ä»¬å¯ä»¥è®¿é—®å½“å‰å¯¹è±¡çš„æˆå‘˜ã€å®ç°é“¾å¼è°ƒç”¨ã€ä»¥åŠåœ¨å¸¸æˆå‘˜å‡½æ•°ä¸­ä¿è¯å¯¹è±¡çš„ä¸å¯ä¿®æ”¹æ€§ã€‚

å¸Œæœ›è¿™ä¸ªè§£é‡Šèƒ½å¸®åŠ©ä½ ç†è§£ `this` æŒ‡é’ˆçš„æ¥æºåŠå…¶åœ¨ C++ ä¸­çš„ä½¿ç”¨ï¼


## thisæŒ‡é’ˆçš„äº§ç”Ÿæœºåˆ¶
ä½ çš„å›ç­”æŠ“ä½äº†`this`æŒ‡é’ˆçš„æ ¸å¿ƒä½œç”¨ï¼Œä½†éœ€è¦æ›´ç²¾ç¡®åœ°ä»C++è¯­è¨€æœºåˆ¶è€Œéç¼–è¯‘å™¨çš„å…·ä½“å®ç°æ¥è§£é‡Šã€‚ä»¥ä¸‹æ˜¯æ›´å‡†ç¡®çš„å›ç­”æ€è·¯ï¼š

---

**C++ä¸­`this`æŒ‡é’ˆçš„äº§ç”Ÿæœºåˆ¶ï¼š**

1. **éšå¼å‚æ•°çš„æœ¬è´¨**  
   C++è§„å®šï¼Œ**æ‰€æœ‰éé™æ€æˆå‘˜å‡½æ•°ï¼ˆnon-static member functionsï¼‰**åœ¨ç¼–è¯‘æ—¶ä¼šéšå¼æ·»åŠ ä¸€ä¸ªæŒ‡å‘å½“å‰å¯¹è±¡çš„æŒ‡é’ˆå‚æ•°ï¼Œå³`this`æŒ‡é’ˆã€‚è¿™å¹¶éå•çº¯å› ä¸ºè½¬æ¢åˆ°Cä»£ç çš„éœ€æ±‚ï¼Œè€Œæ˜¯C++è¯­è¨€æœ¬èº«çš„ç‰¹æ€§ã€‚

2. **åº•å±‚å®ç°åŸç†**  
   å½“è°ƒç”¨`obj.func(x)`æ—¶ï¼Œç¼–è¯‘å™¨ä¼šå°†å…¶è½¬æ¢ä¸ºç±»ä¼¼ï¼š  
   ```cpp
   ClassName::func(&obj, x); // ä¼ªä»£ç ï¼Œä¼ é€’å¯¹è±¡åœ°å€ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°
   ```  
   æˆå‘˜å‡½æ•°å†…éƒ¨å¯¹æˆå‘˜å˜é‡çš„è®¿é—®ï¼ˆå¦‚`this->data`ï¼‰ä¼šè¢«è½¬æ¢ä¸º`this`æŒ‡é’ˆè§£å¼•ç”¨åçš„å†…å­˜åç§»æ“ä½œã€‚

3. **ä¸Cç»“æ„ä½“çš„å¯¹æ¯”**  
   è‹¥ç”¨Cæ¨¡æ‹Ÿç±»çš„è¡Œä¸ºï¼Œéœ€è¦åœ¨å‡½æ•°ä¸­æ‰‹åŠ¨ä¼ é€’ç»“æ„ä½“æŒ‡é’ˆï¼š  
   ```c
   struct MyClass { int data; };
   void MyClass_func(struct MyClass* this, int x) { 
       this->data = x; 
   }
   ```  
   C++çš„`this`æœºåˆ¶è‡ªåŠ¨åŒ–äº†è¿™ä¸€è¿‡ç¨‹ï¼Œä½¿æˆå‘˜å‡½æ•°èƒ½ç›´æ¥è®¿é—®å¯¹è±¡æ•°æ®ã€‚

4. **å…³é”®ç‰¹æ€§**  
   â€¢ **éšå¼å­˜åœ¨**ï¼šå¼€å‘è€…æ— éœ€æ˜¾å¼å£°æ˜`this`ï¼Œä½†å¯åœ¨å‡½æ•°å†…ç›´æ¥ä½¿ç”¨ã€‚
   â€¢ **constæ­£ç¡®æ€§**ï¼š`const`æˆå‘˜å‡½æ•°ä¸­çš„`this`ç±»å‹ä¸º`const ClassName*`ï¼Œç¦æ­¢ä¿®æ”¹å¯¹è±¡çŠ¶æ€ã€‚
   â€¢ **é™æ€å‡½æ•°æ— this**ï¼šé™æ€æˆå‘˜å‡½æ•°ï¼ˆstaticï¼‰ä¸ä¸å®ä¾‹ç»‘å®šï¼Œæ•…æ— `this`å‚æ•°ã€‚

5. **åº”ç”¨åœºæ™¯**  
   â€¢ åŒºåˆ†å±€éƒ¨å˜é‡ä¸æˆå‘˜å˜é‡ï¼š`this->data = data;`
   â€¢ è¿”å›å¯¹è±¡è‡ªèº«å¼•ç”¨ï¼š`return *this;`ï¼ˆç”¨äºé“¾å¼è°ƒç”¨ï¼‰
   â€¢ åˆ¤æ–­å¯¹è±¡åœ°å€ï¼š`if (this == &otherObj) { ... }`

---

**ä¸ºä½•ä½ çš„å›ç­”éœ€è¦ä¿®æ­£ï¼Ÿ**  
â€¢ æ—©æœŸC++ç¼–è¯‘å™¨ï¼ˆå¦‚Cfrontï¼‰ç¡®å®é€šè¿‡è½¬Cå®ç°ï¼Œä½†ç°ä»£ç¼–è¯‘å™¨ï¼ˆå¦‚Clang/GCCï¼‰ä¸å†ä¾èµ–æ­¤æ­¥éª¤ï¼Œç›´æ¥ç”Ÿæˆæœºå™¨ç ã€‚
â€¢ `this`æœºåˆ¶æ˜¯C++è¯­è¨€è§„èŒƒçš„ä¸€éƒ¨åˆ†ï¼Œæ— è®ºåº•å±‚æ˜¯å¦è½¬Cå‡å­˜åœ¨ï¼Œé‡ç‚¹åœ¨äºç†è§£å…¶ä½œä¸ºéšå¼å‚æ•°çš„**è¯­è¨€è®¾è®¡æ„ä¹‰**ï¼Œè€Œéç‰¹å®šç¼–è¯‘å™¨çš„å®ç°æ–¹å¼ã€‚

é€šè¿‡å¼ºè°ƒè¯­è¨€è®¾è®¡å±‚é¢å’Œåº•å±‚åŸç†çš„ç»“åˆï¼Œèƒ½æ›´å…¨é¢è§£é‡Š`this`çš„ç”±æ¥ä¸ä½œç”¨ã€‚


## æˆå‘˜å‡½æ•°ä¸­è°ƒç”¨delete thisä¼šå‘ç”Ÿä»€ä¹ˆ
åœ¨ C++ ä¸­ï¼Œåœ¨æˆå‘˜å‡½æ•°ä¸­è°ƒç”¨ `delete this` **å¯èƒ½ä¼šå¯¼è‡´æœªå®šä¹‰è¡Œä¸º (UB, Undefined Behavior)**ï¼Œä½†åœ¨æŸäº›ç‰¹æ®Šæƒ…å†µä¸‹ï¼Œå®ƒæ˜¯åˆæ³•çš„ã€‚è®©æˆ‘ä»¬è¯¦ç»†åˆ†æ **ä»€ä¹ˆæ—¶å€™å¯ä»¥å®‰å…¨ä½¿ç”¨ `delete this`ï¼Œä»¥åŠä»€ä¹ˆæ—¶å€™ä¼šå¯¼è‡´é”™è¯¯**ã€‚

---

### **ğŸš¨ `delete this` çš„æ½œåœ¨é£é™©**
1. **å¯¹è±¡ä¸æ˜¯ `new` åˆ›å»ºçš„**
   ```cpp
   class A {
   public:
       void destroy() { delete this; } 
   };

   int main() {
       A a;
       a.destroy();  // âŒ æœªå®šä¹‰è¡Œä¸ºï¼Œä¸èƒ½åˆ é™¤æ ˆä¸Šå¯¹è±¡
   }
   ```
   - `a` æ˜¯ **æ ˆä¸Šçš„å¯¹è±¡**ï¼Œå½“ `delete this` æ‰§è¡Œæ—¶ï¼Œ`this` æŒ‡å‘çš„æ˜¯æ ˆä¸Šçš„å†…å­˜ï¼Œ**ä¸èƒ½ç”¨ `delete` é‡Šæ”¾**ï¼Œä¼šå¯¼è‡´ **æœªå®šä¹‰è¡Œä¸ºï¼ˆUBï¼‰**ã€‚

2. **å¯¹è±¡æ˜¯ `shared_ptr` ç®¡ç†çš„**
   ```cpp
   std::shared_ptr<A> p = std::make_shared<A>();
   p->destroy();  // âŒ UBï¼Œä¸èƒ½æ‰‹åŠ¨ delete this
   ```
   - `shared_ptr` è´Ÿè´£ç®¡ç† `A` çš„ç”Ÿå‘½å‘¨æœŸï¼Œ**æ‰‹åŠ¨ `delete this` ç ´åäº† `shared_ptr` çš„å¼•ç”¨è®¡æ•°**ï¼Œå¯èƒ½ä¼šå¯¼è‡´ç¨‹åºå´©æºƒã€‚

---

### **âœ… `delete this` çš„å®‰å…¨ä½¿ç”¨**
#### **1. ç¡®ä¿å¯¹è±¡æ˜¯ `new` åˆ›å»ºçš„**
å¦‚æœå¯¹è±¡æ˜¯åŠ¨æ€åˆ†é…çš„ (`new` åˆ›å»ºçš„)ï¼Œå¹¶ä¸”**æ²¡æœ‰å…¶ä»–ä»£ç ç®¡ç†è¿™ä¸ªå¯¹è±¡**ï¼Œé‚£ä¹ˆ `delete this` æ˜¯å®‰å…¨çš„ï¼š
```cpp
class A {
public:
    void destroy() { delete this; } 
    ~A() { std::cout << "Destructor called" << std::endl; }
};

int main() {
    A* p = new A();
    p->destroy();  // âœ… å®‰å…¨ï¼Œp ç”± new åˆ›å»º
}
```
ğŸ”¹ **æ³¨æ„ï¼š**
- `delete this` ä¹‹åï¼Œ**è°ƒç”¨å®ƒçš„æˆå‘˜å‡½æ•°çš„ `this` æŒ‡é’ˆå˜ä¸ºæ‚¬å‚æŒ‡é’ˆ (dangling pointer)ï¼Œä¸èƒ½å†ä½¿ç”¨**ã€‚

---

#### **2. ç¡®ä¿ `delete this` ä¹‹åä¸ä¼šè®¿é—® `this`**
```cpp
class A {
public:
    void destroy() {
        delete this;
        // std::cout << "After delete" << std::endl; âŒ UBï¼Œthis å·²å¤±æ•ˆ
    }
};
```
ğŸ”¹ **`delete this` ä¹‹åï¼Œä»»ä½•è®¿é—® `this` çš„æ“ä½œéƒ½æ˜¯ UBï¼**

---

#### **3. ç¡®ä¿å¯¹è±¡ä¸è¢«å…¶ä»–æ–¹å¼ç®¡ç†**
å¦‚æœ `this` æ˜¯ç”± `unique_ptr` æˆ– `shared_ptr` ç®¡ç†çš„ï¼Œé‚£ **ä¸èƒ½ä½¿ç”¨ `delete this`**ï¼Œå¦åˆ™ä¼šå¯¼è‡´ double free æˆ–ç¨‹åºå´©æºƒï¼š
```cpp
class A {
public:
    void destroy() { delete this; } 
};

int main() {
    std::unique_ptr<A> p = std::make_unique<A>();
    p->destroy();  // âŒ UBï¼Œunique_ptr ä»ç„¶ä¼š delete å®ƒ
}
```
ğŸ”¹ **æ­£ç¡®åšæ³•æ˜¯ä½¿ç”¨ `std::unique_ptr::release()`**
```cpp
class A {
public:
    void destroy() { delete this; }
};

int main() {
    std::unique_ptr<A> p = std::make_unique<A>();
    p.release()->destroy();  // âœ… å…ˆ releaseï¼Œå† delete
}
```

---

### **æ€»ç»“**
âœ… **å¯ä»¥ä½¿ç”¨ `delete this` çš„æƒ…å†µ**ï¼š
1. **å¯¹è±¡æ˜¯ `new` åˆ›å»ºçš„**ï¼Œä¸” **ä¸ä¼šè¢« `shared_ptr` æˆ– `unique_ptr` ç®¡ç†**ã€‚
2. **`delete this` ä¹‹åï¼Œä¸èƒ½è®¿é—® `this` æŒ‡å‘çš„å†…å­˜**ã€‚

âŒ **ä¸èƒ½ä½¿ç”¨ `delete this` çš„æƒ…å†µ**ï¼š
1. **å¯¹è±¡æ˜¯æ ˆä¸Šåˆ†é…çš„ (`A a;`)**ã€‚
2. **å¯¹è±¡æ˜¯ `shared_ptr` æˆ– `unique_ptr` ç®¡ç†çš„**ï¼Œéœ€è¦å…ˆ `release()` å `delete`ã€‚
3. **`delete this` ä¹‹åï¼Œä»ç„¶è®¿é—® `this` æŒ‡é’ˆ**ã€‚

**é¢è¯•å®˜é—®è¿™ä¸ªé—®é¢˜ï¼Œé€šå¸¸æ˜¯è€ƒå¯Ÿä½ å¯¹ `this` æŒ‡é’ˆç”Ÿå‘½å‘¨æœŸçš„ç†è§£ï¼Œåˆ«è¸©å‘äº†ï¼** ğŸš€


## ææ„å‡½æ•°å’Œæ„é€ å‡½æ•°èƒ½å¦æ˜¯è™šå‡½æ•°
### æ„é€ å‡½æ•°å¯ä»¥æ˜¯è™šå‡½æ•°å—
æ‰€æœ‰çš„ç±»å¯¹è±¡å…¬ç”¨ä¸€ä¸ªè™šå‡½æ•°è¡¨ï¼Œè€Œè™šå‡½æ•°è¡¨å®é™…ä¸Šå®åœ¨ç¼–è¯‘æ—¶ç¡®å®šçš„ï¼Œé‚£ä¹ˆåœ¨æ„é€ å¯¹è±¡æ—¶ç”±äºè¿˜æ²¡æœ‰åˆ†é…å†…å­˜ï¼Œä¹Ÿå°±æ²¡æœ‰è™šå‡½æ•°æŒ‡é’ˆæŒ‡å‘è™šå‡½æ•°è¡¨è°ƒç”¨æ„é€ å‡½æ•°ï¼Œæ‰€ä»¥æ„é€ å‡½æ•°ä¸èƒ½æ˜¯è™šå‡½æ•°
> - è™šå‡½æ•°è¡¨ï¼ˆvtableï¼‰åœ¨ç¼–è¯‘æ—¶ç”Ÿæˆï¼Œä½† vptr åœ¨è¿è¡Œæ—¶åˆå§‹åŒ–ï¼Œæ„é€ æ—¶ vptr å¯èƒ½æœªæ­£ç¡®è®¾ç½®ã€‚
> - æ„é€ å‡½æ•°ä¸èƒ½æ˜¯è™šå‡½æ•°ï¼Œå› ä¸ºå¯¹è±¡åœ¨æ„é€ æ—¶ vptr è¿˜æœªåˆå§‹åŒ–ï¼Œæ— æ³•è¿›è¡Œè™šå‡½æ•°è°ƒç”¨ã€‚

### **ğŸ”¹ ç»§æ‰¿ä¸­çˆ¶ç±»çš„ææ„å‡½æ•°ä¸ºä»€ä¹ˆä¸€å®šæ˜¯è™šå‡½æ•°ï¼Ÿ**
**ç­”ï¼šå¯ä»¥ï¼Œå¹¶ä¸”åœ¨å…·æœ‰å¤šæ€æ€§çš„ç±»ä¸­**ï¼ˆå³æœ‰è™šå‡½æ•°çš„ç±»ï¼‰**çˆ¶ç±»çš„ææ„å‡½æ•°å¿…é¡»å£°æ˜ä¸º `virtual`ï¼Œå¦åˆ™å¯èƒ½ä¼šå¯¼è‡´å†…å­˜æ³„æ¼æˆ–æœªå®šä¹‰è¡Œä¸ºã€‚**

---

#### **âœ… ä¸ºä»€ä¹ˆçˆ¶ç±»çš„ææ„å‡½æ•°éœ€è¦æ˜¯ `virtual`ï¼Ÿ**
 **ğŸŒŸ 1. ç¡®ä¿æ­£ç¡®çš„ææ„é¡ºåº**
å¦‚æœçˆ¶ç±»çš„ææ„å‡½æ•°**ä¸æ˜¯è™šå‡½æ•°**ï¼Œå½“ä¸€ä¸ªæŒ‡å‘å­ç±»çš„åŸºç±»æŒ‡é’ˆè¢« `delete` æ—¶ï¼Œ**åªä¼šè°ƒç”¨åŸºç±»çš„ææ„å‡½æ•°ï¼Œè€Œä¸ä¼šè°ƒç”¨å­ç±»çš„ææ„å‡½æ•°**ï¼Œå¯¼è‡´å­ç±»çš„èµ„æºæœªé‡Šæ”¾ï¼Œå¯èƒ½é€ æˆ**å†…å­˜æ³„æ¼**ã€‚

**ğŸš¨ é”™è¯¯ç¤ºä¾‹ï¼š**
```cpp
#include <iostream>

class Base {
public:
    ~Base() { std::cout << "Base Destructor\n"; } // âŒ éè™šææ„å‡½æ•°
};

class Derived : public Base {
public:
    ~Derived() { std::cout << "Derived Destructor\n"; }
};

int main() {
    Base* ptr = new Derived();
    delete ptr;  // åªä¼šè°ƒç”¨ Base çš„ææ„å‡½æ•°ï¼Œè€Œä¸ä¼šè°ƒç”¨ Derived çš„ææ„å‡½æ•°
    return 0;
}
```
**ğŸ”» è¾“å‡ºï¼š**
```
Base Destructor
```
**âš ï¸ é—®é¢˜ï¼š**
- `Derived` çš„ææ„å‡½æ•°æ²¡æœ‰è¢«è°ƒç”¨ï¼Œå¯¼è‡´ `Derived` å¯èƒ½å­˜åœ¨çš„**åŠ¨æ€åˆ†é…èµ„æºæ²¡æœ‰è¢«é‡Šæ”¾**ï¼Œé€ æˆå†…å­˜æ³„æ¼ã€‚

---

 **ğŸŒŸ 2. é€šè¿‡ `virtual` ç¡®ä¿å®Œæ•´çš„ææ„**
**ğŸš€ è§£å†³æ–¹æ¡ˆï¼šå°†ææ„å‡½æ•°å£°æ˜ä¸º `virtual`**
```cpp
#include <iostream>

class Base {
public:
    virtual ~Base() { std::cout << "Base Destructor\n"; } // âœ… å˜æˆè™šå‡½æ•°
};

class Derived : public Base {
public:
    ~Derived() { std::cout << "Derived Destructor\n"; }
};

int main() {
    Base* ptr = new Derived();
    delete ptr;  // âœ… å…ˆè°ƒç”¨ Derived ææ„ï¼Œå†è°ƒç”¨ Base ææ„ï¼Œé¿å…å†…å­˜æ³„æ¼
    return 0;
}
```
**ğŸ”» è¾“å‡ºï¼š**
```
Derived Destructor
Base Destructor
```
**ğŸ”¹ ç»“æœï¼š**
- **å­ç±»çš„ææ„å‡½æ•° `~Derived()` å…ˆæ‰§è¡Œ**
- **åŸºç±»çš„ææ„å‡½æ•° `~Base()` åæ‰§è¡Œ**
- **æ­£ç¡®ææ„é¡ºåºï¼Œé˜²æ­¢å†…å­˜æ³„æ¼**

---

#### **âœ… ä»€ä¹ˆæ—¶å€™ä¸éœ€è¦ `virtual` ææ„å‡½æ•°ï¼Ÿ**
1. **å½“ç±»**ä¸ç”¨äº**ç»§æ‰¿**ï¼ˆå³ä¸æ˜¯åŸºç±»ï¼‰æ—¶ï¼Œå¯ä»¥ä¸å£°æ˜ `virtual`ã€‚
2. **å¦‚æœç±»ä¸ä¼šé€šè¿‡åŸºç±»æŒ‡é’ˆåˆ é™¤å¯¹è±¡**ï¼Œå¯ä»¥ä¸å£°æ˜ `virtual`ã€‚
3. **å¦‚æœç±»æ˜¯ PODï¼ˆPlain Old Dataï¼‰ç±»å‹**ï¼Œæ— éœ€ `virtual`ï¼Œä»¥å‡å°‘è™šè¡¨ï¼ˆvtableï¼‰å¼€é”€ã€‚

**ğŸš€ ä¾‹å¦‚ï¼š**
```cpp
class SimpleClass {
public:
    ~SimpleClass() { std::cout << "Simple Destructor\n"; }
};
```
è¿™ç§ç±»ä¸æ¶‰åŠç»§æ‰¿ï¼Œæ— éœ€ `virtual`ã€‚

---

#### **âœ… `virtual` ææ„çš„åº•å±‚åŸç†**
**ğŸŒŸ `virtual` ææ„çš„æœ¬è´¨æ˜¯é€šè¿‡** **è™šå‡½æ•°è¡¨ï¼ˆVTableï¼‰** **ç¡®ä¿æ­£ç¡®çš„ææ„é¡ºåº**ã€‚

#### **ğŸ”¹ ç¼–è¯‘å™¨å¦‚ä½•ç®¡ç† `virtual` ææ„ï¼Ÿ**
- å½“ç±»ä¸­æœ‰ `virtual` å‡½æ•°æ—¶ï¼Œç¼–è¯‘å™¨ä¼š**åˆ›å»ºè™šå‡½æ•°è¡¨ï¼ˆVTableï¼‰**ï¼Œç”¨äºå­˜å‚¨æŒ‡å‘è™šå‡½æ•°çš„æŒ‡é’ˆã€‚
- `delete` ä¸€ä¸ªåŸºç±»æŒ‡é’ˆæ—¶ï¼Œè°ƒç”¨çš„å®é™…ä¸Šæ˜¯**è™šè¡¨ä¸­çš„ææ„å‡½æ•°æŒ‡é’ˆ**ï¼Œä¿è¯**å…ˆè°ƒç”¨å­ç±»ææ„ï¼Œå†è°ƒç”¨çˆ¶ç±»ææ„**ã€‚

```cpp
Base* ptr = new Derived();
delete ptr;
```
å†…éƒ¨æ‰§è¡Œï¼š
```cpp
ptr->~Derived(); // å…ˆè°ƒç”¨å­ç±»ææ„å‡½æ•°
ptr->~Base();    // å†è°ƒç”¨åŸºç±»ææ„å‡½æ•°
```

---

#### **âœ… `virtual` ææ„çš„å¼€é”€**
ä½¿ç”¨ `virtual` ææ„ä¼šå¼•å…¥**é¢å¤–çš„å¼€é”€**ï¼š
1. **é¢å¤–çš„ vtable æŒ‡é’ˆ**ï¼ˆæ¯ä¸ªåŒ…å« `virtual` å‡½æ•°çš„ç±»å®ä¾‹éƒ½ä¼šæœ‰ä¸€ä¸ªæŒ‡å‘ `vtable` çš„æŒ‡é’ˆï¼‰ã€‚
2. **è¿è¡Œæ—¶å¤šæ€**ï¼ˆæ¯æ¬¡è°ƒç”¨è™šå‡½æ•°ï¼Œéƒ½ä¼šè¿›è¡Œä¸€æ¬¡ vtable æŸ¥æ‰¾ï¼‰ã€‚

ä½†åœ¨**æœ‰ç»§æ‰¿å…³ç³»çš„ç±»**ä¸­ï¼Œä½¿ç”¨ `virtual` ææ„æ˜¯å¿…è¦çš„ï¼Œ**é¿å…å†…å­˜æ³„æ¼æ¯”å¾®å°çš„å¼€é”€æ›´é‡è¦ï¼**

---

#### **âœ… ç»“è®º**
| **æƒ…å†µ** | **æ˜¯å¦éœ€è¦ `virtual` ææ„** | **åŸå› ** |
|----------|----------------|-------------------------------|
| **åŸºç±»ç”¨äºç»§æ‰¿ï¼Œå¹¶å¯èƒ½é€šè¿‡åŸºç±»æŒ‡é’ˆåˆ é™¤å¯¹è±¡** | âœ… å¿…é¡» | **ä¿è¯æ­£ç¡®ææ„ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼** |
| **åŸºç±»ä¸ä¼šè¢«åŸºç±»æŒ‡é’ˆåˆ é™¤** | âŒ å¯ä»¥çœç•¥ | ä¸éœ€è¦è™šè¡¨ï¼Œå‡å°‘å¼€é”€ |
| **ç±»ä¸ä¼šç”¨äºç»§æ‰¿** | âŒ å¯ä»¥çœç•¥ | ä¸æ˜¯å¤šæ€ç±»ï¼Œæ— éœ€è™šææ„ |
| **ç±»æ˜¯ PODï¼ˆPlain Old Dataï¼‰** | âŒ å¯ä»¥çœç•¥ | æ²¡æœ‰è™šè¡¨ï¼Œä¸ç”¨ `virtual` |

ğŸ“Œ **å»ºè®®ï¼š**
- å¦‚æœç±»**å¯èƒ½è¢«ç»§æ‰¿**ï¼Œå¹¶ä¸”**å¯èƒ½é€šè¿‡åŸºç±»æŒ‡é’ˆåˆ é™¤**ï¼Œ**ä¸€å®šè¦å£°æ˜ `virtual` ææ„å‡½æ•°**ï¼
- å¦‚æœç±»ä¸ä¼šè¢«åŸºç±»æŒ‡é’ˆåˆ é™¤ï¼Œ**å¯ä»¥ä¸å£°æ˜ `virtual` ä»¥å‡å°‘å¼€é”€**ã€‚

ğŸš€ **æ­£ç¡®ä½¿ç”¨ `virtual` ææ„ï¼Œè®© C++ ä»£ç æ›´å®‰å…¨ã€æ›´é«˜æ•ˆï¼**


## å¤šæ€
### **C++ å¤šæ€çš„ç±»å‹**
C++ ä¸­çš„å¤šæ€ï¼ˆPolymorphismï¼‰ä¸»è¦åˆ†ä¸ºä¸¤ç±»ï¼š
1. **ç¼–è¯‘æ—¶å¤šæ€ï¼ˆé™æ€å¤šæ€ / æ—©ç»‘å®šï¼‰**
2. **è¿è¡Œæ—¶å¤šæ€ï¼ˆåŠ¨æ€å¤šæ€ / æ™šç»‘å®šï¼‰**

| ç±»å‹ | æ–¹å¼ | ç‰¹ç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|--------|
| **ç¼–è¯‘æ—¶å¤šæ€** | å‡½æ•°é‡è½½ | ç¼–è¯‘æœŸç¡®å®šï¼Œé€Ÿåº¦å¿« | ç›¸åŒåŠŸèƒ½ä½†ä¸åŒå‚æ•° |
| | è¿ç®—ç¬¦é‡è½½ | ä»£ç å¯è¯»æ€§é«˜ | è‡ªå®šä¹‰æ•°æ®ç±»å‹ |
| | æ¨¡æ¿ | ä»£ç å¤ç”¨æ€§é«˜ | æ³›å‹ç¼–ç¨‹ |
| **è¿è¡Œæ—¶å¤šæ€** | è™šå‡½æ•° | è¿è¡Œæ—¶åŠ¨æ€ç»‘å®š | éœ€è¦ç»Ÿä¸€æ¥å£ |
| | çº¯è™šå‡½æ•° | å¼ºåˆ¶å­ç±»å®ç° | æŠ½è±¡ç±» |

---

 **ä½•æ—¶ä½¿ç”¨å“ªç§å¤šæ€ï¼Ÿ**
âœ… **ä½¿ç”¨ç¼–è¯‘æ—¶å¤šæ€**ï¼š
- éœ€è¦**æ€§èƒ½ä¼˜å…ˆ**ï¼Œä¸éœ€è¦è¿è¡Œæ—¶åŠ¨æ€å†³ç­–ã€‚
- é€‚ç”¨äº**å°å‹ã€é€šç”¨**çš„å‡½æ•°ï¼ˆå¦‚ `add(int, int)`ï¼‰ã€‚
- é€‚ç”¨äº**è¿ç®—ç¬¦é‡è½½**ï¼ˆå¦‚ `Complex operator+`ï¼‰ã€‚
- é€‚ç”¨äº**æ¨¡æ¿ç¼–ç¨‹**ï¼Œå‡å°‘é‡å¤ä»£ç ã€‚

âœ… **ä½¿ç”¨è¿è¡Œæ—¶å¤šæ€**ï¼š
- éœ€è¦**é¢å‘å¯¹è±¡è®¾è®¡**ï¼Œæä¾›**ç»Ÿä¸€æ¥å£**ï¼ˆå¦‚ `Animal::makeSound()`ï¼‰ã€‚
- é€‚ç”¨äº**æ’ä»¶ç³»ç»Ÿã€åŠ¨æ€åŠ è½½ç±»**ï¼ˆå¦‚ GUI æ¡†æ¶ï¼‰ã€‚
- é€‚ç”¨äº**å·¥å‚æ¨¡å¼ã€ç­–ç•¥æ¨¡å¼**ç­‰è®¾è®¡æ¨¡å¼ã€‚

---




## **è™šç»§æ‰¿ï¼ˆVirtual Inheritanceï¼‰**
**è™šç»§æ‰¿** æ˜¯ C++ è§£å†³ **å¤šé‡ç»§æ‰¿** æ—¶ **â€œè±å½¢ç»§æ‰¿â€**ï¼ˆä¹Ÿç§° **é’»çŸ³ç»§æ‰¿**ï¼‰é—®é¢˜çš„ä¸€ç§æœºåˆ¶ã€‚

---

### **1. ä¸ºä»€ä¹ˆéœ€è¦è™šç»§æ‰¿ï¼Ÿ**
å‡è®¾æœ‰å¦‚ä¸‹ç»§æ‰¿å…³ç³»ï¼š
```cpp
class A {
public:
    int value;
};

class B : public A {};  // B ç»§æ‰¿ A
class C : public A {};  // C ç»§æ‰¿ A
class D : public B, public C {};  // D åŒæ—¶ç»§æ‰¿ B å’Œ C
```
**é—®é¢˜**ï¼š
- ç±» `D` ç»§æ‰¿ `B` å’Œ `C`ï¼Œä½† `B` å’Œ `C` å„è‡ªéƒ½ç»§æ‰¿ `A`ã€‚
- **å¯¼è‡´ `D` æ‹¥æœ‰ä¸¤ä¸ª `A` çš„å‰¯æœ¬**ï¼Œå³ `D` å†…éƒ¨æœ‰ä¸¤ä¸ª `value` å˜é‡ï¼š
  - `D::B::A::value`
  - `D::C::A::value`
- è¿™æ ·å°±ä¼š**å¼•å‘äºŒä¹‰æ€§**ï¼š
```cpp
D obj;
obj.value = 10;  // âŒ ç¼–è¯‘é”™è¯¯ï¼šæ— æ³•ç¡®å®šè®¿é—®çš„æ˜¯å“ªä¸ª `value`
```
- è®¿é—® `value` å˜é‡æ—¶ï¼Œç¼–è¯‘å™¨æ— æ³•ç¡®å®š `obj.value` åº”è¯¥æŒ‡å‘ `B::A::value` è¿˜æ˜¯ `C::A::value`ã€‚

---

### **2. è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨è™šç»§æ‰¿**
ä¸ºäº†è§£å†³**è±å½¢ç»§æ‰¿**é—®é¢˜ï¼ŒC++ æä¾› **è™šç»§æ‰¿** (`virtual`) æœºåˆ¶ï¼Œè®© `B` å’Œ `C` **å…±äº«åŒä¸€ä¸ª `A` çš„å®ä¾‹**ï¼š
```cpp
class A {
public:
    int value;
};

class B : virtual public A {};  // B è™šç»§æ‰¿ A
class C : virtual public A {};  // C è™šç»§æ‰¿ A
class D : public B, public C {};  // D åŒæ—¶ç»§æ‰¿ B å’Œ C
```
#### **è™šç»§æ‰¿çš„å…³é”®ç‚¹**
1. `B` å’Œ `C` **è™šç»§æ‰¿** `A`ï¼Œè¡¨ç¤º `A` **ä¸ä¼šè¢«å¤åˆ¶å¤šä»½**ã€‚
2. `D` ç»§æ‰¿ `B` å’Œ `C` åï¼Œ`D` å†…éƒ¨**åªä¼šæœ‰ä¸€ä¸ª `A` çš„å®ä¾‹**ã€‚
3. è®¿é—® `value` å˜é‡æ—¶ï¼Œä¸ä¼šå†å‡ºç°äºŒä¹‰æ€§ï¼š
```cpp
D obj;
obj.value = 10;  // âœ… ç°åœ¨ä¸ä¼šæŠ¥é”™ï¼Œå› ä¸º `D` åªæœ‰ä¸€ä¸ª `A::value`
```
4. `D` ç»§æ‰¿ `B` å’Œ `C` æ—¶ï¼Œä¸éœ€è¦å†ä½¿ç”¨ `virtual` å…³é”®å­—ï¼Œå› ä¸º `B` å’Œ `C` å·²ç»å£°æ˜äº†è™šç»§æ‰¿ã€‚

---

### **3. è™šç»§æ‰¿çš„å†…å­˜å¸ƒå±€**
åœ¨**æ™®é€šå¤šç»§æ‰¿**ä¸­ï¼Œæ¯ä¸ªåŸºç±»ä¼šæœ‰è‡ªå·±çš„ç‹¬ç«‹å‰¯æœ¬ï¼š
```cpp
class A { int x; };
class B : public A {};
class C : public A {};
class D : public B, public C {};
```
å†…å­˜å¸ƒå±€ï¼š
```
D
â”œâ”€â”€ B
â”‚   â””â”€â”€ A (B::A)
â””â”€â”€ C
    â””â”€â”€ A (C::A)
```
- `D` æœ‰ä¸¤ä¸ª `A`ï¼Œå¯¼è‡´æ•°æ®å†—ä½™å’ŒäºŒä¹‰æ€§é—®é¢˜ã€‚

---

 **è™šç»§æ‰¿çš„å†…å­˜å¸ƒå±€**
```cpp
class A { int x; };
class B : virtual public A {};
class C : virtual public A {};
class D : public B, public C {};
```
è™šç»§æ‰¿åï¼š
```
D
â”œâ”€â”€ B
â”œâ”€â”€ C
â””â”€â”€ A  (å…±äº«)
```
- `D` åªæœ‰ **ä¸€ä¸ª** `A`ï¼Œè§£å†³äº†äºŒä¹‰æ€§å’Œå†…å­˜æµªè´¹é—®é¢˜ã€‚
- C++ é€šè¿‡ **è™šåŸºç±»è¡¨ï¼ˆvtableï¼‰** å’Œ **è™šåŸºç±»æŒ‡é’ˆï¼ˆvptrï¼‰** å®ç°å…±äº« `A`ï¼Œåœ¨è¿è¡Œæ—¶æ­£ç¡®è§£æ `A` çš„ä½ç½®ã€‚

---

### **4. è™šç»§æ‰¿çš„æ„é€ å‡½æ•°**
ç”±äº **B å’Œ C åªâ€œå£°æ˜â€äº†ç»§æ‰¿ `A`ï¼Œä½†ä¸çœŸæ­£æ„é€  `A`**ï¼Œæ‰€ä»¥ï¼š
- **B å’Œ C çš„æ„é€ å‡½æ•°ä¸ä¼šåˆå§‹åŒ– `A`**
- **æœ€ç»ˆçš„æ´¾ç”Ÿç±»ï¼ˆ`D`ï¼‰è´Ÿè´£åˆå§‹åŒ– `A`**

```cpp
class A {
public:
    int value;
    A(int v) : value(v) { cout << "A constructed\n"; }
};

class B : virtual public A {
public:
    B() : A(0) { cout << "B constructed\n"; }
};

class C : virtual public A {
public:
    C() : A(0) { cout << "C constructed\n"; }
};

class D : public B, public C {
public:
    D() : A(100) { cout << "D constructed\n"; }
};

int main() {
    D obj;
    cout << obj.value << endl;  // è¾“å‡º 100
}
```
**è¾“å‡ºç»“æœ**ï¼š
```
A constructed
B constructed
C constructed
D constructed
100
```
### **æ„é€ é¡ºåº**
1. `A` ç”± `D` ç›´æ¥åˆå§‹åŒ–ï¼ˆ`A(100)`ï¼‰ã€‚
2. `B` å’Œ `C` è¢«æ„é€ ï¼Œä½†ä¸ä¼šå†åˆå§‹åŒ– `A`ï¼ˆå³ `A(0)` ä¸ä¼šæ‰§è¡Œï¼‰ã€‚
3. `D` ç»§æ‰¿ `B` å’Œ `C`ï¼Œæœ€ç»ˆ `A::value` æ˜¯ `100`ã€‚

---

### **5. ä»€ä¹ˆæ—¶å€™ä½¿ç”¨è™šç»§æ‰¿ï¼Ÿ**
âœ… **é€‚ç”¨äº**ï¼š
- è§£å†³ **å¤šé‡ç»§æ‰¿ï¼ˆè±å½¢ç»§æ‰¿ï¼‰** å¯¼è‡´çš„**æ•°æ®å†—ä½™** å’Œ **äºŒä¹‰æ€§**ã€‚
- é¿å… **é‡å¤å­˜å‚¨åŸºç±»æ•°æ®**ï¼ŒèŠ‚çœå†…å­˜ã€‚

âŒ **ä¸é€‚ç”¨äº**ï¼š
- **å•ç»§æ‰¿** æˆ– **ç®€å•çš„å¤šç»§æ‰¿**ï¼Œæ²¡æœ‰å¤šé‡ç»§æ‰¿æ—¶ä¸éœ€è¦è™šç»§æ‰¿ã€‚
- **æ€§èƒ½æ•æ„Ÿ** åœºæ™¯ï¼šè™šç»§æ‰¿å¢åŠ äº†ä¸€å®šçš„è¿è¡Œæ—¶å¼€é”€ï¼Œå› ä¸ºå®ƒä¾èµ–**è™šåŸºç±»è¡¨ï¼ˆvtableï¼‰** å’Œ **è™šæŒ‡é’ˆï¼ˆvptrï¼‰** è§£æåŸºç±»çš„ä½ç½®ã€‚

---

### **6. æ€»ç»“**
| å…³é”®ç‚¹ | æ™®é€šç»§æ‰¿ | è™šç»§æ‰¿ |
|--------|--------|-------|
| **åŸºç±»å¯¹è±¡çš„æ•°é‡** | æ¯æ¡ç»§æ‰¿è·¯å¾„éƒ½ä¼šç”Ÿæˆä¸€ä»½åŸºç±»å¯¹è±¡ | åªå­˜åœ¨**ä¸€ä¸ª**å…±äº«çš„åŸºç±»å¯¹è±¡ |
| **è®¿é—®åŸºç±»æˆå‘˜æ—¶** | å¯èƒ½äº§ç”Ÿ**äºŒä¹‰æ€§** | **ä¸ä¼š** äº§ç”ŸäºŒä¹‰æ€§ |
| **å†…å­˜å ç”¨** | å¯èƒ½ä¼šæœ‰ **å¤šä¸ªåŸºç±»å¯¹è±¡**ï¼Œæµªè´¹å†…å­˜ | **åªå­˜ä¸€ä»½åŸºç±»å¯¹è±¡**ï¼ŒèŠ‚çœå†…å­˜ |
| **è®¿é—®æ–¹å¼** | ç›´æ¥è®¿é—® | é€šè¿‡ **è™šåŸºç±»è¡¨ï¼ˆvtableï¼‰** å’Œ **è™šåŸºç±»æŒ‡é’ˆï¼ˆvptrï¼‰** |

- **è™šç»§æ‰¿çš„æ ¸å¿ƒç›®çš„æ˜¯è§£å†³â€œè±å½¢ç»§æ‰¿â€é—®é¢˜**ï¼Œé¿å…å¤šä»½åŸºç±»å®ä¾‹ï¼Œæé«˜ä»£ç å®‰å…¨æ€§å’Œå†…å­˜åˆ©ç”¨ç‡ã€‚
- ä½†è™šç»§æ‰¿å¼•å…¥äº† **è™šåŸºç±»æŒ‡é’ˆï¼ˆvptrï¼‰**ï¼Œå¯¼è‡´è®¿é—®åŸºç±»æˆå‘˜æ—¶éœ€è¦**é¢å¤–çš„æŒ‡é’ˆè§£æ**ï¼Œå¯èƒ½å½±å“**æ€§èƒ½**ã€‚

---

ğŸ’¡ **ä¸€å¥è¯æ€»ç»“**ï¼š
âœ… **å¦‚æœä½ çš„ç±»è®¾è®¡æ¶‰åŠ** **å¤šé‡ç»§æ‰¿**ï¼Œå¹¶ä¸”**åŸºç±»æœ‰å…±äº«æ•°æ®**ï¼Œå»ºè®®ä½¿ç”¨ **è™šç»§æ‰¿** æ¥é¿å…é‡å¤æ•°æ®å’Œè®¿é—®äºŒä¹‰æ€§ï¼ ğŸš€


## ç»§æ‰¿ä¸‹sizeofé¢˜ç›®
è™šç»§æ‰¿æƒ…å†µä¸‹ï¼ŒåŒ…å«ä¸€ä¸ªæŒ‡å‘è™šçˆ¶ç±»çš„æŒ‡é’ˆï¼Œå¦‚æœçˆ¶ç±»å«æœ‰æˆå‘˜å±æ€§ï¼Œåˆ™æ´¾ç”Ÿç±»åŒ…å«çˆ¶ç±»å¤§å°
```c++
ç¬¬ä¸€ç§æƒ…å†µï¼š4ï¼Œ8ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€	ç¬¬äºŒç§æƒ…å†µï¼š4ï¼Œ4ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ç¬¬ä¸‰ç§æƒ…å†µï¼š8ï¼Œ16ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€  ç¬¬å››ç§æƒ…å†µï¼š8ï¼Œ8
class aã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€		class aã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€  class aã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€class a
{ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ 		  {ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€    {ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ {
    virtual void func();ã€€ã€€ã€€ã€€ã€€ã€€virtual void func();ã€€ã€€ã€€ã€€ã€€ã€€virtual void func();ã€€ã€€ã€€ã€€  virtual void func();
};ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ 	  };ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€    char x;ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€   char x;
class b:public virtual aã€€ã€€ã€€  class b :public aã€€ã€€ã€€ã€€ã€€ã€€ã€€ };ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€   };
{ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€       {ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ ã€€   class b:public virtual aã€€ã€€ã€€ class b:public a
    virtual void foo();ã€€ã€€ã€€ã€€ã€€ã€€  virtual void foo();ã€€ã€€ã€€ã€€{ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€  {
};ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€        };ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€virtual void foo();ã€€ã€€ã€€ã€€ã€€ã€€ã€€virtual void foo();
ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€           };ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ };
```

## å­ç±»å¦‚ä½•è°ƒç”¨çˆ¶ç±»çš„å®ç°
è¿™å°±æ˜¯å…³é”®ç‚¹ â€”â€” å³ä½¿ä½ **é‡å†™äº†è™šå‡½æ•°**ï¼Œä½ ä»ç„¶å¯ä»¥åœ¨ B çš„æ–¹æ³•ä¸­ï¼Œ**æ˜¾ç¤ºè°ƒç”¨åŸºç±»çš„å®ç°**ï¼Œ**ç»•è¿‡è™šè¡¨**ï¼š

```cpp
void B::foo() {
    std::cout << "B::foo, but also call A::foo\n";
    A::foo();  // ğŸ‘ˆ ç›´æ¥è°ƒç”¨åŸºç±»å®ç°
}
```
è¿™ä¸ªè°ƒç”¨æ˜¯é™æ€ç»‘å®šçš„ï¼Œç¼–è¯‘å™¨çŸ¥é“ä½ æƒ³è¦çš„æ˜¯ A::foo()ï¼Œå®ƒä¸ä¼šèµ°è™šè¡¨ã€‚

### ä¾‹é¢˜
![alt text](image-164.png)




# å†…å­˜ç®¡ç†
## malloc & free
`malloc` å’Œ `free` æœ¬èº«å¹¶ä¸ç›´æ¥å±äºç³»ç»Ÿè°ƒç”¨ï¼Œä½†å®ƒä»¬ç¡®å®ä¸ç³»ç»Ÿè°ƒç”¨æœ‰å…³ï¼Œç‰¹åˆ«æ˜¯åœ¨åº•å±‚å†…å­˜åˆ†é…å’Œé‡Šæ”¾æ—¶ã€‚

### **malloc å’Œ free ä¸ç³»ç»Ÿè°ƒç”¨çš„å…³ç³»**

1. **malloc**:
   - `malloc` æ˜¯ä¸€ä¸ªæ ‡å‡†åº“å‡½æ•°ï¼Œè´Ÿè´£ä»ç¨‹åºçš„å †å†…å­˜ä¸­åˆ†é…å†…å­˜ã€‚å…¶å…·ä½“å®ç°ä¾èµ–äºæ“ä½œç³»ç»Ÿçš„å†…å­˜ç®¡ç†æœºåˆ¶ã€‚ 
   - **å°å—å†…å­˜åˆ†é…**ï¼šå½“åˆ†é…çš„å†…å­˜è¾ƒå°ï¼ˆä¾‹å¦‚å‡  KBï¼‰ï¼Œ`malloc` é€šå¸¸ä¼šä»é¢„å…ˆåˆ†é…çš„å †ç©ºé—´ä¸­ç›´æ¥åˆ†é…å†…å­˜ï¼Œè€Œä¸éœ€è¦ç³»ç»Ÿè°ƒç”¨ã€‚
   - **å¤§å—å†…å­˜åˆ†é…**ï¼šå½“éœ€è¦çš„å†…å­˜è¾ƒå¤§æ—¶ï¼Œ`malloc` ä¼šé€šè¿‡ç³»ç»Ÿè°ƒç”¨å‘æ“ä½œç³»ç»Ÿè¯·æ±‚æ›´å¤šçš„å†…å­˜ã€‚å¸¸è§çš„ç³»ç»Ÿè°ƒç”¨æœ‰ `sbrk()` æˆ– `mmap()`ï¼Œå…·ä½“ä½¿ç”¨å“ªä¸ªç³»ç»Ÿè°ƒç”¨å–å†³äºæ“ä½œç³»ç»Ÿå’Œå†…å­˜åˆ†é…å™¨çš„å®ç°ã€‚

2. **free**:
   - `free` æ˜¯ç”¨æ¥é‡Šæ”¾ä¹‹å‰é€šè¿‡ `malloc` åˆ†é…çš„å†…å­˜ã€‚å®ƒçš„å®ç°ä¹Ÿæ¶‰åŠåˆ°å†…å­˜ç®¡ç†å™¨ï¼Œé€šå¸¸å¹¶ä¸ç›´æ¥è°ƒç”¨æ“ä½œç³»ç»Ÿçš„ç³»ç»Ÿè°ƒç”¨æ¥é‡Šæ”¾å•ä¸ªå†…å­˜å—ï¼Œä½†å®ƒä¼šå¯¹å †å†…å­˜è¿›è¡Œç®¡ç†ï¼ˆå¦‚åˆå¹¶ç©ºé—²å†…å­˜å—ï¼‰ã€‚
   - åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¦‚æœé‡Šæ”¾çš„æ˜¯ä¸€å¤§å—å†…å­˜ï¼ˆä¾‹å¦‚ç”± `malloc` é€šè¿‡ `mmap` åˆ†é…çš„å†…å­˜ï¼‰ï¼Œ`free` ä¼šè°ƒç”¨ç³»ç»Ÿè°ƒç”¨ `munmap()` æ¥é‡Šæ”¾å†…å­˜ã€‚

### **æ“ä½œç³»ç»Ÿä¸­çš„ç›¸å…³ç³»ç»Ÿè°ƒç”¨**

- **sbrk()**ï¼š`sbrk` æ˜¯è¾ƒæ—©çš„ç³»ç»Ÿè°ƒç”¨ï¼Œç”¨äºè°ƒæ•´ç¨‹åºçš„å †ç©ºé—´å¤§å°ï¼ˆé€šè¿‡æ”¹å˜ç¨‹åºçš„æ•°æ®æ®µçš„æœ«å°¾ï¼‰ã€‚ç°ä»£æ“ä½œç³»ç»Ÿä¸­è¾ƒå°‘ä½¿ç”¨ `sbrk`ï¼Œè€Œæ˜¯ä½¿ç”¨ `mmap`ã€‚
  
- **mmap()**ï¼š`mmap` æ˜¯ç”¨äºæ˜ å°„æ–‡ä»¶æˆ–è®¾å¤‡åˆ°å†…å­˜ä¸­çš„ç³»ç»Ÿè°ƒç”¨ï¼Œé€šå¸¸åœ¨ç”³è¯·å¤§å—å†…å­˜æ—¶ä½¿ç”¨ã€‚ç°ä»£çš„å†…å­˜åˆ†é…å™¨ï¼ˆå¦‚ `glibc`ï¼‰é€šå¸¸ä¼šä½¿ç”¨ `mmap` æ¥å¤„ç†å¤§å—å†…å­˜çš„åˆ†é…ã€‚

### **æ€»ç»“**

- `malloc` å’Œ `free` ä¸æ˜¯ç›´æ¥çš„ç³»ç»Ÿè°ƒç”¨ï¼Œè€Œæ˜¯é€šè¿‡åº•å±‚çš„å†…å­˜åˆ†é…å™¨å®ç°çš„ï¼Œå†…å­˜åˆ†é…å™¨æœ¬èº«å¯èƒ½ä¼šè°ƒç”¨æ“ä½œç³»ç»Ÿæä¾›çš„ç³»ç»Ÿè°ƒç”¨ï¼ˆå¦‚ `mmap()` æˆ– `sbrk()`ï¼‰æ¥è¯·æ±‚æˆ–é‡Šæ”¾å†…å­˜ã€‚
- é¢‘ç¹çš„å°å—å†…å­˜åˆ†é…é€šå¸¸ä¸æ¶‰åŠç³»ç»Ÿè°ƒç”¨ï¼Œä½†å¤§å—å†…å­˜çš„åˆ†é…å’Œé‡Šæ”¾é€šå¸¸ä¼šè§¦å‘ç³»ç»Ÿè°ƒç”¨ã€‚

## mmapçš„å®ç°åŸç†
`mmap`ï¼ˆmemory mapï¼‰æ˜¯ **å†…å­˜æ˜ å°„** æœºåˆ¶ï¼Œå®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯ **å°†æ–‡ä»¶æˆ–åŒ¿åé¡µæ˜ å°„åˆ°è¿›ç¨‹çš„åœ°å€ç©ºé—´ï¼Œä½¿å¾—åº”ç”¨ç¨‹åºå¯ä»¥åƒæ“ä½œå†…å­˜ä¸€æ ·è®¿é—®æ•°æ®ï¼Œè€Œæ— éœ€ `read`/`write` ç³»ç»Ÿè°ƒç”¨**ã€‚  

`mmap` ä¸»è¦ç”± **é¡µè¡¨æ˜ å°„** å’Œ **ç¼ºé¡µä¸­æ–­æœºåˆ¶** ç»„æˆï¼Œå…¶åº•å±‚ä¾èµ– **è™šæ‹Ÿå†…å­˜ç®¡ç†**ï¼Œå…è®¸é«˜æ•ˆçš„æ–‡ä»¶ I/O ä»¥åŠå¤§å—å†…å­˜åˆ†é…ã€‚

---

### **1. `mmap` çš„æ ¸å¿ƒæµç¨‹**
å½“è°ƒç”¨ `mmap` æ—¶ï¼ŒLinux å†…æ ¸ä¼šæ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š

 **â‘  è§£æ `mmap` å‚æ•°**
```cpp
void* addr = mmap(NULL, 4096, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, -1, 0);
```
å‚æ•°è§£æï¼š
- `addr = NULL`ï¼šè®©å†…æ ¸é€‰æ‹©æ˜ å°„åœ°å€ï¼ˆé€šå¸¸ä»è¿›ç¨‹åœ°å€ç©ºé—´çš„ **mmap åŒºåŸŸ** é€‰æ‹©ï¼‰ã€‚
- `length = 4096`ï¼šæ˜ å°„å¤§å°ï¼Œå¿…é¡»æ˜¯ **é¡µå¤§å°**ï¼ˆé€šå¸¸ 4KBï¼‰çš„æ•´æ•°å€ã€‚
- `PROT_READ | PROT_WRITE`ï¼šå…è®¸ **è¯»å†™** è®¿é—®ã€‚
- `MAP_PRIVATE | MAP_ANONYMOUS`ï¼š
  - `MAP_PRIVATE`ï¼šå†™æ—¶å¤åˆ¶ï¼Œä¸å½±å“å…¶ä»–è¿›ç¨‹ã€‚
  - `MAP_ANONYMOUS`ï¼šä¸æ˜ å°„æ–‡ä»¶ï¼Œåªåˆ†é…å†…å­˜ã€‚
- `fd = -1, offset = 0`ï¼šå¯¹äºåŒ¿åæ˜ å°„ï¼Œæ–‡ä»¶æè¿°ç¬¦æ— æ•ˆã€‚

---

 **â‘¡ è¿›ç¨‹åœ°å€ç©ºé—´å»ºç«‹æ˜ å°„**
- **æ–‡ä»¶æ˜ å°„**ï¼šå¦‚æœ `mmap` ç»‘å®šåˆ°ä¸€ä¸ªæ–‡ä»¶ï¼Œå†…æ ¸ä¼šå°†è¯¥æ–‡ä»¶çš„**ç‰©ç†é¡µæ¡†ï¼ˆframeï¼‰** æ˜ å°„åˆ°**è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´**ï¼Œä½†**ä¸ä¼šç«‹å³åˆ†é…ç‰©ç†å†…å­˜**ï¼Œè€Œæ˜¯**é‡‡ç”¨æ‡’åŠ è½½**ï¼ˆå³æŒ‰éœ€åŠ è½½ï¼‰ã€‚
- **åŒ¿åæ˜ å°„**ï¼šå¦‚æœ `MAP_ANONYMOUS`ï¼Œåˆ™ç›´æ¥åœ¨ **ç‰©ç†å†…å­˜** æˆ– **äº¤æ¢åŒº** åˆ†é…æ–°çš„ **é›¶é¡µï¼ˆzero pageï¼‰**ï¼Œå¹¶æ˜ å°„åˆ°è¿›ç¨‹ã€‚

---

 **â‘¢ æ›´æ–°è¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜ç»“æ„**
- å†…æ ¸åœ¨ **è¿›ç¨‹æ§åˆ¶å—ï¼ˆPCBï¼‰** çš„ **è™šæ‹Ÿå†…å­˜åŒºåŸŸï¼ˆVMA, Virtual Memory Areaï¼‰** è®°å½•æ–°çš„æ˜ å°„åŒºåŸŸã€‚
- **VMA ç»“æ„**ï¼ˆ`struct vm_area_struct`ï¼‰æè¿°äº† `mmap` æ˜ å°„çš„ **èµ·å§‹åœ°å€ã€å¤§å°ã€æƒé™ã€æ˜ å°„æ–‡ä»¶ç­‰ä¿¡æ¯**ã€‚
- è¿™æ„å‘³ç€è¿›ç¨‹çš„ **é¡µè¡¨** ç°åœ¨çŸ¥é“äº†è¯¥åŒºåŸŸï¼Œä½† **è¿˜æ²¡æœ‰çœŸæ­£åˆ†é…ç‰©ç†é¡µ**ã€‚

---

 **â‘£ ç¼ºé¡µä¸­æ–­ï¼ˆPage Faultï¼‰æœºåˆ¶**
- è¿›ç¨‹è®¿é—®æ˜ å°„åŒºåŸŸçš„**ç¬¬ä¸€æ¬¡è®¿é—®**ä¼šè§¦å‘ **ç¼ºé¡µå¼‚å¸¸ï¼ˆPage Faultï¼‰**ï¼š
  1. **æ£€æŸ¥é¡µè¡¨**ï¼šCPU å‘ç°å¯¹åº”çš„è™šæ‹Ÿåœ°å€æ²¡æœ‰æ˜ å°„ç‰©ç†é¡µï¼Œè§¦å‘å¼‚å¸¸ã€‚
  2. **å¤„ç†ç¼ºé¡µ**ï¼š
     - **æ–‡ä»¶æ˜ å°„**ï¼šä»ç£ç›˜åŠ è½½ç›¸åº”çš„é¡µåˆ°ç‰©ç†å†…å­˜ã€‚
     - **åŒ¿åæ˜ å°„**ï¼šåˆ†é…æ–°çš„ç‰©ç†é¡µï¼Œå¹¶å¡«å…… 0ï¼ˆzero pageï¼‰ã€‚
  3. **æ›´æ–°é¡µè¡¨**ï¼šé¡µè¡¨æŒ‡å‘åˆ†é…çš„ç‰©ç†é¡µï¼Œè¿›ç¨‹æ¢å¤æ‰§è¡Œã€‚

---

 **â‘¤ è¿›ç¨‹è®¿é—®æ˜ å°„åŒºåŸŸ**
- ç°åœ¨ `mmap` åŒºåŸŸå¯ä»¥åƒæ™®é€šå†…å­˜ä¸€æ ·è®¿é—®ï¼Œä¸éœ€è¦ `read()`/`write()` ç³»ç»Ÿè°ƒç”¨ã€‚
- **å†™æ—¶å¤åˆ¶ï¼ˆCOW, Copy-On-Writeï¼‰**ï¼š
  - `MAP_PRIVATE` æ–¹å¼ä¸‹ï¼Œå¤šä¸ªè¿›ç¨‹å…±äº«åŒä¸€ç‰©ç†é¡µï¼Œåªæœ‰**å½“æŸä¸ªè¿›ç¨‹å†™å…¥**è¯¥åŒºåŸŸæ—¶ï¼Œæ‰ä¼š**åˆ†é…æ–°é¡µ**ã€‚

---

 **â‘¥ é‡Šæ”¾æ˜ å°„ (`munmap`)**
- è°ƒç”¨ `munmap(addr, length)` é‡Šæ”¾æ˜ å°„ï¼š
  - é‡Šæ”¾ **VMA ç»“æ„**ï¼Œè§£é™¤åœ°å€æ˜ å°„ã€‚
  - å¦‚æœ `MAP_SHARED`ï¼Œä¼šå°†è„é¡µå†™å›æ–‡ä»¶ã€‚
  - å¦‚æœ `MAP_ANONYMOUS`ï¼Œåˆ™ç›´æ¥é‡Šæ”¾ç‰©ç†å†…å­˜ã€‚

---

### **2. `mmap` çš„ä¼˜åŠ¿**
 âœ… **é«˜æ•ˆçš„æ–‡ä»¶ I/O**
- ç›´æ¥å°†æ–‡ä»¶æ˜ å°„åˆ°å†…å­˜ï¼Œé¿å… `read()`/`write()` çš„ **ç”¨æˆ·æ€-å†…æ ¸æ€åˆ‡æ¢**ï¼Œ**å‡å°‘ç³»ç»Ÿè°ƒç”¨**ï¼Œé€‚åˆ**å¤§æ–‡ä»¶è¯»å–**ï¼ˆå¦‚æ•°æ®åº“ã€æ—¥å¿—å¤„ç†ï¼‰ã€‚

 âœ… **æŒ‰éœ€åŠ è½½ï¼Œå‡å°‘å†…å­˜å ç”¨**
- `mmap` é‡‡ç”¨ **æ‡’åŠ è½½**ï¼ˆLazy Loadingï¼‰ï¼Œåªåœ¨è®¿é—®æ—¶åŠ è½½æ‰€éœ€çš„é¡µï¼Œè€Œ `malloc` ä¼šç«‹åˆ»åˆ†é…æ•´ä¸ªå—ã€‚

 âœ… **å‡å°‘æ•°æ®æ‹·è´**
- ä¼ ç»Ÿ `read()` éœ€è¦ **ç£ç›˜ â†’ å†…æ ¸ç¼“å†²åŒº â†’ ç”¨æˆ·ç¼“å†²åŒº** ä¸‰æ­¥ï¼Œè€Œ `mmap` ç›´æ¥åœ¨è¿›ç¨‹åœ°å€ç©ºé—´æ˜ å°„ç£ç›˜é¡µï¼Œå‡å°‘ **æ•°æ®æ‹·è´**ã€‚

 âœ… **æ”¯æŒè¿›ç¨‹é—´é€šä¿¡ï¼ˆIPCï¼‰**
- `mmap` ç»“åˆ `MAP_SHARED` å…è®¸**å¤šä¸ªè¿›ç¨‹å…±äº«åŒä¸€å—å†…å­˜**ï¼Œç”¨äº**é«˜æ•ˆ IPC**ï¼ˆå¦‚ `shm_open` å…±äº«å†…å­˜ï¼‰ã€‚

---

### **3. `mmap` vs. `malloc`**
| **å¯¹æ¯”é¡¹**   | **mmap** | **malloc** |
|-------------|---------|----------|
| **å†…å­˜æ¥æº** | ç›´æ¥å‘ **å†…æ ¸ç”³è¯·** | ä» **å †åˆ†é…**ï¼ˆ`sbrk()` æˆ– `mmap()`ï¼‰ |
| **æ•°æ®æ‹·è´** | **0 æ‹·è´**ï¼ˆç›´æ¥æ˜ å°„ï¼‰ | `malloc â†’ ç”¨æˆ·ç©ºé—´` æ‹·è´ |
| **é€‚ç”¨åœºæ™¯** | **å¤§å—åˆ†é…**ã€æ–‡ä»¶æ˜ å°„ | **å°å—å†…å­˜ç®¡ç†** |
| **æ€§èƒ½** | é«˜æ•ˆï¼Œä½†é€‚åˆ**é•¿ç”Ÿå‘½å‘¨æœŸ** | é€‚åˆ**é¢‘ç¹åˆ†é…å’Œé‡Šæ”¾** |
| **ç¢ç‰‡åŒ–** | æ— **å †ç¢ç‰‡** | å¯èƒ½å¯¼è‡´**å †ç¢ç‰‡åŒ–** |

- `mmap` é€‚ç”¨äº **å¤§å—** å†…å­˜åˆ†é…ï¼ˆ>128KBï¼‰ï¼Œå‡å°‘ç¢ç‰‡ï¼Œä½† `malloc` é€‚åˆå°å¯¹è±¡åˆ†é…ã€‚

---

### **4. `mmap` çš„ç¼ºç‚¹**
âŒ **å°å¯¹è±¡æ€§èƒ½å·®**ï¼š
- ç”±äº `mmap` ç›´æ¥å‘ **å†…æ ¸** ç”³è¯·å†…å­˜ï¼Œç®¡ç†å¼€é”€å¤§ï¼Œé¢‘ç¹ `mmap/munmap` ä¼šé™ä½æ€§èƒ½ã€‚

âŒ **æœ€å°åˆ†é…å•ä½æ˜¯é¡µ**ï¼š
- `mmap` åªèƒ½æŒ‰é¡µï¼ˆé€šå¸¸ 4KBï¼‰å¯¹é½ï¼Œæ— æ³•ç²¾ç¡®æ§åˆ¶å°å—åˆ†é…ã€‚

âŒ **é¡µå›æ”¶ä¸çµæ´»**ï¼š
- `malloc` å¯ä»¥åˆå¹¶/é‡Šæ”¾ç¢ç‰‡ï¼Œä½† `mmap` æ— æ³•å›æ”¶éƒ¨åˆ†é¡µï¼ˆå¿…é¡» `munmap` æ•´ä¸ªåŒºåŸŸï¼‰ã€‚

---

### **5. æ€»ç»“**
âœ… `mmap` **åŸç†**ï¼š
- é€šè¿‡ **é¡µè¡¨æ˜ å°„** å’Œ **ç¼ºé¡µä¸­æ–­æœºåˆ¶** ç›´æ¥å°† **æ–‡ä»¶/åŒ¿åé¡µ** æ˜ å°„åˆ° **è¿›ç¨‹åœ°å€ç©ºé—´**ï¼Œæ— éœ€ `read/write`ã€‚
- **æ‡’åŠ è½½** + **å†™æ—¶å¤åˆ¶** æœºåˆ¶ä¼˜åŒ–å†…å­˜ç®¡ç†ã€‚

âœ… `mmap` **é€‚ç”¨åœºæ™¯**ï¼š
- **å¤§å—å†…å­˜**ï¼ˆ>128KBï¼‰ã€‚
- **æ–‡ä»¶ I/O åŠ é€Ÿ**ï¼ˆå¦‚æ•°æ®åº“ã€æ—¥å¿—ç³»ç»Ÿï¼‰ã€‚
- **è¿›ç¨‹é—´é€šä¿¡ï¼ˆIPCï¼‰**ã€‚

âœ… `mmap` vs. `malloc`ï¼š
- `malloc` é€‚åˆ **å°å¯¹è±¡ç®¡ç†**ï¼ˆ<128KBï¼‰ã€‚
- `mmap` é€‚åˆ **å¤§å¯¹è±¡ã€é›¶æ‹·è´æ–‡ä»¶è®¿é—®**ã€‚

âœ… **ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š
- ç»“åˆ **`malloc` + `mmap`**ï¼ˆ`glibc` çš„ `malloc` å°±æ˜¯è¿™æ ·åšçš„ï¼‰ã€‚
- ä½¿ç”¨ **jemalloc/tcmalloc** å¤„ç†ç¢ç‰‡é—®é¢˜ã€‚

## malloc & mmap (ç”³è¯·>128kb)
å½“ `malloc` ç”³è¯·çš„å†…å­˜ **è¶…è¿‡ 128KBï¼ˆå³ 128 Ã— 1024 å­—èŠ‚ï¼‰** æ—¶ï¼Œ`glibc` çš„ `malloc` **ä¼šä½¿ç”¨ `mmap`** æ¥åˆ†é…å†…å­˜ï¼Œè€Œä¸æ˜¯ä»å †ï¼ˆheapï¼‰åˆ†é…ã€‚  

---

### **1. `malloc` å†…éƒ¨çš„åˆ†é…ç­–ç•¥**
`glibc` é‡‡ç”¨ **`ptmalloc`ï¼ˆåŸºäº `dlmalloc` æ”¹è¿›ï¼‰** ä½œä¸º `malloc` çš„é»˜è®¤å®ç°ã€‚  
å…¶åˆ†é…ç­–ç•¥å¦‚ä¸‹ï¼š

#### **ï¼ˆ1ï¼‰å°å—å†…å­˜ï¼ˆâ‰¤ 128KBï¼‰â€”â€” ä½¿ç”¨ `sbrk()` ä»å †åˆ†é…**
- å°äºç­‰äº **128KB** çš„åˆ†é…ï¼Œä¼šä» `heap`ï¼ˆè¿›ç¨‹å †åŒºï¼‰ç”³è¯·ï¼Œä½¿ç”¨ `sbrk()` å¢åŠ å †ç©ºé—´ã€‚
- `malloc` ç»´æŠ¤ä¸€ä¸ª **free listï¼ˆç©ºé—²é“¾è¡¨ï¼‰**ï¼Œä»å·²åˆ†é…çš„ **å †å—** å¤ç”¨å†…å­˜ï¼Œé¿å…é¢‘ç¹ `sbrk()`ã€‚

#### **ï¼ˆ2ï¼‰å¤§å—å†…å­˜ï¼ˆ> 128KBï¼‰â€”â€” ä½¿ç”¨ `mmap()`**
- å¦‚æœç”³è¯·çš„å†…å­˜**è¶…è¿‡ 128KB**ï¼Œåˆ™ `malloc` **ä¼šç›´æ¥è°ƒç”¨ `mmap()`** æ¥åˆ†é…ã€‚
- è¿™äº›å¤§å—å†…å­˜ä¸ä¼šè¿›å…¥ `malloc` çš„ **free list**ï¼Œè€Œæ˜¯**ç‹¬ç«‹ç®¡ç†**ï¼Œåœ¨ `free()` æ—¶ç›´æ¥ `munmap()` é‡Šæ”¾ã€‚

---

### **2. ä¸ºä»€ä¹ˆå¤§å—å†…å­˜ä½¿ç”¨ `mmap`ï¼Ÿ**
ä½¿ç”¨ `mmap` è€Œä¸æ˜¯ `sbrk()` çš„åŸå› ä¸»è¦æœ‰ **ä¸‰ç‚¹**ï¼š

#### âœ… **ï¼ˆ1ï¼‰é¿å…å †ç¢ç‰‡**
- **å †å†…å­˜çš„åˆ†é…æ˜¯çº¿æ€§å¢é•¿çš„**ï¼ˆ`sbrk()` åªèƒ½æ‰©å±•å †ï¼Œä¸èƒ½æ”¶ç¼©ï¼‰ã€‚
- å¦‚æœ `malloc` åœ¨å †ä¸Šåˆ†é…ä¸€ä¸ªå¤§å—ï¼ˆä¾‹å¦‚ 1MBï¼‰ï¼Œåç»­é‡Šæ”¾æ—¶ï¼Œå †ä¸­çš„**ç¢ç‰‡å¯èƒ½æ— æ³•å¤ç”¨**ï¼Œå¯¼è‡´**å†…å­˜æµªè´¹**ã€‚
- `mmap` **ç›´æ¥æ˜ å°„**ï¼Œä¸å½±å“ `heap`ã€‚

#### âœ… **ï¼ˆ2ï¼‰æ›´å¿«çš„é‡Šæ”¾**
- **`mmap` åˆ†é…çš„å†…å­˜** åœ¨ `free()` æ—¶ä¼šè¢«**ç›´æ¥é‡Šæ”¾ç»™æ“ä½œç³»ç»Ÿ**ï¼ˆ`munmap()`ï¼‰ï¼Œä¸ä¼šç•™åœ¨ `malloc` çš„ `free list` é‡Œã€‚
- **å †ä¸Šçš„å†…å­˜**ï¼ˆ`sbrk` æ–¹å¼ï¼‰å³ä½¿ `free()` äº†ï¼Œé™¤éæ˜¯**æœ€é¡¶ç«¯çš„å—**ï¼Œå¦åˆ™æ— æ³•é‡Šæ”¾ç»™ OSã€‚

#### âœ… **ï¼ˆ3ï¼‰æŒ‰éœ€åˆ†é¡µï¼Œå‡å°‘å†…å­˜å ç”¨**
- `mmap` é‡‡ç”¨ **æŒ‰éœ€åˆ†é…ï¼ˆlazy allocationï¼‰**ï¼Œåªæœ‰è®¿é—®æ—¶æ‰åˆ†é…ç‰©ç†é¡µï¼ˆå‡å°‘ RSSï¼‰ã€‚
- **å¤§å¯¹è±¡è®¿é—®å±€éƒ¨æ€§å·®**ï¼Œ`malloc` çš„ `free list` å¤ç”¨æ•ˆæœä¸å¥½ï¼Œè€Œ `mmap` èƒ½ç›´æ¥ç®¡ç†å¤§å—å†…å­˜ã€‚

---

### **3. `malloc` ä½•æ—¶è°ƒç”¨ `mmap()`ï¼Ÿ**
- **glibc è®¾å®šçš„é˜ˆå€¼æ˜¯ 128KB**ï¼ˆ`glibc` 2.15+ï¼Œå…·ä½“å€¼ç”± `MMAP_THRESHOLD` æ§åˆ¶ï¼‰ã€‚
- `malloc` **æ£€æŸ¥ç”³è¯·å¤§å°**ï¼š
  - **â‰¤ 128KB**ï¼šä½¿ç”¨ `sbrk()` åœ¨ `heap` åˆ†é…ã€‚
  - **> 128KB**ï¼šè°ƒç”¨ `mmap()`ã€‚

---

### **4. ä»£ç éªŒè¯ `malloc` æ˜¯å¦ä½¿ç”¨ `mmap()`**
å¯ä»¥ä½¿ç”¨ `strace` è·Ÿè¸ª `malloc` è°ƒç”¨ï¼š
```bash
strace ./a.out 2>&1 | grep mmap
```
æˆ–è€…ç¼–å†™æµ‹è¯•ä»£ç ï¼š
```cpp
#include <iostream>
#include <cstdlib>
#include <sys/mman.h>
#include <unistd.h>

int main() {
    size_t small_size = 128 * 1024; // 128KB
    size_t large_size = 129 * 1024; // 129KB

    void* p1 = malloc(small_size); // å¯èƒ½ç”¨ sbrk() (heap)
    void* p2 = malloc(large_size); // å¯èƒ½ç”¨ mmap()

    std::cout << "Small alloc: " << p1 << std::endl;
    std::cout << "Large alloc: " << p2 << std::endl;

    free(p1);
    free(p2);

    return 0;
}
```
ç„¶åè¿è¡Œï¼š
```bash
cat /proc/self/maps | grep heap  # æŸ¥çœ‹ heap åœ°å€
```
å¦‚æœ `large_size` åˆ†é…çš„åœ°å€ **ä¸åœ¨ heap é‡Œ**ï¼Œè¯´æ˜å®ƒæ˜¯ `mmap` ç”³è¯·çš„ã€‚

---

### **5. æ€»ç»“**
âœ… **`malloc` åœ¨å¤§å¯¹è±¡ï¼ˆ>128KBï¼‰æ—¶ï¼Œå†…éƒ¨ä¼šè°ƒç”¨ `mmap()`**ï¼Œä»¥å‡å°‘ **å †ç¢ç‰‡ã€æå‡é‡Šæ”¾æ•ˆç‡**ã€‚  
âœ… **å°å¯¹è±¡ï¼ˆâ‰¤128KBï¼‰ä½¿ç”¨ `sbrk()` ä» `heap` åˆ†é…**ï¼Œå¹¶ç»´æŠ¤ `free list` æ¥å¤ç”¨å†…å­˜ã€‚  
âœ… **`mmap` åˆ†é…çš„å†…å­˜å¯ä»¥ç«‹å³ `munmap()` é‡Šæ”¾ç»™ OSï¼Œè€Œ `heap` éœ€è¦ `brk()` å›é€€**ã€‚

## sbrk & mmap
æ˜¯çš„ï¼Œä½ è¯´å¾—éå¸¸å‡†ç¡®ï¼ä¸‹é¢æˆ‘ç»™ä½ æ¢³ç†ä¸€ä¸‹ `malloc` èƒŒåçš„ä¸¤ç§åˆ†é…æœºåˆ¶ï¼š`sbrk` å’Œ `mmap`ï¼Œä»¥åŠå®ƒä»¬çš„**é‡Šæ”¾ç­–ç•¥å·®å¼‚**ï¼š

---

### ğŸ§  malloc çš„åº•å±‚å®ç°æœºåˆ¶ï¼ˆglibc ä»¥ ptmalloc ä¸ºä¾‹ï¼‰

åœ¨ glibc çš„ `malloc` å®ç°ä¸­ï¼Œ**å†…å­˜åˆ†é…æœ‰ä¸¤ç§ä¸»è¦æ–¹å¼**ï¼š

#### 1. ğŸ”¹ ä½¿ç”¨ `sbrk`ï¼ˆbrkï¼‰æ‰©å±•å †åŒºï¼ˆheapï¼‰
- åˆ†é…è¾ƒå°çš„å†…å­˜å—ï¼ˆä¸€èˆ¬ < 128KBï¼‰ï¼Œä»å †åŒºå°¾éƒ¨è·å–ã€‚
- ä½¿ç”¨ `sbrk` å°†è¿›ç¨‹çš„æ•°æ®æ®µå‘ä¸Šæ‰©å±•ï¼Œå±äº**è¿›ç¨‹ç§æœ‰å †ç©ºé—´**ã€‚
- åˆ†é…çš„ç©ºé—´ä¼šçº³å…¥ **malloc çš„å†…éƒ¨ç®¡ç†ï¼ˆå¦‚ free listï¼‰**ï¼Œåç»­å¯ä»¥å¤ç”¨ã€‚

##### ğŸ“Œ ç‰¹ç‚¹ï¼š
- **ç©ºé—´é‡ç”¨ç‡é«˜**ï¼šfree åä¸ä¼šç«‹åˆ»å½’è¿˜ç³»ç»Ÿï¼Œè€Œæ˜¯æ”¾å…¥ç©ºé—²é“¾è¡¨ï¼Œä¾›ä¸‹æ¬¡ malloc ä½¿ç”¨ã€‚
- é€‚åˆé¢‘ç¹åˆ†é…/é‡Šæ”¾çš„å°å†…å­˜å—ã€‚

---

#### 2. ğŸ”¸ ä½¿ç”¨ `mmap`ï¼ˆåŒ¿åæ˜ å°„ï¼‰
- åˆ†é…å¤§å—å†…å­˜ï¼ˆglibc é»˜è®¤è¶…è¿‡ 128KB ä¼šè§¦å‘ `mmap`ï¼‰ã€‚
- ä¸å†ä»è¿›ç¨‹ heap ä¸­åˆ†é…ï¼Œè€Œæ˜¯**å•ç‹¬é€šè¿‡åŒ¿åæ˜ å°„æ˜ å°„ä¸€å—å†…å­˜åŒºåŸŸ**ã€‚

##### ğŸ“Œ ç‰¹ç‚¹ï¼š
- **free åç›´æ¥è°ƒç”¨ `munmap`**ï¼Œè¿™å—å†…å­˜**ç«‹åˆ»å½’è¿˜æ“ä½œç³»ç»Ÿ**ã€‚
- å› ä¸ºä¸è¿›å…¥ malloc çš„ç®¡ç†æ± ï¼Œæ‰€ä»¥ä¸ä¼šè¢«å¤ç”¨ã€‚
- ç¼ºç‚¹ï¼šé¢‘ç¹ `mmap/munmap` æˆæœ¬è¾ƒé«˜ã€‚

---

### ğŸ§¾ free è¡Œä¸ºçš„å·®å¼‚

| åˆ†é…æ–¹å¼ | ä½¿ç”¨æ¥å£ | ç©ºé—´æ¥æº       | `free` åè¡Œä¸º              | æ˜¯å¦å½’è¿˜ OS |
|----------|-----------|----------------|-----------------------------|-------------|
| `sbrk`   | å°å— malloc | è¿›ç¨‹ heap       | è¿›å…¥ç©ºé—²é“¾è¡¨ï¼Œç­‰å¾…å¤ç”¨      | âŒ å¦       |
| `mmap`   | å¤§å— malloc | å†…æ ¸åŒ¿åæ˜ å°„åŒº | è°ƒç”¨ `munmap`ï¼Œç«‹å³é‡Šæ”¾     | âœ… æ˜¯       |

---

### âœ… ç»“è®º

> malloc èƒŒåæ˜¯å¦ä½¿ç”¨ sbrk æˆ– mmap å–å†³äºä½ ç”³è¯·çš„å†…å­˜å¤§å°ï¼š
- å°å†…å­˜å—ï¼ˆ< 128KBï¼‰é€šå¸¸ä½¿ç”¨ **sbrk** + **å†…å­˜æ± æœºåˆ¶**ï¼›
- å¤§å†…å­˜å—åˆ™èµ° **mmap**ï¼Œfree åä¹Ÿç›´æ¥ `munmap` å›æ”¶ã€‚

ä½ å¯ä»¥é€šè¿‡ç¯å¢ƒå˜é‡æˆ–è€…è°ƒè¯•å·¥å…·çœ‹åˆ°è¿™ä¸ªè¡Œä¸ºï¼Œæ¯”å¦‚ï¼š

```bash
MALLOC_TRACE=log.txt ./a.out
```

æˆ–è€…ç”¨ `strace ./a.out` çœ‹åº•å±‚æ˜¯ `brk` è¿˜æ˜¯ `mmap`ã€‚

---

å¦‚æœä½ æœ‰å…´è¶£æˆ‘å¯ä»¥å¸¦ä½ å®ç°ä¸€ä¸ªç®€åŒ–ç‰ˆçš„ malloc æ¨¡æ‹Ÿè¿™ä¸ªè¡Œä¸ºï¼Œæˆ–è€…æ·±å…¥è®²è®² ptmalloc ä¸­ chunk çš„ç»„ç»‡ç»“æ„å’Œ bin ç®¡ç†ï¼Ÿ


## mallocå†…å­˜æº¢å‡º
å¦‚æœ `malloc` å‘ç”Ÿ **å†…å­˜æº¢å‡º**ï¼ˆå³æ— æ³•æˆåŠŸåˆ†é…å†…å­˜ï¼‰ï¼Œä¼šæœ‰ä»¥ä¸‹å‡ ç§æƒ…å†µï¼š  

---

### **1. `malloc` å¤±è´¥ï¼Œè¿”å› `nullptr`**  
å½“ç³»ç»Ÿ **å†…å­˜ä¸è¶³** æˆ–è€… **è¿›ç¨‹å—é™äºæœ€å¤§å¯ç”¨å†…å­˜** æ—¶ï¼Œ`malloc` å¯èƒ½ä¼šå¤±è´¥ï¼Œå¹¶è¿”å› `nullptr`ï¼š
```cpp
#include <iostream>
#include <cstdlib>

int main() {
    size_t size = 1024L * 1024 * 1024 * 1024; // 1TB
    void* ptr = malloc(size);

    if (ptr == nullptr) {
        std::cerr << "Memory allocation failed!" << std::endl;
    } else {
        std::cout << "Memory allocated successfully!" << std::endl;
        free(ptr);
    }

    return 0;
}
```
#### **ğŸ“Œ å¯èƒ½çš„åŸå› **
- ç‰©ç†å†…å­˜ + äº¤æ¢ç©ºé—´ä¸è¶³
- è¿›ç¨‹è¢« `ulimit` é™åˆ¶ï¼š
  ```bash
  ulimit -a   # æŸ¥çœ‹æœ€å¤§å†…å­˜é™åˆ¶
  ```
- è¿›ç¨‹è¾¾åˆ° `RLIMIT_AS` é™åˆ¶ï¼ˆLinux å¯ç”¨ `setrlimit()` è®¾ç½®ï¼‰

---

### **2. `malloc` å¤±è´¥ï¼Œä½†è¿›ç¨‹è¢« `OOM Killer` æ€æ­»**
åœ¨ **Linux** ä¸Šï¼Œå¦‚æœ `malloc` ç”³è¯·äº†å¤ªå¤šå†…å­˜ï¼Œå¯¼è‡´**ç‰©ç†å†…å­˜å’Œ swap ç©ºé—´è€—å°½**ï¼Œç³»ç»Ÿçš„ **OOM Killerï¼ˆOut Of Memory Killerï¼‰** å¯èƒ½ä¼šç›´æ¥æ€æ­»è¿›ç¨‹ï¼Œè€Œä¸æ˜¯è¿”å› `nullptr`ã€‚

**å¦‚ä½•æŸ¥çœ‹ OOM æ€æ­»çš„è¿›ç¨‹ï¼Ÿ**
```bash
dmesg | grep -i "out of memory"
```

---

### **3. `malloc` è§¦å‘ `mmap()`ï¼Œå¯¼è‡´åœ°å€ç©ºé—´è€—å°½**
- **glibc è§„å®š 128KB ä»¥ä¸Šçš„åˆ†é…ä¼šä½¿ç”¨ `mmap()`**
- è¿‡å¤š `mmap()` ç”³è¯·ä¼šå¯¼è‡´ **åœ°å€ç©ºé—´ä¸è¶³**
- 32 ä½è¿›ç¨‹**æœ€å¤šåªèƒ½ä½¿ç”¨ 4GBï¼ˆç”¨æˆ·æ€ 3GB / 2GBï¼‰**
- 64 ä½ç³»ç»Ÿå¦‚æœæœ‰ **åœ°å€ç©ºé—´é™åˆ¶ï¼ˆ`ulimit` æˆ– `cgroup`ï¼‰**ï¼Œä¹Ÿå¯èƒ½ `mmap()` å¤±è´¥

**ç¤ºä¾‹**
```cpp
#include <iostream>
#include <vector>

int main() {
    std::vector<void*> ptrs;
    while (true) {
        void* p = malloc(200 * 1024 * 1024); // 200MB
        if (!p) {
            std::cerr << "malloc failed!" << std::endl;
            break;
        }
        ptrs.push_back(p);
    }
}
```
**ğŸ“Œ å¯èƒ½çš„é”™è¯¯**
- **è¿”å› `nullptr`**
- **è¿›ç¨‹è¢« OOM æ€æ­»**
- **å´©æºƒ `Segmentation fault`**

---

### **4. è®¿é—®å·²åˆ†é…ä½†æœªåˆå§‹åŒ–çš„å†…å­˜**
`malloc` **ä¸ä¼šåˆå§‹åŒ–åˆ†é…çš„å†…å­˜**ï¼Œå¦‚æœè®¿é—®æœªåˆå§‹åŒ–çš„æ•°æ®ï¼Œå¯èƒ½ä¼šå¯¼è‡´ **æœªå®šä¹‰è¡Œä¸ºï¼ˆUBï¼‰**ï¼š
```cpp
#include <iostream>

int main() {
    int* p = (int*)malloc(10 * sizeof(int));
    std::cout << *p << std::endl; // æœªå®šä¹‰è¡Œä¸ºï¼
    free(p);
}
```
**è§£å†³æ–¹æ¡ˆ**
- **ä½¿ç”¨ `calloc()`**ï¼ˆä¼šæ¸…é›¶ï¼‰
- **æ‰‹åŠ¨ `memset(p, 0, size)`**

---

### **5. è®¿é—®å·²é‡Šæ”¾çš„å†…å­˜ï¼ˆUse-After-Freeï¼‰**
å¦‚æœ `malloc` å¤±è´¥æˆ–é”™è¯¯é‡Šæ”¾äº†å·²åˆ†é…å†…å­˜ï¼Œå¯èƒ½ä¼šå¯¼è‡´ **æ®µé”™è¯¯ï¼ˆSegmentation Faultï¼‰**ï¼š
```cpp
#include <iostream>
#include <cstdlib>

int main() {
    int* p = (int*)malloc(100);
    free(p);
    std::cout << *p << std::endl; // âŒ Use-After-Free
}
```
**è§£å†³æ–¹æ¡ˆ**
- é‡Šæ”¾åç½® `p = nullptr;`
- ä½¿ç”¨ `Valgrind` æ£€æŸ¥ï¼š
  ```bash
  valgrind --leak-check=full ./a.out
  ```

---

### **6. å†…å­˜æ³„æ¼**
å¦‚æœ `malloc` æˆåŠŸä½†**æ²¡æœ‰ `free()` é‡Šæ”¾**ï¼Œå°±ä¼š**å¯¼è‡´å†…å­˜æ³„æ¼**ï¼š
```cpp
void leak_memory() {
    int* p = (int*)malloc(100); // âŒ æ²¡æœ‰ free
}
```
**ğŸ“Œ å½±å“**
- è¿›ç¨‹é•¿æœŸè¿è¡Œä¼š**å ç”¨è¶Šæ¥è¶Šå¤šå†…å­˜**
- å¯ç”¨å·¥å…·æ£€æµ‹ï¼š
  ```bash
  valgrind --leak-check=full ./a.out
  ```

---

### **7. æ€»ç»“**
| **æƒ…å†µ**                          | **ç»“æœ** |
|-----------------------------------|---------|
| **å†…å­˜ä¸è¶³**                      | `malloc` è¿”å› `nullptr` |
| **è¿›ç¨‹è¶…å‡º `ulimit` æˆ– `RLIMIT_AS`** | `malloc` è¿”å› `nullptr` |
| **ç³»ç»Ÿ OOMï¼Œè¿›ç¨‹è¢«æ€**              | OOM Killer æ€æ­»è¿›ç¨‹ |
| **åœ°å€ç©ºé—´è€—å°½ï¼ˆmmap å¤±è´¥ï¼‰**        | `malloc` è¿”å› `nullptr` |
| **è®¿é—®æœªåˆå§‹åŒ–çš„ malloc æ•°æ®**       | æœªå®šä¹‰è¡Œä¸º |
| **Use-After-Free**                 | æ®µé”™è¯¯ï¼ˆSegmentation Faultï¼‰ |
| **å†…å­˜æ³„æ¼**                       | è¿›ç¨‹å†…å­˜å ç”¨ä¸æ–­å¢é•¿ |

ğŸ’¡ **é¢è¯•å›ç­”å»ºè®®**
- `malloc` **ä¸ä¼šæŠ›å¼‚å¸¸**ï¼Œå¤±è´¥æ—¶è¿”å› `nullptr`
- å¯èƒ½å¯¼è‡´ **OOMã€åœ°å€ç©ºé—´è€—å°½ã€æ®µé”™è¯¯**
- **é¿å… Use-After-Freeã€å†…å­˜æ³„æ¼**
- **ä½¿ç”¨ `valgrind` æ£€æµ‹é—®é¢˜**

å¦‚æœé¢è¯•å®˜ç»§ç»­è¿½é—®ï¼Œå¯ä»¥æ·±å…¥ `glibc` çš„ `ptmalloc` æœºåˆ¶ï¼


## glibc-freeå†…å­˜å—å›æ”¶
å¾ˆå¥½ï¼Œè¿™ä¸ªé—®é¢˜æ·±å…¥åˆ°äº† **glibc çš„å†…å­˜åˆ†é…æœºåˆ¶æœ¬è´¨**ï¼Œç‰¹åˆ«æ˜¯æ¶‰åŠåˆ° `free()` çš„å†…éƒ¨è¡Œä¸ºâ€”â€”**å°å—å¦‚ä½•å½’è¿˜ç»™å†…å­˜æ± ï¼Œå¤§å—å¦‚ä½•å½’è¿˜ç»™æ“ä½œç³»ç»Ÿ**ã€‚ä¸‹é¢åˆ†æƒ…å†µç»™ä½ è¯¦ç»†å‰–æï¼š

---

### ğŸ§± åŸºç¡€ï¼šglibc malloc çš„åˆ†é…å™¨ï¼ˆptmallocï¼‰

glibc çš„ `malloc/free` ä½¿ç”¨çš„æ˜¯ **ptmalloc**ï¼ˆpthreads mallocï¼‰æœºåˆ¶ï¼Œæ˜¯åŸºäº `dlmalloc` çš„å¤šçº¿ç¨‹ä¼˜åŒ–ç‰ˆæœ¬ã€‚å…¶æ ¸å¿ƒå†…å­˜ç»„ç»‡æ–¹å¼ä¸»è¦æ¶‰åŠï¼š

- **`arena`**ï¼ˆçº¿ç¨‹ç§æœ‰æˆ–å…±äº«ï¼‰
- **`chunk`**ï¼ˆmalloc/free çš„åŸºæœ¬å•ä½ï¼‰
- **bin åˆ†ç±»**ï¼ˆfast binã€small binã€large binã€unsorted binï¼‰

---

### âœ… å¸¸è§„å†…å­˜å—ï¼šå¦‚ä½•å›æ”¶ï¼Ÿ

#### ğŸ§© ä¸€èˆ¬ï¼ˆéå·¨å¤§ï¼‰å†…å­˜å—ï¼š

- åˆ†é…é€šå¸¸æ¥è‡ªè¿›ç¨‹å †åŒºï¼ˆé€šè¿‡ `sbrk` ç³»ç»Ÿè°ƒç”¨æ‰©å±• `brk`ï¼‰
- æ¯ä¸ªå—å« **chunk**ï¼ŒåŒ…å«å‰éƒ¨å…ƒä¿¡æ¯ï¼ˆå¤§å°ã€çŠ¶æ€ç­‰ï¼‰

#### å›æ”¶æµç¨‹ï¼š

1. **è°ƒç”¨ `free(ptr)`**
2. glibc ä¼šé€šè¿‡ `ptr - sizeof(header)` æ‰¾åˆ°è¿™ä¸ª chunk çš„èµ·å§‹ä½ç½®
3. è®¾ç½®è¯¥å—ä¸ºâ€œå¯ç”¨â€
4. å°†è¯¥å—æ”¾å…¥ **unsorted bin**
5. åç»­ `malloc` ä¼šä¼˜å…ˆä» bin ä¸­å¤ç”¨è¿™å—å†…å­˜
6. è‹¥ç›¸é‚»ç©ºé—²å—å¯åˆå¹¶ï¼Œglibc ä¼šå°è¯•åˆå¹¶å½¢æˆæ›´å¤§å—ï¼ˆé˜²ç¢ç‰‡ï¼‰

#### ğŸ¯ åˆ†ç±»å½’å…¥ä¸åŒ binï¼š

| Bin ç±»å‹     | ä½œç”¨                                               |
|--------------|----------------------------------------------------|
| fast bin     | éçº¿ç¨‹å®‰å…¨ï¼Œè¶…å¿«åˆ†é…/å›æ”¶ï¼ˆ16~64å­—èŠ‚å·¦å³ï¼‰        |
| small bin    | ç”¨äºå°å†…å­˜å—ï¼ˆé€šå¸¸ < 512 å­—èŠ‚ï¼‰                    |
| large bin    | æ›´å¤§å†…å­˜å—ï¼ŒæŒ‰å¤§å°åˆ†ç±»                            |
| unsorted bin | åˆšé‡Šæ”¾ä¸‹æ¥çš„ chunk æš‚æ—¶åœ¨è¿™é‡Œï¼Œåç»­å†å½’å…¥åˆé€‚ bin |

---

### ğŸ§± è¶…å¤§å†…å­˜å—ï¼ˆmmap åˆ†é…ï¼‰

#### âœ¨ æ¡ä»¶ï¼š

- è‹¥ä¸€æ¬¡ç”³è¯·çš„å¤§å° **è¶…è¿‡ mmap é˜ˆå€¼ï¼ˆé»˜è®¤128 KBï¼‰**ï¼Œglibc ä¼š**ç»•è¿‡ heap åŒº**ï¼Œç›´æ¥è°ƒç”¨ `mmap` åˆ†é…åŒ¿åå†…å­˜é¡µã€‚

```cpp
void* p = malloc(200 * 1024);  // mmap è§¦å‘
```

#### ğŸ” é‡Šæ”¾æ—¶ï¼š

- `free()` æ£€æµ‹åˆ°è¯¥å—æ˜¯é€šè¿‡ `mmap` åˆ†é…çš„
- ç›´æ¥è°ƒç”¨ `munmap()` å°†å†…å­˜é¡µå½’è¿˜ç»™æ“ä½œç³»ç»Ÿï¼

ğŸ¯ è¿™äº›å¤§å— **ä¸ä¼šæ”¾å…¥ binï¼Œä¹Ÿä¸å‚ä¸å†…å­˜æ± é‡ç”¨**ã€‚

---

### ğŸ“‚ å°ç»“å¯¹æ¯”

| ç±»åˆ«         | åˆ†é…æ–¹å¼       | å›æ”¶æ–¹å¼             | æ˜¯å¦æ”¾å…¥ bin | æ˜¯å¦å½’è¿˜ OS |
|--------------|----------------|----------------------|---------------|--------------|
| å¸¸è§„å†…å­˜å—   | sbrk() + arena | æ ‡è®°ç©ºé—² & æ”¾å…¥ bin | âœ…            | âŒ é™¤éæœ€åä¸€ä¸ª chunk |
| mmap å¤§å—    | mmap()         | ç›´æ¥ munmap()        | âŒ            | âœ…           |

---

### ğŸ” ç¤ºä¾‹ï¼šglibc åˆ¤æ–­æ˜¯å¦ mmap å—

glibc åœ¨ `malloc_chunk` ä¸­çš„ metadata ä¼šæ ‡è¯†ä¸€ä¸ª chunk æ˜¯å¦ç”± `mmap` åˆ†é…ï¼š

```c
#define IS_MMAPPED(m)  ((m)->size & IS_MMAPPED_BIT)
```

ä¹Ÿå°±æ˜¯è¯´ï¼Œglibc å¯ä»¥åœ¨ `free()` æ—¶å‡†ç¡®åˆ¤æ–­å‡ºè¿™ä¸ªå†…å­˜å—çš„æ¥æºï¼Œä»è€Œå†³å®šæ˜¯å¦ï¼š

- åˆå¹¶è¿› bin
- ç›´æ¥è°ƒç”¨ `munmap`

---

### ğŸ§  è¡¥å……ï¼šä»€ä¹ˆæ—¶å€™ sbrk() åˆ†é…çš„ç©ºé—´ä¼šè¢«å½’è¿˜ç»™æ“ä½œç³»ç»Ÿï¼Ÿ

åªæœ‰å½“ï¼š

- **è¢«é‡Šæ”¾çš„ chunk æ˜¯å †åŒºçš„â€œæœ«å°¾â€**
- å¹¶ä¸”æ²¡æœ‰å…¶ä»–å—ä½¿ç”¨å®ƒåè¾¹çš„ç©ºé—´

glibc æ‰ä¼šé€šè¿‡ `brk` æŠŠ heap å‘ä¸‹æ”¶ç¼©ã€‚

ä½†ç”±äºå †æ˜¯è¿ç»­çº¿æ€§ç©ºé—´ï¼Œè¿™ç§æƒ…å†µéå¸¸å°‘è§ã€‚

---

### âœ… æ€»ç»“

| åœºæ™¯             | åˆ†é…æœºåˆ¶     | å›æ”¶æ“ä½œ            | å¤ç”¨ç­–ç•¥           |
|------------------|--------------|---------------------|--------------------|
| å°å†…å­˜ï¼ˆfast/small binï¼‰ | sbrk()       | åŠ å…¥ bin            | âœ… åç»­å¯å¤ç”¨       |
| æ™®é€šå¤§å—ï¼ˆlarge binï¼‰   | sbrk()       | åŠ å…¥ large bin      | âœ…                 |
| è¶…å¤§å—ï¼ˆ>128KBï¼‰       | mmap()       | ç›´æ¥ munmap         | âŒ æ— æ³•å¤ç”¨         |
| æœ€åä¸€ä¸ªå †å—         | sbrk()       | å¯èƒ½ shrink heap     | âœ…ï¼ˆéå¸¸å°‘è§ï¼‰     |

---

å¦‚æœä½ æƒ³ï¼Œæˆ‘è¿˜å¯ä»¥ç”¨ `malloc_stats()`ã€`mallinfo()` æˆ– gdb ç¤ºä¾‹æ¥å±•ç¤ºè¿™äº› bin çš„å®é™…è¡Œä¸ºï¼Œä¹Ÿå¯ä»¥ç”»ä¸ªå›¾è¾…åŠ©ç†è§£ ğŸ¤ã€‚è¦ä¸è¦æˆ‘ç»§ç»­å±•å¼€ï¼Ÿ



## freeé‡Šæ”¾oså¦‚ä½•çŸ¥é“é‡Šæ”¾å¤šå°‘
ä½ çš„ç†è§£**åŸºæœ¬æ˜¯å¯¹çš„**ï¼Œä¸è¿‡æˆ‘ä»¬æ¥ç²¾ç¡®åœ°è§£é‡Šä¸€ä¸‹è¿™ä»¶äº‹ï¼š

---

 âœ… æ˜¯çš„ï¼Œ`malloc` è¿”å›çš„æŒ‡é’ˆ **å®é™…æ˜¯æŒ‡å‘ä¸€ä¸ªâ€œæ•°æ®åŒºâ€**ï¼Œè€Œè¿™ä¸ªæ•°æ®åŒºçš„å‰é¢ç¡®å®å­˜åœ¨ä¸€ä¸ª **â€œæ§åˆ¶å¤´â€/â€œå…ƒæ•°æ®â€**ï¼Œé‡Œé¢ä¿å­˜äº†ä½ è¯´çš„ã€Œç©ºé—´å¤§å°ã€ä¿¡æ¯ç­‰ã€‚

ä¸è¿‡æ³¨æ„å‡ ç‚¹ç»†èŠ‚ï¼š

---

### ğŸ”§ å®é™…çš„å†…å­˜å¸ƒå±€ï¼ˆä»¥ glibc ä¸ºä¾‹ï¼‰

å½“ä½ æ‰§è¡Œï¼š

```cpp
void* p = malloc(100);
```

å†…éƒ¨åšçš„äº‹æƒ…å¤§è‡´å¦‚ä¸‹ï¼ˆæ¦‚å¿µç¤ºæ„å›¾ï¼‰ï¼š

```
  [ chunk header | ç”¨æˆ·æ•°æ® ]
       â†‘
   p - 0x10ï¼ˆåç§»ï¼‰
       â†“
       p
```

- `chunk header`ï¼ˆå…ƒæ•°æ®ï¼‰é€šå¸¸æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œè®°å½•ï¼š
  - è¯¥å—çš„å¤§å°ï¼ˆæ¯”å¦‚ 100 + headerå¤§å° + å¯¹é½ï¼‰
  - è¯¥å—æ˜¯å¦å·²ä½¿ç”¨
  - ä¸Šä¸€ä¸ªå—æ˜¯å¦ç©ºé—²ï¼ˆæ–¹ä¾¿å¿«é€Ÿåˆå¹¶ï¼‰
- `p` å®é™…è¿”å›çš„æ˜¯ **æ•°æ®åŒºåŸŸçš„é¦–åœ°å€**ï¼Œä¹Ÿå°±æ˜¯ **`chunk` çš„èµ·å§‹åœ°å€ + header å¤§å°ï¼ˆä¾‹å¦‚ 16 å­—èŠ‚ï¼‰**
- **ä¸æ˜¯ 2B**ï¼Œè€Œæ˜¯ä¸€ä¸ªå®Œæ•´çš„ç»“æ„ï¼Œé€šå¸¸æ˜¯ 16 å­—èŠ‚æˆ– 32 å­—èŠ‚å¯¹é½çš„ï¼ˆè§†ç³»ç»Ÿå’Œå®ç°è€Œå®šï¼‰

---

#### ğŸ“Œ é‡è¦ç‚¹æ€»ç»“

| é¡¹ç›®                | å†…å®¹ |
|---------------------|------|
| å…ƒæ•°æ®é•¿åº¦          | é€šå¸¸æ˜¯ 16B æˆ–æ›´å¤šï¼ˆglibc æ˜¯ 16Bï¼‰ |
| `malloc(size)` è¿”å› | è¿”å›çš„æ˜¯æ•°æ®åŒºåŸŸçš„åœ°å€ï¼ˆå…ƒæ•°æ®ä¹‹åï¼‰ |
| `free(ptr)` å·¥ä½œåŸç† | ä¼šå‘å‰åç§»å…ƒæ•°æ®é•¿åº¦ï¼Œä»è€ŒçŸ¥é“ size |

---

#### ğŸ“‚ æºç ï¼ˆglibc ä¸­ malloc_chunkï¼‰

glibc çš„å†…éƒ¨åˆ†é…ç»“æ„ç±»ä¼¼äºï¼š

```cpp
struct malloc_chunk {
  size_t      prev_size;  // å‰ä¸€ä¸ªchunkçš„å¤§å°ï¼ˆå¦‚æœå‰ä¸€ä¸ªæ˜¯freeçš„ï¼‰
  size_t      size;       // å½“å‰chunkçš„å¤§å°ï¼ˆåŒ…å«å¤´éƒ¨å’Œæ•°æ®åŒºï¼‰
  struct malloc_chunk* fd; // æŒ‡å‘ç©ºé—²å—çš„å‰å‘æŒ‡é’ˆ
  struct malloc_chunk* bk; // æŒ‡å‘ç©ºé—²å—çš„åå‘æŒ‡é’ˆ
};
```

è¿™ä¹Ÿè§£é‡Šäº†ä¸ºä»€ä¹ˆå®é™…åˆ†é…çš„æ¯”ä½ è¯·æ±‚çš„æ›´å¤šã€‚

---

#### ğŸ¯ ä½ è¯´çš„â€œ2B | xBâ€çš„æ„æ€å¯ä»¥è¿™ä¹ˆç†è§£ï¼š

- ä½ è¯´çš„ **â€œ2Bâ€** å®é™…ä¸Šå¯¹åº”çš„æ˜¯ä¸€ä¸ª **å®Œæ•´çš„å…ƒæ•°æ®ç»“æ„**ï¼ˆä¸€èˆ¬ä¸å°‘äº16å­—èŠ‚ï¼‰ã€‚
- â€œxBâ€ æ˜¯ä½ èƒ½ç”¨çš„å†…å­˜ï¼ˆä¹Ÿå°±æ˜¯ `malloc` è¿”å›çš„æŒ‡é’ˆæŒ‡å‘è¿™é‡Œï¼‰ã€‚
- free çš„æ—¶å€™ï¼Œç³»ç»Ÿå°±æ ¹æ®è¿™å‰é¢å…ƒæ•°æ®ä¸­çš„å¤§å°ä¿¡æ¯å†³å®šå¦‚ä½•å›æ”¶ã€‚

---

éœ€è¦æˆ‘ç”¨å›¾å½¢åŠ¨ç”»æ–¹å¼å¸®ä½ å¯è§†åŒ–ä¸€ä¸‹æ•´ä¸ªè¿‡ç¨‹å—ï¼Ÿæ¯”å¦‚ä» `malloc` åˆ° `free` çš„å †ç»“æ„æ¼”å˜è¿‡ç¨‹é‚£ç§ã€‚

## os-malloc å¯¹æ¯”. tcmalloc åœ¨å†…å­˜å—ä¿¡æ¯å’Œç»„ç»‡ä¸Šçš„å·®åˆ«
è¿™æ˜¯ä¸ªå¾ˆæ£’çš„é—®é¢˜ï¼Œæ¶‰åŠæ“ä½œç³»ç»Ÿ + åˆ†é…å™¨çš„å®ç°ç»†èŠ‚ã€‚æˆ‘ä»¬æ¥è¯¦ç»†å¯¹æ¯”ä¸€ä¸‹ï¼š

---

### âœ… æ€»è§ˆï¼š`malloc`ï¼ˆglibcï¼‰ vs `tcmalloc`

| ç‰¹æ€§ | `glibc malloc` | `tcmalloc`ï¼ˆGoogle Thread-Caching Mallocï¼‰ |
|------|----------------|--------------------------------------------|
| è®¾è®¡ç›®æ ‡ | é€šç”¨æ€§ï¼Œçº¿ç¨‹å®‰å…¨ï¼Œæ€§èƒ½ä¸­ç­‰ | é«˜æ€§èƒ½ï¼Œä¼˜åŒ–å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„ malloc/free |
| ç®¡ç†æ–¹å¼ | å¤šç§ binã€arena ç®¡ç† | å¤šçº§ç¼“å­˜ï¼Œçº¿ç¨‹å±€éƒ¨ç¼“å­˜ Thread Cache |
| å…¸å‹ç”¨é€” | é€šç”¨ Linux åº”ç”¨ | é«˜æ€§èƒ½æœåŠ¡ç«¯ï¼Œå¦‚ Web æœåŠ¡å™¨ã€æ•°æ®åº“ç­‰ |

---

### ğŸ§± ä¸€ä¸ªå†…å­˜å—ï¼ˆChunk/Spanï¼‰åˆ°åº•åŒ…å«å“ªäº›ä¿¡æ¯ï¼Ÿ

#### glibc `malloc` çš„å†…å­˜å—ç»“æ„

glibc ä½¿ç”¨ `malloc_chunk` ç®¡ç†å†…å­˜å—ï¼Œç»“æ„å¤§è‡´å¦‚ä¸‹ï¼ˆç®€åŒ–ç‰ˆï¼‰ï¼š

```cpp
struct malloc_chunk {
    size_t prev_size; // å¦‚æœå‰å—ç©ºé—²ï¼Œè®°å½•å‰å—å¤§å°
    size_t size;      // å½“å‰å—å¤§å°ï¼ˆå«å¤´éƒ¨ï¼‰
    struct malloc_chunk* fd; // ç©ºé—²å—åŒå‘é“¾è¡¨
    struct malloc_chunk* bk;
    // æ•°æ®åŒºèµ·ç‚¹
};
```

- ä¸€ä¸ª `chunk` æ˜¯å †ä¸­çš„åˆ†é…å•ä½ã€‚
- ç”¨æˆ·æ‹¿åˆ°çš„æ˜¯ `chunk` çš„æ•°æ®éƒ¨åˆ†ï¼ˆheader åé¢ï¼‰ã€‚
- æ‰€æœ‰å—è¿æˆç©ºé—²é“¾è¡¨ï¼ˆbinï¼‰ã€‚

#### tcmalloc çš„å†…å­˜å—ç»“æ„

tcmalloc ä½¿ç”¨ **object span + thread cache** çš„æ¨¡å‹ï¼Œåˆ†ä¸¤ç§ç±»å‹ç®¡ç†ï¼š

##### 1. å°å¯¹è±¡ï¼ˆâ‰¤32KBï¼‰ï¼šThread Cacheï¼ˆæ¯çº¿ç¨‹ä¸€ä»½ï¼‰

```cpp
struct FreeListEntry {
    FreeListEntry* next;
};

struct ThreadCache {
    FreeListEntry* list[kMaxSizeClass]; // æ¯ä¸ªå¤§å° class ä¸€ä¸ªé“¾è¡¨
};
```

- ä¸è®°å½• sizeï¼Œä¸éœ€è¦ headerï¼
- æ¯ç±»å¤§å°ç›´æ¥æ”¾åˆ°ä¸€ä¸ª `freelist` é“¾è¡¨é‡Œï¼Œåˆ†é…/é‡Šæ”¾åªæ“ä½œæŒ‡é’ˆï¼Œéå¸¸å¿«ã€‚

##### 2. å¤§å¯¹è±¡ï¼ˆ>32KBï¼‰ï¼šPage Heap + Spanï¼ˆè·¨é¡µç®¡ç†ï¼‰

```cpp
struct Span {
    void* start;
    size_t length; // é¡µæ•°
    bool in_use;
    Span* next;
};
```

- æ¯ä¸ª span è®°å½•äº†ä¸€æ®µè¿ç»­å†…å­˜é¡µçš„çŠ¶æ€ã€‚
- tcmalloc ç”¨ `page map` è®°å½•æ¯ä¸€é¡µå±äºå“ªä¸ª spanã€‚

---

### ğŸ“¦ å†…å­˜å—æ˜¯å¦‚ä½•è¢«ç®¡ç†çš„ï¼Ÿ

#### glibc malloc ç®¡ç†æœºåˆ¶

1. å¤šä¸ª **bin** ç®¡ç†ä¸åŒå¤§å°çš„å—ï¼ˆfast binã€small binã€large binï¼‰
2. ä½¿ç”¨ `ptmalloc` å¤š arena æ”¯æŒå¹¶å‘ï¼ˆæ¯ä¸ªçº¿ç¨‹å¯èƒ½æœ‰è‡ªå·±çš„ arenaï¼‰
3. chunk å›æ”¶åæ”¾å…¥ bin ä¸­ï¼Œä¸‹æ¬¡å¤ç”¨

#### tcmalloc ç®¡ç†æœºåˆ¶

1. **Thread Cache**ï¼šæ¯ä¸ªçº¿ç¨‹ç»´æŠ¤ç‹¬ç«‹çš„ free listï¼ˆåŠ å¿«åˆ†é…ï¼‰
2. **Central Cache**ï¼šå½“ Thread Cache ä¸å¤Ÿç”¨æ—¶ä»ä¸­å¤®ç¼“å­˜å–å¯¹è±¡
3. **Page Heap**ï¼šæ‰€æœ‰å†…å­˜åˆ†é…æœ€ç»ˆæ¥è‡ª Page Heapï¼ˆç³»ç»Ÿåˆ†é…çš„é¡µï¼‰

---

### ğŸ“Š å†…å­˜æ± ä¸æ€§èƒ½å·®å¼‚

| ç‰¹æ€§ | `glibc malloc` | `tcmalloc` |
|------|----------------|------------|
| å°å¯¹è±¡å¼€é”€ | æœ‰ header å…ƒä¿¡æ¯ | æ—  headerï¼Œå‡ ä¹æ— å¼€é”€ |
| å¤šçº¿ç¨‹æ€§èƒ½ | æœ‰é”ï¼Œå¤š arena | æ— é”ï¼ŒThread Local Cache |
| å†…å­˜ç¢ç‰‡ | æ˜“ç¢ç‰‡åŒ– | class åˆ†çº§ + span åˆå¹¶æœºåˆ¶å¥½å¾ˆå¤š |
| é‡ç”¨æ•ˆç‡ | bin ä¸­æŸ¥æ‰¾åˆé€‚å— | æŒ‰ class æ‹†åˆ†å›æ”¶ï¼Œæå¿« |

---

### âœ… æ€»ç»“å¯¹æ¯”

| å†…å®¹å— | glibc malloc | tcmalloc |
|--------|--------------|----------|
| æ¯å—æ˜¯å¦å« metadata | âœ…ï¼ˆchunk headerï¼‰ | âŒï¼ˆå°å—æ— ï¼Œspan ç®¡å¤§å—ï¼‰ |
| ç®¡ç†ç­–ç•¥ | chunk + bin | span + freelist |
| å¹¶å‘åˆ†é…ä¼˜åŒ– | arena + é” | thread cache + ä¸­å¤®ç¼“å­˜ |
| é‡Šæ”¾é€»è¾‘ | å›æ”¶è‡³ binï¼Œç­‰å¾…åˆå¹¶ | å›æ”¶è‡³æœ¬åœ° freelistï¼Œè¿‡é‡å›å½’ central cache |

---

å¦‚æœä½ æƒ³â€œ**å®ç°è‡ªå·±çš„ malloc**â€ï¼Œç†è§£ tcmalloc çš„æ€è·¯éå¸¸æœ‰å‚è€ƒæ„ä¹‰ã€‚

éœ€è¦æˆ‘ç”»ä¸ªå†…å­˜ç»“æ„çš„å¯¹æ¯”å›¾å—ï¼Ÿè¿˜æ˜¯æƒ³çœ‹ glibc malloc æˆ– tcmalloc çš„æºä»£ç ç‰‡æ®µç¤ºæ„ï¼Ÿ


## è®¿é—®è¶Šç•Œæ˜¯å¦‚ä½•è¢«å‘ç°å¹¶æŠ¥é”™çš„å‘¢
è¿™ä¸ªé—®é¢˜éå¸¸æ ¸å¿ƒï¼æˆ‘ä»¬æ¥ä»”ç»†åˆ†æï¼š

---

### ğŸ§  ä½ çš„é—®é¢˜æœ¬è´¨æ˜¯ï¼š
> **åœ¨ä½¿ç”¨ glibc çš„ `malloc` åˆ†é…å†…å­˜åï¼Œè‹¥è®¿é—®äº†å·²åˆ†é…èŒƒå›´ä¹‹å¤–ä½†åœ°å€åˆæ³•ï¼Œæ˜¯å¦ä¼šæŠ¥é”™ï¼Ÿå¦‚æœæŠ¥é”™ï¼Œæ˜¯æ€ä¹ˆæ£€æµ‹åˆ°çš„ï¼Ÿ**

ä¸¾ä¸ªä¾‹å­ï¼š

```cpp
std::vector<int> arr(3);
arr[3] = 100;  // æ˜æ˜¾è¶Šç•Œ
```

ä½ æƒ³çŸ¥é“ï¼šä¸ºå•¥æœ‰æ—¶å€™æŠ¥é”™ï¼Œæœ‰æ—¶å€™ä¸æŠ¥é”™ï¼Ÿglibc çš„ `malloc` æ˜¯å¦èƒ½æ£€æµ‹åˆ°è¿™ä¸ªé”™è¯¯ï¼Ÿ

---

### ğŸš¨ **glibc çš„ malloc å¹¶ä¸èƒ½æ£€æµ‹é€»è¾‘è¶Šç•Œ**

#### ğŸ§· è¶Šç•Œä½†æ˜¯åœ°å€åˆæ³•ï¼š

- `arr(3)` åˆ†é…äº† 3 ä¸ª `int`ï¼Œç†è®ºä¸Š 12 å­—èŠ‚ã€‚
- ä½† `malloc` å†…éƒ¨ä¸ºäº†å†…å­˜å¯¹é½ã€ç®¡ç†å…ƒä¿¡æ¯ï¼Œ**å¯èƒ½å®é™…åˆ†é…äº†æ›´å¤šç©ºé—´**ï¼ˆæ¯”å¦‚ 32 å­—èŠ‚å—ï¼‰ã€‚
- æ‰€ä»¥å½“ä½ è®¿é—® `arr[3]`ï¼Œä¹Ÿå°±æ˜¯è®¿é—®ç¬¬ 4 ä¸ªå…ƒç´ ï¼Œ**å®é™…åœ°å€è¿˜åœ¨è¿™å—å†…å­˜é‡Œ**ï¼Œç³»ç»Ÿä¸ä¼šçŸ¥é“ä½ è¶Šç•Œäº†ã€‚

âœ… ç»“è®ºï¼š**è¿™ç§è®¿é—®é€šå¸¸ä¸ä¼šè§¦å‘ä»»ä½•æŠ¥é”™ï¼**

---

### âš ï¸ é‚£ä»€ä¹ˆæ—¶å€™ä¼šæŠ¥é”™å‘¢ï¼Ÿ

#### æƒ…å†µ 1ï¼š**è¶Šç•Œè®¿é—®åˆ°äº†æœªæ˜ å°„é¡µ**

- å¦‚æœä½ è¶Šç•Œè®¿é—®åˆ°äº†ä¸‹ä¸€ä¸ªé¡µè¾¹ç•Œä¹‹å¤–ï¼Œ**æ“ä½œç³»ç»Ÿå‘ç°è¯¥é¡µæœªæ˜ å°„ï¼Œå°±ä¼šè§¦å‘ `SIGSEGV`**ï¼ˆæ®µé”™è¯¯ï¼‰

#### æƒ…å†µ 2ï¼š**è¿è¡Œåº“ä½¿ç”¨æ£€æµ‹å·¥å…·æˆ–å¸¦è°ƒè¯•ä¿æŠ¤**

å¦‚ï¼š

- `glibc` çš„ `malloc` åœ¨å¼€å¯ **`MALLOC_CHECK_`** æˆ– **`MALLOC_PERTURB_`** ç¯å¢ƒå˜é‡æ—¶
- ä½¿ç”¨ **`valgrind`**ã€**`AddressSanitizer`** ç­‰å·¥å…·
- ç¼–è¯‘å™¨å¼€å¯äº† `-D_GLIBCXX_DEBUG`ï¼ˆåœ¨ä½¿ç”¨ STL æ—¶ï¼‰

è¿™äº›åœºæ™¯ä¸‹ï¼Œ**è¿è¡Œåº“ä¼šåœ¨åˆ†é…æ—¶åŠ ä¸Š guard bytesã€å¡«å……åŒºåŸŸã€é‡Šæ”¾æ£€æµ‹ç­‰æœºåˆ¶**ï¼Œèƒ½åœ¨è®¿é—®è¶Šç•Œæ—¶æ£€æµ‹å¹¶æŠ¥é”™ã€‚

---

### ğŸ’¡ STL æ˜¯æ€ä¹ˆåšåˆ°è¶Šç•Œæ£€æµ‹çš„ï¼Ÿ

æ ‡å‡† STL å®¹å™¨ï¼ˆå¦‚ `vector`ï¼‰ä¸ä¼šé»˜è®¤åšè¾¹ç•Œæ£€æŸ¥ï¼š

```cpp
std::vector<int> v(3);
v[3] = 42;     // âŒ ä¸ä¼šå´©æºƒï¼Œåªæ˜¯æœªå®šä¹‰è¡Œä¸º
v.at(3) = 42;  // âœ… ä¼šæŠ› std::out_of_range å¼‚å¸¸
```

#### `v[3]` æ˜¯çº¯è£¸è®¿é—®ï¼Œä¸æ£€æŸ¥è¾¹ç•Œã€‚
#### `v.at(3)` å†…éƒ¨è°ƒç”¨äº† `if (pos >= size()) throw` æ¥åšè¿è¡Œæ—¶æ£€æŸ¥ã€‚

---

### âœ… å¦‚ä½•æ£€æµ‹å’Œé¿å…è¿™ç§â€œæ½œåœ¨ç‚¸å¼¹â€ï¼Ÿ

#### ğŸ›  æ–¹æ³• 1ï¼šå¼€å¯ STL Debug æ¨¡å¼
```bash
g++ -D_GLIBCXX_DEBUG -g your_code.cpp
```
- ä¼šåœ¨ `v[i]` ç­‰æ“ä½œä¸­å¢åŠ è¾¹ç•Œæ£€æŸ¥ã€‚
- æ£€æµ‹åˆ°éæ³•è®¿é—®ç›´æ¥å´©æºƒå¹¶æç¤ºè¯¦ç»†ä½ç½®ã€‚

---

#### ğŸ›  æ–¹æ³• 2ï¼šä½¿ç”¨ AddressSanitizer
```bash
g++ -fsanitize=address -g your_code.cpp
./a.out
```

> ä¼šæ£€æµ‹å †æ ˆè¶Šç•Œã€use-after-freeã€heap-buffer-overflow ç­‰é—®é¢˜ï¼Œç²¾ç¡®å®šä½é”™è¯¯è¡Œå·ã€‚

---

#### ğŸ›  æ–¹æ³• 3ï¼šä½¿ç”¨ `valgrind`
```bash
valgrind ./your_program
```

è™½ç„¶æ¯” AddressSanitizer æ…¢ï¼Œä½†ä¾æ—§æ˜¯å¾ˆæœ‰æ•ˆçš„å †å†…å­˜æ£€æµ‹å·¥å…·ã€‚

---

### ğŸ” è¡¥å……ï¼šglibc malloc å†…å­˜å—ç»“æ„

glibc çš„ `malloc` å†…éƒ¨ä¼šåˆ†é…ä¸€ä¸ª **åŒ…å«å…ƒä¿¡æ¯çš„ chunk**ï¼Œå¸ƒå±€å¤§è‡´å¦‚ä¸‹ï¼š

```
[ prev_size ][ size ][ user data ...... ]
                 ^
                è¿”å›ç»™ç”¨æˆ·çš„æŒ‡é’ˆ
```

- ç”¨æˆ·è°ƒç”¨ `free()` æ—¶ï¼Œglibc ä¼šé€šè¿‡æŒ‡é’ˆå›é€€æ‰¾åˆ° `size`ã€‚
- å¦‚æœä½ è¶Šç•Œä¿®æ”¹äº†åé¢æ•°æ®ï¼Œ**glibc æ˜¯æ— æ³•çŸ¥é“çš„**ï¼Œé™¤éä½ åˆšå¥½ç ´åäº†å…ƒä¿¡æ¯ï¼Œæˆ–åœ¨ debug æ£€æµ‹æ¨¡å¼ä¸‹ã€‚

---

### ğŸ§¾ æ€»ç»“

| åœºæ™¯ | æ˜¯å¦æ£€æµ‹è¶Šç•Œ | åŸå›  |
|------|----------------|------|
| æ™®é€š `malloc` åˆ†é…ï¼Œè®¿é—®åˆæ³•åœ°å€ | âŒ ä¸æ£€æµ‹ | æ²¡æœ‰è¶Šç•Œä¿æŠ¤æœºåˆ¶ |
| è®¿é—®æœªæ˜ å°„åœ°å€ | âœ… æ“ä½œç³»ç»Ÿ SIGSEGV | é¡µè¡¨ä¿æŠ¤ |
| ä½¿ç”¨ `vector.at()` | âœ… STL è¾¹ç•Œæ£€æŸ¥ | æŠ›å¼‚å¸¸ |
| å¼€å¯ `-D_GLIBCXX_DEBUG` | âœ… STL debug æ£€æŸ¥ | å´©æºƒå¹¶æç¤º |
| ä½¿ç”¨ ASan/valgrind | âœ… å†…å­˜é”™è¯¯æ£€æµ‹ | ç²¾ç¡®æ£€æµ‹ |

---

å¦‚æœä½ æƒ³æˆ‘æ¼”ç¤ºä¸€æ®µä»£ç ï¼Œåœ¨ glibc ä¸‹è®¿é—® vector è¶Šç•Œçš„ç¤ºä¾‹æ•ˆæœï¼ˆåˆ†åˆ«æœ‰æ— æŠ¥é”™ï¼‰ï¼Œæˆ‘ä¹Ÿå¯ä»¥ç»™ä½ å†™ä¸€ä¸ª ğŸ‘‡ è¦ä¸è¦è¯•è¯•çœ‹ï¼Ÿ



## å†…å­˜å¯¹é½
### **1. ä»€ä¹ˆæ˜¯å†…å­˜å¯¹é½ï¼Ÿ**  
**å†…å­˜å¯¹é½ï¼ˆMemory Alignmentï¼‰** æ˜¯æŒ‡åœ¨è®¡ç®—æœºå†…å­˜ä¸­ï¼Œä¸ºäº†æé«˜ CPU è®¿é—®æ•°æ®çš„æ•ˆç‡ï¼Œç¼–è¯‘å™¨ä¼šæŒ‰ç…§ä¸€å®šçš„è§„åˆ™**è°ƒæ•´æ•°æ®ç»“æ„çš„å­˜å‚¨æ–¹å¼**ï¼Œä½¿å¾—æ•°æ®å­˜å‚¨åœ¨**ç‰¹å®šçš„åœ°å€è¾¹ç•Œ**ä¸Šã€‚  

#### **1.1 ä¸ºä»€ä¹ˆéœ€è¦å†…å­˜å¯¹é½ï¼Ÿ**  
- **æé«˜è®¿é—®é€Ÿåº¦**ï¼šç°ä»£ CPU è®¿é—®å†…å­˜æ—¶ï¼Œé€šå¸¸æ˜¯ä»¥ **å­—ï¼ˆwordï¼‰** æˆ– **å—ï¼ˆcache lineï¼‰** ä¸ºå•ä½ã€‚å¦‚æœæ•°æ®æœªå¯¹é½ï¼Œå¯èƒ½éœ€è¦ **å¤šæ¬¡è®¿å­˜**ï¼Œå½±å“æ€§èƒ½ã€‚  
- **ç¡¬ä»¶é™åˆ¶**ï¼šæŸäº› CPU åªèƒ½è®¿é—®å¯¹é½çš„æ•°æ®ï¼Œå¦åˆ™ä¼šå¼•å‘**æ€»çº¿é”™è¯¯ï¼ˆBus Errorï¼‰** æˆ– **æ€§èƒ½ä¸‹é™**ã€‚  
- **ä¿æŒå…¼å®¹æ€§**ï¼šä¸åŒæ¶æ„ï¼ˆå¦‚ x86 å’Œ ARMï¼‰å¯¹å†…å­˜è®¿é—®è¦æ±‚ä¸åŒï¼Œè‰¯å¥½çš„å¯¹é½å¯æé«˜è·¨å¹³å°å…¼å®¹æ€§ã€‚  

---

### **2. å†…å­˜å¯¹é½è§„åˆ™**  
#### **2.1 åŸºæœ¬æ•°æ®ç±»å‹å¯¹é½è§„åˆ™**  
ä¸åŒçš„æ•°æ®ç±»å‹åœ¨å†…å­˜ä¸­çš„**å¯¹é½æ–¹å¼**ä¾èµ–äºå…¶**å¤§å°ï¼ˆSizeï¼‰**ï¼š
| **æ•°æ®ç±»å‹** | **å¤§å°ï¼ˆBytesï¼‰** | **å¯¹é½æ–¹å¼** |
|------------|----------------|------------|
| `char`     | 1              | 1          |
| `short`    | 2              | 2          |
| `int`      | 4              | 4          |
| `float`    | 4              | 4          |
| `double`   | 8              | 8          |
| `long long` | 8             | 8          |
  
ğŸ”¹ **å¯¹é½åŸåˆ™**ï¼š  
1. **å˜é‡çš„åœ°å€å¿…é¡»æ˜¯å…¶å¤§å°çš„æ•´æ•°å€**ï¼Œå¦‚ `int` (4B) åªèƒ½å­˜æ”¾åœ¨ `0x0004, 0x0008, 0x000C...` ç­‰åœ°å€ä¸Šã€‚  
2. **ç»“æ„ä½“ä¸­çš„æ¯ä¸ªæˆå‘˜å˜é‡çš„èµ·å§‹åœ°å€å¿…é¡»æ˜¯å…¶è‡ªèº«å¤§å°çš„æ•´æ•°å€**ï¼Œå¯èƒ½ä¼šæ’å…¥**å¡«å……å­—èŠ‚ï¼ˆPaddingï¼‰**ã€‚

---

#### **2.2 ç»“æ„ä½“å¯¹é½è§„åˆ™**  
å½“ä¸€ä¸ªç»“æ„ä½“ä¸­æœ‰å¤šä¸ªæˆå‘˜å˜é‡æ—¶ï¼Œå…¶**å¯¹é½æ–¹å¼å—æœ€å¤§æˆå‘˜ç±»å‹å½±å“**ã€‚  

âœ… **ç¤ºä¾‹**
```cpp
struct A {
    char  c;   // 1 å­—èŠ‚
    int   i;   // 4 å­—èŠ‚
    short s;   // 2 å­—èŠ‚
};
```
ğŸ“Œ **å†…å­˜å¸ƒå±€**
```
| c(1B) | padding(3B) | i(4B) | s(2B) | padding(2B) |
```
ğŸ“Œ **å†…å­˜å ç”¨**
- `char` (1B) **å¿…é¡»å¯¹é½ 1B**ï¼Œæ— å¡«å……ã€‚
- `int` (4B) **å¿…é¡»å¯¹é½ 4B**ï¼Œæ‰€ä»¥ `char` ä¹‹åå¡«å…… **3B**ã€‚
- `short` (2B) **å¿…é¡»å¯¹é½ 2B**ï¼Œä½†ç”±äº `int` ç»“æŸåå·²ç»æ˜¯ `4B` å¯¹é½ï¼Œæ‰€ä»¥ä¸éœ€è¦é¢å¤–å¡«å……ã€‚
- ç»“æ„ä½“çš„ **æ€»å¤§å°å¿…é¡»æ˜¯æœ€å¤§æˆå‘˜çš„å€æ•°**ï¼Œæ‰€ä»¥éœ€è¦å¡«å…… **2B** ä½¿å…¶å˜æˆ `4B` çš„å€æ•°ã€‚

ğŸ”¹ **æœ€ç»ˆç»“æ„ä½“å¤§å°**ï¼š**12B**ï¼ˆä¸æ˜¯ `1+4+2=7B`ï¼Œå› ä¸ºå¡«å……ï¼‰

---

### **3. å½±å“å†…å­˜å¯¹é½çš„å› ç´ **
#### **3.1 ç¼–è¯‘å™¨é»˜è®¤å¯¹é½**
ä¸åŒç¼–è¯‘å™¨å¯èƒ½ä¼šæœ‰ä¸åŒçš„**é»˜è®¤å¯¹é½æ–¹å¼**ï¼Œé€šå¸¸ä¸º **æœ€å¤§æ•°æ®æˆå‘˜å¤§å°** æˆ– **å¹³å°é»˜è®¤å¯¹é½æ–¹å¼**ï¼ˆå¦‚ `x86` é»˜è®¤ 4Bï¼Œ`x64` é»˜è®¤ 8Bï¼‰ã€‚

#### **3.2 `#pragma pack(n)` æ§åˆ¶å¯¹é½**
æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ **`#pragma pack(n)`** æ¥æ‰‹åŠ¨æ§åˆ¶å¯¹é½ç²’åº¦ï¼š

âœ… **ç¤ºä¾‹**
```cpp
#pragma pack(2) // è®¾ç½®ç»“æ„ä½“æŒ‰ 2 å­—èŠ‚å¯¹é½
struct B {
    char c;  // 1B
    int i;   // 4B
    short s; // 2B
};
#pragma pack() // æ¢å¤é»˜è®¤å¯¹é½
```
ğŸ“Œ **å†…å­˜å¸ƒå±€**
```
| c(1B) | padding(1B) | i(4B) | s(2B) |
```
ğŸ”¹ **ç»“æ„ä½“å¤§å°å˜æˆ `8B`ï¼ˆæ¯”é»˜è®¤çš„ `12B` æ›´ç´§å‡‘ï¼‰**

---

### **4. å¦‚ä½•ä¼˜åŒ–ç»“æ„ä½“å¯¹é½ï¼Ÿ**
#### **4.1 è°ƒæ•´å˜é‡é¡ºåº**
âœ… **ä¼˜åŒ–å‰**
```cpp
struct C {
    char  c;  // 1B
    int   i;  // 4B
    short s;  // 2B
};  // å ç”¨ 12B
```
âœ… **ä¼˜åŒ–å**
```cpp
struct C {
    int   i;  // 4B
    short s;  // 2B
    char  c;  // 1B
};  // å ç”¨ 8B
```
ğŸ”¹ **é€šè¿‡è°ƒæ•´é¡ºåºï¼Œå‡å°‘å¡«å……ï¼ŒèŠ‚çœ 4B å†…å­˜**ã€‚

#### **4.2 ä½¿ç”¨ `#pragma pack(n)` æ§åˆ¶å¯¹é½**
åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `#pragma pack(1)` è¿›è¡Œ**ç´§å‡‘å­˜å‚¨**ï¼Œä½†å¯èƒ½ä¼šé™ä½ CPU è®¿é—®æ•ˆç‡ã€‚

---

### **5. æ€»ç»“**
1. **å†…å­˜å¯¹é½å¯ä»¥æé«˜ CPU è®¿é—®æ•ˆç‡**ï¼Œå‡å°‘è·¨å­—èŠ‚è®¿é—®å¼€é”€ã€‚  
2. **ä¸åŒæ•°æ®ç±»å‹éµå¾ªå¯¹é½è§„åˆ™**ï¼Œæˆå‘˜çš„å­˜å‚¨åœ°å€å¿…é¡»æ˜¯è‡ªèº«å¤§å°çš„æ•´æ•°å€ã€‚  
3. **ç»“æ„ä½“çš„å¯¹é½ç”±æœ€å¤§æˆå‘˜å¤§å°å†³å®š**ï¼Œå¹¶ä¸”ç¼–è¯‘å™¨ä¼šæ’å…¥**å¡«å……å­—èŠ‚ï¼ˆPaddingï¼‰** ä»¥ä¿è¯æ­£ç¡®å¯¹é½ã€‚  
4. **å¯ä»¥ä½¿ç”¨ `#pragma pack(n)` æ§åˆ¶å¯¹é½**ï¼Œä½†å¯èƒ½ä¼šå½±å“æ€§èƒ½ã€‚  
5. **é€šè¿‡è°ƒæ•´æˆå‘˜é¡ºåºå¯ä»¥å‡å°‘å¡«å……ï¼Œæé«˜ç©ºé—´åˆ©ç”¨ç‡**ã€‚  

ğŸš€ **åˆç†åˆ©ç”¨å†…å­˜å¯¹é½ï¼Œæ—¢èƒ½æé«˜è®¿é—®æ•ˆç‡ï¼Œåˆèƒ½å‡å°‘å†…å­˜æµªè´¹ï¼**


# å¤šæ€
## **C++ å¤šæ€çš„ç±»å‹**
C++ ä¸­çš„å¤šæ€ï¼ˆPolymorphismï¼‰ä¸»è¦åˆ†ä¸ºä¸¤ç±»ï¼š
1. **ç¼–è¯‘æ—¶å¤šæ€ï¼ˆé™æ€å¤šæ€ / æ—©ç»‘å®šï¼‰**
2. **è¿è¡Œæ—¶å¤šæ€ï¼ˆåŠ¨æ€å¤šæ€ / æ™šç»‘å®šï¼‰**

---

## **1. ç¼–è¯‘æ—¶å¤šæ€ï¼ˆé™æ€å¤šæ€ / æ—©ç»‘å®šï¼‰**
**ç‰¹ç‚¹ï¼š**  
- åœ¨**ç¼–è¯‘é˜¶æ®µ**å°±ç¡®å®šäº†è°ƒç”¨å“ªä¸ªå‡½æ•°ã€‚
- é€šè¿‡ **å‡½æ•°é‡è½½ã€è¿ç®—ç¬¦é‡è½½ã€æ¨¡æ¿** å®ç°ã€‚
- è¿è¡Œæ—¶æ— é¢å¤–å¼€é”€ï¼Œæ‰§è¡Œé€Ÿåº¦å¿«ã€‚

### **ï¼ˆ1ï¼‰å‡½æ•°é‡è½½ï¼ˆFunction Overloadingï¼‰**
**åŒä¸€ä¸ªä½œç”¨åŸŸ**å†…å®šä¹‰å¤šä¸ª**å‡½æ•°åç›¸åŒä½†å‚æ•°ä¸åŒ**çš„å‡½æ•°ï¼Œç¼–è¯‘å™¨æ ¹æ®å‚æ•°ç±»å‹é€‰æ‹©åˆé€‚çš„å‡½æ•°ã€‚  
**ç¤ºä¾‹ï¼š**
```cpp
#include <iostream>
using namespace std;

void print(int i) { cout << "int: " << i << endl; }
void print(double d) { cout << "double: " << d << endl; }
void print(string s) { cout << "string: " << s << endl; }

int main() {
    print(10);       // è°ƒç”¨ print(int)
    print(3.14);     // è°ƒç”¨ print(double)
    print("Hello");  // è°ƒç”¨ print(string)
    return 0;
}
```
âœ… **ä¼˜ç‚¹ï¼š** æ˜“è¯»ï¼Œé€‚ç”¨äºå‚æ•°ä¸åŒä½†é€»è¾‘ç›¸ä¼¼çš„æƒ…å†µã€‚  
âŒ **ç¼ºç‚¹ï¼š** ä¸èƒ½ç”¨äºè¿è¡Œæ—¶å†³ç­–ã€‚

---

### **ï¼ˆ2ï¼‰è¿ç®—ç¬¦é‡è½½ï¼ˆOperator Overloadingï¼‰**
å¯¹ C++ **è¿ç®—ç¬¦è¿›è¡Œè‡ªå®šä¹‰**ï¼Œä½¿å…¶é€‚ç”¨äºç”¨æˆ·è‡ªå®šä¹‰ç±»å‹ã€‚
**ç¤ºä¾‹ï¼š**
```cpp
#include <iostream>
using namespace std;

class Complex {
public:
    double real, imag;
    Complex(double r, double i) : real(r), imag(i) {}
    
    // é‡è½½ + è¿ç®—ç¬¦
    Complex operator+(const Complex& c) {
        return Complex(real + c.real, imag + c.imag);
    }

    void print() { cout << real << " + " << imag << "i" << endl; }
};

int main() {
    Complex c1(2, 3), c2(1, 4);
    Complex c3 = c1 + c2;  // ä½¿ç”¨é‡è½½çš„ + å·
    c3.print();
    return 0;
}
```
âœ… **ä¼˜ç‚¹ï¼š** ä½¿ç”¨æˆ·å®šä¹‰çš„ç±»æ›´ç›´è§‚æ˜“ç”¨ã€‚  
âŒ **ç¼ºç‚¹ï¼š** ä»£ç å¯è¯»æ€§å¯èƒ½é™ä½ï¼Œä¸é€‚ç”¨äºæ‰€æœ‰è¿ç®—ç¬¦ã€‚

---

### **ï¼ˆ3ï¼‰æ¨¡æ¿ï¼ˆTemplateï¼‰**
**æ³›å‹ç¼–ç¨‹**çš„ä¸€ç§æ–¹å¼ï¼Œä½¿åŒä¸€æ®µä»£ç é€‚ç”¨äº**å¤šç§æ•°æ®ç±»å‹**ã€‚
**ç¤ºä¾‹ï¼š**
```cpp
#include <iostream>
using namespace std;

template <typename T>
T add(T a, T b) {
    return a + b;
}

int main() {
    cout << add(3, 5) << endl;      // int
    cout << add(3.5, 2.1) << endl;  // double
    return 0;
}
```
âœ… **ä¼˜ç‚¹ï¼š** ä»£ç å¤ç”¨ï¼Œå‡å°‘é‡å¤ä»£ç ã€‚  
âŒ **ç¼ºç‚¹ï¼š** ç¼–è¯‘æ—¶é—´è¾ƒé•¿ï¼Œè°ƒè¯•å›°éš¾ã€‚

---

## **2. è¿è¡Œæ—¶å¤šæ€ï¼ˆåŠ¨æ€å¤šæ€ / æ™šç»‘å®šï¼‰**
**ç‰¹ç‚¹ï¼š**  
- åœ¨**è¿è¡Œé˜¶æ®µ**æ ¹æ®å¯¹è±¡çš„ç±»å‹**åŠ¨æ€ç»‘å®š**è°ƒç”¨çš„å‡½æ•°ã€‚
- é€šè¿‡ **ç»§æ‰¿ + è™šå‡½æ•°ï¼ˆVirtual Functionï¼‰** å®ç°ã€‚
- å­˜åœ¨**é¢å¤–çš„è¿è¡Œæ—¶å¼€é”€**ï¼ˆè™šè¡¨æŸ¥æ‰¾ï¼‰ã€‚

### **ï¼ˆ1ï¼‰è™šå‡½æ•°ï¼ˆVirtual Functionï¼‰**
åŸºç±»æä¾›**è™šå‡½æ•°**ï¼Œæ´¾ç”Ÿç±»**é‡å†™ï¼ˆoverrideï¼‰**å®ƒï¼Œå®é™…è°ƒç”¨å“ªä¸ªå‡½æ•°**å–å†³äºå¯¹è±¡çš„ç±»å‹**ï¼ˆè€ŒéæŒ‡é’ˆ/å¼•ç”¨çš„ç±»å‹ï¼‰ã€‚
**ç¤ºä¾‹ï¼š**
```cpp
#include <iostream>
using namespace std;

class Base {
public:
    virtual void show() { cout << "Base class" << endl; }
};

class Derived : public Base {
public:
    void show() override { cout << "Derived class" << endl; }
};

int main() {
    Base* b = new Derived();  // çˆ¶ç±»æŒ‡é’ˆæŒ‡å‘å­ç±»å¯¹è±¡
    b->show();  // è°ƒç”¨ Derived::show()
    delete b;
    return 0;
}
```
**è¿è¡Œç»“æœï¼š**
```
Derived class
```
âœ… **ä¼˜ç‚¹ï¼š** å…è®¸åœ¨åŸºç±»ä¸­å®šä¹‰å…¬å…±æ¥å£ï¼Œæ´¾ç”Ÿç±»æä¾›å…·ä½“å®ç°ã€‚  
âŒ **ç¼ºç‚¹ï¼š** éœ€è¦é¢å¤–çš„å†…å­˜å­˜å‚¨ **è™šè¡¨ï¼ˆvtableï¼‰**ï¼ŒæŸ¥æ‰¾è™šå‡½æ•°æ—¶æœ‰**æ€§èƒ½å¼€é”€**ã€‚

---

### **ï¼ˆ2ï¼‰çº¯è™šå‡½æ•° & æŠ½è±¡ç±»**
å¦‚æœåŸºç±»çš„æ–¹æ³•**æ— å…·ä½“å®ç°**ï¼Œåº”ä½¿ç”¨**çº¯è™šå‡½æ•°**ï¼ŒåŸºç±»ç§°ä¸º**æŠ½è±¡ç±»**ï¼š
```cpp
class Animal {
public:
    virtual void makeSound() = 0;  // çº¯è™šå‡½æ•°
};
```
å­ç±»å¿…é¡»å®ç° `makeSound()`ï¼Œå¦åˆ™å®ƒä¹Ÿæ˜¯æŠ½è±¡ç±»ã€‚

---

### **ï¼ˆ3ï¼‰åŠ¨æ€å¤šæ€çš„å®ç°åŸç†ï¼ˆè™šè¡¨ VTable æœºåˆ¶ï¼‰**
**C++ è¿è¡Œæ—¶å¤šæ€çš„å®ç°ä¾èµ–è™šè¡¨ï¼ˆVTableï¼‰ï¼š**
- **æ¯ä¸ªæœ‰è™šå‡½æ•°çš„ç±»**æœ‰ä¸€ä¸ª**è™šè¡¨ï¼ˆVirtual Tableï¼‰**ï¼Œå­˜å‚¨æŒ‡å‘è™šå‡½æ•°çš„æŒ‡é’ˆã€‚
- **æ¯ä¸ªå¯¹è±¡**æœ‰ä¸€ä¸ª**éšè—çš„ vptr æŒ‡é’ˆ**ï¼ŒæŒ‡å‘æ‰€å±ç±»çš„è™šè¡¨ã€‚
- **è°ƒç”¨è™šå‡½æ•°æ—¶**ï¼Œé€šè¿‡ `vptr` æŸ¥æ‰¾ **è™šè¡¨**ï¼Œæ‰§è¡Œç›¸åº”çš„å‡½æ•°ã€‚

**ç¤ºæ„å›¾ï¼š**
```
Base vtable:
[0] -> Base::show()

Derived vtable:
[0] -> Derived::show()
```

---

## **3. æ€»ç»“**
| ç±»å‹ | æ–¹å¼ | ç‰¹ç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|--------|
| **ç¼–è¯‘æ—¶å¤šæ€** | å‡½æ•°é‡è½½ | ç¼–è¯‘æœŸç¡®å®šï¼Œé€Ÿåº¦å¿« | ç›¸åŒåŠŸèƒ½ä½†ä¸åŒå‚æ•° |
| | è¿ç®—ç¬¦é‡è½½ | ä»£ç å¯è¯»æ€§é«˜ | è‡ªå®šä¹‰æ•°æ®ç±»å‹ |
| | æ¨¡æ¿ | ä»£ç å¤ç”¨æ€§é«˜ | æ³›å‹ç¼–ç¨‹ |
| **è¿è¡Œæ—¶å¤šæ€** | è™šå‡½æ•° | è¿è¡Œæ—¶åŠ¨æ€ç»‘å®š | éœ€è¦ç»Ÿä¸€æ¥å£ |
| | çº¯è™šå‡½æ•° | å¼ºåˆ¶å­ç±»å®ç° | æŠ½è±¡ç±» |

---

## **4. ä½•æ—¶ä½¿ç”¨å“ªç§å¤šæ€ï¼Ÿ**
âœ… **ä½¿ç”¨ç¼–è¯‘æ—¶å¤šæ€**ï¼š
- éœ€è¦**æ€§èƒ½ä¼˜å…ˆ**ï¼Œä¸éœ€è¦è¿è¡Œæ—¶åŠ¨æ€å†³ç­–ã€‚
- é€‚ç”¨äº**å°å‹ã€é€šç”¨**çš„å‡½æ•°ï¼ˆå¦‚ `add(int, int)`ï¼‰ã€‚
- é€‚ç”¨äº**è¿ç®—ç¬¦é‡è½½**ï¼ˆå¦‚ `Complex operator+`ï¼‰ã€‚
- é€‚ç”¨äº**æ¨¡æ¿ç¼–ç¨‹**ï¼Œå‡å°‘é‡å¤ä»£ç ã€‚

âœ… **ä½¿ç”¨è¿è¡Œæ—¶å¤šæ€**ï¼š
- éœ€è¦**é¢å‘å¯¹è±¡è®¾è®¡**ï¼Œæä¾›**ç»Ÿä¸€æ¥å£**ï¼ˆå¦‚ `Animal::makeSound()`ï¼‰ã€‚
- é€‚ç”¨äº**æ’ä»¶ç³»ç»Ÿã€åŠ¨æ€åŠ è½½ç±»**ï¼ˆå¦‚ GUI æ¡†æ¶ï¼‰ã€‚
- é€‚ç”¨äº**å·¥å‚æ¨¡å¼ã€ç­–ç•¥æ¨¡å¼**ç­‰è®¾è®¡æ¨¡å¼ã€‚

---

## **5. é¢å¤–ï¼šC++20 å¤šæ€çš„æ–°ç‰¹æ€§**
C++20 å¼•å…¥äº† `concepts` å’Œ `std::variant`ï¼Œæä¾›äº†ä¸€äº›æ–°çš„å¤šæ€æ–¹å¼ï¼š
- `concepts`ï¼šç”¨äº**é™åˆ¶æ¨¡æ¿å‚æ•°**ï¼Œåœ¨ç¼–è¯‘æœŸæä¾›æ›´ä¸¥æ ¼çš„æ£€æŸ¥ã€‚
- `std::variant`ï¼šå¯ä»¥ä½œä¸º**æ— ç»§æ‰¿çš„å¤šæ€æ›¿ä»£æ–¹æ¡ˆ**ï¼Œé¿å…è™šè¡¨å¼€é”€ã€‚

**ç¤ºä¾‹ï¼ˆ`concepts` æ›¿ä»£å¤šæ€ï¼‰ï¼š**
```cpp
#include <concepts>
#include <iostream>
using namespace std;

template <typename T>
concept Drawable = requires(T t) {
    { t.draw() } -> std::same_as<void>;
};

template <Drawable T>
void render(const T& shape) {
    shape.draw();
}

class Circle {
public:
    void draw() { cout << "Drawing Circle" << endl; }
};

class Square {
public:
    void draw() { cout << "Drawing Square" << endl; }
};

int main() {
    Circle c;
    Square s;
    render(c);
    render(s);
}
```

---

### **æ€»ç»“**
C++ æä¾›äº†**ç¼–è¯‘æ—¶å¤šæ€ï¼ˆé™æ€å¤šæ€ï¼‰**å’Œ**è¿è¡Œæ—¶å¤šæ€ï¼ˆåŠ¨æ€å¤šæ€ï¼‰**ï¼Œé€‚ç”¨äºä¸åŒåœºæ™¯ã€‚ç†è§£ **è™šå‡½æ•°ã€è™šè¡¨ã€æ¨¡æ¿** ç­‰ç‰¹æ€§å¯ä»¥å¸®åŠ©å†™å‡ºé«˜æ•ˆã€çµæ´»çš„ C++ ä»£ç ã€‚


# å‡½æ•°ç­¾åâ€”â€”é‡è½½çš„åˆ¤æ–­æ¡ä»¶
ä¸å¯ä»¥é‡è½½ã€‚`f(const int a)` å’Œ `f(int a)` **ä¸èƒ½é‡è½½**ï¼Œå› ä¸ºå®ƒä»¬çš„å‡½æ•°ç­¾åæ˜¯ä¸€æ ·çš„ã€‚

---

## ğŸ” åŸå› åˆ†æ

C++ ä¸­å‡½æ•°èƒ½å¦é‡è½½ï¼Œæ˜¯æ ¹æ®**å‡½æ•°ç­¾åï¼ˆfunction signatureï¼‰**æ¥åˆ¤æ–­çš„ã€‚

### âœ… å‡½æ•°ç­¾ååŒ…æ‹¬ï¼š

- å‡½æ•°å
- å‚æ•°ä¸ªæ•°
- å‚æ•°ç±»å‹ï¼ˆ**ç±»å‹æœ¬èº«ï¼Œä¸åŒ…æ‹¬ const ä¿®é¥°**ï¼‰
- å‚æ•°é¡ºåº

---

### âŒ ä¸åŒ…æ‹¬çš„å†…å®¹æœ‰ï¼š

- å‚æ•°å
- å‚æ•°çš„ const ä¿®é¥°ï¼ˆ**å€¼ä¼ é€’æ—¶**ï¼‰
- è¿”å›å€¼ç±»å‹

---

## ğŸ“Œ ä¸¾ä¸ªä¾‹å­

```cpp
void f(int a) { std::cout << "non-const\n"; }

void f(const int a) { std::cout << "const\n"; }  // âŒ ç¼–è¯‘æŠ¥é”™ï¼šå‡½æ•°é‡å®šä¹‰
```

### ğŸ§  ä¸ºä»€ä¹ˆï¼Ÿ

å› ä¸º `int` å’Œ `const int` åœ¨**å€¼ä¼ é€’**æ—¶æ²¡æœ‰åŒºåˆ«ï¼Œ`a` æ˜¯å®å‚çš„æ‹·è´ï¼Œ`const` ä¿®é¥°çš„æ˜¯è¿™ä¸ªæ‹·è´æœ¬èº«ï¼Œä¸å½±å“è°ƒç”¨æ–¹å¼ã€‚

---

## âœ… å¯ä»¥é‡è½½çš„æƒ…å†µï¼šå¼•ç”¨ä¸åŒ

```cpp
void f(int& a) { std::cout << "int&\n"; }
void f(const int& a) { std::cout << "const int&\n"; }
```

### âœ… è¿™ä¸¤ä¸ªå‡½æ•°å¯ä»¥é‡è½½ï¼

å› ä¸ºä¸€ä¸ªæ˜¯å¯¹ `int&`ï¼ˆå·¦å€¼å¯å˜å¼•ç”¨ï¼‰ï¼Œä¸€ä¸ªæ˜¯ `const int&`ï¼ˆå·¦å€¼åªè¯»å¼•ç”¨ï¼‰ï¼Œè°ƒç”¨æ—¶ä¼šæ ¹æ®ä¼ å…¥å®å‚æ˜¯å¦æ˜¯ const æ¥é€‰æ‹©ã€‚

---

## ğŸ§  æ€»ç»“

| å½¢å¼              | èƒ½å¦é‡è½½ | åŸå›                             |
|-------------------|----------|---------------------------------|
| `f(int)` vs `f(const int)` | âŒ ä¸å¯ä»¥ | ç­¾åç›¸åŒï¼Œconst ä¿®é¥°çš„æ˜¯å€¼ä¼ é€’çš„æ‹·è´ |
| `f(int&)` vs `f(const int&)` | âœ… å¯ä»¥ | å‚æ•°ç±»å‹ä¸åŒï¼šå¯å˜å¼•ç”¨ vs åªè¯»å¼•ç”¨     |

---

æœ‰éœ€è¦æˆ‘å¯ä»¥ä¸¾ä¸€ä¸ªå° demo æ¥æ¼”ç¤ºè¿è¡Œç»“æœï¼Œè¦ä¸è¦ï¼Ÿ


# RAIIé”
 **RAII é”ï¼ˆResource Acquisition Is Initializationï¼‰**
RAIIï¼ˆèµ„æºè·å–å³åˆå§‹åŒ–ï¼‰æ˜¯ä¸€ç§ C++ èµ„æºç®¡ç†æ€æƒ³ï¼Œç¡®ä¿èµ„æºåœ¨å¯¹è±¡ç”Ÿå‘½å‘¨æœŸå†…è¢«æ­£ç¡®ç®¡ç†ã€‚**RAII é”ï¼ˆRAII-based locksï¼‰** ä¸»è¦ç”¨äº**è‡ªåŠ¨ç®¡ç†çº¿ç¨‹åŒæ­¥ä¸­çš„é”**ï¼Œé¿å…**æ­»é”ã€èµ„æºæ³„éœ²**ç­‰é—®é¢˜ã€‚

---

## **ğŸ”¹ å¸¸è§ RAII é”**
### **1ï¸âƒ£ `std::lock_guard<std::mutex>`**
**ğŸ”¹ ä½œç”¨**ï¼š
- **æœ€ç®€å•çš„ RAII é”**ï¼Œç”¨äºç®¡ç† `std::mutex`ã€‚
- **ä½œç”¨åŸŸçº§åˆ«é”**ï¼Œ**å½“ `lock_guard` å¯¹è±¡é”€æ¯æ—¶ï¼Œè‡ªåŠ¨é‡Šæ”¾é”**ã€‚
- **ä¸æ”¯æŒæ‰‹åŠ¨è§£é”**ï¼Œä¸€æ—¦åˆ›å»ºå¿…é¡»ç­‰ä½œç”¨åŸŸç»“æŸæ‰èƒ½é‡Šæ”¾é”ã€‚

**âœ… ç¤ºä¾‹**
```cpp
#include <iostream>
#include <thread>
#include <mutex>

std::mutex mtx;

void print(int id) {
    std::lock_guard<std::mutex> lock(mtx);  // RAII æ–¹å¼åŠ é”
    std::cout << "Thread " << id << " is running\n";
}  // ä½œç”¨åŸŸç»“æŸï¼Œè‡ªåŠ¨è§£é”

int main() {
    std::thread t1(print, 1);
    std::thread t2(print, 2);
    t1.join();
    t2.join();
    return 0;
}
```
**ğŸ”¹ ç‰¹ç‚¹**
- **ç®€å•æ˜“ç”¨**ï¼Œé€‚ç”¨äºçŸ­ä½œç”¨åŸŸé”ã€‚
- **ä¸æ”¯æŒ `unlock()`**ï¼Œé˜²æ­¢æ‰‹åŠ¨è§£é”å¸¦æ¥çš„é”™è¯¯ã€‚

---

### **2ï¸âƒ£ `std::unique_lock<std::mutex>`**
**ğŸ”¹ ä½œç”¨**ï¼š
- **æ¯” `lock_guard` æ›´çµæ´»**ï¼Œæ”¯æŒ**æ‰‹åŠ¨è§£é”**ã€‚
- **æ”¯æŒ `try_lock()` å’Œ `defer_lock` æ¨¡å¼**ã€‚
- **é€‚ç”¨äºéœ€è¦ä¸åŒåŠ é”ç­–ç•¥çš„åœºæ™¯**ï¼ˆå¦‚é€’å½’é”ã€å¤šæ¡ä»¶å˜é‡ï¼‰ã€‚

**âœ… ç¤ºä¾‹**
```cpp
#include <iostream>
#include <thread>
#include <mutex>

std::mutex mtx;

void print(int id) {
    std::unique_lock<std::mutex> lock(mtx);  // RAII é”
    std::cout << "Thread " << id << " is running\n";
    lock.unlock();  // æ‰‹åŠ¨é‡Šæ”¾é”ï¼Œå…¶ä»–çº¿ç¨‹å¯è¿›å…¥
}  

int main() {
    std::thread t1(print, 1);
    std::thread t2(print, 2);
    t1.join();
    t2.join();
    return 0;
}
```
**ğŸ”¹ ç‰¹ç‚¹**
- **æ”¯æŒ `lock()/unlock()`**ï¼Œå¯ä»¥åœ¨ä½œç”¨åŸŸå†…æ‰‹åŠ¨è§£é”ã€‚
- **æ”¯æŒ `std::adopt_lock`ï¼Œ`std::try_to_lock`ï¼Œ`std::defer_lock` ç­‰æ¨¡å¼**ã€‚
- é€‚ç”¨äº **é”éœ€è¦æ›´å¤æ‚æ§åˆ¶çš„æƒ…å†µ**ã€‚

---

### **3ï¸âƒ£ `std::scoped_lock<std::mutex>`ï¼ˆC++17ï¼‰**
**ğŸ”¹ ä½œç”¨**ï¼š
- **C++17 å¼•å…¥çš„æ–°å‹ RAII é”**ï¼ŒåŒæ—¶é”å®š**å¤šä¸ª `mutex`**ã€‚
- **é˜²æ­¢æ­»é”**ï¼Œé‡‡ç”¨**ç»Ÿä¸€çš„ `std::lock()` æ–¹å¼åŠ é”**ã€‚

**âœ… ç¤ºä¾‹**
```cpp
#include <iostream>
#include <thread>
#include <mutex>

std::mutex mtx1, mtx2;

void print(int id) {
    std::scoped_lock lock(mtx1, mtx2);  // ä¸€æ¬¡æ€§åŠ é”å¤šä¸ªäº’æ–¥é‡
    std::cout << "Thread " << id << " is running\n";
}  

int main() {
    std::thread t1(print, 1);
    std::thread t2(print, 2);
    t1.join();
    t2.join();
    return 0;
}
```
**ğŸ”¹ ç‰¹ç‚¹**
- **å¯ä»¥åŒæ—¶åŠ é”å¤šä¸ª `mutex`**ï¼Œ**é˜²æ­¢æ­»é”**ã€‚
- **ä¸æ”¯æŒæ‰‹åŠ¨è§£é”**ï¼Œä½œç”¨åŸŸç»“æŸè‡ªåŠ¨é‡Šæ”¾ã€‚

---

### **4ï¸âƒ£ `std::shared_lock<std::shared_mutex>`ï¼ˆC++17ï¼‰**
**ğŸ”¹ ä½œç”¨**ï¼š
- **é€‚ç”¨äºè¯»å¤šå†™å°‘çš„åœºæ™¯**ã€‚
- **å…è®¸å¤šä¸ªçº¿ç¨‹å…±äº«è®¿é—®èµ„æº**ï¼ˆ**å…±äº«é”**ï¼‰ã€‚
- **å†™æ“ä½œä»ç„¶éœ€è¦ç‹¬å é”**ï¼ˆ**ç‹¬å é”**ï¼‰ã€‚

**âœ… ç¤ºä¾‹**
```cpp
#include <iostream>
#include <thread>
#include <shared_mutex>

std::shared_mutex smtx;

void readData(int id) {
    std::shared_lock lock(smtx);  // å…±äº«é”ï¼Œå¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶æŒæœ‰
    std::cout << "Reader " << id << " is reading data\n";
}

void writeData(int id) {
    std::unique_lock lock(smtx);  // ç‹¬å é”ï¼Œä¿è¯æ•°æ®å®‰å…¨
    std::cout << "Writer " << id << " is writing data\n";
}

int main() {
    std::thread r1(readData, 1);
    std::thread r2(readData, 2);
    std::thread w1(writeData, 3);

    r1.join();
    r2.join();
    w1.join();
    return 0;
}
```
**ğŸ”¹ ç‰¹ç‚¹**
- **å¤šä¸ªçº¿ç¨‹å¯åŒæ—¶è¯»å–**ï¼ˆå…±äº«é”ï¼‰ã€‚
- **å†™æ“ä½œéœ€è¦ç‹¬å é”**ï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚

---

### **ğŸ”¹ RAII é”é€‰å‹æ€»ç»“**
| é”ç±»å‹ | ä½œç”¨ | ç‰¹ç‚¹ | é€‚ç”¨åœºæ™¯ |
|--------|------|------|----------|
| `std::lock_guard` | ä½œç”¨åŸŸè‡ªåŠ¨ç®¡ç† `std::mutex` | **ç®€å•é«˜æ•ˆï¼Œä¸èƒ½ unlock()** | çŸ­ä½œç”¨åŸŸåŠ é” |
| `std::unique_lock` | å¯æ‰‹åŠ¨æ§åˆ¶ `lock/unlock` | **çµæ´»ï¼Œå¯ `try_lock()`** | éœ€è¦è§£é”ã€ç§»åŠ¨é”çš„æƒ…å†µ |
| `std::scoped_lock` (C++17) | ä¸€æ¬¡æ€§é”ä½å¤šä¸ª `mutex` | **é˜²æ­¢æ­»é”** | éœ€è¦åŒæ—¶åŠ å¤šä¸ªé” |
| `std::shared_lock` (C++17) | å…±äº« `std::shared_mutex` | **å¤šä¸ªçº¿ç¨‹å…±äº«è¯»é”** | è¯»å¤šå†™å°‘çš„åœºæ™¯ |

---

### **ğŸ”¹ ç»“è®º**
1. **æ™®é€šåŠ é”ç”¨ `std::lock_guard`ï¼Œé˜²æ­¢å¿˜è®°é‡Šæ”¾é”ã€‚**
2. **éœ€è¦æ‰‹åŠ¨æ§åˆ¶é”ï¼Œç”¨ `std::unique_lock`ã€‚**
3. **å¤šä¸ª `mutex` é¿å…æ­»é”ï¼Œç”¨ `std::scoped_lock`ï¼ˆC++17ï¼‰ã€‚**
4. **è¯»å¤šå†™å°‘çš„æƒ…å†µï¼Œç”¨ `std::shared_lock`ï¼ˆC++17ï¼‰ã€‚**

RAII é”èƒ½å¤Ÿ**é¿å…æ­»é”**ã€**ä¿è¯å¼‚å¸¸å®‰å…¨**ï¼Œæ˜¯**C++ å¤šçº¿ç¨‹å¼€å‘çš„æœ€ä½³å®è·µ**ï¼ğŸš€

## lock_guardåº•å±‚å®ç°
ä¼ å…¥ä¸€ä¸ªé”å¼•ç”¨ï¼Œåœ¨æ„é€ æ—¶è·å–é”ï¼Œææ„æ—¶é‡Šæ”¾é”
```cpp
template <class _Mutex>
class _NODISCARD lock_guard { // class with destructor that unlocks a mutex
public:
    using mutex_type = _Mutex;

    explicit lock_guard(_Mutex& _Mtx) : _MyMutex(_Mtx) { // construct and lock
        _MyMutex.lock();
    }

    lock_guard(_Mutex& _Mtx, adopt_lock_t) : _MyMutex(_Mtx) {} // construct but don't lock

    ~lock_guard() noexcept {
        _MyMutex.unlock();
    }

    lock_guard(const lock_guard&) = delete;
    lock_guard& operator=(const lock_guard&) = delete;

private:
    _Mutex& _MyMutex;
};
```

# å¼‚å¸¸å¤„ç†
## C++ å¼‚å¸¸å¤„ç†ï¼ˆException Handlingï¼‰åŸºæœ¬æ¦‚å¿µ

### **1. æ¦‚è¿°**
C++ æä¾›äº†ä¸€ç§**å¼‚å¸¸å¤„ç†æœºåˆ¶**ï¼Œç”¨äºåœ¨**è¿è¡Œæ—¶**å¤„ç†ç¨‹åºä¸­çš„**é”™è¯¯æˆ–å¼‚å¸¸æƒ…å†µ**ã€‚  
å¼‚å¸¸å¤„ç†æœºåˆ¶çš„ä¸»è¦ç›®çš„æ˜¯**æé«˜ç¨‹åºçš„å¥å£®æ€§**ï¼Œé¿å…å› é”™è¯¯å¯¼è‡´ç¨‹åºå´©æºƒã€‚  

åœ¨ C++ ä¸­ï¼Œå¼‚å¸¸å¤„ç†çš„æ ¸å¿ƒç”±ä»¥ä¸‹ä¸‰éƒ¨åˆ†ç»„æˆï¼š
1. **throw** â€”â€” æŠ›å‡ºå¼‚å¸¸  
2. **try** â€”â€” å¯èƒ½å‘ç”Ÿå¼‚å¸¸çš„ä»£ç å—  
3. **catch** â€”â€” æ•è·å¼‚å¸¸å¹¶è¿›è¡Œå¤„ç†

---

### **2. å¼‚å¸¸å¤„ç†çš„åŸºæœ¬è¯­æ³•**
```cpp
try {
    // å¯èƒ½å‘ç”Ÿå¼‚å¸¸çš„ä»£ç 
    throw å¼‚å¸¸å¯¹è±¡;
} 
catch (å¼‚å¸¸ç±»å‹ å˜é‡) {
    // å¼‚å¸¸å¤„ç†ä»£ç 
}
```

---

### **3. å¼‚å¸¸å¤„ç†ç¤ºä¾‹**
#### **ï¼ˆ1ï¼‰åŸºæœ¬ç¤ºä¾‹**
```cpp
#include <iostream>
using namespace std;

void divide(int a, int b) {
    if (b == 0)
        throw "é™¤æ•°ä¸èƒ½ä¸º0";  // æŠ›å‡ºå¼‚å¸¸
    cout << "ç»“æœ: " << a / b << endl;
}

int main() {
    try {
        divide(10, 2);
        divide(5, 0);  // è§¦å‘å¼‚å¸¸
    } 
    catch (const char* e) {  // æ•è·å¼‚å¸¸
        cout << "å¼‚å¸¸: " << e << endl;
    }

    cout << "ç¨‹åºç»§ç»­æ‰§è¡Œ..." << endl;
    return 0;
}
```
**è¾“å‡ºï¼š**
```
ç»“æœ: 5
å¼‚å¸¸: é™¤æ•°ä¸èƒ½ä¸º0
ç¨‹åºç»§ç»­æ‰§è¡Œ...
```
âœ… **ä¼˜åŠ¿ï¼š** ä»£ç ä¸ä¼šå› å¼‚å¸¸è€Œå´©æºƒï¼Œå¼‚å¸¸è¢«æ•è·åç¨‹åºç»§ç»­æ‰§è¡Œã€‚

---

#### **ï¼ˆ2ï¼‰æ•è·ä¸åŒç±»å‹çš„å¼‚å¸¸**
C++ å…è®¸æŠ›å‡ºä¸åŒç±»å‹çš„å¼‚å¸¸ï¼Œå¹¶åœ¨ `catch` è¯­å¥ä¸­åˆ†åˆ«å¤„ç†ï¼š
```cpp
#include <iostream>
using namespace std;

void test(int x) {
    if (x == 0)
        throw "é”™è¯¯ï¼šx ä¸èƒ½ä¸º 0";
    if (x < 0)
        throw x;  // æŠ›å‡ºæ•´æ•°
    if (x > 100)
        throw 3.14;  // æŠ›å‡º double ç±»å‹
}

int main() {
    try {
        test(-5);
    }
    catch (const char* e) { cout << "å­—ç¬¦ä¸²å¼‚å¸¸: " << e << endl; }
    catch (int e) { cout << "æ•´æ•°å¼‚å¸¸: " << e << endl; }
    catch (double e) { cout << "æµ®ç‚¹æ•°å¼‚å¸¸: " << e << endl; }
    return 0;
}
```
âœ… **C++ æ”¯æŒæŠ›å‡ºä¸åŒç±»å‹çš„å¼‚å¸¸ï¼Œcatch è¯­å¥å¯ä»¥åŒ¹é…å…·ä½“çš„å¼‚å¸¸ç±»å‹è¿›è¡Œå¤„ç†ã€‚**

---

#### **ï¼ˆ3ï¼‰ä½¿ç”¨ `catch(...)` æ•è·æ‰€æœ‰å¼‚å¸¸**
å¦‚æœä¸ç¡®å®šå¼‚å¸¸çš„ç±»å‹ï¼Œå¯ä»¥ä½¿ç”¨ `catch(...)` æ•è·æ‰€æœ‰å¼‚å¸¸ï¼š
```cpp
try {
    throw 42;  // æŠ›å‡ºæ•´æ•°å¼‚å¸¸
}
catch (...) {
    cout << "æ•è·åˆ°å¼‚å¸¸ï¼Œä½†æœªçŸ¥ç±»å‹ï¼" << endl;
}
```
âœ… **`catch(...)` æ˜¯å…œåº•æ–¹æ¡ˆï¼Œé€‚ç”¨äºæ— æ³•é¢„çŸ¥å¼‚å¸¸ç±»å‹çš„æƒ…å†µã€‚**

---

### **4. C++ æ ‡å‡†å¼‚å¸¸ï¼ˆ`std::exception`ï¼‰**
C++ æä¾›äº†æ ‡å‡†å¼‚å¸¸ç±» `std::exception`ï¼Œä»¥åŠå¤šä¸ªæ´¾ç”Ÿç±»ï¼š
| å¼‚å¸¸ç±» | è¯´æ˜ |
|--------|------|
| `std::exception` | æ‰€æœ‰å¼‚å¸¸çš„åŸºç±» |
| `std::bad_alloc` | å†…å­˜åˆ†é…å¤±è´¥ï¼ˆ`new` å¤±è´¥ï¼‰ |
| `std::out_of_range` | å®¹å™¨è®¿é—®è¶Šç•Œ |
| `std::runtime_error` | è¿è¡Œæ—¶é”™è¯¯ |
| `std::logic_error` | é€»è¾‘é”™è¯¯ |
| `std::invalid_argument` | å‚æ•°æ— æ•ˆ |

#### **ï¼ˆ1ï¼‰ä½¿ç”¨ `std::exception` å¤„ç†å¼‚å¸¸**
```cpp
#include <iostream>
#include <exception>
using namespace std;

void test() {
    throw runtime_error("è¿è¡Œæ—¶é”™è¯¯");
}

int main() {
    try {
        test();
    }
    catch (const exception& e) {  // æ•è·æ ‡å‡†å¼‚å¸¸
        cout << "æ ‡å‡†å¼‚å¸¸: " << e.what() << endl;
    }
    return 0;
}
```
âœ… **`e.what()` è¿”å›å¼‚å¸¸ä¿¡æ¯ï¼Œå¯ç”¨äºè°ƒè¯•ã€‚**

---

### **5. æ„é€ å‡½æ•°å’Œææ„å‡½æ•°ä¸­çš„å¼‚å¸¸**
#### **ï¼ˆ1ï¼‰æ„é€ å‡½æ•°æŠ›å‡ºå¼‚å¸¸**
å¦‚æœæ„é€ å‡½æ•°å¤±è´¥ï¼Œåº”è¯¥**æŠ›å‡ºå¼‚å¸¸**ï¼Œä»¥é˜²æ­¢åˆ›å»º**ä¸å®Œæ•´å¯¹è±¡**ï¼š
```cpp
#include <iostream>
#include <stdexcept>
using namespace std;

class Test {
public:
    Test() {
        throw runtime_error("æ„é€ å‡½æ•°å¤±è´¥ï¼");
    }
};

int main() {
    try {
        Test obj;
    }
    catch (const exception& e) {
        cout << "æ•è·å¼‚å¸¸: " << e.what() << endl;
    }
}
```

#### **ï¼ˆ2ï¼‰ææ„å‡½æ•°ä¸èƒ½æŠ›å‡ºå¼‚å¸¸**
ææ„å‡½æ•°å¦‚æœæŠ›å‡ºå¼‚å¸¸ï¼Œä¼šå¯¼è‡´**ç¨‹åºç»ˆæ­¢**ï¼Œå› æ­¤å»ºè®®åœ¨ææ„å‡½æ•°ä¸­**æ•è·æ‰€æœ‰å¼‚å¸¸**ï¼š
```cpp
class Test {
public:
    ~Test() {
        try {
            throw runtime_error("ææ„å¼‚å¸¸ï¼");
        }
        catch (...) {
            cout << "ææ„å¼‚å¸¸è¢«æ•è·ï¼" << endl;
        }
    }
};
```

---

### **6. `noexcept` å…³é”®å­—**
C++11 å¼•å…¥ `noexcept`ï¼Œç”¨äº**å£°æ˜æŸä¸ªå‡½æ•°ä¸ä¼šæŠ›å‡ºå¼‚å¸¸**ï¼š
```cpp
void func() noexcept {  // ç¡®ä¿æ­¤å‡½æ•°ä¸ä¼šæŠ›å‡ºå¼‚å¸¸
    cout << "å®‰å…¨å‡½æ•°" << endl;
}
```
âœ… **`noexcept` ä¼˜åŒ–ä»£ç æ€§èƒ½ï¼Œæé«˜ç¼–è¯‘å™¨ä¼˜åŒ–èƒ½åŠ›ã€‚**

---

### **7. å¼‚å¸¸ vs. é”™è¯¯ä»£ç **
| æ–¹å¼ | é€‚ç”¨åœºæ™¯ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|--------|------|------|
| **å¼‚å¸¸ï¼ˆExceptionï¼‰** | **ä¸å¯é¢„æµ‹çš„é”™è¯¯**ï¼ˆå¦‚å†…å­˜ä¸è¶³ã€æ–‡ä»¶ä¸å­˜åœ¨ï¼‰ | ä»£ç æ¸…æ™°ï¼Œå¯è‡ªåŠ¨ä¼ æ’­ | å½±å“æ€§èƒ½ |
| **é”™è¯¯ä»£ç ï¼ˆError Codeï¼‰** | **å¯é¢„è§çš„é”™è¯¯**ï¼ˆå¦‚ `open()` å¤±è´¥ï¼‰ | å¼€é”€å°ï¼Œé¿å…å¼‚å¸¸æœºåˆ¶ | éœ€è¦æ‰‹åŠ¨æ£€æŸ¥ |

**ç¤ºä¾‹ï¼š**
```cpp
int divide(int a, int b, int& result) {
    if (b == 0) return -1;  // è¿”å›é”™è¯¯ç 
    result = a / b;
    return 0;
}
```
âœ… **é”™è¯¯ç é€‚ç”¨äºæ€§èƒ½è¦æ±‚é«˜çš„ä»£ç ï¼ˆå¦‚åµŒå…¥å¼ç³»ç»Ÿï¼‰ã€‚**

---

### **8. ç»“è®º**
- **C++ å¼‚å¸¸å¤„ç†æœºåˆ¶** æä¾›äº† `try-catch-throw` è¯­æ³•ï¼Œå¯ç”¨äºå¤„ç†**è¿è¡Œæ—¶é”™è¯¯**ã€‚
- **æ ‡å‡†å¼‚å¸¸ç±»**ï¼ˆå¦‚ `std::exception`ï¼‰å¯ä»¥ç”¨äº**æ•è·å¸¸è§å¼‚å¸¸**ï¼Œæé«˜ä»£ç å¥å£®æ€§ã€‚
- **ææ„å‡½æ•°** ä¸èƒ½æŠ›å‡ºå¼‚å¸¸ï¼Œåº”ä½¿ç”¨ `catch(...)` æ•è·æ‰€æœ‰å¼‚å¸¸ã€‚
- **C++11 å¼•å…¥ `noexcept`**ï¼Œæé«˜æ€§èƒ½ï¼Œé€‚ç”¨äº**ä¸åº”æŠ›å‡ºå¼‚å¸¸çš„å‡½æ•°**ã€‚
- **å¼‚å¸¸ vs. é”™è¯¯ç **ï¼šå¼‚å¸¸é€‚ç”¨äº**ä¸å¯é¢„æµ‹çš„é”™è¯¯**ï¼Œé”™è¯¯ç é€‚ç”¨äº**å¯é¢„è§çš„é”™è¯¯**ã€‚

**ğŸ‘‰ C++ å¼‚å¸¸æœºåˆ¶é€‚ç”¨äºå…³é”®ä»£ç ï¼Œä½†åœ¨æ€§èƒ½æ•æ„Ÿçš„åœºæ™¯ï¼ˆå¦‚é«˜é¢‘è°ƒç”¨ï¼‰åº”è°¨æ…ä½¿ç”¨ï¼**

## try catchçš„åº•å±‚åŸç†
C++ çš„ `try-catch` å¼‚å¸¸å¤„ç†æœºåˆ¶çœ‹èµ·æ¥ç®€å•ï¼Œä½†åº•å±‚å®ç°éå¸¸å¤æ‚ã€‚ä¸‹é¢æˆ‘ä»¬ä» **ç¼–è¯‘å™¨æ”¯æŒ**ã€**æ ˆå±•å¼€**ã€**å¼‚å¸¸è¡¨æœºåˆ¶** ç­‰è§’åº¦ï¼Œæ·±å…¥è®²è§£å…¶åŸç†ã€‚

---

### ğŸ”§ **1. å¼‚å¸¸å¤„ç†çš„åŸºæœ¬æµç¨‹**

å½“ç¨‹åºæ‰§è¡Œåˆ° `throw` æŠ›å‡ºå¼‚å¸¸æ—¶ï¼ŒC++ ä¼šæ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š

1. **æŠ›å‡ºå¼‚å¸¸ (`throw`)ï¼š**
   - æ„é€ å¼‚å¸¸å¯¹è±¡ï¼ˆé€šå¸¸æ˜¯æ‹·è´æˆ–ç§»åŠ¨æ„é€ ï¼‰ï¼Œå¹¶è®°å½•ç±»å‹ä¿¡æ¯ã€‚
   - æŸ¥æ‰¾å½“å‰è°ƒç”¨æ ˆä¸Šæ˜¯å¦æœ‰åŒ¹é…çš„ `catch` å—ã€‚
   - å¦‚æœæ‰¾åˆ°äº†ï¼Œæ‰§è¡Œâ€œæ ˆå±•å¼€â€ï¼Œé‡Šæ”¾ä¸­é—´å‡½æ•°è°ƒç”¨æ ˆä¸Šçš„å±€éƒ¨å˜é‡ã€‚

2. **æ ˆå±•å¼€ï¼ˆStack Unwindingï¼‰ï¼š**
   - ç¼–è¯‘å™¨åœ¨å‡½æ•°ä¸­æ’å…¥â€œæ¸…ç†ä»£ç â€ï¼ˆdestructors, `finally` ç­‰ç­‰ï¼‰ä»¥ç¡®ä¿ç¦»å¼€ä½œç”¨åŸŸæ—¶èµ„æºèƒ½æ­£å¸¸é‡Šæ”¾ã€‚
   - é€å±‚è°ƒç”¨å¯¹è±¡ææ„å‡½æ•°ã€‚

3. **åŒ¹é…å¤„ç†å™¨ (`catch`)ï¼š**
   - åŠ¨æ€ç±»å‹æ£€æŸ¥ï¼šåŒ¹é…ç±»å‹ï¼ˆæ”¯æŒå­ç±»ä¸å¼•ç”¨çš„æ•è·ï¼‰ã€‚
   - ä¸€æ—¦åŒ¹é…ï¼Œè·³è½¬åˆ°å¯¹åº”çš„ `catch` è¯­å¥å—æ‰§è¡Œã€‚

---

### ğŸ§  **2. åŠ¨æ€æ•è·çš„å…³é”®ï¼šè¿è¡Œæ—¶ç±»å‹ä¿¡æ¯ + å¼‚å¸¸è¡¨**

#### ğŸ”¸ a. **è¿è¡Œæ—¶ç±»å‹ä¿¡æ¯ï¼ˆRTTIï¼‰**
æ¯ä¸ªå¼‚å¸¸å¯¹è±¡åœ¨æŠ›å‡ºæ—¶ä¼šæºå¸¦ç±»å‹ä¿¡æ¯ï¼Œç¼–è¯‘å™¨ä½¿ç”¨ RTTI æ¥åˆ¤æ–­å“ªä¸ª `catch` èƒ½å¤„ç†å½“å‰å¼‚å¸¸ï¼ˆåŒ…æ‹¬ç»§æ‰¿ä½“ç³»ï¼‰ã€‚

#### ğŸ”¸ b. **å¼‚å¸¸è¡¨ï¼ˆä¸æ˜¯ç”¨ `goto` å®ç°çš„ï¼‰**
ä¸åŒäº C è¯­è¨€çš„ `setjmp/longjmp`ï¼ŒC++ ä½¿ç”¨ **å¼‚å¸¸å¤„ç†è¡¨**ï¼ˆException Handling Tableï¼‰ï¼š

- ç¼–è¯‘å™¨åœ¨æ¯ä¸ªå‡½æ•°ä¸­è®°å½•å“ªäº›ä»£ç å—å±äº `try`ã€‚
- åŒæ—¶è®°å½•å¯¹åº”çš„ `catch` å¤„ç†å™¨ã€‚
- è¿™äº›è¡¨é€šå¸¸åœ¨å¯æ‰§è¡Œæ–‡ä»¶çš„ `.eh_frame`ã€`.gcc_except_table`ï¼ˆGCCï¼‰æˆ– `.pdata`ï¼ˆMSVCï¼‰æ®µä¸­ã€‚

**ä¼˜ç‚¹ï¼š**
- æ— éœ€æ¯æ¬¡è¿›å…¥å‡½æ•°éƒ½å¼€é”€ï¼ˆå¦‚ä¿å­˜æ ˆä¸Šä¸‹æ–‡ï¼‰ï¼Œæ€§èƒ½å¥½ã€‚
- æ”¯æŒå¤æ‚çš„æ§åˆ¶æµä¸æ„é€ å‡½æ•°ææ„å‡½æ•°çš„è‡ªåŠ¨è°ƒç”¨ã€‚

---

### ğŸ—ï¸ **3. æ ˆå±•å¼€æ˜¯æ€ä¹ˆåšçš„ï¼Ÿ**

å½“å¼‚å¸¸æŠ›å‡ºåï¼ŒC++ ä½¿ç”¨â€œæ ˆå±•å¼€å™¨â€ï¼ˆstack unwinderï¼‰ä»å½“å‰å‡½æ•°ä¸€å±‚å±‚â€œé€€æ ˆâ€ï¼š

- æ£€æŸ¥æ¯å±‚å‡½æ•°æ˜¯å¦æœ‰å¯¹åº”çš„ `catch`ã€‚
- å¦‚æœæ²¡æœ‰å°±è°ƒç”¨è¯¥å±‚æ‰€æœ‰å±€éƒ¨å¯¹è±¡çš„ææ„å‡½æ•°ã€‚
- ç›´åˆ°æ‰¾åˆ°åŒ¹é…çš„ `catch`ï¼Œæˆ–è€…åˆ°è¾¾ `main()`ï¼Œå¼‚å¸¸æœªè¢«å¤„ç†ï¼Œè°ƒç”¨ `std::terminate()`ã€‚

> é€šå¸¸ä¾èµ–å¹³å° ABI å®ç°ï¼Œæ¯”å¦‚ï¼š
> - **Itanium ABIï¼ˆGCC/Clangï¼‰**
> - **SEHï¼ˆç»“æ„åŒ–å¼‚å¸¸å¤„ç†ï¼ŒWindowsï¼‰**

---

### ğŸ” **4. C++ å¼‚å¸¸å¤„ç†çš„åº•å±‚æ€§èƒ½ä¸å½±å“**

- **æ­£å¸¸è·¯å¾„æ— æ€§èƒ½å¼€é”€**ï¼šå¼‚å¸¸å¤„ç†çš„æŒ‡ä»¤ä¸åœ¨ä¸»æ‰§è¡Œè·¯å¾„ä¸Šï¼Œä¸å½±å“æ€§èƒ½ï¼ˆä¸åƒ Java çš„ `try-catch` ä¼šæ’å…¥é¢å¤–è·³è½¬ï¼‰ã€‚
- **å¼‚å¸¸è·¯å¾„ä»£ä»·é«˜**ï¼šæ ˆå±•å¼€ + æŸ¥æ‰¾ + æ„é€ /ææ„å¼‚å¸¸å¯¹è±¡ã€‚
- **ä¸å»ºè®®åœ¨æ€§èƒ½å…³é”®è·¯å¾„é¢‘ç¹ä½¿ç”¨å¼‚å¸¸**ã€‚

---

### ğŸ“Œ **æ€»ç»“**

| ç»„æˆéƒ¨åˆ†           | åŸç†                                                     |
|--------------------|----------------------------------------------------------|
| `throw`            | æ„é€ å¼‚å¸¸å¯¹è±¡ + è®°å½•ç±»å‹ä¿¡æ¯                              |
| å¼‚å¸¸è¡¨             | ç¼–è¯‘å™¨æ„é€ çš„ `.eh_frame` æˆ– `.gcc_except_table`           |
| æ ˆå±•å¼€             | è°ƒç”¨å¯¹è±¡ææ„å‡½æ•°ï¼ŒæŒ‰æ ˆå±‚å±‚é€€å›ï¼Œç›´åˆ°æ‰¾åˆ° `catch`        |
| åŠ¨æ€åŒ¹é… `catch`   | åˆ©ç”¨ RTTI åˆ¤æ–­æ˜¯å¦ç±»å‹å…¼å®¹                               |
| å¹³å°æ”¯æŒ           | Itanium ABIï¼ˆLinuxï¼‰ã€SEHï¼ˆWindowsï¼‰                    |

å¦‚æœä½ æƒ³çœ‹æ±‡ç¼–æˆ–ä¸­é—´ä»£ç æ¼”ç¤ºåº•å±‚æµç¨‹ï¼Œæˆ‘ä¹Ÿå¯ä»¥å¸¦ä½ ä¸€æ­¥æ­¥åˆ†æ ğŸ‘‡ï¼ˆæ¯”å¦‚ä½¿ç”¨ `g++ -fno-exceptions`, `gdb`, `objdump` ç­‰ï¼‰ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ


## ä»€ä¹ˆæ˜¯æ ˆå±•å¼€(é€€æ ˆ+æ¸…ç†)
### âœ… ä»€ä¹ˆæ˜¯â€œæ ˆå±•å¼€ï¼ˆStack Unwindingï¼‰â€

**æ ˆå±•å¼€**æ˜¯ C++ å¼‚å¸¸å¤„ç†æœºåˆ¶ä¸­çš„æ ¸å¿ƒæ­¥éª¤ä¹‹ä¸€ã€‚ç®€å•æ¥è¯´ï¼š

> **å½“æŠ›å‡ºå¼‚å¸¸æ—¶ï¼Œç¨‹åºä¼šä»å½“å‰æ‰§è¡Œç‚¹ä¾æ¬¡â€œé€€å›â€è°ƒç”¨æ ˆä¸Šçš„å‡½æ•°å¸§ï¼Œå¹¶ä¾æ¬¡è°ƒç”¨å®ƒä»¬ä¸­å±€éƒ¨å¯¹è±¡çš„ææ„å‡½æ•°ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªåŒ¹é…çš„ `catch` å—ã€‚**

---

### ğŸ” æ ˆå±•å¼€ä¸ºä»€ä¹ˆå­˜åœ¨ï¼Ÿ

åœ¨ C++ ä¸­ï¼Œæˆ‘ä»¬å¤§é‡ä½¿ç”¨ RAIIï¼ˆæ¯”å¦‚ `std::lock_guard`, `std::unique_ptr` ç­‰ï¼‰ã€‚ä¸ºäº†ä¿è¯å¼‚å¸¸æŠ›å‡ºåï¼Œ**èµ„æºèƒ½å¤Ÿè¢«æ­£ç¡®é‡Šæ”¾**ï¼Œå°±éœ€è¦åœ¨å¼‚å¸¸ä¼ é€’è¿‡ç¨‹ä¸­é€å±‚è°ƒç”¨ææ„å‡½æ•°ã€‚

---

### ğŸ§± æ ˆå±•å¼€å‘ç”Ÿæ—¶åšäº†å“ªäº›äº‹ï¼Ÿ

å½“ä½ å†™ä¸‹è¿™æ®µä»£ç ï¼š

```cpp
void funcA() {
    std::string s = "hello";
    throw std::runtime_error("error");
}

void funcB() {
    funcA();
}

int main() {
    try {
        funcB();
    } catch (const std::exception& e) {
        std::cout << e.what() << std::endl;
    }
}
```

å‘ç”Ÿäº†ä»€ä¹ˆï¼š

1. `funcA` ä¸­æŠ›å‡ºå¼‚å¸¸ï¼›
2. ç¼–è¯‘å™¨ä¼šï¼š
   - **é”€æ¯ `funcA` ä¸­çš„æ‰€æœ‰å±€éƒ¨å˜é‡ï¼ˆè°ƒç”¨ææ„å‡½æ•°ï¼‰**
   - é€€å›åˆ° `funcB`ï¼Œç»§ç»­å±•å¼€æ ˆ
   - å¦‚æœ `funcB` ä¸­ä¹Ÿæœ‰å±€éƒ¨å˜é‡ï¼ŒåŒæ ·ææ„å®ƒä»¬
3. æœ€ç»ˆæ‰¾åˆ°äº† `main` ä¸­çš„ `catch`ï¼Œæ‰â€œåœæ­¢â€æ ˆå±•å¼€ï¼Œè¿›å…¥å¼‚å¸¸å¤„ç†å—

---

### ğŸ¯ å°ç»“ï¼šæ ˆå±•å¼€çš„ä½œç”¨

| ä½œç”¨                            | è¯´æ˜ |
|----------------------------------|------|
| é”€æ¯å±€éƒ¨å¯¹è±¡                     | ä¿è¯èµ„æºé‡Šæ”¾ï¼ˆå¦‚ RAIIï¼‰ |
| æŸ¥æ‰¾åŒ¹é…çš„å¼‚å¸¸å¤„ç†å™¨ï¼ˆcatchï¼‰    | æ‰¾åˆ°å¹¶è·³è½¬æ‰§è¡Œ |
| æ¸…ç†ç°åœº                         | ç¡®ä¿ç¨‹åºè¡Œä¸ºä¸€è‡´æ€§ |

---

### ğŸ“Œ æ³¨æ„äº‹é¡¹

- å¦‚æœåœ¨æ ˆå±•å¼€è¿‡ç¨‹ä¸­å†æ¬¡æŠ›å‡ºå¼‚å¸¸ï¼ˆæ¯”å¦‚ææ„å‡½æ•°ä¸­æŠ›å‡ºå¼‚å¸¸ï¼‰ï¼Œ**ç¨‹åºä¼šç»ˆæ­¢ï¼ˆ`std::terminate()`ï¼‰**ï¼›
- ææ„å‡½æ•°ä¸åº”æŠ›å‡ºå¼‚å¸¸ï¼›
- ä¸å…è®¸æ ˆå±•å¼€ç©¿è¶Š `extern "C"` å‡½æ•°æˆ–æŸäº›ç³»ç»Ÿè¾¹ç•Œã€‚

---

å¦‚æœä½ æ„Ÿå…´è¶£ï¼Œæˆ‘å¯ä»¥ç”¨ `g++ -S` ç”Ÿæˆæ±‡ç¼–æˆ–ä½¿ç”¨ `gdb` å¸¦ä½ è§‚å¯Ÿæ ˆå±•å¼€çš„ç°åœº ğŸ”§ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ


# inlineåŠå…¶å¼€é”€
## inlineä»‹ç»
### **å†…è”å‡½æ•°ï¼ˆInline Functionï¼‰ä¸å¼€é”€åˆ†æ**

#### **1. ä»€ä¹ˆæ˜¯å†…è”å‡½æ•°ï¼Ÿ**
å†…è”å‡½æ•°ï¼ˆ`inline`ï¼‰æ˜¯ä¸€ç§ç‰¹æ®Šçš„å‡½æ•°ï¼Œå®ƒçš„**å‡½æ•°è°ƒç”¨**è¢«**æ›¿æ¢ä¸ºå‡½æ•°ä½“**ï¼Œä»è€Œé¿å…äº†**å‡½æ•°è°ƒç”¨çš„é¢å¤–å¼€é”€**ï¼ˆå¦‚å‹æ ˆã€è·³è½¬ç­‰ï¼‰ã€‚  
**å®šä¹‰æ–¹æ³•**ï¼š
```cpp
inline int add(int a, int b) {
    return a + b;
}
```
åœ¨ç¼–è¯‘æ—¶ï¼Œç¼–è¯‘å™¨ä¼šå°† `add(2,3)` æ›¿æ¢ä¸º `2 + 3`ï¼Œé¿å…å‡½æ•°è°ƒç”¨çš„é¢å¤–å¼€é”€ã€‚

---

#### **2. å†…è”å‡½æ•°çš„ä¼˜åŠ¿**
1. **å‡å°‘å‡½æ•°è°ƒç”¨å¼€é”€**ï¼š
   - æ™®é€šå‡½æ•°è°ƒç”¨éœ€è¦è¿›è¡Œ**å‹æ ˆã€è·³è½¬ã€è¿”å›**ç­‰æ“ä½œï¼Œå­˜åœ¨é¢å¤–çš„ CPU å¼€é”€ã€‚
   - å†…è”å‡½æ•°ä¼šç›´æ¥æ›¿æ¢åˆ°è°ƒç”¨å¤„ï¼Œé¿å…äº†è¿™äº›æ“ä½œï¼Œæé«˜æ‰§è¡Œæ•ˆç‡ã€‚

2. **é€‚ç”¨äºçŸ­å°çš„å‡½æ•°**ï¼š
   - é€‚ç”¨äºé‚£äº›æ‰§è¡Œä»£ç å°‘ã€é¢‘ç¹è°ƒç”¨çš„å‡½æ•°ï¼Œå¦‚**getter/setterã€æ•°å­¦è¿ç®—**ç­‰ã€‚

3. **æé«˜ä»£ç å¯è¯»æ€§**ï¼š
   - å¯ä»¥ç”¨å‡½æ•°å°è£…é€»è¾‘ï¼Œè€Œä¸ç”¨æ‹…å¿ƒé¢å¤–çš„è°ƒç”¨å¼€é”€ã€‚

---

#### **3. å†…è”å‡½æ•°çš„å¼€é”€**
è™½ç„¶å†…è”å‡½æ•°å¯ä»¥å‡å°‘è°ƒç”¨å¼€é”€ï¼Œä½†å®ƒä¹Ÿæœ‰**æ½œåœ¨çš„æˆæœ¬**ï¼š

1. **å¢åŠ ä»£ç ä½“ç§¯ï¼ˆä»£ç è†¨èƒ€ï¼‰**ï¼š
   - **æ¯æ¬¡è°ƒç”¨éƒ½å¤åˆ¶ä¸€éå‡½æ•°ä½“**ï¼Œå¯¼è‡´**å¯æ‰§è¡Œæ–‡ä»¶ä½“ç§¯å¢å¤§**ï¼Œå¯èƒ½å½±å“ CPU **æŒ‡ä»¤ç¼“å­˜ï¼ˆI-Cacheï¼‰**çš„æ€§èƒ½ã€‚
   - ç‰¹åˆ«æ˜¯**å‡½æ•°ä½“è¾ƒå¤§**æ—¶ï¼Œå†…è”å¯èƒ½å¯¼è‡´ç¨‹åºè†¨èƒ€ï¼Œé™ä½ CPU æŒ‡ä»¤ç¼“å­˜å‘½ä¸­ç‡ï¼Œåè€Œå½±å“æ€§èƒ½ã€‚

2. **å¢åŠ ç¼–è¯‘æ—¶é—´**ï¼š
   - ç”±äºç¼–è¯‘å™¨éœ€è¦åœ¨è°ƒç”¨å¤„å±•å¼€å‡½æ•°ä»£ç ï¼Œå¯èƒ½ä¼šå¢åŠ ç¼–è¯‘æ—¶é—´ã€‚

3. **ä¸é€‚ç”¨äºé€’å½’å‡½æ•°**ï¼š
   - é€’å½’å‡½æ•°**æ— æ³•å®Œå…¨å±•å¼€**ï¼Œç¼–è¯‘å™¨é€šå¸¸ä¸ä¼šè‡ªåŠ¨å°†é€’å½’å‡½æ•°å†…è”ã€‚

4. **å¯èƒ½å¯¼è‡´ä¼˜åŒ–å¤±æ•ˆ**ï¼š
   - ä¸€äº›ä¼˜åŒ–ï¼ˆå¦‚å‡½æ•°åˆ†æ”¯é¢„æµ‹ï¼‰åœ¨éå†…è”æ—¶å¯èƒ½ä¼šæ‰§è¡Œå¾—æ›´å¥½ï¼Œè€Œå†…è”åå¯èƒ½ç ´åä¼˜åŒ–ç­–ç•¥ã€‚

---

#### **4. ä½•æ—¶ä½¿ç”¨å†…è”å‡½æ•°ï¼Ÿ**
é€‚ç”¨äºï¼š
âœ… **çŸ­å°çš„ã€æ‰§è¡Œé¢‘ç¹çš„å‡½æ•°**ï¼ˆå¦‚ `getter/setter`ï¼‰ã€‚
âœ… **é€»è¾‘ç®€å•çš„æ•°å­¦è¿ç®—**ï¼ˆå¦‚ `add`, `mul` ç­‰ï¼‰ã€‚
âœ… **C++ ç±»çš„æˆå‘˜å‡½æ•°ï¼ˆé»˜è®¤ä¼šå†…è”ï¼‰**ã€‚

ä¸é€‚ç”¨äºï¼š
âŒ **å¤æ‚çš„å¤§å‹å‡½æ•°**ï¼ˆä»£ç è†¨èƒ€ï¼‰ã€‚  
âŒ **é€’å½’å‡½æ•°**ï¼ˆæ— æ³•å®Œå…¨å±•å¼€ï¼‰ã€‚  
âŒ **è™šå‡½æ•°ï¼ˆåŠ¨æ€ç»‘å®šï¼‰**ï¼ˆæ— æ³•ç¡®å®šæœ€ç»ˆè°ƒç”¨å¯¹è±¡ï¼‰ã€‚

---

#### **5. ç¤ºä¾‹ï¼šæ™®é€šå‡½æ•° VS å†…è”å‡½æ•°**
```cpp
#include <iostream>
#include <chrono>

using namespace std;
using namespace std::chrono;

inline int inline_add(int a, int b) { return a + b; }
int normal_add(int a, int b) { return a + b; }

int main() {
    const int N = 100000000;
    int result = 0;

    auto start1 = high_resolution_clock::now();
    for (int i = 0; i < N; ++i) result += inline_add(i, i);
    auto end1 = high_resolution_clock::now();

    auto start2 = high_resolution_clock::now();
    for (int i = 0; i < N; ++i) result += normal_add(i, i);
    auto end2 = high_resolution_clock::now();

    cout << "Inline function time: " 
         << duration_cast<milliseconds>(end1 - start1).count() << " ms" << endl;
    cout << "Normal function time: " 
         << duration_cast<milliseconds>(end2 - start2).count() << " ms" << endl;

    return 0;
}
```
**å®éªŒç»“æœ**ï¼š
é€šå¸¸**å†…è”å‡½æ•°æ¯”æ™®é€šå‡½æ•°å¿«**ï¼Œå› ä¸ºå®ƒé¿å…äº†å‡½æ•°è°ƒç”¨çš„å¼€é”€ã€‚

---

### **6. ç¼–è¯‘å™¨å¦‚ä½•å†³å®šæ˜¯å¦å†…è”ï¼Ÿ**
å°½ç®¡ä½¿ç”¨äº† `inline` å…³é”®å­—ï¼Œ**ç¼–è¯‘å™¨ä¸ä¸€å®šä¼šå†…è”**ï¼Œæœ€ç»ˆç”±ç¼–è¯‘å™¨å†³å®šï¼š
- **ç¼–è¯‘ä¼˜åŒ–çº§åˆ«ï¼ˆO2/O3ï¼‰**ï¼šé«˜çº§ä¼˜åŒ–çº§åˆ«æ›´å€¾å‘äºå†…è”å°å‹å‡½æ•°ã€‚
- **å‡½æ•°å¤§å°**ï¼šå°å‹å‡½æ•°æ›´å®¹æ˜“è¢«å†…è”ã€‚
- **æ˜¯å¦é€’å½’**ï¼šé€’å½’å‡½æ•°ä¸ä¼šè¢«å†…è”ã€‚
- **æ˜¯å¦è™šå‡½æ•°**ï¼šè™šå‡½æ•°é»˜è®¤ä¸ä¼šè¢«å†…è”ã€‚


**å¼ºåˆ¶å†…è”**ï¼ˆå¯èƒ½å¤±æ•ˆï¼‰ï¼š  
GCC / Clang:
```cpp
__attribute__((always_inline)) inline void myfunc() { /* code */ }
```
MSVC:
```cpp
__forceinline void myfunc() { /* code */ }
```

---

### **7. æ€»ç»“**
|  ä¼˜ç‚¹  |  ç¼ºç‚¹  |
|  ----  |  ----  |
| å‡å°‘å‡½æ•°è°ƒç”¨å¼€é”€ | ä»£ç è†¨èƒ€ |
| é€‚ç”¨äºçŸ­å°é«˜é¢‘è°ƒç”¨çš„å‡½æ•° | å¢åŠ ç¼–è¯‘æ—¶é—´ |
| æé«˜ç¨‹åºæ€§èƒ½ | å¯èƒ½å½±å“ CPU ç¼“å­˜ä¼˜åŒ– |
| é¿å…é€’å½’å‡½æ•°è°ƒç”¨çš„é¢å¤–å¼€é”€ | ä¸é€‚ç”¨äºé€’å½’/è™šå‡½æ•° |

#### **æœ€ä½³å®è·µ**
- **çŸ­å°ã€é¢‘ç¹è°ƒç”¨çš„å‡½æ•°**é€‚åˆ `inline`ã€‚
- **å¤§å‡½æ•°ã€é€’å½’å‡½æ•°ã€è™šå‡½æ•°**é¿å… `inline`ã€‚
- **é¿å…æ»¥ç”¨ `inline`**ï¼Œè®©ç¼–è¯‘å™¨è‡ªåŠ¨ä¼˜åŒ–ã€‚


## inlineå’Œå®defineçš„åŒºåˆ«
`inline`å‡½æ•°å’Œå®ï¼ˆMacroï¼‰åœ¨ä»£ç æ›¿æ¢æœºåˆ¶ä¸Šæœ‰ç›¸ä¼¼ä¹‹å¤„ï¼Œä½†äºŒè€…åœ¨å®ç°æ–¹å¼ã€å®‰å…¨æ€§ã€é€‚ç”¨åœºæ™¯ç­‰æ–¹é¢å­˜åœ¨æ˜¾è‘—å·®å¼‚ã€‚ä»¥ä¸‹æ˜¯ä¸»è¦åŒºåˆ«çš„æ€»ç»“ï¼š

---

### 1. **å±•å¼€é˜¶æ®µä¸æœºåˆ¶**
â€¢ **å®**ï¼šåœ¨**é¢„å¤„ç†é˜¶æ®µ**è¿›è¡Œç®€å•çš„**æ–‡æœ¬æ›¿æ¢**ï¼Œä¸ä¼šè¿›è¡Œè¯­æ³•æ£€æŸ¥æˆ–ç±»å‹éªŒè¯ã€‚ä¾‹å¦‚ï¼š
  ```cpp
  #define SQUARE(x) x*x
  // è°ƒç”¨SQUARE(3+2)ä¼šè¢«æ›¿æ¢ä¸º3+2*3+2ï¼Œç»“æœä¸º11ï¼ˆè€Œéé¢„æœŸçš„25ï¼‰
  ```
  ç”±äºå®æ˜¯ç›´æ¥æ›¿æ¢ï¼Œå‚æ•°å¯èƒ½å› è¿ç®—ç¬¦ä¼˜å…ˆçº§æˆ–å‰¯ä½œç”¨å¯¼è‡´é”™è¯¯ã€‚

â€¢ **`inline`å‡½æ•°**ï¼šåœ¨**ç¼–è¯‘é˜¶æ®µ**å±•å¼€ï¼Œç¼–è¯‘å™¨å°†å‡½æ•°ä»£ç **åµŒå…¥è°ƒç”¨å¤„**ã€‚å®ƒéµå¾ªå‡½æ•°è¯­æ³•è§„åˆ™ï¼Œæ”¯æŒç±»å‹æ£€æŸ¥ã€å‚æ•°éªŒè¯ç­‰ã€‚ä¾‹å¦‚ï¼š
  ```cpp
  inline int square(int x) { return x*x; }
  // è°ƒç”¨square(3+2)ä¼šè¢«æ­£ç¡®è®¡ç®—ä¸º25
  ```
  ç¼–è¯‘å™¨ä¼šæ ¹æ®å‡½æ•°å¤æ‚åº¦å†³å®šæ˜¯å¦å†…è”ï¼Œå¤æ‚å‡½æ•°ï¼ˆå¦‚å«å¾ªç¯ï¼‰å¯èƒ½è¢«å¿½ç•¥ã€‚

---

### 2. **ç±»å‹å®‰å…¨ä¸é”™è¯¯æ£€æŸ¥**
â€¢ **å®**ï¼šæ— ç±»å‹æ£€æŸ¥ï¼Œå‚æ•°å¯èƒ½å› ç±»å‹ä¸åŒ¹é…å¯¼è‡´ä¸å¯é¢„çŸ¥è¡Œä¸ºã€‚ä¾‹å¦‚ï¼š
  ```cpp
  #define MAX(a, b) ((a) > (b) ? (a) : (b))
  // è‹¥å‚æ•°ä¸ºæµ®ç‚¹æ•°æˆ–æ··åˆç±»å‹ï¼Œå¯èƒ½å¼•å‘é”™è¯¯
  ```
  æ­¤å¤–ï¼Œå®æ— æ³•å¤„ç†ä½œç”¨åŸŸæˆ–ç±»çš„ç§æœ‰æˆå‘˜ã€‚

â€¢ **`inline`å‡½æ•°**ï¼šä½œä¸ºçœŸæ­£çš„å‡½æ•°ï¼Œæ”¯æŒç±»å‹æ£€æŸ¥å’Œå‚æ•°éªŒè¯ï¼Œèƒ½ç›´æ¥æ“ä½œç±»çš„ç§æœ‰æˆå‘˜ï¼Œä¸”å¯è°ƒè¯•ã€‚

---

### 3. **ä»£ç å‰¯ä½œç”¨ä¸å¯ç»´æŠ¤æ€§**
â€¢ **å®**ï¼šå‚æ•°è‹¥å«å‰¯ä½œç”¨ï¼ˆå¦‚è‡ªå¢æ“ä½œï¼‰ä¼šå¯¼è‡´å¤šæ¬¡æ±‚å€¼ã€‚ä¾‹å¦‚ï¼š
  ```cpp
  #define ADD(x, y) (x + y)
  int a = 5, b = 3;
  int res = ADD(a++, b); // å±•å¼€ä¸ºa++ + bï¼Œaè‡ªå¢ä¸¤æ¬¡
  ```
  ç»“æœå¯èƒ½ä¸ç¬¦åˆé¢„æœŸã€‚

â€¢ **`inline`å‡½æ•°**ï¼šå‚æ•°æŒ‰æ­£å¸¸å‡½æ•°è§„åˆ™ä¼ é€’ï¼Œé¿å…å‰¯ä½œç”¨é—®é¢˜ï¼š
  ```cpp
  inline int add(int x, int y) { return x + y; }
  int res = add(a++, b); // å‚æ•°å…ˆæ±‚å€¼å†ä¼ é€’ï¼Œaä»…è‡ªå¢ä¸€æ¬¡
  ```

---

### 4. **é€‚ç”¨åœºæ™¯ä¸é™åˆ¶**
â€¢ **å®**ï¼š
  â€¢ é€‚åˆå®šä¹‰å¸¸é‡ï¼ˆå¦‚`#define PI 3.14`ï¼‰æˆ–ç®€å•ä»£ç ç‰‡æ®µã€‚
  â€¢ å¯ç”¨äºå¤´æ–‡ä»¶é‡å¤åŒ…å«ä¿æŠ¤ï¼ˆ`#ifndef`ï¼‰ã€‚
  â€¢ æ— æ³•é€’å½’æˆ–å¤„ç†å¤æ‚é€»è¾‘ã€‚

â€¢ **`inline`å‡½æ•°**ï¼š
  â€¢ é€‚åˆçŸ­å°ã€é¢‘ç¹è°ƒç”¨çš„å‡½æ•°ï¼ˆå¦‚ç®€å•æ•°å­¦è¿ç®—ï¼‰ã€‚
  â€¢ é¿å…ç”¨äºå«å¾ªç¯ã€é€’å½’æˆ–é•¿ä»£ç çš„å‡½æ•°ï¼ˆå¯èƒ½å¯¼è‡´ä»£ç è†¨èƒ€ï¼‰ã€‚
  â€¢ ç±»çš„æˆå‘˜å‡½æ•°é»˜è®¤å†…è”ï¼Œç±»å¤–å®šä¹‰éœ€æ˜¾å¼æ·»åŠ `inline`ã€‚

---

### 5. **è°ƒè¯•ä¸ç»´æŠ¤**
â€¢ **å®**ï¼šè°ƒè¯•å›°éš¾ï¼Œé¢„å¤„ç†å™¨æ›¿æ¢åçš„ä»£ç ä¸å¯è§ï¼Œä¸”æ— æ³•è¿›è¡Œæ–­ç‚¹è°ƒè¯•ã€‚
â€¢ **`inline`å‡½æ•°**ï¼šæ”¯æŒè°ƒè¯•å·¥å…·è·Ÿè¸ªï¼Œä»£ç å¯è¯»æ€§æ›´é«˜ã€‚

---

### æ€»ç»“å¯¹æ¯”è¡¨
| **ç‰¹æ€§**         | **å®**                          | **`inline`å‡½æ•°**                     |
|------------------|---------------------------------|--------------------------------------|
| **å±•å¼€é˜¶æ®µ**      | é¢„å¤„ç†é˜¶æ®µï¼ˆæ–‡æœ¬æ›¿æ¢ï¼‰         | ç¼–è¯‘é˜¶æ®µï¼ˆä»£ç åµŒå…¥ï¼‰                 |
| **ç±»å‹æ£€æŸ¥**      | æ—                               | æœ‰                                   |
| **å‰¯ä½œç”¨å¤„ç†**    | å¯èƒ½å¯¼è‡´å¤šæ¬¡æ±‚å€¼                | å‚æ•°æŒ‰å‡½æ•°è§„åˆ™ä¼ é€’                   |
| **é€‚ç”¨åœºæ™¯**      | å¸¸é‡ã€ç®€å•ä»£ç ç‰‡æ®µ              | çŸ­å°é¢‘ç¹è°ƒç”¨çš„å‡½æ•°                   |
| **ç±»æˆå‘˜è®¿é—®**    | æ— æ³•è®¿é—®ç§æœ‰æˆå‘˜                | å¯è®¿é—®ç±»çš„ç§æœ‰æˆå‘˜                   |
| **è°ƒè¯•æ”¯æŒ**      | ä¸æ”¯æŒ                          | æ”¯æŒè°ƒè¯•å·¥å…·                         |
| **ä»£ç è†¨èƒ€é£é™©**  | ä½ï¼ˆç®€å•æ›¿æ¢ï¼‰                  | é«˜ï¼ˆå¤æ‚å‡½æ•°å¯èƒ½è†¨èƒ€ï¼‰               |

---

### å»ºè®®
â€¢ **ä¼˜å…ˆä½¿ç”¨`inline`å‡½æ•°**ï¼šåœ¨C++ä¸­ï¼Œ`inline`å‡½æ•°æ›´å®‰å…¨ã€æ˜“ç»´æŠ¤ï¼Œå°¤å…¶æ˜¯æ¶‰åŠç±»å‹æˆ–ç±»æˆå‘˜æ—¶ã€‚
â€¢ **è°¨æ…ä½¿ç”¨å®**ï¼šä»…åœ¨éœ€è¦é¢„å¤„ç†åŠŸèƒ½ï¼ˆå¦‚å¤´æ–‡ä»¶ä¿æŠ¤ï¼‰æˆ–ç®€å•æ–‡æœ¬æ›¿æ¢æ—¶ä½¿ç”¨ï¼Œé¿å…å¤æ‚é€»è¾‘ã€‚

## inlineä»€ä¹ˆæ—¶å€™å±•å¼€
```plaintext
æ˜¯å¦å£°æ˜ä¸ºinlineï¼Ÿ â†’ å¦ â†’ å¯èƒ½è¢«ç¼–è¯‘å™¨è‡ªåŠ¨å†…è”ï¼ˆé«˜ä¼˜åŒ–çº§åˆ«ï¼‰
                â†“æ˜¯
æ˜¯å¦ä½“ç§¯å°ä¸”æ— å¤æ‚æ§åˆ¶æµï¼Ÿ â†’ å¦ â†’ æ‹’ç»å†…è”(å¦‚æœé€’å½’)
                â†“æ˜¯
æ˜¯å¦é«˜é¢‘è°ƒç”¨ï¼Ÿ â†’ å¦ â†’ å¯èƒ½æ‹’ç»
                â†“æ˜¯
æ˜¯å¦ä¼˜åŒ–çº§åˆ«è¶³å¤Ÿé«˜ï¼Ÿ â†’ å¦ â†’ å¯èƒ½æ‹’ç»
                â†“æ˜¯
æœ€ç»ˆå±•å¼€ä¸ºå†…è”ä»£ç 
```


# volatileå…³é”®å­—
## **`volatile` å…³é”®å­—çš„ä½œç”¨**
`volatile` å…³é”®å­—ç”¨äºå‘Šè¯‰ç¼–è¯‘å™¨ **å˜é‡çš„å€¼å¯èƒ½ä¼šè¢«å¤–éƒ¨å› ç´ ï¼ˆå¦‚ç¡¬ä»¶æˆ–å¤šçº¿ç¨‹ï¼‰æ”¹å˜**ï¼Œå› æ­¤ **ç¦æ­¢ä¼˜åŒ–** è¯¥å˜é‡çš„è®¿é—®ï¼Œä»¥ç¡®ä¿æ¯æ¬¡è¯»å–éƒ½èƒ½å¾—åˆ°æœ€æ–°çš„å€¼ã€‚

---

## è™šç»§æ‰¿sizeof()é—®é¢˜
è™šç»§æ‰¿ç§è™šåŸºç±»è¢«å•ç‹¬ç®¡ç†ï¼Œå­ç±»ä¼šåŒ…å«ä¸€ä¸ªæŒ‡å‘è™šåŸºç±»çš„æŒ‡é’ˆ


## **`volatile` ä¸»è¦ä½œç”¨**
### **1. é˜²æ­¢ç¼–è¯‘å™¨ä¼˜åŒ–**
é€šå¸¸ï¼Œç¼–è¯‘å™¨ä¼šä¸ºäº†ä¼˜åŒ–æ€§èƒ½ï¼Œå°†å˜é‡çš„å€¼**ç¼“å­˜åˆ°å¯„å­˜å™¨**æˆ–**ä¼˜åŒ–æ‰ä¸å¿…è¦çš„å†…å­˜è®¿é—®**ã€‚ä½†å¦‚æœå˜é‡çš„å€¼å¯èƒ½è¢« **å¤–éƒ¨ç¡¬ä»¶** æˆ– **å¤šçº¿ç¨‹** æ”¹å˜ï¼Œåˆ™ç¼–è¯‘å™¨çš„ä¼˜åŒ–å¯èƒ½ä¼šå¯¼è‡´ç¨‹åºè¡Œä¸ºå¼‚å¸¸ã€‚`volatile` å…³é”®å­—å¯ä»¥é˜»æ­¢è¿™ç§ä¼˜åŒ–ã€‚

### **2. ç¡®ä¿å˜é‡æ¯æ¬¡è¯»å–éƒ½ç›´æ¥è®¿é—®å†…å­˜**
å¯¹äºæ™®é€šå˜é‡ï¼Œç¼–è¯‘å™¨å¯èƒ½ä¼˜åŒ–ä»£ç ï¼Œä½¿å˜é‡çš„å€¼ä¿ç•™åœ¨ CPU **å¯„å­˜å™¨** ä¸­ï¼Œè€Œä¸ä¼šæ¯æ¬¡éƒ½ä»å†…å­˜è¯»å–ã€‚ä¾‹å¦‚ï¼š
```cpp
bool stop = false;

while (!stop) {
    // Do something...
}
```
ç¼–è¯‘å™¨å¯èƒ½ä¼šä¼˜åŒ– `stop` çš„è®¿é—®ï¼Œå°†å®ƒ**ç¼“å­˜åˆ°å¯„å­˜å™¨**ï¼Œå¦‚æœ `stop` å˜é‡çš„å€¼æ˜¯ç”±å¦ä¸€ä¸ªçº¿ç¨‹æˆ–å¤–éƒ¨è®¾å¤‡æ”¹å˜çš„ï¼Œå½“å‰çº¿ç¨‹å¯èƒ½æ°¸è¿œæ— æ³•æ„ŸçŸ¥åˆ°ã€‚

å¦‚æœ `stop` è¢«å£°æ˜ä¸º `volatile`ï¼š
```cpp
volatile bool stop = false;
```
ç¼–è¯‘å™¨å°±ä¸ä¼šä¼˜åŒ– `stop` çš„è®¿é—®ï¼Œæ¯æ¬¡éƒ½ä¼šç›´æ¥ä»**å†…å­˜**ä¸­è¯»å–ï¼Œè€Œä¸æ˜¯ä»å¯„å­˜å™¨ç¼“å­˜ï¼Œç¡®ä¿è·å–åˆ°æœ€æ–°çš„å€¼ã€‚

---

## **`volatile` çš„é€‚ç”¨åœºæ™¯**
### **1. å˜é‡ç”±å¤–éƒ¨ç¡¬ä»¶ï¼ˆå¦‚ I/O è®¾å¤‡ï¼‰ä¿®æ”¹**
æŸäº›å˜é‡çš„å€¼å¯èƒ½ç”± **å¤–éƒ¨è®¾å¤‡**ï¼ˆå¦‚ä¼ æ„Ÿå™¨ã€ä¸­æ–­ï¼‰ä¿®æ”¹ï¼š
```cpp
volatile int sensor_data;  // ä¼ æ„Ÿå™¨æ•°æ®å¯èƒ½éšæ—¶å˜åŒ–

void readSensor() {
    while (sensor_data != 0) {  // ç¡®ä¿ sensor_data è¢«æ­£ç¡®è¯»å–
        // å¤„ç†æ•°æ®...
    }
}
```
å¦‚æœ `sensor_data` æ²¡æœ‰ `volatile`ï¼Œç¼–è¯‘å™¨å¯èƒ½ä¼šä¼˜åŒ–ä»£ç ï¼ŒæŠŠ `sensor_data` çš„å€¼ç¼“å­˜ï¼Œå¯¼è‡´ä»£ç æ— æ³•æ£€æµ‹åˆ°æ•°æ®å˜åŒ–ã€‚

---

### **2. å˜é‡è¢«å¤šçº¿ç¨‹ä¿®æ”¹**
åœ¨**å¤šçº¿ç¨‹ç¯å¢ƒ**ä¸‹ï¼Œä¸€ä¸ªçº¿ç¨‹å¯èƒ½ä¿®æ”¹æŸä¸ªå˜é‡ï¼Œè€Œå¦ä¸€ä¸ªçº¿ç¨‹éœ€è¦æ­£ç¡®è¯»å–è¯¥å˜é‡ï¼š
```cpp
volatile bool stop = false;  // ç”±å¦ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹

void worker() {
    while (!stop) {  // ç¡®ä¿ stop çš„æœ€æ–°å€¼è¢«è¯»å–
        // æ‰§è¡Œä»»åŠ¡...
    }
}
```
è¿™æ ·ï¼Œ`stop` å˜é‡çš„ä¿®æ”¹å¯ä»¥è¢«åŠæ—¶æ„ŸçŸ¥ã€‚

âš  **æ³¨æ„**ï¼š`volatile` **ä¸èƒ½ä¿è¯çº¿ç¨‹å®‰å…¨**ï¼Œå®ƒåªä¿è¯å˜é‡è®¿é—®ä¸è¢«ä¼˜åŒ–ï¼Œè€Œ**ä¸ä¼šä¿è¯åŸå­æ€§**ï¼Œæ‰€ä»¥åœ¨å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­ï¼Œé€šå¸¸åº”è¯¥ä½¿ç”¨ `std::atomic` ä»£æ›¿ `volatile`ã€‚

---

### **3. å˜é‡åœ¨ `setjmp/longjmp` ä»£ç ä¸­ä½¿ç”¨**
åœ¨ `setjmp/longjmp` ä»£ç å—ä¸­ï¼Œ`volatile` å˜é‡ä¸ä¼šå› è·³è½¬è€Œä¸¢å¤±ï¼š
```cpp
#include <setjmp.h>
#include <stdio.h>

jmp_buf buf;

void second() {
    longjmp(buf, 1);  // è·³å› setjmp
}

void first() {
    second();
}

int main() {
    volatile int x = 1;
    if (setjmp(buf)) {
        printf("x = %d\n", x);  // ç¡®ä¿ x çš„å€¼æ­£ç¡®
        return 0;
    }
    x = 2;
    first();
    return 0;
}
```
`volatile` ç¡®ä¿ `x` çš„å€¼åœ¨ `longjmp` ä¹‹åä»ç„¶æœ‰æ•ˆã€‚

---

## **`volatile` ä¸é€‚ç”¨çš„åœºæ™¯**
### **1. `volatile` ä¸èƒ½ä¿è¯åŸå­æ€§**
```cpp
volatile int counter = 0;

void increment() {
    counter++;  // ä¸æ˜¯åŸå­æ“ä½œ
}
```
è™½ç„¶ `volatile` è®© `counter` æ¯æ¬¡è®¿é—®éƒ½ä»å†…å­˜è¯»å–ï¼Œä½† `counter++` å®é™…ä¸Šæ˜¯ï¼š
```cpp
int temp = counter;  // è¯»å–
temp = temp + 1;     // è®¡ç®—
counter = temp;      // å†™å›
```
**åœ¨å¤šçº¿ç¨‹æƒ…å†µä¸‹ï¼Œå¯èƒ½ä¼šå‘ç”Ÿç«æ€æ¡ä»¶**ï¼Œå¯¼è‡´ `counter` çš„ä¿®æ”¹ä¸¢å¤±ã€‚å› æ­¤ï¼Œåº”ä½¿ç”¨ `std::atomic<int>` ä»£æ›¿ï¼š
```cpp
#include <atomic>
std::atomic<int> counter = 0;

void increment() {
    counter.fetch_add(1, std::memory_order_relaxed);
}
```

---

## **æ€»ç»“**
| å…³é”®ç‚¹ | `volatile` |
|--------|-----------|
| **ä½œç”¨** | é˜²æ­¢ç¼–è¯‘å™¨ä¼˜åŒ–ï¼Œç¡®ä¿å˜é‡æ¯æ¬¡éƒ½ä»**å†…å­˜**è¯»å– |
| **é€‚ç”¨åœºæ™¯** | ç¡¬ä»¶å¯„å­˜å™¨ã€å¤šçº¿ç¨‹æ ‡å¿—ä½ã€`setjmp/longjmp` |
| **ä¸é€‚ç”¨** | **ä¸èƒ½ä¿è¯çº¿ç¨‹å®‰å…¨**ï¼Œä¸é€‚ç”¨äºåŸå­æ“ä½œå’ŒåŒæ­¥ |
| **æ¨èæ›¿ä»£æ–¹æ¡ˆ** | `std::atomic`ï¼ˆåŸå­æ“ä½œï¼‰ï¼Œ`std::mutex`ï¼ˆäº’æ–¥é”ï¼‰ |

âœ… **æ¨èä½¿ç”¨ `volatile` çš„æƒ…å†µ**ï¼š
- å˜é‡çš„å€¼ç”±**å¤–éƒ¨è®¾å¤‡**æˆ–**ç¡¬ä»¶ä¸­æ–­**ä¿®æ”¹ã€‚
- å˜é‡åœ¨ `setjmp/longjmp` ä»£ç å—ä¸­ä½¿ç”¨ã€‚
- **æ ‡å¿—ä½å˜é‡**ï¼Œç”¨äºçº¿ç¨‹é—´é€šçŸ¥ï¼ˆä½†ä»éœ€é…åˆ `std::atomic` æˆ– `mutex`ï¼‰ã€‚

âŒ **ä¸æ¨èä½¿ç”¨ `volatile` çš„æƒ…å†µ**ï¼š
- å¤šçº¿ç¨‹å…±äº«å˜é‡çš„åŒæ­¥ï¼ˆåº”ä½¿ç”¨ `std::atomic` æˆ– `mutex`ï¼‰ã€‚
- ä¿æŠ¤æ•°æ®å®Œæ•´æ€§ï¼ˆ`volatile` ä¸èƒ½ä¿è¯åŸå­æ€§ï¼‰ã€‚

---

ğŸš€ **æ€»ç»“ä¸€å¥è¯**ï¼š
`volatile` ä¸»è¦ç”¨äº **é˜²æ­¢ç¼–è¯‘å™¨ä¼˜åŒ–**ï¼Œç¡®ä¿å˜é‡çš„**æœ€æ–°å€¼**å¯ä»¥è¢«æ­£ç¡®è¯»å–ï¼Œä½† **ä¸èƒ½ä¿è¯çº¿ç¨‹å®‰å…¨**ï¼Œå¯¹äºå¤šçº¿ç¨‹åŒæ­¥ï¼Œåº”ä½¿ç”¨ **`std::atomic` æˆ– `mutex`**ã€‚

# lambdaè¡¨è¾¾å¼
> **[capture] (parameters) {body}**
> [=]ä»¥å€¼æ•è·å¤–ç•Œæ‰€æœ‰å˜é‡
> [&]ä»¥å¼•ç”¨æ•è·å¤–ç•Œæ‰€æœ‰å˜é‡
> [var,...]
> [&var,&...]æ•è·ç‰¹å®šå˜é‡


# static
![alt text](image-103.png)
## cå’Œc++staticçš„åŒºåˆ«
`static` å…³é”®å­—åœ¨ C å’Œ C++ ä¸­æ—¢æœ‰ç›¸ä¼¼ä¹‹å¤„ï¼Œä¹Ÿå­˜åœ¨æ˜¾è‘—å·®å¼‚ã€‚ä»¥ä¸‹æ˜¯ä¸¤è€…çš„æ ¸å¿ƒåŒºåˆ«å’Œç‰¹æ€§æ€»ç»“ï¼š

---

### ä¸€ã€**C è¯­è¨€ä¸­çš„ `static`**
#### 1. **ä¿®é¥°å˜é‡**
â€¢ **å…¨å±€å˜é‡**  
  ç”¨ `static` ä¿®é¥°çš„å…¨å±€å˜é‡ï¼ˆé™æ€å…¨å±€å˜é‡ï¼‰**ä½œç”¨åŸŸä»…é™äºå½“å‰æ–‡ä»¶**ï¼Œå…¶ä»–æ–‡ä»¶æ— æ³•é€šè¿‡ `extern` å£°æ˜è®¿é—®ã€‚ä¾‹å¦‚ï¼š  
  ```c
  static int global_var;  // åªèƒ½åœ¨å½“å‰æ–‡ä»¶å†…ä½¿ç”¨
  ```

â€¢ **å±€éƒ¨å˜é‡**  
  ç”¨ `static` ä¿®é¥°çš„å±€éƒ¨å˜é‡ï¼ˆé™æ€å±€éƒ¨å˜é‡ï¼‰**ç”Ÿå‘½å‘¨æœŸå»¶é•¿è‡³ç¨‹åºç»“æŸ**ï¼Œä½†ä½œç”¨åŸŸä»é™äºå‡½æ•°å†…éƒ¨ï¼Œä¸”ä»…åˆå§‹åŒ–ä¸€æ¬¡ã€‚ä¾‹å¦‚ï¼š  
  ```c
  void func() {
      static int count = 0;  // ä»…åˆå§‹åŒ–ä¸€æ¬¡ï¼Œå¤šæ¬¡è°ƒç”¨ä¿ç•™å€¼
      count++;
  }
  ```

#### 2. **ä¿®é¥°å‡½æ•°**
â€¢ **é™æ€å‡½æ•°**  
  ç”¨ `static` ä¿®é¥°çš„å‡½æ•°**åªèƒ½åœ¨å½“å‰æ–‡ä»¶å†…è°ƒç”¨**ï¼Œå…¶ä»–æ–‡ä»¶æ— æ³•è®¿é—®ï¼Œé¿å…å‘½åå†²çªã€‚ä¾‹å¦‚ï¼š  
  ```c
  static void helper() { /* ... */ }  // ä»…åœ¨å½“å‰æ–‡ä»¶å¯è§
  ```

---

### äºŒã€**C++ ä¸­çš„ `static`**
#### 1. **ç»§æ‰¿ C è¯­è¨€çš„åŠŸèƒ½**
C++ å…¼å®¹ C è¯­è¨€çš„ `static` ç”¨æ³•ï¼ŒåŒ…æ‹¬é™æ€å…¨å±€å˜é‡ã€é™æ€å±€éƒ¨å˜é‡å’Œé™æ€å‡½æ•°ï¼Œè§„åˆ™ä¸ C ä¸€è‡´ã€‚

#### 2. **ç±»çš„é™æ€æˆå‘˜**
è¿™æ˜¯ C++ å¯¹ `static` çš„æ‰©å±•ï¼Œä¸é¢å‘å¯¹è±¡ç‰¹æ€§ç›¸å…³ï¼š
â€¢ **é™æ€æ•°æ®æˆå‘˜**  
  â€¢ å±äºç±»æœ¬èº«ï¼Œè€Œéç±»çš„å®ä¾‹ï¼Œæ‰€æœ‰å¯¹è±¡å…±äº«åŒä¸€ä»½æ•°æ®ã€‚  
  â€¢ **å¿…é¡»ç±»å†…å£°æ˜ï¼Œç±»å¤–åˆå§‹åŒ–**ï¼ˆå¸¸é‡é™æ€æˆå‘˜å¯åœ¨ç±»å†…åˆå§‹åŒ–ï¼‰ã€‚ä¾‹å¦‚ï¼š  
    ```cpp
    class MyClass {
    public:
        static int shared_value;  // å£°æ˜
    };
    int MyClass::shared_value = 0;  // ç±»å¤–åˆå§‹åŒ–
    ```

â€¢ **é™æ€æˆå‘˜å‡½æ•°**  
  â€¢ åªèƒ½è®¿é—®ç±»çš„é™æ€æˆå‘˜ï¼Œä¸èƒ½è®¿é—®éé™æ€æˆå‘˜ã€‚  
  â€¢ å¯é€šè¿‡ç±»åç›´æ¥è°ƒç”¨ï¼Œæ— éœ€å®ä¾‹åŒ–å¯¹è±¡ã€‚ä¾‹å¦‚ï¼š  
    ```cpp
    class MyClass {
    public:
        static void print() { cout << shared_value; }
    };
    MyClass::print();  // ç›´æ¥è°ƒç”¨
    ```

---

### ä¸‰ã€**æ ¸å¿ƒåŒºåˆ«æ€»ç»“**
| **ç‰¹æ€§**               | **C è¯­è¨€**                                | **C++**                                  |
|-------------------------|------------------------------------------|------------------------------------------|
| **ä½œç”¨åŸŸæ§åˆ¶**          | é™åˆ¶å…¨å±€å˜é‡/å‡½æ•°åˆ°å½“å‰æ–‡ä»¶       | å…¼å®¹ Cï¼ŒåŒæ—¶æ”¯æŒç±»çš„é™æ€æˆå‘˜ä½œç”¨åŸŸ |
| **å˜é‡å­˜å‚¨ä½ç½®**        | é™æ€å…¨å±€/å±€éƒ¨å˜é‡å‡å­˜æ”¾åœ¨å…¨å±€æ•°æ®åŒº   | ç±»é™æ€æˆå‘˜å˜é‡åŒæ ·å­˜æ”¾åœ¨å…¨å±€æ•°æ®åŒº |
| **ç±»ç›¸å…³åŠŸèƒ½**          | æ— ç±»çš„æ¦‚å¿µï¼Œä¸æ”¯æŒç±»æˆå‘˜ä¿®é¥°             | é™æ€æˆå‘˜å˜é‡/å‡½æ•°å±äºç±»æœ¬èº«      |
| **åˆå§‹åŒ–è§„åˆ™**          | é™æ€å˜é‡å¯ç›´æ¥åœ¨å£°æ˜æ—¶åˆå§‹åŒ–         | ç±»é™æ€æˆå‘˜å˜é‡éœ€åœ¨ç±»å¤–åˆå§‹åŒ–     |

---

### å››ã€**å…¸å‹åœºæ™¯å¯¹æ¯”**
1. **è·¨æ–‡ä»¶è®¿é—®**  
   â€¢ C ä¸­é™æ€å…¨å±€å˜é‡å¯¹å…¶ä»–æ–‡ä»¶ä¸å¯è§ï¼Œä½†å¯é€šè¿‡è¿”å›é™æ€å˜é‡æŒ‡é’ˆçš„å‡½æ•°é—´æ¥è®¿é—®ï¼ˆç±»ä¼¼ C++ çš„å°è£…ï¼‰ã€‚  
   â€¢ C++ ä¸­ç±»çš„é™æ€æˆå‘˜å¯é€šè¿‡ç±»åç›´æ¥è®¿é—®ï¼Œæ— éœ€ä¾èµ–å¯¹è±¡å®ä¾‹ã€‚

2. **æ•°æ®å…±äº«**  
   â€¢ C ä¸­é™æ€å±€éƒ¨å˜é‡å®ç°å‡½æ•°é—´æ•°æ®ä¿ç•™ã€‚  
   â€¢ C++ ä¸­é™æ€æˆå‘˜å˜é‡å®ç°å¤šä¸ªå¯¹è±¡å…±äº«åŒä¸€æ•°æ®ã€‚

3. **å†…å­˜ç®¡ç†**  
   â€¢ C/C++ çš„é™æ€å˜é‡å‡å­˜æ”¾åœ¨å…¨å±€æ•°æ®åŒºï¼Œç”Ÿå‘½å‘¨æœŸä¸ç¨‹åºä¸€è‡´ã€‚

---

### äº”ã€**æ³¨æ„äº‹é¡¹**
1. **é¿å…æ»¥ç”¨ `static`**  
   â€¢ è¿‡åº¦ä½¿ç”¨é™æ€å˜é‡å¯èƒ½å¯¼è‡´ä»£ç è€¦åˆåº¦é«˜æˆ–å†…å­˜å ç”¨è¿‡å¤§ã€‚
2. **çº¿ç¨‹å®‰å…¨é—®é¢˜**  
   â€¢ é™æ€å˜é‡åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­éœ€é¢å¤–åŒæ­¥å¤„ç†ã€‚
3. **C++ é™æ€æˆå‘˜å‡½æ•°é™åˆ¶**  
   â€¢ ä¸èƒ½ä½¿ç”¨ `this` æŒ‡é’ˆï¼Œä¹Ÿæ— æ³•è°ƒç”¨éé™æ€æˆå‘˜å‡½æ•°ã€‚

---

### æ€»ç»“
C è¯­è¨€çš„ `static` ä¸»è¦ç”¨äºæ§åˆ¶ä½œç”¨åŸŸå’Œå­˜å‚¨å‘¨æœŸï¼Œè€Œ C++ åœ¨æ­¤åŸºç¡€ä¸Šæ‰©å±•äº†ç±»çš„é™æ€æˆå‘˜åŠŸèƒ½ï¼Œå®ç°äº†æ•°æ®ä¸è¡Œä¸ºçš„ç±»çº§åˆ«å…±äº«ã€‚ç†è§£ä¸¤è€…çš„å·®å¼‚æœ‰åŠ©äºç¼–å†™æ›´é«˜æ•ˆã€å®‰å…¨çš„è·¨è¯­è¨€ä»£ç ã€‚

## ä¸ºä»€ä¹ˆç±»é™æ€æˆå‘˜å˜é‡éœ€åœ¨ç±»å¤–åˆå§‹åŒ–â€”â€”é˜²æ­¢é‡å®šä¹‰
ç±»é™æ€æˆå‘˜å˜é‡å¿…é¡»åœ¨ç±»å¤–åˆå§‹åŒ–çš„åŸå› å¯ä»¥ä»å­˜å‚¨ç‰¹æ€§ã€è¯­è¨€è§„åˆ™å’Œåˆå§‹åŒ–é€»è¾‘ä¸‰ä¸ªç»´åº¦æ·±å…¥è§£æï¼š

---

### ä¸€ã€å­˜å‚¨ç‰¹æ€§ä¸å†…å­˜åˆ†é…è§„åˆ™
1. **é™æ€å­˜å‚¨åŒºå½’å±**  
   é™æ€æˆå‘˜å˜é‡å­˜å‚¨åœ¨**å…¨å±€æ•°æ®åŒºï¼ˆé™æ€å­˜å‚¨åŒºï¼‰**ï¼Œä¸ç±»çš„å®ä¾‹å¯¹è±¡æ— å…³ã€‚è¿™ç§å­˜å‚¨ç‰¹æ€§è¦æ±‚å…¶å†…å­˜åˆ†é…æ—©äºä»»ä½•å¯¹è±¡åˆ›å»ºï¼Œè€Œç±»å†…å£°æ˜ä»…æè¿°ç±»å‹ä¿¡æ¯ï¼Œå¹¶ä¸å®é™…åˆ†é…å†…å­˜ã€‚  
   **ç¤ºä¾‹**ï¼š  
   ```cpp
   class MyClass {
   public:
       static int count;  // å£°æ˜ï¼ˆæœªåˆ†é…å†…å­˜ï¼‰
   };
   int MyClass::count = 0;  // ç±»å¤–å®šä¹‰å¹¶åˆ†é…å†…å­˜
   ```

2. **é¿å…é‡å¤å®šä¹‰é£é™©**  
   è‹¥åœ¨ç±»å†…åˆå§‹åŒ–ï¼Œæ¯ä¸ªåŒ…å«è¯¥å¤´æ–‡ä»¶çš„æºæ–‡ä»¶éƒ½ä¼šå°è¯•å®šä¹‰åŒä¸€é™æ€å˜é‡ï¼Œå¯¼è‡´é“¾æ¥é˜¶æ®µçš„**é‡å¤å®šä¹‰é”™è¯¯**ã€‚ç±»å¤–åˆå§‹åŒ–ç¡®ä¿å†…å­˜ä»…åˆ†é…ä¸€æ¬¡ï¼Œæ‰€æœ‰å¯¹è±¡å…±äº«åŒä¸€æ•°æ®å‰¯æœ¬ã€‚

---

### äºŒã€è¯­è¨€è§„åˆ™ä¸åˆå§‹åŒ–é€»è¾‘
3. **ä¸æ™®é€šæˆå‘˜çš„æœ¬è´¨å·®å¼‚**  
   â€¢ **æ™®é€šæˆå‘˜å˜é‡**ï¼šéšå¯¹è±¡å®ä¾‹åŒ–åœ¨æ ˆ/å †ä¸­åˆ†é…å†…å­˜ï¼Œé€šè¿‡æ„é€ å‡½æ•°åˆå§‹åŒ–åˆ—è¡¨æˆ–é»˜è®¤å€¼åˆå§‹åŒ–ã€‚  
   â€¢ **é™æ€æˆå‘˜å˜é‡**ï¼šç‹¬ç«‹äºå¯¹è±¡å­˜åœ¨ï¼Œæ— æ³•é€šè¿‡æ„é€ å‡½æ•°åˆå§‹åŒ–ï¼ˆæ„é€ å‡½æ•°ä»…å¤„ç†å¯¹è±¡çº§åˆ«çš„èµ„æºï¼‰ã€‚  
   **å…³é”®å¯¹æ¯”**ï¼š  
   ```cpp
   class Test {
   private:
       int a = 10;        // æ™®é€šæˆå‘˜å¯ç±»å†…åˆå§‹åŒ–ï¼ˆC++11èµ·ï¼‰
       static int b;      // é™æ€æˆå‘˜ä»…å£°æ˜ï¼Œä¸å¯ç±»å†…åˆå§‹åŒ–ï¼ˆé™¤éconstæ•´å‹ï¼‰
   };
   int Test::b = 20;      // å¿…é¡»ç±»å¤–åˆå§‹åŒ–
   ```

4. **C++è¯­æ³•é™åˆ¶ä¸ä¾‹å¤–æƒ…å†µ**  
   â€¢ **å…è®¸ç±»å†…åˆå§‹åŒ–çš„ç‰¹ä¾‹**ï¼š  
     `const static`ä¿®é¥°çš„æ•´å‹ï¼ˆå¦‚`int`ã€`char`ï¼‰æˆ–æšä¸¾ç±»å‹ï¼Œå¯åœ¨ç±»å†…ç›´æ¥èµ‹äºˆå¸¸é‡è¡¨è¾¾å¼å€¼ã€‚  
     **ç¤ºä¾‹**ï¼š  
     ```cpp
     class Math {
     public:
         const static int MAX = 100;  // åˆæ³•ï¼ˆæ•´å‹ä¸”constï¼‰
         // static float PI = 3.14;  // éæ³•ï¼ˆéæ•´å‹ï¼‰
     };
     ```

---

### ä¸‰ã€åˆå§‹åŒ–æ—¶æœºä¸ä½œç”¨åŸŸæ§åˆ¶
5. **ç”Ÿå‘½å‘¨æœŸä¸ä½œç”¨åŸŸç®¡ç†**  
   é™æ€æˆå‘˜å˜é‡çš„ç”Ÿå‘½å‘¨æœŸä»ç¨‹åºå¯åŠ¨å¼€å§‹ï¼Œåˆ°ç¨‹åºç»“æŸé”€æ¯ã€‚ç±»å¤–åˆå§‹åŒ–å¼ºåˆ¶å¼€å‘è€…æ˜¾å¼æŒ‡å®šå…¶ä½œç”¨åŸŸï¼ˆé€šè¿‡`ç±»å::å˜é‡å`ï¼‰ï¼Œé¿å…ä¸å…¶ä»–å…¨å±€å˜é‡å‘½åå†²çªã€‚  
   **é”™è¯¯æ¡ˆä¾‹**ï¼š  
   ```cpp
   // å¤´æ–‡ä»¶MyClass.h
   class MyClass {
   public:
       static int count = 0;  // é”™è¯¯ï¼å¤šä¸ªæºæ–‡ä»¶åŒ…å«æ­¤å¤´æ–‡ä»¶æ—¶é“¾æ¥å¤±è´¥
   };
   ```

6. **ç¼–è¯‘å™¨å¤„ç†æµç¨‹**  
   ç±»å®šä¹‰åœ¨ç¼–è¯‘é˜¶æ®µä»…ç”Ÿæˆç¬¦å·è¡¨ï¼Œè€Œç±»å¤–åˆå§‹åŒ–åœ¨é“¾æ¥é˜¶æ®µå®Œæˆå†…å­˜åˆ†é…ã€‚è¿™ç§åˆ†ç¦»ç¡®ä¿é™æ€æˆå‘˜åœ¨ç¨‹åºåŠ è½½æ—¶å³è¢«æ­£ç¡®åˆå§‹åŒ–ï¼Œæ— éœ€ä¾èµ–å¯¹è±¡å®ä¾‹åŒ–æµç¨‹ã€‚

---

### å››ã€æ€»ç»“å¯¹æ¯”è¡¨
| **ç‰¹æ€§**               | **æ™®é€šæˆå‘˜å˜é‡**               | **é™æ€æˆå‘˜å˜é‡**               |
|------------------------|-------------------------------|-------------------------------|
| **å­˜å‚¨ä½ç½®**           | å¯¹è±¡å†…å­˜ï¼ˆæ ˆ/å †ï¼‰             | å…¨å±€æ•°æ®åŒºï¼ˆé™æ€å­˜å‚¨åŒºï¼‰       |
| **åˆå§‹åŒ–æ–¹å¼**         | æ„é€ å‡½æ•°/ç±»å†…é»˜è®¤å€¼ï¼ˆC++11ï¼‰ | å¿…é¡»åœ¨ç±»å¤–æ˜¾å¼åˆå§‹åŒ–ï¼ˆé™¤ç‰¹ä¾‹ï¼‰|
| **ç”Ÿå‘½å‘¨æœŸ**           | ä¸å¯¹è±¡å…±å­˜äº¡                  | ç¨‹åºå¯åŠ¨åˆ°ç»“æŸ                |
| **å†…å­˜åˆ†é…æ¬¡æ•°**       | æ¯ä¸ªå¯¹è±¡ç‹¬ç«‹åˆ†é…              | ä»…åˆ†é…ä¸€æ¬¡ï¼Œå…¨ä½“å¯¹è±¡å…±äº«       |

---

### äº”ã€å®é™…åº”ç”¨å»ºè®®
â€¢ **ä¼˜å…ˆä½¿ç”¨ç±»å¤–åˆå§‹åŒ–**ï¼šç¡®ä¿ä»£ç å¯ç§»æ¤æ€§ï¼Œé¿å…ä¸åŒç¼–è¯‘å™¨å¯¹ç±»å†…åˆå§‹åŒ–çš„æ”¯æŒå·®å¼‚ã€‚  
â€¢ **åˆ©ç”¨ç‰¹ä¾‹ä¼˜åŒ–ä»£ç **ï¼šå¯¹`const static`æ•´å‹æˆå‘˜ä½¿ç”¨ç±»å†…åˆå§‹åŒ–ç®€åŒ–ä»£ç ï¼ˆå¦‚å®šä¹‰æšä¸¾æˆ–å¸¸é‡æ•°ç»„å¤§å°ï¼‰ã€‚  
â€¢ **çº¿ç¨‹å®‰å…¨æ³¨æ„äº‹é¡¹**ï¼šé™æ€æˆå‘˜å˜é‡åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­éœ€é€šè¿‡äº’æ–¥é”æˆ–åŸå­æ“ä½œä¿æŠ¤ã€‚  

é€šè¿‡ç†è§£è¿™äº›åº•å±‚æœºåˆ¶ï¼Œå¼€å‘è€…èƒ½æ›´ç²¾å‡†åœ°æ§åˆ¶ç±»è®¾è®¡ä¸­çš„èµ„æºåˆ†é…ä¸åˆå§‹åŒ–é€»è¾‘ï¼Œé¿å…æ½œåœ¨çš„å†…å­˜é”™è¯¯å’Œé€»è¾‘ç¼ºé™·ã€‚


## æ„é€ å‡½æ•°ä¸­èƒ½å¦ä½¿ç”¨staticæˆå‘˜



# const 
- const T x; è¡¨ç¤ºxæ˜¯å¸¸é‡
- const T* x; è¡¨ç¤ºæŒ‡é’ˆxæŒ‡å‘å¸¸é‡
- T* const x; è¡¨ç¤ºxæ˜¯å¸¸é‡æŒ‡é’ˆï¼ŒæŒ‡å‘å›ºå®šä½ç½®ä¸èƒ½ä¿®æ”¹
- const T* const x; æŒ‡é’ˆåŠå…¶æŒ‡å‘éƒ½æ˜¯å¸¸é‡ï¼Œä¸å¯ä¿®æ”¹

## defineå’Œconstï¼Œconstexprçš„åŒºåˆ«
å¤„ç†é˜¶æ®µä¸åŒ
- defineæ˜¯**é¢„å¤„ç†**ï¼Œæœ¬è´¨ä¸Šæ˜¯æ–‡æœ¬æ›¿æ¢ï¼Œä¸è¿›è¡Œç±»å‹æ£€æŸ¥ï¼Œä¸å—ä½œç”¨åŸŸæ§åˆ¶ï¼Œå¹¶ä¸”æ— æ³•è°ƒè¯•
- conståœ¨**è¿è¡Œæ—¶**å®šä¹‰ï¼Œå¯å®šä¹‰ä½œç”¨åŸŸï¼Œå¹¶ä¸”ä¼šè¿›è¡Œç±»å‹æ£€æŸ¥
- constexpråœ¨**ç¼–è¯‘æ—¶**è¿›è¡Œï¼Œåœ¨ç¼–è¯‘æ—¶ç›´æ¥å±•å¼€ï¼Œä¸å ç”¨å†…å­˜

---

 **å¯¹æ¯”æ€»ç»“**
| å…³é”®å­—      | ä½œç”¨èŒƒå›´  | ç±»å‹å®‰å…¨ | è®¡ç®—æ—¶æœº | æ˜¯å¦åˆ†é…å†…å­˜ | ä¸»è¦ç”¨é€” |
|------------|---------|--------|---------|------------|----------|
| `#define`  | å…¨å±€    | âŒ å¦  | é¢„å¤„ç†é˜¶æ®µ | âŒ å¦ | å®æ›¿æ¢ï¼Œç®€å•æ–‡æœ¬æ›¿æ¢ |
| `const`    | ä½œç”¨åŸŸå¯æ§ | âœ… æ˜¯  | è¿è¡Œæ—¶ï¼ˆå¯èƒ½ä¼˜åŒ–ï¼‰ | âœ… å¯èƒ½ | è¿è¡Œæ—¶å¸¸é‡ |
| `constexpr` | ä½œç”¨åŸŸå¯æ§ | âœ… æ˜¯  | ç¼–è¯‘æœŸ  | âŒ ä¸åˆ†é… | ç¼–è¯‘æœŸå¸¸é‡ï¼Œæ€§èƒ½ä¼˜åŒ– |

# æ•°ç»„å’ŒæŒ‡é’ˆçš„åŒºåˆ«
![alt text](image-104.png)

# è½¬ä¹‰å­—ç¬¦ & åŠå…¶å¯¹å­—ç¬¦äº§ç”Ÿçš„å½±å“
 **C/C++ ä¸­çš„è½¬ä¹‰å­—ç¬¦ï¼ˆEscape Sequencesï¼‰**
è½¬ä¹‰å­—ç¬¦æ˜¯ä»¥ `\` å¼€å¤´çš„ç‰¹æ®Šå­—ç¬¦åºåˆ—ï¼Œå®ƒä»¬åœ¨å­—ç¬¦ä¸²æˆ–å­—ç¬¦å¸¸é‡ä¸­è¡¨ç¤ºç‰¹æ®Šçš„å«ä¹‰ã€‚

---

## **1. å¸¸è§çš„è½¬ä¹‰å­—ç¬¦åŠå…¶ä½œç”¨**
| **è½¬ä¹‰å­—ç¬¦** | **æè¿°** | **ASCII å€¼ï¼ˆåè¿›åˆ¶ï¼‰** | **å­—ç¬¦ä¸²è¡¨ç°** |
|-------------|---------|-----------------|--------------|
| `\n` | æ¢è¡Œï¼ˆNewlineï¼‰ | 10 | ä½¿å…‰æ ‡ç§»åŠ¨åˆ°ä¸‹ä¸€è¡Œ |
| `\t` | æ°´å¹³åˆ¶è¡¨ç¬¦ï¼ˆTabï¼‰ | 9 | æ’å…¥ä¸€ä¸ªåˆ¶è¡¨ç¬¦ï¼ˆTabï¼‰ |
| `\r` | å›è½¦ï¼ˆCarriage Returnï¼‰ | 13 | ä½¿å…‰æ ‡å›åˆ°å½“å‰è¡Œå¼€å¤´ |
| `\b` | é€€æ ¼ï¼ˆBackspaceï¼‰ | 8 | åˆ é™¤å‰ä¸€ä¸ªå­—ç¬¦ |
| `\f` | æ¢é¡µï¼ˆForm feedï¼‰ | 12 | åœ¨æ‰“å°æ—¶æ¢é¡µ |
| `\v` | å‚ç›´åˆ¶è¡¨ç¬¦ï¼ˆVertical Tabï¼‰ | 11 | æ’å…¥ä¸€ä¸ªå‚ç›´åˆ¶è¡¨ç¬¦ |
| `\\` | åæ–œæ  | 92 | åœ¨å­—ç¬¦ä¸²ä¸­è¡¨ç¤º `\` æœ¬èº« |
| `\'` | å•å¼•å· | 39 | åœ¨å­—ç¬¦å¸¸é‡ä¸­è¡¨ç¤º `'` |
| `\"` | åŒå¼•å· | 34 | åœ¨å­—ç¬¦ä¸²ä¸­è¡¨ç¤º `"` |
| `\?` | é—®å· | 63 | é¿å…ä¸‰å­—ç¬¦åºåˆ—å¹²æ‰°ï¼ˆå¦‚ `??=` è¢«è§£æä¸º `#`ï¼‰ |
| `\0` | ç©ºå­—ç¬¦ï¼ˆNull Characterï¼‰ | 0 | ç»“æŸ C é£æ ¼å­—ç¬¦ä¸² |

---

## **2. å…«è¿›åˆ¶å’Œåå…­è¿›åˆ¶è½¬ä¹‰å­—ç¬¦**
### **ï¼ˆ1ï¼‰å…«è¿›åˆ¶è½¬ä¹‰å­—ç¬¦ `\ooo`**
- é‡‡ç”¨ **`\`+ä¸‰ä½å…«è¿›åˆ¶æ•°ï¼ˆ0-7 ä¹‹é—´ï¼‰** è¡¨ç¤º ASCII ç ã€‚
- **ç¤ºä¾‹ï¼š**
  ```cpp
  char ch1 = '\101';  // A (å…«è¿›åˆ¶ 101 = åè¿›åˆ¶ 65)
  char ch2 = '\123';  // S (å…«è¿›åˆ¶ 123 = åè¿›åˆ¶ 83)
  ```
- **ä½œç”¨åœ¨å­—ç¬¦ä¸²ä¸­çš„è¡¨ç°ï¼š**
  ```cpp
  char* str = "\123456";  
  printf("%s\n", str);  // S456
  ```
  - `\123` è§£æä¸º `'S'`ï¼Œåé¢çš„ `456` è¢«å½“ä½œæ™®é€šå­—ç¬¦ã€‚

### **ï¼ˆ2ï¼‰åå…­è¿›åˆ¶è½¬ä¹‰å­—ç¬¦ `\xhh`**
- é‡‡ç”¨ **`\x`+åå…­è¿›åˆ¶æ•°ï¼ˆä¸é™åˆ¶ä½æ•°ï¼‰** è¡¨ç¤º ASCII ç ã€‚
- **ç¤ºä¾‹ï¼š**
  ```cpp
  char ch1 = '\x41';  // A (åå…­è¿›åˆ¶ 41 = åè¿›åˆ¶ 65)
  char ch2 = '\xA9';  // Â© (åå…­è¿›åˆ¶ A9 = åè¿›åˆ¶ 169)
  ```
- **ä½œç”¨åœ¨å­—ç¬¦ä¸²ä¸­çš„è¡¨ç°ï¼š**
  ```cpp
  char* str = "\x41BC";  
  printf("%s\n", str);  // ABC
  ```
  - `\x41` è§£æä¸º `'A'`ï¼Œåé¢çš„ `BC` ä½œä¸ºæ™®é€šå­—ç¬¦ã€‚

---

## **3. è½¬ä¹‰å­—ç¬¦åœ¨å­—ç¬¦ä¸²ä¸­çš„è¡¨ç°**
### **ï¼ˆ1ï¼‰æ§åˆ¶å­—ç¬¦**
```cpp
#include <iostream>
using namespace std;
int main() {
    cout << "Hello\nWorld!" << endl;
    cout << "Hello\tWorld!" << endl;
    cout << "Hello\bWorld!" << endl;
    return 0;
}
```
**è¾“å‡ºï¼š**
```
Hello
World!
Hello   World!
HellWorld!
```
- `\n` æ¢è¡Œï¼Œ`\t` æ’å…¥ Tabï¼Œ`\b` é€€æ ¼ã€‚

### **ï¼ˆ2ï¼‰å…«è¿›åˆ¶/åå…­è¿›åˆ¶å­—ç¬¦**
```cpp
#include <iostream>
using namespace std;
int main() {
    cout << "\101BC" << endl;   // è¾“å‡ºï¼šABC (å…«è¿›åˆ¶ 101)
    cout << "\x41BC" << endl;   // è¾“å‡ºï¼šABC (åå…­è¿›åˆ¶ 41)
    return 0;
}
```

---

## **4. æ³¨æ„äº‹é¡¹**
1. **å…«è¿›åˆ¶å’Œåå…­è¿›åˆ¶è§£æè§„åˆ™**
   - **å…«è¿›åˆ¶ `\ooo` æœ€å¤šä¸‰ä½**ï¼Œå¤šä½™éƒ¨åˆ†è§£æä¸ºæ™®é€šå­—ç¬¦ã€‚
   - **åå…­è¿›åˆ¶ `\xhh` å¯æ— é™ä½æ•°**ï¼Œç›´åˆ°é‡åˆ°éåå…­è¿›åˆ¶å­—ç¬¦ä¸ºæ­¢ã€‚

2. **å­—ç¬¦ä¸²ç»ˆæ­¢**
   - `\0`ï¼ˆç©ºå­—ç¬¦ï¼‰ç”¨äºç»ˆæ­¢ C é£æ ¼å­—ç¬¦ä¸²ï¼š
     ```cpp
     char str[] = "Hello\0World";
     printf("%s\n", str);  // åªæ‰“å° "Hello"
     ```
   - `strlen(str)` é‡åˆ° `\0` ç»ˆæ­¢ã€‚

3. **`\r` çš„ç‰¹æ®Šæ€§**
   - `\r` ä½¿å…‰æ ‡å›åˆ°è¡Œé¦–ï¼Œä¸æ¢è¡Œï¼š
     ```cpp
     cout << "Hello\rWorld!" << endl;
     ```
     **å¯èƒ½è¾“å‡º**ï¼ˆç»ˆç«¯ä¾èµ–ï¼‰ï¼š
     ```
     World!
     ```

---

### **æ€»ç»“**
- **`\n, \t, \b, \r, \0`** æ§åˆ¶å­—ç¬¦å½±å“æ–‡æœ¬å¸ƒå±€ã€‚
- **`\\, \', \", \?`** å¤„ç†ç‰¹æ®Šç¬¦å·ã€‚
- **`\ooo, \xhh`** ç”¨äºç›´æ¥è¡¨ç¤º ASCII ç å€¼ã€‚
- **å…«è¿›åˆ¶** è½¬ä¹‰å­—ç¬¦æœ€å¤š 3 ä½ï¼Œè€Œ **åå…­è¿›åˆ¶** æ²¡æœ‰é™åˆ¶ã€‚


# extern
![alt text](image-105.png)
> extern "C"å‘Šè¯‰ç¼–è¯‘å™¨æŒ‰ç…§Cè¯­è¨€çš„è§„åˆ™æ¥å¤„ç†ï¼Œå› ä¸ºcä¸æ”¯æŒå‡½æ•°é‡è½½ï¼Œè€Œc++æ”¯æŒå¹¶ä¸”ä¼šåŠ ä¸Šä¸€äº›é¢å¤–çš„ä¿¡æ¯æ¥è¿›è¡Œä¿®é¥°ä»¥åŒºåˆ†ä¸åŒå‡½æ•°ï¼Œæ‰€ä»¥ä¼šé€ æˆè°ƒç”¨ä¸æ”¯æŒ
![alt text](image-106.png)

# final
- ä¿®é¥°ç±»ï¼Œç±»ä¸å¯è¢«ç»§æ‰¿
- ä¿®é¥°è™šå‡½æ•°ï¼Œè¯¥è™šå‡½æ•°ä¸å¯è¢«æ´¾ç”Ÿç±»é‡å†™

# using & typedef & typename
éƒ½å¯ä»¥ç”¨æ¥å®šä¹‰ç±»å‹åˆ«åï¼Œä½†æ˜¯usingå¯ä»¥å®šä¹‰æ¨¡æ¿åˆ«åè€Œtypenameä¸å¯ä»¥

# memcpy & memmove
- memcpyï¼Œä¸å¤„ç†åœ°å€é‡å ï¼Œä»æºåœ°å€å¤åˆ¶æŒ‡å®šç›´æ¥åˆ°ç›®æ ‡åœ°å€ï¼Œå¦‚æœæºåœ°å€å’Œç›®æ ‡åœ°å€é‡å åˆ™è¡Œä¸ºæ˜¯æœªå®šä¹‰çš„
- memmoveï¼Œ å¤„ç†åœ°å€é‡å 

# NULL & nullptr
NULLåœ¨c++ä¸­ç›´æ¥defineä¸º0ï¼Œè€Œnullptræ˜¯nullptr_tç±»å‹ï¼Œå½“å­˜åœ¨ç±»å‹é‡è½½çš„æ—¶å€™å¦‚æœä½¿ç”¨NULLï¼Œé‡è½½è°ƒç”¨ä¼ å…¥å‚æ•°NULLå¯èƒ½å¯¼è‡´è°ƒç”¨é”™è¯¯çš„é‡è½½ï¼Œæ‰€ä»¥å»ºè®®ä½¿ç”¨nullptr
> int print(int a)
> int print(void* ptr)
> å¦‚æœä¼ å…¥çš„æ˜¯NULLè°ƒç”¨å“ªä¸€ä¸ªå‘¢

# atomic<T>
`std::atomic` æ˜¯ C++11 å¼•å…¥çš„ä¸€ä¸ªæ¨¡æ¿ç±»ï¼Œç”¨äºæä¾›å¯¹å…±äº«æ•°æ®çš„åŸå­æ“ä½œï¼Œä¿è¯å¤šçº¿ç¨‹ç¨‹åºä¸­çš„æ•°æ®ä¸€è‡´æ€§å’Œçº¿ç¨‹å®‰å…¨ã€‚ä¸ä¼ ç»Ÿçš„é”æœºåˆ¶ï¼ˆå¦‚äº’æ–¥é”ï¼‰ä¸åŒï¼Œ`std::atomic` é€šè¿‡åŸå­æ“ä½œç›´æ¥å¯¹æ•°æ®è¿›è¡Œæ“ä½œï¼Œé¿å…äº†é”çš„å¼€é”€ï¼Œèƒ½å¤Ÿæé«˜æ€§èƒ½ã€‚
## ä½¿ç”¨æ–¹å¼
### åŸå­æ“ä½œçš„åŸºæœ¬æ¦‚å¿µ

åŸå­æ“ä½œæ˜¯æŒ‡æ“ä½œåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸ä¼šè¢«ä¸­æ–­çš„æ“ä½œã€‚å¯¹äºå¤šçº¿ç¨‹ç¨‹åºæ¥è¯´ï¼ŒåŸå­æ“ä½œå¯ä»¥ç¡®ä¿æŸä¸ªçº¿ç¨‹åœ¨æ‰§è¡ŒæŸä¸ªæ“ä½œæ—¶ä¸ä¼šè¢«å…¶ä»–çº¿ç¨‹å¹²æ‰°ã€‚å› æ­¤ï¼Œ`std::atomic` æä¾›äº†ä¸€äº›ä¿è¯åŸå­æ€§çš„åŸºæœ¬æ“ä½œã€‚

### `std::atomic` çš„ä½¿ç”¨æ–¹å¼

`std::atomic` å¯ä»¥ç”¨æ¥å£°æ˜ä¸€ä¸ªç±»å‹ä¸ºåŸå­çš„å˜é‡ã€‚å®ƒå¯ä»¥ç”¨äºå†…ç½®ç±»å‹ï¼ˆå¦‚ `int`, `bool`, `float` ç­‰ï¼‰ï¼Œæˆ–è€…è‡ªå®šä¹‰ç±»å‹ï¼ˆå¦‚ `std::atomic<MyType>`ï¼‰ã€‚åœ¨è¿›è¡ŒåŸå­æ“ä½œæ—¶ï¼Œ`std::atomic` ä¼šç¡®ä¿æ“ä½œæ˜¯åŸå­çš„ï¼Œä¸ä¼šè¢«å…¶ä»–çº¿ç¨‹å¹²æ‰°ã€‚

### å¸¸ç”¨çš„ `std::atomic` æ–¹æ³•

ä»¥ä¸‹æ˜¯ `std::atomic` ç±»å¸¸ç”¨çš„ä¸€äº›æˆå‘˜å‡½æ•°åŠå…¶è¯´æ˜ï¼š

1. **æ„é€ å‡½æ•°**ï¼š
   - `std::atomic<T>()`ï¼šæ„é€ ä¸€ä¸ªç©ºçš„åŸå­å˜é‡ã€‚
   - `std::atomic<T>(T value)`ï¼šæ„é€ ä¸€ä¸ªå€¼ä¸º `value` çš„åŸå­å˜é‡ã€‚

2. **åŸºæœ¬æ“ä½œ**ï¼š
   - `T load(std::memory_order order = std::memory_order_seq_cst)`ï¼š
     - ä»åŸå­å¯¹è±¡ä¸­è¯»å–å€¼ã€‚`order` å‚æ•°ç”¨äºæ§åˆ¶å†…å­˜é¡ºåºï¼Œé»˜è®¤æ˜¯ `std::memory_order_seq_cst`ã€‚
   - `void store(T value, std::memory_order order = std::memory_order_seq_cst)`ï¼š
     - å°† `value` å­˜å‚¨åˆ°åŸå­å¯¹è±¡ä¸­ï¼Œ`order` æ§åˆ¶å­˜å‚¨çš„å†…å­˜é¡ºåºã€‚
   - `T exchange(T value, std::memory_order order = std::memory_order_seq_cst)`ï¼š
     - å°†åŸå­å¯¹è±¡çš„å€¼æ›¿æ¢ä¸º `value`ï¼Œå¹¶è¿”å›åŸæ¥çš„å€¼ã€‚`order` æ§åˆ¶å†…å­˜é¡ºåºã€‚
   - `bool compare_exchange_weak(T& expected, T desired, std::memory_order success_order, std::memory_order failure_order)`ï¼š
     - æ¯”è¾ƒåŸå­å˜é‡çš„å€¼æ˜¯å¦ç­‰äº `expected`ï¼Œå¦‚æœæ˜¯ï¼Œå°†å…¶å€¼è®¾ç½®ä¸º `desired`ï¼Œå¦åˆ™å°†å½“å‰å€¼å­˜å‚¨åˆ° `expected` ä¸­ã€‚`success_order` å’Œ `failure_order` æ§åˆ¶å†…å­˜é¡ºåºã€‚`compare_exchange_weak` ä¼šå¤±è´¥å¹¶é‡è¯•ï¼Œé€‚ç”¨äºéœ€è¦å¤šæ¬¡å°è¯•çš„åœºæ™¯ã€‚

3. **ç®—æœ¯æ“ä½œ**ï¼š
   - `T fetch_add(T arg, std::memory_order order = std::memory_order_seq_cst)`ï¼š
     - å°†åŸå­å¯¹è±¡çš„å€¼åŠ ä¸Š `arg`ï¼Œå¹¶è¿”å›åŸæ¥çš„å€¼ã€‚`order` æ§åˆ¶å†…å­˜é¡ºåºã€‚
   - `T fetch_sub(T arg, std::memory_order order = std::memory_order_seq_cst)`ï¼š
     - ä»åŸå­å¯¹è±¡çš„å€¼ä¸­å‡å» `arg`ï¼Œå¹¶è¿”å›åŸæ¥çš„å€¼ã€‚`order` æ§åˆ¶å†…å­˜é¡ºåºã€‚

4. **å…¶ä»–å¸¸ç”¨æ–¹æ³•**ï¼š
   - `bool is_lock_free()`ï¼š
     - æ£€æŸ¥å½“å‰åŸå­æ“ä½œæ˜¯å¦æ˜¯é”è‡ªç”±çš„ã€‚å¦‚æœç¡¬ä»¶æ¶æ„æ”¯æŒåŸå­æ“ä½œï¼ˆä¾‹å¦‚ x86ï¼‰ï¼Œé‚£ä¹ˆè¿™äº›æ“ä½œå°±å¯èƒ½æ˜¯é”è‡ªç”±çš„ã€‚

### å†…å­˜é¡ºåºï¼ˆMemory Orderï¼‰

`std::atomic` æä¾›äº†ä¸åŒçš„å†…å­˜é¡ºåºé€‰é¡¹ï¼Œæ§åˆ¶æ“ä½œçš„å†…å­˜å¯è§æ€§ã€‚å†…å­˜é¡ºåºå†³å®šäº†æ“ä½œåœ¨å¤šä¸ªçº¿ç¨‹ä¸­çš„æ‰§è¡Œé¡ºåºï¼Œç¡®ä¿äº†æ•°æ®åŒæ­¥çš„ä¸€è‡´æ€§ã€‚C++ ä¸­å¸¸ç”¨çš„å†…å­˜é¡ºåºæœ‰ï¼š

- `std::memory_order_relaxed`ï¼šä¸æä¾›ä»»ä½•åŒæ­¥ä¿è¯ï¼Œä»…ä¿è¯åŸå­æ“ä½œçš„åŸå­æ€§ã€‚
- `std::memory_order_consume`ï¼šä¿è¯ä¾èµ–äºæ­¤æ“ä½œçš„å…¶ä»–æ“ä½œæŒ‰ç…§é¡ºåºæ‰§è¡Œï¼Œä½†è¿™åœ¨ç°ä»£ç¼–è¯‘å™¨ä¸­é€šå¸¸ä¼šè¢«è½¬æ¢ä¸º `std::memory_order_acquire`ã€‚
- `std::memory_order_acquire`ï¼šä¿è¯è¯¥æ“ä½œä¹‹å‰çš„æ‰€æœ‰æ“ä½œéƒ½åœ¨è¯¥æ“ä½œä¹‹åæ‰§è¡Œã€‚
- `std::memory_order_release`ï¼šä¿è¯è¯¥æ“ä½œä¹‹åçš„æ‰€æœ‰æ“ä½œéƒ½åœ¨è¯¥æ“ä½œä¹‹å‰æ‰§è¡Œã€‚
- `std::memory_order_acq_rel`ï¼šåŒæ—¶æ‹¥æœ‰ `acquire` å’Œ `release` çš„ä¿è¯ã€‚
- `std::memory_order_seq_cst`ï¼šæœ€å¼ºçš„é¡ºåºä¿è¯ï¼Œä¿è¯ä¸¥æ ¼çš„é¡ºåºä¸€è‡´æ€§ã€‚

### ç¤ºä¾‹ä»£ç 

ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„å¤šçº¿ç¨‹ç¤ºä¾‹ï¼Œæ¼”ç¤ºäº†å¦‚ä½•ä½¿ç”¨ `std::atomic` æ¥ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚

```cpp
#include <iostream>
#include <atomic>
#include <thread>

std::atomic<int> counter(0);  // ä½¿ç”¨ std::atomic æ¥ä¿è¯çº¿ç¨‹å®‰å…¨

void increment() {
    for (int i = 0; i < 1000; ++i) {
        counter.fetch_add(1, std::memory_order_relaxed);  // åŸå­åœ°é€’å¢
    }
}

int main() {
    std::thread t1(increment);  // åˆ›å»ºç¬¬ä¸€ä¸ªçº¿ç¨‹
    std::thread t2(increment);  // åˆ›å»ºç¬¬äºŒä¸ªçº¿ç¨‹

    t1.join();  // ç­‰å¾…çº¿ç¨‹1å®Œæˆ
    t2.join();  // ç­‰å¾…çº¿ç¨‹2å®Œæˆ

    std::cout << "Final counter value: " << counter.load() << std::endl;  // è¾“å‡ºç»“æœ

    return 0;
}
```

### è§£é‡Šï¼š

- `counter` æ˜¯ä¸€ä¸ªåŸå­æ•´æ•°ï¼Œç¡®ä¿åœ¨å¤šä¸ªçº¿ç¨‹ä¸­å¯¹å…¶çš„è®¿é—®æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚
- `fetch_add(1, std::memory_order_relaxed)` æ˜¯ä¸€ä¸ªåŸå­æ“ä½œï¼Œç”¨äºé€’å¢ `counter`ã€‚
- `load()` ç”¨äºè¯»å–åŸå­å˜é‡çš„å€¼ã€‚
- `std::memory_order_relaxed` è¡¨ç¤ºä¸åšåŒæ­¥ä¿è¯ï¼Œæ€§èƒ½è¾ƒå¥½ï¼Œä½†éœ€å°å¿ƒä½¿ç”¨ï¼Œä»¥é¿å…ç«æ€æ¡ä»¶ã€‚

### é”è‡ªç”±ï¼ˆLock-Freeï¼‰æ“ä½œ

`std::atomic` è¿˜å…è®¸æˆ‘ä»¬æ£€æŸ¥åŸå­æ“ä½œæ˜¯å¦æ˜¯é”è‡ªç”±çš„ï¼Œè¿™å–å†³äºåº•å±‚ç¡¬ä»¶æ¶æ„å’Œæ“ä½œç³»ç»Ÿã€‚ä¾‹å¦‚ï¼Œ`std::atomic::is_lock_free()` å¯ä»¥ç”¨æ¥æ£€æŸ¥åŸå­æ“ä½œæ˜¯å¦æ— éœ€åŠ é”å°±å¯ä»¥ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚

### æ€»ç»“

- `std::atomic` æä¾›äº†å¯¹åŸºæœ¬æ•°æ®ç±»å‹çš„åŸå­æ“ä½œæ”¯æŒï¼Œç¡®ä¿å¤šçº¿ç¨‹ç¯å¢ƒä¸‹æ•°æ®çš„ä¸€è‡´æ€§ã€‚
- `std::atomic` å¯ä»¥ç”¨äºåŸå­åœ°è¿›è¡ŒåŠ å‡ã€äº¤æ¢ã€æ¯”è¾ƒå’Œäº¤æ¢ç­‰æ“ä½œï¼Œé¿å…ä½¿ç”¨é”å¸¦æ¥çš„æ€§èƒ½å¼€é”€ã€‚
- å†…å­˜é¡ºåºï¼ˆ`memory_order_*`ï¼‰ç”¨äºæ§åˆ¶åŸå­æ“ä½œçš„æ‰§è¡Œé¡ºåºï¼Œç¡®ä¿æ•°æ®åŒæ­¥çš„æ­£ç¡®æ€§ã€‚
- åŸå­æ“ä½œæ”¯æŒçš„æ˜¯â€œé”è‡ªç”±â€çš„æ“ä½œï¼Œèƒ½å¤Ÿæé«˜å¹¶å‘æ€§èƒ½ã€‚

`std::atomic` æ˜¯ C++11 ä¸­æä¾›çš„å¼ºå¤§å·¥å…·ï¼Œèƒ½å¤Ÿå¸®åŠ©å¼€å‘è€…æ›´é«˜æ•ˆåœ°å¤„ç†å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­çš„å…±äº«æ•°æ®è®¿é—®é—®é¢˜ï¼Œç‰¹åˆ«æ˜¯åœ¨æ€§èƒ½è¦æ±‚é«˜çš„åœºæ™¯ä¸‹ã€‚

## åº•å±‚å®ç°
`std::atomic` æ˜¯ C++ æ ‡å‡†åº“ä¸­æä¾›çš„ä¸€ç§åŸå­ç±»å‹ï¼Œç”¨äºæ”¯æŒå¤šçº¿ç¨‹ç¼–ç¨‹ä¸­çš„åŸå­æ“ä½œï¼Œç¡®ä¿åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­å¯¹æ•°æ®çš„è®¿é—®ä¸ä¼šå‘ç”Ÿç«æ€æ¡ä»¶ã€‚å…¶å®ç°æ–¹å¼å’ŒåŸç†æ¶‰åŠåˆ°å¤šç§ç¡¬ä»¶å’Œæ“ä½œç³»ç»Ÿçš„åº•å±‚æœºåˆ¶ï¼Œå…·ä½“å¦‚ä½•å®ç° `atomic` ä¾èµ–äºç¡¬ä»¶çš„åŸå­æ“ä½œæŒ‡ä»¤ã€å†…å­˜æ¨¡å‹ä»¥åŠç¼–è¯‘å™¨çš„æ”¯æŒã€‚

### 1. **åŸå­æ“ä½œçš„åŸºæœ¬æ¦‚å¿µ**

åŸå­æ“ä½œæŒ‡çš„æ˜¯ä¸å¯åˆ†å‰²çš„æ“ä½œï¼Œè¦ä¹ˆå®Œå…¨æ‰§è¡Œï¼Œè¦ä¹ˆå®Œå…¨ä¸æ‰§è¡Œã€‚å¯¹äºå¤šçº¿ç¨‹ç¨‹åºï¼ŒåŸå­æ“ä½œä¿è¯äº†åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸ä¼šè¢«çº¿ç¨‹è°ƒåº¦æˆ–ä¸­æ–­ï¼Œé¿å…äº†ç«æ€æ¡ä»¶ã€‚å¸¸è§çš„åŸå­æ“ä½œæœ‰ï¼šè¯»å–ã€å†™å…¥ã€åŠ æ³•ã€å‡æ³•ã€äº¤æ¢ç­‰ã€‚

### 2. **ç¡¬ä»¶æ”¯æŒçš„åŸå­æ“ä½œ**

åœ¨ç¡¬ä»¶å±‚é¢ï¼Œè®¸å¤šç°ä»£å¤„ç†å™¨æ¶æ„ï¼ˆå¦‚ x86, ARM, PowerPC ç­‰ï¼‰æä¾›äº†åŸå­æŒ‡ä»¤ã€‚è¿™äº›æŒ‡ä»¤å…è®¸å¯¹å†…å­˜ä¸­çš„æ•°æ®è¿›è¡ŒåŸå­æ€§çš„è¯»å†™ï¼Œå¸¸è§çš„åŸå­æŒ‡ä»¤æœ‰ï¼š
- **Compare-and-Swap (CAS)** æˆ– **Compare-and-Set (CAS)**: æ¯”è¾ƒå†…å­˜ä¸­çš„å€¼ä¸é¢„æœŸå€¼æ˜¯å¦ç›¸ç­‰ï¼Œå¦‚æœç›¸ç­‰åˆ™å°†å…¶æ›´æ–°ä¸ºæ–°å€¼ï¼Œå¦åˆ™ä¸åšä»»ä½•æ“ä½œã€‚
- **Fetch-and-Add**: å°†å†…å­˜ä¸­çš„å€¼å¢åŠ æŸä¸ªé‡å¹¶è¿”å›æ—§å€¼ã€‚
- **Load-Link/Store-Conditional (LL/SC)**: ä¸€äº›æ¶æ„ï¼ˆå¦‚ ARM å’Œ PowerPCï¼‰æä¾›çš„æœºåˆ¶ï¼Œå…è®¸çº¿ç¨‹è¯»å–å€¼å¹¶é”å®šè¯¥å€¼ï¼Œå¦‚æœåœ¨åç»­å†™å…¥æ—¶æ²¡æœ‰å…¶ä»–çº¿ç¨‹ä¿®æ”¹è¯¥å€¼ï¼Œåˆ™å†™å…¥æ“ä½œæ‰ä¼šæˆåŠŸã€‚

è¿™äº›åŸå­æŒ‡ä»¤æ˜¯ `std::atomic` å®ç°çš„åŸºç¡€ï¼Œç¼–è¯‘å™¨å’Œæ“ä½œç³»ç»Ÿçš„åŸå­æ“ä½œå¾€å¾€æ˜¯åŸºäºè¿™äº›ç¡¬ä»¶æŒ‡ä»¤æ¥å®ç°çš„ã€‚

### 3. **å†…å­˜æ¨¡å‹å’ŒåŒæ­¥**

`std::atomic` å¿…é¡»éµå¾ªç‰¹å®šçš„å†…å­˜æ¨¡å‹ï¼Œä»¥ç¡®ä¿åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­çº¿ç¨‹é—´çš„å¯è§æ€§å’Œé¡ºåºæ€§ã€‚C++11 å¼•å…¥äº† **C++å†…å­˜æ¨¡å‹**ï¼Œå…¶æ ¸å¿ƒæ˜¯ **é¡ºåºä¸€è‡´æ€§**ï¼ˆsequential consistencyï¼‰å’Œ **å†…å­˜å±éšœ**ã€‚

- **å†…å­˜å±éšœï¼ˆMemory Barriersï¼‰**ï¼šä¸ºäº†ä¿è¯åŸå­æ“ä½œçš„æ­£ç¡®é¡ºåºï¼Œ`std::atomic` æ“ä½œä¼šé€šè¿‡å†…å­˜å±éšœæ¥é™åˆ¶ CPU å¯¹å†…å­˜æ“ä½œçš„é‡æ’åºã€‚ä¸åŒçš„å†…å­˜é¡ºåºï¼ˆå¦‚ `std::memory_order_acquire`ã€`std::memory_order_release` å’Œ `std::memory_order_seq_cst`ï¼‰ä¼šåœ¨ä¸åŒçš„åœºæ™¯ä¸‹æ’å…¥ä¸åŒç±»å‹çš„å†…å­˜å±éšœã€‚
  
- **åŸå­æ“ä½œå†…å­˜é¡ºåº**ï¼š
  - `std::memory_order_relaxed`ï¼šä¸ä¿è¯åŒæ­¥æˆ–é¡ºåºæ€§ï¼Œä»…ä¿è¯æ“ä½œçš„åŸå­æ€§ã€‚
  - `std::memory_order_consume`ï¼šä»…ä¿è¯ä¾èµ–å…³ç³»ã€‚
  - `std::memory_order_acquire`ï¼šä¿è¯æ‰€æœ‰å‰ç½®æ“ä½œå…ˆäºè¯¥æ“ä½œæ‰§è¡Œã€‚
  - `std::memory_order_release`ï¼šä¿è¯æ‰€æœ‰åç»­æ“ä½œåœ¨è¯¥æ“ä½œåæ‰§è¡Œã€‚
  - `std::memory_order_acq_rel`ï¼šåŒæ—¶åŒ…å« `acquire` å’Œ `release` çš„è¯­ä¹‰ã€‚
  - `std::memory_order_seq_cst`ï¼šä¿è¯ä¸¥æ ¼çš„å…¨åºä¸€è‡´æ€§ã€‚

### 4. **`std::atomic`çš„å®ç°**

`std::atomic` çš„å®ç°é€šå¸¸ä¾èµ–äºåº•å±‚çš„ç¡¬ä»¶åŸå­æŒ‡ä»¤ã€‚å¯¹äºä¸åŒçš„æ“ä½œç³»ç»Ÿå’Œç¡¬ä»¶æ¶æ„ï¼Œ`std::atomic` å¯èƒ½ä¼šæœ‰ä¸åŒçš„å®ç°ã€‚å¤§å¤šæ•°ç°ä»£ç¼–è¯‘å™¨ï¼ˆå¦‚ GCCã€Clangã€MSVCï¼‰ä¼šé€šè¿‡ç‰¹å®šçš„å†…è”æ±‡ç¼–æˆ–è€…å†…å­˜å±éšœæŒ‡ä»¤æ¥å®ç° `std::atomic` æ“ä½œã€‚

#### ä»¥ `std::atomic<int>` ä¸ºä¾‹ï¼š

1. **å†…å­˜æ“ä½œ**ï¼š`std::atomic<int>` çš„å†…éƒ¨å®ç°é€šå¸¸ä¼šä½¿ç”¨ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘æ•´æ•°æ•°æ®ï¼Œå¹¶é€šè¿‡åŸå­æŒ‡ä»¤æ¥ä¿è¯è¯¥æ•´æ•°çš„æ“ä½œæ˜¯åŸå­çš„ã€‚ä¾‹å¦‚ï¼Œå¯èƒ½ä¼šä½¿ç”¨ `Compare-and-Swap (CAS)` æ¥å®ç°åŸå­è¯»å–å’Œä¿®æ”¹ã€‚
   
2. **åŒæ­¥å’Œé¡ºåº**ï¼šåŸå­æ“ä½œçš„é¡ºåºæ§åˆ¶é€šå¸¸ä¼šé€šè¿‡å†…å­˜å±éšœæˆ–ç¡¬ä»¶æ”¯æŒçš„ç‰¹æ€§æ¥å®ç°ã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨ `std::memory_order_acquire` æ—¶ï¼Œç¼–è¯‘å™¨ä¼šåœ¨è¯»å–æ“ä½œå‰æ’å…¥å†…å­˜å±éšœï¼Œç¡®ä¿å¯¹å‰é¢æ“ä½œçš„ä¿®æ”¹å¯¹å…¶ä»–çº¿ç¨‹å¯è§ã€‚

3. **é”çš„ä½¿ç”¨**ï¼šåœ¨æŸäº›å¹³å°ï¼ŒåŸå­æ“ä½œå¯èƒ½ä¼šé€šè¿‡æŸäº›åº•å±‚çš„åŒæ­¥æœºåˆ¶æ¥ä¿è¯ä¸€è‡´æ€§ï¼Œå°½ç®¡å¤§å¤šæ•°ç°ä»£å¹³å°çš„åŸå­æ“ä½œå¹¶ä¸ä¾èµ–ä¼ ç»Ÿçš„äº’æ–¥é”ã€‚ä½†åœ¨ä¸€äº›ä¸æ”¯æŒç¡¬ä»¶åŸå­æ“ä½œçš„å¹³å°ä¸Šï¼Œ`std::atomic` å¯èƒ½ä¼šé€€åŒ–ä¸ºä½¿ç”¨äº’æ–¥é”æ¥åŒæ­¥ã€‚

#### æ ¸å¿ƒä»£ç ç¤ºä¾‹ï¼š

```cpp
template<typename T>
class atomic {
public:
    T load(std::memory_order order = std::memory_order_seq_cst) const {
        T expected;
        // ä½¿ç”¨ç¡¬ä»¶æ”¯æŒçš„åŸå­æ“ä½œè¯»å–æ•°æ®
        __atomic_load(&data, &expected, order);
        return expected;
    }

    void store(T value, std::memory_order order = std::memory_order_seq_cst) {
        // ä½¿ç”¨ç¡¬ä»¶æ”¯æŒçš„åŸå­æ“ä½œå­˜å‚¨æ•°æ®
        __atomic_store(&data, &value, order);
    }

    bool compare_exchange_strong(T& expected, T desired, 
                                  std::memory_order order = std::memory_order_seq_cst) {
        // ä½¿ç”¨CASæŒ‡ä»¤è¿›è¡Œæ¯”è¾ƒå¹¶äº¤æ¢
        return __atomic_compare_exchange(&data, &expected, &desired, false, order, order);
    }

private:
    T data;
};
```

åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œ`load`ã€`store` å’Œ `compare_exchange_strong` ç­‰å‡½æ•°éƒ½ä¾èµ–äºåº•å±‚çš„åŸå­æ“ä½œï¼ˆå¦‚ `__atomic_load`ã€`__atomic_store` å’Œ `__atomic_compare_exchange`ï¼‰æ¥ä¿è¯æ•°æ®çš„åŸå­æ€§å’ŒåŒæ­¥é¡ºåºã€‚

### 5. **`std::atomic` å®ç°çš„çº¿ç¨‹å®‰å…¨æ€§**

- **çº¿ç¨‹å®‰å…¨æ€§**ï¼š`std::atomic` æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼ŒåŸå­æ“ä½œé€šè¿‡ç¡¬ä»¶æˆ–æ“ä½œç³»ç»Ÿçš„æ”¯æŒç¡®ä¿ä¸ä¼šå‘ç”Ÿæ•°æ®ç«äº‰ã€‚å½“ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶å¯¹åŒä¸€ `std::atomic` å˜é‡è¿›è¡Œæ“ä½œæ—¶ï¼Œæ“ä½œä¼šåœ¨åº•å±‚é€šè¿‡ç¡¬ä»¶åŸå­æ“ä½œæˆ–é”è¿›è¡ŒåŒæ­¥ï¼Œç¡®ä¿æ•°æ®çš„æ­£ç¡®æ€§ã€‚
  
- **æ€§èƒ½è€ƒè™‘**ï¼šä½¿ç”¨åŸå­æ“ä½œé€šå¸¸æ¯”ä½¿ç”¨äº’æ–¥é”ï¼ˆå¦‚ `std::mutex`ï¼‰æ•ˆç‡æ›´é«˜ï¼Œä½†åœ¨é«˜å¹¶å‘ç¯å¢ƒä¸‹ï¼Œå¦‚æœé¢‘ç¹åœ°ä¿®æ”¹åŒä¸€ä¸ªåŸå­å˜é‡ï¼Œå¯èƒ½ä¼šå‡ºç°æ€§èƒ½ç“¶é¢ˆã€‚é€šå¸¸ï¼Œ`std::atomic` é€‚åˆç”¨äºè®¡æ•°å™¨ã€æ ‡å¿—ä½ç­‰å°ç²’åº¦çš„æ•°æ®åŒæ­¥ã€‚

### æ€»ç»“ï¼š

`std::atomic` çš„å®ç°ä¾èµ–äºç¡¬ä»¶çš„åŸå­æŒ‡ä»¤å’Œæ“ä½œç³»ç»Ÿçš„æ”¯æŒã€‚å®ƒé€šè¿‡åˆ©ç”¨åº•å±‚çš„åŸå­æŒ‡ä»¤ï¼ˆå¦‚ CASï¼‰å’Œå†…å­˜å±éšœæ¥ç¡®ä¿å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„æ•°æ®ä¸€è‡´æ€§å’ŒåŒæ­¥æ€§ã€‚`std::atomic` æä¾›äº†é«˜æ•ˆçš„çº¿ç¨‹å®‰å…¨åŸå­æ“ä½œï¼Œæ˜¯å®ç°é«˜æ•ˆå¹¶å‘æ§åˆ¶çš„æ ¸å¿ƒå·¥å…·ã€‚


## atomicå®ç°è¯»å†™é”
å¥½çš„ï¼Œä¸‹é¢æˆ‘æ¥ç”¨ **C++11 çš„åŸå­å˜é‡ï¼ˆ`std::atomic`ï¼‰** å®ç°ä¸€ä¸ªç®€æ˜“çš„è¯»å†™é”ï¼ˆ**Read-Write Lock / Shared Mutex**ï¼‰ã€‚  
è¿™ä¸ªç‰ˆæœ¬æ”¯æŒï¼š
- **å¤šä¸ªçº¿ç¨‹å¹¶å‘è¯»å–**ï¼ˆè¯»é”å…±äº«ï¼‰ï¼›
- **å†™æ—¶ç‹¬å **ï¼ˆå†™é”äº’æ–¥ï¼‰ï¼›
- å†™é”éœ€è¦ç­‰æ‰€æœ‰è¯»é”é‡Šæ”¾åæ‰èƒ½è·å¾—ã€‚

---

### âœ… å®ç°åŸç†ç®€è¿°

æˆ‘ä»¬ç”¨ä¸€ä¸ª `std::atomic<int>` æ¥è¡¨ç¤ºé”çš„çŠ¶æ€ï¼š

- `> 0`ï¼šè¡¨ç¤ºæœ‰ n ä¸ªè¯»è€…æ­£åœ¨è¯»ï¼›
- `== 0`ï¼šæ— äººè®¿é—®ï¼›
- `== -1`ï¼šå½“å‰æœ‰ä¸€ä¸ªå†™è€…æŒæœ‰å†™é”ï¼Œç‹¬å çŠ¶æ€ã€‚

é€šè¿‡ `compare_exchange` åŸå­åœ°è¿›è¡ŒåŠ é”/è§£é”ã€‚

---

### ğŸ§© ä»£ç å®ç°ï¼š`RWLock`

```cpp
#include <atomic>
#include <thread>
#include <iostream>

class RWLock {
private:
    std::atomic<int> count;  // >0: è¯»è€…æ•°; ==-1: å†™è€…ç‹¬å 

public:
    RWLock() : count(0) {}

    // è·å–è¯»é”
    void lock_shared() {
        while (true) {
            int expected = count.load();
            // å¦‚æœæ²¡æœ‰å†™è€…ï¼Œå°è¯•åŠ 1
            if (expected >= 0) {
                if (count.compare_exchange_weak(expected, expected + 1)) {
                    return;
                }
            }
            std::this_thread::yield(); // æ”¾å¼ƒCPUï¼Œé¿å…æ­»å¾ªç¯
        }
    }

    // é‡Šæ”¾è¯»é”
    void unlock_shared() {
        count.fetch_sub(1);
    }

    // è·å–å†™é”
    void lock() {
        while (true) {
            int expected = 0;
            // åªæœ‰åœ¨æ²¡äººè¯»æ²¡äººå†™çš„æƒ…å†µä¸‹è®¾ç½®ä¸º -1
            if (count.compare_exchange_weak(expected, -1)) {
                return;
            }
            std::this_thread::yield();
        }
    }

    // é‡Šæ”¾å†™é”
    void unlock() {
        count.store(0);
    }
};
```

---

### ğŸš€ ä½¿ç”¨ç¤ºä¾‹

```cpp
RWLock rwlock;

void reader(int id) {
    rwlock.lock_shared();
    std::cout << "Reader " << id << " reading...\n";
    std::this_thread::sleep_for(std::chrono::milliseconds(100));
    rwlock.unlock_shared();
}

void writer(int id) {
    rwlock.lock();
    std::cout << "Writer " << id << " writing...\n";
    std::this_thread::sleep_for(std::chrono::milliseconds(200));
    rwlock.unlock();
}
```

ä½ å¯ä»¥åˆ›å»ºå¤šä¸ª `std::thread` åˆ†åˆ«è°ƒç”¨ `reader()` å’Œ `writer()` æ¥æµ‹è¯•è¯»å†™äº’æ–¥æ€§ã€‚

---

### âš ï¸ æ³¨æ„ç‚¹

- è¿™ä¸ªè¯»å†™é”æ˜¯**è½»é‡çº§çš„è½®è¯¢è‡ªæ—‹é”**ï¼Œé€‚ç”¨äºé”ç«äº‰ä¸æ¿€çƒˆçš„åœºæ™¯ï¼›
- ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨ç³»ç»Ÿå®ç°çš„ `std::shared_mutex`ï¼ˆC++17ï¼‰ï¼›
- å†™è€…ä¼š **é¥¿æ­»**ï¼ˆå¤§é‡è¯»é”æ—¶å†™é”éš¾ä»¥è·å¾—ï¼‰ï¼Œå¯ä»¥é¢å¤–åŠ æ ‡å¿—æˆ–é˜Ÿåˆ—é¿å…ã€‚

---

å¦‚æœä½ å¸Œæœ›æ”¯æŒ **å¯å‡çº§é”ï¼ˆå‡çº§è¯»ä¸ºå†™ï¼‰** æˆ–å®ç° **å…¬å¹³è°ƒåº¦æœºåˆ¶**ï¼Œä¹Ÿå¯ä»¥ç»§ç»­æ‰©å±•è¿™ä¸ªç»“æ„ã€‚æˆ‘å¯ä»¥å¸®ä½ å®ç°æ›´å®Œæ•´çš„ç‰ˆæœ¬ ğŸ˜

éœ€è¦æˆ‘ç»§ç»­ä¼˜åŒ–è¿™ä¸ªè¯»å†™é”ï¼Œæˆ–åŠ ä¸Šå¯å‡çº§é”ç‰ˆæœ¬å—ï¼Ÿ

## atomicå®ç°æ— é”é˜Ÿåˆ—
ä»¥ä¸‹æ˜¯ä½¿ç”¨ `std::atomic` æ•°ç»„å®ç°æ— é”é˜Ÿåˆ—çš„æ ¸å¿ƒä»£ç ä¸è®¾è®¡æ€è·¯ï¼Œç»“åˆäº†å¤šç¯‡æŠ€æœ¯åšå®¢å’Œè®ºæ–‡çš„å®ç°åŸç†ï¼š

---

### ä¸€ã€æ•°æ®ç»“æ„è®¾è®¡
```cpp
#include <atomic>
#include <vector>

template <typename T, size_t Capacity = 65535>
class LockFreeArrayQueue {
private:
    std::vector<T> buffer;          // å­˜å‚¨å…ƒç´ çš„æ•°ç»„
    std::atomic<size_t> head{0};    // å‡ºé˜ŸæŒ‡é’ˆï¼ˆæ¶ˆè´¹è€…è§†è§’ï¼‰
    std::atomic<size_t> tail{0};    // å…¥é˜ŸæŒ‡é’ˆï¼ˆç”Ÿäº§è€…è§†è§’ï¼‰
    std::atomic<size_t> max_read{0};// å·²æäº¤çš„æœ€å¤§å¯è¯»ä½ç½®

public:
    LockFreeArrayQueue() : buffer(Capacity) {}

    bool enqueue(const T& item);
    bool dequeue(T& item);
};
```

---

### äºŒã€å…¥é˜Ÿæ“ä½œï¼ˆEnqueueï¼‰
```cpp
bool enqueue(const T& item) {
    size_t curr_tail, curr_head;
    do {
        curr_tail = tail.load(std::memory_order_relaxed);
        curr_head = head.load(std::memory_order_acquire);
        
        // æ£€æŸ¥é˜Ÿåˆ—æ˜¯å¦å·²æ»¡
        if ((curr_tail + 1) % Capacity == curr_head % Capacity) 
            return false;
        
    } while (!tail.compare_exchange_weak(
        curr_tail, curr_tail + 1, 
        std::memory_order_relaxed, std::memory_order_relaxed
    ));

    // å†™å…¥æ•°æ®å¹¶æäº¤å¯è¯»ä½ç½®
    buffer[curr_tail % Capacity] = item;
    size_t expected_max = curr_tail;
    while (!max_read.compare_exchange_weak(
        expected_max, curr_tail + 1, 
        std::memory_order_release, std::memory_order_relaxed
    )) { expected_max = curr_tail; }

    return true;
}
```

---

### ä¸‰ã€å‡ºé˜Ÿæ“ä½œï¼ˆDequeueï¼‰
```cpp
bool dequeue(T& item) {
    size_t curr_head, curr_max;
    do {
        curr_head = head.load(std::memory_order_relaxed);
        curr_max = max_read.load(std::memory_order_acquire);
        
        // æ£€æŸ¥é˜Ÿåˆ—æ˜¯å¦ä¸ºç©º
        if (curr_head >= curr_max) 
            return false;
        
        // è¯»å–æ•°æ®å¹¶å°è¯•ç§»åŠ¨headæŒ‡é’ˆ
        item = buffer[curr_head % Capacity];
    } while (!head.compare_exchange_weak(
        curr_head, curr_head + 1, 
        std::memory_order_release, std::memory_order_relaxed
    ));

    return true;
}
```

---

### å››ã€å…³é”®è®¾è®¡åŸç†
1. **ç¯å½¢æ•°ç»„ä¼˜åŒ–**  
   é€šè¿‡ `% Capacity` å®ç°ç¯å½¢ç¼“å†²ï¼Œé¿å…å†…å­˜æ— é™å¢é•¿ã€‚ç´¢å¼•æº¢å‡ºæ—¶è‡ªåŠ¨å›ç»•ï¼Œä¿è¯é•¿æœŸè¿è¡Œç¨³å®šæ€§ã€‚

2. **å¤šç”Ÿäº§è€…æ”¯æŒ**  
   `max_read` å˜é‡ç¡®ä¿ç”Ÿäº§è€…å†™å…¥å®Œæˆå‰ï¼Œæ¶ˆè´¹è€…ä¸ä¼šè¯»å–æœªæäº¤çš„æ•°æ®ã€‚å†™å…¥å®Œæˆåé€šè¿‡åŸå­æ“ä½œæ›´æ–° `max_read`ã€‚

3. **å†…å­˜é¡ºåºæ§åˆ¶**  
   â€¢ `std::memory_order_acquire`ï¼šç¡®ä¿è¯»å–æ“ä½œå‰çš„æ‰€æœ‰å†…å­˜å†™å…¥å¯è§ã€‚
   â€¢ `std::memory_order_release`ï¼šä¿è¯å†™å…¥æ“ä½œåçš„ç»“æœå¯¹å…¶ä»–çº¿ç¨‹å¯è§ã€‚

4. **ABAé—®é¢˜è§„é¿**  
   ç”±äºç´¢å¼•æŒç»­é€’å¢ï¼ˆéå¤ç”¨æ—§å€¼ï¼‰ï¼Œæ— éœ€é¢å¤–æ ‡ç­¾ï¼ˆTagï¼‰å³å¯é¿å…ABAé—®é¢˜ã€‚

---

### äº”ã€æ€§èƒ½æµ‹è¯•ç¤ºä¾‹
```cpp
#include <thread>
#include <iostream>

int main() {
    LockFreeArrayQueue<int> queue;
    std::thread producer([&] {
        for (int i = 0; i < 1000; ++i) {
            while (!queue.enqueue(i)) { /* é˜Ÿåˆ—æ»¡æ—¶é‡è¯• */ }
        }
    });

    std::thread consumer([&] {
        int val;
        for (int i = 0; i < 1000; ++i) {
            while (!queue.dequeue(val)) { /* é˜Ÿåˆ—ç©ºæ—¶é‡è¯• */ }
            std::cout << "Dequeued: " << val << std::endl;
        }
    });

    producer.join();
    consumer.join();
    return 0;
}
```

---

### å…­ã€ä¼˜åŒ–æ–¹å‘
1. **ç¼“å­˜è¡Œå¯¹é½**  
   å¯¹ `head`ã€`tail`ã€`max_read` è¿›è¡Œå†…å­˜å¡«å……ï¼ˆPaddingï¼‰ï¼Œé¿å…ä¼ªå…±äº«ï¼ˆFalse Sharingï¼‰ï¼š
   ```cpp
   alignas(64) std::atomic<size_t> head; // 64å­—èŠ‚å¯¹é½
   ```

2. **æ‰¹é‡æ“ä½œ**  
   æ”¯æŒæ‰¹é‡å…¥é˜Ÿ/å‡ºé˜Ÿï¼Œå‡å°‘CASæ“ä½œæ¬¡æ•°ã€‚

3. **åŠ¨æ€æ‰©å®¹**  
   ç»“åˆé“¾è¡¨å®ç°åŠ¨æ€å®¹é‡ï¼ˆéœ€å¤„ç†èŠ‚ç‚¹å†…å­˜å›æ”¶é—®é¢˜ï¼‰ã€‚

---

### ä¸ƒã€é€‚ç”¨åœºæ™¯
â€¢ **é«˜é¢‘äº¤æ˜“ç³»ç»Ÿ**ï¼šä½å»¶è¿Ÿæ¶ˆæ¯ä¼ é€’ã€‚
â€¢ **ç½‘ç»œæ•°æ®åŒ…å¤„ç†**ï¼šå¦‚DPDKä¸­çš„æ— é”ç¯å½¢ç¼“å†²ï¼ˆRing Bufferï¼‰ã€‚
â€¢ **å®æ—¶æ—¥å¿—æ”¶é›†**ï¼šé«˜ååé‡æ—¥å¿—å†™å…¥ã€‚

---

è¯¥å®ç°é€šè¿‡åŸå­æ“ä½œå’Œç¯å½¢æ•°ç»„çš„ç»“åˆï¼Œåœ¨ä¿è¯çº¿ç¨‹å®‰å…¨çš„åŒæ—¶é¿å…äº†é”çš„å¼€é”€ï¼Œé€‚ç”¨äºé«˜å¹¶å‘åœºæ™¯ã€‚å¦‚éœ€å®Œæ•´ä»£ç æˆ–è¿›ä¸€æ­¥æ€§èƒ½è°ƒä¼˜æ–¹æ³•ï¼Œå¯å‚è€ƒã€‚

# åç¨‹
## åç¨‹çš„ä½¿ç”¨
### ä»€ä¹ˆæ˜¯åç¨‹ (Coroutine)?

åç¨‹æ˜¯ä¸€ç§è½»é‡çº§çš„çº¿ç¨‹ï¼Œèƒ½å¤Ÿåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­æš‚åœå¹¶åœ¨æœªæ¥æŸä¸ªæ—¶åˆ»æ¢å¤æ‰§è¡Œã€‚å®ƒæä¾›äº†ä¸€ç§é«˜æ•ˆçš„å¹¶å‘æ–¹å¼ï¼Œä¸çº¿ç¨‹ç›¸æ¯”ï¼Œå®ƒçš„å¼€é”€æ›´å°ï¼Œå› ä¸ºåç¨‹ä¸éœ€è¦ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå®ƒä»¬æ˜¯åœ¨å•ä¸€çº¿ç¨‹ä¸­äº¤æ›¿æ‰§è¡Œçš„ã€‚

åç¨‹çš„ç‰¹ç‚¹ï¼š
- **åä½œå¼è°ƒåº¦**ï¼šä¸çº¿ç¨‹ç›¸æ¯”ï¼Œåç¨‹ä¸ä¼šç”±æ“ä½œç³»ç»Ÿè°ƒåº¦ï¼Œè€Œæ˜¯ç”±ç¨‹åºè‡ªå·±æ§åˆ¶ã€‚ç¨‹åºé€šè¿‡æ˜¾å¼çš„ `yield` æˆ– `suspend` ç­‰æœºåˆ¶è®©å‡ºæ§åˆ¶æƒï¼Œç„¶åå¯ä»¥åœ¨æœªæ¥æ¢å¤æ‰§è¡Œã€‚
- **èŠ‚çœèµ„æº**ï¼šåç¨‹é€šå¸¸æ¯”çº¿ç¨‹æ›´åŠ è½»é‡ï¼Œå®ƒä»¬å…±äº«åŒä¸€ä¸ªçº¿ç¨‹çš„å †æ ˆç©ºé—´ï¼Œä¸éœ€è¦ç‹¬ç«‹çš„å†…æ ¸è°ƒåº¦ï¼Œå› æ­¤èµ„æºå¼€é”€æ¯”çº¿ç¨‹å°ã€‚
- **éé˜»å¡**ï¼šåç¨‹å¸¸ç”¨äºå¼‚æ­¥ç¼–ç¨‹ï¼Œå¯ä»¥å®ç°éé˜»å¡çš„I/Oæ“ä½œï¼Œä½¿å¾—ç¨‹åºä¸ä¼šå› ç­‰å¾…è€Œé˜»å¡ï¼Œæä¾›æ›´é«˜çš„å¹¶å‘æ€§ã€‚

### åç¨‹çš„ä½¿ç”¨åœºæ™¯
1. **å¼‚æ­¥ç¼–ç¨‹**ï¼šåç¨‹ç”¨äºå¤„ç†éé˜»å¡çš„ I/O æ“ä½œï¼Œå¦‚ç½‘ç»œè¯·æ±‚ã€æ–‡ä»¶è¯»å–ç­‰ï¼Œå¯ä»¥é¿å…ä½¿ç”¨å›è°ƒåœ°ç‹±ã€‚
2. **å¹¶å‘æ‰§è¡Œ**ï¼šåœ¨åŒä¸€ä¸ªçº¿ç¨‹å†…æ‰§è¡Œå¤šä¸ªä»»åŠ¡ï¼Œé¿å…çº¿ç¨‹åˆ‡æ¢çš„å¼€é”€ã€‚
3. **ç”Ÿæˆå™¨**ï¼šåœ¨C++ä¸­ï¼Œåç¨‹å¯ä»¥ç”¨äºå®ç°ç”Ÿæˆå™¨ï¼ˆé€šè¿‡`co_yield`ï¼‰ï¼Œåœ¨éœ€è¦æ—¶æŒ‰éœ€ç”Ÿæˆæ•°æ®ã€‚

### å¦‚ä½•åœ¨ C++ ä¸­ä½¿ç”¨åç¨‹

åœ¨C++20æ ‡å‡†ä¸­ï¼Œæ­£å¼å¼•å…¥äº†åç¨‹çš„æ”¯æŒã€‚C++20é€šè¿‡ä»¥ä¸‹å…³é”®è¯æ”¯æŒåç¨‹ï¼š
- `co_await`ï¼šç”¨äºæŒ‚èµ·å½“å‰åç¨‹å¹¶ç­‰å¾…ä¸€ä¸ªå¼‚æ­¥æ“ä½œå®Œæˆã€‚
- `co_yield`ï¼šç”¨äºè¿”å›ä¸€ä¸ªå€¼å¹¶æŒ‚èµ·åç¨‹ï¼Œå…è®¸åç¨‹æ¢å¤æ—¶è¿”å›æ§åˆ¶æƒã€‚
- `co_return`ï¼šç”¨äºç»ˆæ­¢åç¨‹å¹¶è¿”å›ä¸€ä¸ªå€¼ã€‚

### åŸºæœ¬çš„åç¨‹ç”¨æ³•ç¤ºä¾‹ï¼ˆC++20ï¼‰

å‡è®¾æˆ‘ä»¬éœ€è¦å®ç°ä¸€ä¸ªç®€å•çš„å¼‚æ­¥ä»»åŠ¡ï¼Œå¯ä»¥ä½¿ç”¨åç¨‹æ¥å®ç°ï¼š

```cpp
#include <iostream>
#include <coroutine>
#include <thread>
#include <chrono>

using namespace std;

// ç®€å•çš„åç¨‹ä»»åŠ¡
struct SimpleTask {
    struct promise_type;  // å£°æ˜ promise_type
    using handle_type = std::coroutine_handle<promise_type>;

    struct promise_type {
        SimpleTask get_return_object() {
            return SimpleTask{handle_type::from_promise(*this)};
        }
        std::suspend_always initial_suspend() { return {}; }
        std::suspend_always final_suspend() noexcept { return {}; }
        void unhandled_exception() { std::exit(1); }
        void return_void() {}
    };

    handle_type coro;

    SimpleTask(handle_type h) : coro(h) {}
    ~SimpleTask() { coro.destroy(); }
};

SimpleTask asyncFunction() {
    cout << "Start task" << endl;
    std::this_thread::sleep_for(std::chrono::seconds(2));  // æ¨¡æ‹ŸI/Oæ“ä½œ
    cout << "End task" << endl;
    co_return;
}

int main() {
    auto task = asyncFunction();
    cout << "Task is running asynchronously" << endl;
    this_thread::sleep_for(chrono::seconds(3));  // ç­‰å¾…åç¨‹ç»“æŸ
    return 0;
}
```

#### è§£é‡Šï¼š
- `SimpleTask`ï¼šåç¨‹ä»»åŠ¡çš„ç±»å‹ã€‚å®ƒå®šä¹‰äº†ä¸€ä¸ª `promise_type`ï¼Œå®ƒåŒ…å«äº†åç¨‹çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†å’ŒçŠ¶æ€ã€‚
- `asyncFunction`ï¼šè¿™æ˜¯ä¸€ä¸ªåç¨‹å‡½æ•°ï¼Œæ‰§è¡Œä¸€äº›ä»»åŠ¡ï¼ˆå¦‚æ¨¡æ‹ŸI/Oæ“ä½œï¼‰ï¼Œå¹¶é€šè¿‡ `co_return` å®Œæˆåç¨‹ã€‚
- `std::coroutine_handle<promise_type>`ï¼šåç¨‹çš„æ§åˆ¶å¥æŸ„ï¼Œç”¨äºæ¢å¤åç¨‹ã€é”€æ¯åç¨‹ç­‰ã€‚

### å…³é”®å­—ï¼š
1. **`co_await`**ï¼šæŒ‚èµ·å½“å‰åç¨‹ï¼Œç­‰å¾…å¼‚æ­¥æ“ä½œå®Œæˆã€‚
2. **`co_yield`**ï¼šè¿”å›å¹¶æŒ‚èµ·å½“å‰åç¨‹ï¼Œä½¿å¾—åç¨‹å¯ä»¥åœ¨ä»¥åæ¢å¤ã€‚
3. **`co_return`**ï¼šç»“æŸåç¨‹çš„æ‰§è¡Œï¼Œè¿”å›ä¸€ä¸ªå€¼ï¼ˆå¦‚æœæœ‰ï¼‰ã€‚

### ç¤ºä¾‹è§£é‡Šï¼š
1. `co_return`ï¼šç»“æŸåç¨‹çš„æ‰§è¡Œå¹¶è¿”å›ã€‚
2. `initial_suspend` å’Œ `final_suspend`ï¼šå®šä¹‰äº†åç¨‹å¼€å§‹å’Œç»“æŸæ—¶çš„è¡Œä¸ºã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œåç¨‹å¼€å§‹æ—¶æŒ‚èµ·ï¼Œç„¶ååœ¨ç»“æŸæ—¶æ¸…ç†èµ„æºã€‚
3. `std::this_thread::sleep_for`ï¼šæ¨¡æ‹Ÿè€—æ—¶çš„æ“ä½œï¼Œæ¯”å¦‚ I/O ç­‰å¾…ã€‚

### æ›´å¤æ‚çš„ç¤ºä¾‹ï¼ˆå¼‚æ­¥ I/O æ¨¡æ‹Ÿï¼‰

å‡è®¾ä½ æƒ³è¦å®ç°ä¸€ä¸ªé€šè¿‡åç¨‹æ¥æ¨¡æ‹Ÿå¼‚æ­¥I/Oæ“ä½œï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªæ›´å¤æ‚çš„ä¾‹å­ï¼š

```cpp
#include <iostream>
#include <coroutine>
#include <thread>
#include <chrono>

using namespace std;

struct AsyncIO {
    struct promise_type;
    using handle_type = std::coroutine_handle<promise_type>;

    struct promise_type {
        AsyncIO get_return_object() { return AsyncIO{handle_type::from_promise(*this)}; }
        std::suspend_always initial_suspend() { return {}; }
        std::suspend_always final_suspend() noexcept { return {}; }
        void unhandled_exception() { std::exit(1); }
        void return_value(int v) { result = v; }

        int result;
    };

    handle_type coro;
    AsyncIO(handle_type h) : coro(h) {}
    ~AsyncIO() { coro.destroy(); }
    int result() { return coro.promise().result; }
};

AsyncIO asyncReadFromDisk() {
    cout << "Starting disk read..." << endl;
    std::this_thread::sleep_for(std::chrono::seconds(2));  // æ¨¡æ‹Ÿå¼‚æ­¥I/Oæ“ä½œ
    cout << "Finished disk read." << endl;
    co_return 42;  // æ¨¡æ‹Ÿè¿”å›è¯»å–ç»“æœ
}

int main() {
    auto task = asyncReadFromDisk();
    cout << "Waiting for result..." << endl;
    std::this_thread::sleep_for(std::chrono::seconds(3));
    cout << "Result: " << task.result() << endl;
    return 0;
}
```

### æ€»ç»“ï¼š
1. **åç¨‹çš„ä¼˜åŠ¿**ï¼š
   - æé«˜äº†å¹¶å‘æ€§ï¼Œä¸éœ€è¦åˆ›å»ºå¤šä¸ªçº¿ç¨‹ã€‚
   - é€‚ç”¨äºå¤„ç†å¼‚æ­¥ä»»åŠ¡ï¼Œæ¯”å¦‚ I/O æ“ä½œã€ç½‘ç»œè¯·æ±‚ç­‰ã€‚
   - èµ„æºå ç”¨è¾ƒå°ï¼Œé€šå¸¸åªéœ€ä¸€ä¸ªçº¿ç¨‹å°±èƒ½å¤„ç†å¤šä¸ªå¹¶å‘ä»»åŠ¡ã€‚
  
2. **åç¨‹çš„å®ç°**ï¼š
   - åç¨‹æ˜¯ç”±ç¨‹åºå‘˜æ§åˆ¶çš„ï¼Œå¹¶éç”±æ“ä½œç³»ç»Ÿè°ƒåº¦ã€‚
   - å®ƒä½¿ç”¨äº† `co_await`, `co_yield`, `co_return` ç­‰å…³é”®å­—è¿›è¡Œæ§åˆ¶ã€‚

C++20åç¨‹æä¾›äº†ä¸€ä¸ªé«˜æ•ˆçš„æ–¹å¼æ¥å¤„ç†å¼‚æ­¥æ“ä½œï¼Œèƒ½å¤Ÿé¿å…å›è°ƒåœ°ç‹±å’Œå¤æ‚çš„å¼‚æ­¥ç¼–ç¨‹æ¨¡å¼ã€‚

## è¿›ç¨‹ çº¿ç¨‹ åç¨‹ çš„åŒºåˆ«ï¼Ÿ
### **1. æ¦‚è¿°**  
åœ¨è®¡ç®—æœºç¼–ç¨‹ä¸­ï¼Œ**è¿›ç¨‹ï¼ˆProcessï¼‰**ã€**çº¿ç¨‹ï¼ˆThreadï¼‰** å’Œ **åç¨‹ï¼ˆCoroutineï¼‰** æ˜¯ä¸‰ç§ä¸åŒçš„æ‰§è¡Œå•å…ƒï¼Œå®ƒä»¬çš„è°ƒåº¦æ–¹å¼ã€èµ„æºç®¡ç†å’Œæ‰§è¡Œæ–¹å¼å„ä¸ç›¸åŒã€‚  

| **å¯¹æ¯”é¡¹** | **è¿›ç¨‹ï¼ˆProcessï¼‰** | **çº¿ç¨‹ï¼ˆThreadï¼‰** | **åç¨‹ï¼ˆCoroutineï¼‰** |
|------------|----------------|----------------|----------------|
| **å®šä¹‰** | æ“ä½œç³»ç»Ÿåˆ†é…èµ„æºçš„åŸºæœ¬å•ä½ | è¿›ç¨‹å†…çš„ç‹¬ç«‹æ‰§è¡Œæµ | è½»é‡çº§ç”¨æˆ·æ€çº¿ç¨‹ |
| **è°ƒåº¦æ–¹å¼** | ç”± **æ“ä½œç³»ç»Ÿï¼ˆOSï¼‰** è°ƒåº¦ | ç”± **OS è¿›è¡Œçº¿ç¨‹è°ƒåº¦** | ç”± **ç”¨æˆ·ä»£ç ï¼ˆç¨‹åºï¼‰** è°ƒåº¦ |
| **èµ„æºå¼€é”€** | æ‹¥æœ‰ **ç‹¬ç«‹çš„åœ°å€ç©ºé—´**ï¼Œåˆ›å»ºå’Œåˆ‡æ¢ä»£ä»·å¤§ | å…±äº«è¿›ç¨‹åœ°å€ç©ºé—´ï¼Œåˆ›å»ºå’Œåˆ‡æ¢ä»£ä»·å° | è¿è¡Œåœ¨ç”¨æˆ·æ€ï¼Œåˆ›å»ºå’Œåˆ‡æ¢ä»£ä»·æœ€å° |
| **åˆ‡æ¢æ–¹å¼** | ä¾èµ– **OS è°ƒåº¦**ï¼ˆä¸Šä¸‹æ–‡åˆ‡æ¢æ¶ˆè€—é«˜ï¼‰ | ä¾èµ– **OS è°ƒåº¦**ï¼ˆä¸Šä¸‹æ–‡åˆ‡æ¢è¾ƒå¿«ï¼‰ | **ç”¨æˆ·æ€åˆ‡æ¢**ï¼ˆæ— éœ€å†…æ ¸æ€åˆ‡æ¢ï¼Œæœ€å¿«ï¼‰ |
| **æ•°æ®å…±äº«** | è¿›ç¨‹é—´**ä¸å…±äº«**æ•°æ®ï¼Œéœ€ä½¿ç”¨ IPC æœºåˆ¶ï¼ˆç®¡é“ã€æ¶ˆæ¯é˜Ÿåˆ—ã€å…±äº«å†…å­˜ç­‰ï¼‰ | **å…±äº«è¿›ç¨‹çš„åœ°å€ç©ºé—´**ï¼Œä½†è®¿é—®æ•°æ®éœ€åŠ é”ï¼ˆå¦‚ `mutex`ï¼‰ | **æœ¬è´¨ä¸Šæ˜¯å•çº¿ç¨‹ï¼Œé¿å…äº†æ•°æ®ç«äº‰** |
| **å¹¶è¡Œèƒ½åŠ›** | **æ”¯æŒçœŸæ­£çš„å¹¶è¡Œ**ï¼ˆå¤šä¸ª CPU å¯åŒæ—¶è¿è¡Œå¤šä¸ªè¿›ç¨‹ï¼‰ | **æ”¯æŒçœŸæ­£çš„å¹¶è¡Œ**ï¼ˆå¤šä¸ª CPU å¯åŒæ—¶è¿è¡Œå¤šä¸ªçº¿ç¨‹ï¼‰ | **ä¸æ”¯æŒçœŸæ­£çš„å¹¶è¡Œ**ï¼ˆæœ¬è´¨æ˜¯ä¸€ä¸ªçº¿ç¨‹å†…éƒ¨çš„ä»»åŠ¡åˆ‡æ¢ï¼‰ |
| **é€‚ç”¨åœºæ™¯** | ç‹¬ç«‹è¿è¡Œçš„åº”ç”¨ç¨‹åºï¼ˆå¦‚æµè§ˆå™¨ã€æ•°æ®åº“ï¼‰ | å¤šä»»åŠ¡å¹¶è¡Œè®¡ç®—ï¼ˆå¦‚ Web æœåŠ¡å™¨ã€å›¾åƒå¤„ç†ï¼‰ | é«˜å¹¶å‘ã€é«˜ IO ä»»åŠ¡ï¼ˆå¦‚ç½‘ç»œè¯·æ±‚ã€åç¨‹æ¡†æ¶ï¼‰ |

---

### **2. è¿›ç¨‹ï¼ˆProcessï¼‰**
#### **2.1 å®šä¹‰**
- è¿›ç¨‹æ˜¯ **æ“ä½œç³»ç»Ÿèµ„æºåˆ†é…çš„åŸºæœ¬å•ä½**ã€‚
- æ¯ä¸ªè¿›ç¨‹æœ‰ **ç‹¬ç«‹çš„å†…å­˜ç©ºé—´**ï¼ŒåŒ…å«ä»£ç æ®µã€æ•°æ®æ®µã€å †ã€æ ˆç­‰ã€‚
- è¿›ç¨‹ä¹‹é—´**ä¸èƒ½ç›´æ¥å…±äº«å†…å­˜**ï¼Œå¿…é¡»é€šè¿‡ **è¿›ç¨‹é—´é€šä¿¡ï¼ˆIPCï¼‰**ï¼ˆå¦‚ç®¡é“ã€æ¶ˆæ¯é˜Ÿåˆ—ã€å…±äº«å†…å­˜ï¼‰ã€‚

#### **2.2 ç‰¹ç‚¹**
âœ… **ä¼˜åŠ¿**
1. **è¿›ç¨‹éš”ç¦»**ï¼Œä¸€ä¸ªè¿›ç¨‹å´©æºƒä¸ä¼šå½±å“å…¶ä»–è¿›ç¨‹ï¼Œå®‰å…¨æ€§é«˜ã€‚  
2. **å¯ä»¥åˆ©ç”¨å¤šæ ¸ CPU è¿›è¡ŒçœŸæ­£çš„å¹¶è¡Œè®¡ç®—**ã€‚  

âŒ **åŠ£åŠ¿**
1. **åˆ›å»ºå’Œåˆ‡æ¢æˆæœ¬é«˜**ï¼Œå› ä¸ºæ¶‰åŠ**å®Œæ•´çš„ä¸Šä¸‹æ–‡åˆ‡æ¢**ï¼ˆCPU éœ€è¦ä¿å­˜/æ¢å¤å¯„å­˜å™¨ã€å†…å­˜ç­‰ï¼‰ã€‚  
2. **è¿›ç¨‹é—´é€šä¿¡å¤æ‚**ï¼ˆå…±äº«æ•°æ®éœ€è¦ä½¿ç”¨ IPC æœºåˆ¶ï¼‰ã€‚  

#### **2.3 ç¤ºä¾‹**
âœ… **åˆ›å»ºè¿›ç¨‹ï¼ˆC++ ä½¿ç”¨ `fork()`ï¼‰**
```cpp
#include <iostream>
#include <unistd.h>  // fork()

int main() {
    pid_t pid = fork();
    if (pid == 0) {
        std::cout << "æˆ‘æ˜¯å­è¿›ç¨‹ï¼ŒPIDï¼š" << getpid() << std::endl;
    } else {
        std::cout << "æˆ‘æ˜¯çˆ¶è¿›ç¨‹ï¼ŒPIDï¼š" << getpid() << std::endl;
    }
    return 0;
}
```

---

### **3. çº¿ç¨‹ï¼ˆThreadï¼‰**
#### **3.1 å®šä¹‰**
- çº¿ç¨‹æ˜¯ **CPU è°ƒåº¦çš„åŸºæœ¬å•ä½**ï¼Œå®ƒè¿è¡Œåœ¨è¿›ç¨‹å†…ï¼Œ**å…±äº«è¿›ç¨‹çš„å†…å­˜ç©ºé—´**ã€‚  
- çº¿ç¨‹ä¹‹é—´å¯ä»¥**ç›´æ¥è®¿é—®è¿›ç¨‹æ•°æ®**ï¼Œä½†éœ€è¦ä½¿ç”¨**é”ï¼ˆmutexï¼‰**ç­‰æœºåˆ¶æ¥é¿å…ç«äº‰æ¡ä»¶ï¼ˆrace conditionï¼‰ã€‚  

#### **3.2 ç‰¹ç‚¹**
âœ… **ä¼˜åŠ¿**
1. **æ¯”è¿›ç¨‹åˆ‡æ¢å¿«**ï¼ˆçº¿ç¨‹å…±äº«å†…å­˜ï¼Œå‡å°‘äº†ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€ï¼‰ã€‚  
2. **é€‚åˆå¤šä»»åŠ¡å¹¶è¡Œ**ï¼ˆå¦‚ Web æœåŠ¡å™¨ã€è®¡ç®—å¯†é›†å‹ä»»åŠ¡ï¼‰ã€‚  

âŒ **åŠ£åŠ¿**
1. **æ•°æ®å…±äº«å®¹æ˜“å¯¼è‡´ç«äº‰é—®é¢˜**ï¼Œéœ€è¦åŒæ­¥æœºåˆ¶ï¼ˆå¦‚ `mutex`ã€`condition_variable`ï¼‰ã€‚  
2. **ä¸€ä¸ªçº¿ç¨‹å´©æºƒå¯èƒ½å½±å“æ•´ä¸ªè¿›ç¨‹**ï¼ˆå› ä¸ºçº¿ç¨‹å…±äº«åœ°å€ç©ºé—´ï¼‰ã€‚  

#### **3.3 ç¤ºä¾‹**
âœ… **åˆ›å»ºçº¿ç¨‹ï¼ˆC++ ä½¿ç”¨ `std::thread`ï¼‰**
```cpp
#include <iostream>
#include <thread>

void task() {
    std::cout << "çº¿ç¨‹ ID: " << std::this_thread::get_id() << std::endl;
}

int main() {
    std::thread t1(task);
    t1.join();  // ç­‰å¾…çº¿ç¨‹æ‰§è¡Œå®Œæˆ
    return 0;
}
```

---

### **4. åç¨‹ï¼ˆCoroutineï¼‰**
#### **4.1 å®šä¹‰**
- åç¨‹æ˜¯ **ä¸€ç§è½»é‡çº§çš„ç”¨æˆ·æ€çº¿ç¨‹**ï¼Œæœ¬è´¨ä¸Šæ˜¯**çº¿ç¨‹å†…çš„å‡½æ•°è°ƒåº¦æœºåˆ¶**ã€‚  
- **ç”±ç¨‹åºæ§åˆ¶è°ƒåº¦**ï¼ˆè€Œä¸æ˜¯ OS ï¼‰ï¼Œå¯ä»¥ **æŒ‚èµ·/æ¢å¤**ï¼Œé€‚ç”¨äºé«˜å¹¶å‘åœºæ™¯ï¼ˆå¦‚ç½‘ç»œè¯·æ±‚ï¼‰ã€‚  

#### **4.2 ç‰¹ç‚¹**
âœ… **ä¼˜åŠ¿**
1. **åˆ‡æ¢æˆæœ¬æœ€ä½**ï¼ˆä¸æ¶‰åŠ OS å†…æ ¸æ€åˆ‡æ¢ï¼Œæ‰€æœ‰æ“ä½œéƒ½åœ¨ç”¨æˆ·æ€å®Œæˆï¼‰ã€‚  
2. **ä¸éœ€è¦é”**ï¼ˆåç¨‹æœ¬è´¨æ˜¯å•çº¿ç¨‹ï¼Œä¸ä¼šå‘ç”Ÿæ•°æ®ç«äº‰ï¼‰ã€‚  
3. **é€‚åˆé«˜å¹¶å‘åœºæ™¯**ï¼ˆå¦‚ `async/await` å¤„ç†ç½‘ç»œ IOï¼‰ã€‚  

âŒ **åŠ£åŠ¿**
1. **æ— æ³•åˆ©ç”¨å¤šæ ¸ CPU**ï¼ˆåç¨‹æ˜¯å•çº¿ç¨‹çš„ï¼Œä¸èƒ½çœŸæ­£å¹¶è¡Œï¼‰ã€‚  
2. **éœ€è¦ç¼–ç¨‹è¯­è¨€æˆ–æ¡†æ¶æ”¯æŒ**ï¼ˆå¦‚ C++20 `std::coroutine`ã€Python `asyncio`ï¼‰ã€‚  

#### **4.3 ç¤ºä¾‹**
âœ… **C++ åç¨‹ï¼ˆC++20 `std::coroutine`ï¼‰**
```cpp
#include <iostream>
#include <coroutine>

struct Task {
    struct promise_type {
        Task get_return_object() { return {}; }
        std::suspend_never initial_suspend() { return {}; }
        std::suspend_never final_suspend() noexcept { return {}; }
        void return_void() {}
        void unhandled_exception() { std::terminate(); }
    };
};

Task my_coroutine() {
    std::cout << "Hello from coroutine!" << std::endl;
    co_return;
}

int main() {
    my_coroutine();
    return 0;
}
```

---

### **5. è¿›ç¨‹ vs çº¿ç¨‹ vs åç¨‹**
| **ç‰¹æ€§** | **è¿›ç¨‹** | **çº¿ç¨‹** | **åç¨‹** |
|------------|----------------|----------------|----------------|
| **è°ƒåº¦** | **OS è´Ÿè´£è°ƒåº¦** | **OS è´Ÿè´£è°ƒåº¦** | **ç¨‹åºè‡ªè¡Œè°ƒåº¦** |
| **åˆ‡æ¢æˆæœ¬** | **é«˜ï¼ˆæ¶‰åŠå†…æ ¸æ€åˆ‡æ¢ï¼‰** | **ä¸­ï¼ˆä»æ¶‰åŠå†…æ ¸æ€åˆ‡æ¢ï¼‰** | **ä½ï¼ˆç”¨æˆ·æ€å®Œæˆåˆ‡æ¢ï¼‰** |
| **æ•°æ®å…±äº«** | **ä¸å…±äº«ï¼ˆéœ€ IPCï¼‰** | **å…±äº«ï¼ˆéœ€åŒæ­¥æœºåˆ¶ï¼‰** | **å…±äº«ï¼ˆå•çº¿ç¨‹ï¼Œæ— éœ€åŒæ­¥ï¼‰** |
| **å¹¶è¡Œèƒ½åŠ›** | **æ”¯æŒå¤šæ ¸å¹¶è¡Œ** | **æ”¯æŒå¤šæ ¸å¹¶è¡Œ** | **ä¸æ”¯æŒå¤šæ ¸å¹¶è¡Œï¼ˆå•çº¿ç¨‹å†…è°ƒåº¦ï¼‰** |
| **é€‚ç”¨åœºæ™¯** | **ç‹¬ç«‹åº”ç”¨ï¼ˆå¦‚æµè§ˆå™¨ã€æ•°æ®åº“ï¼‰** | **å¤šä»»åŠ¡å¹¶è¡Œï¼ˆå¦‚ Web æœåŠ¡å™¨ï¼‰** | **é«˜å¹¶å‘ IOï¼ˆå¦‚å¼‚æ­¥ç½‘ç»œè¯·æ±‚ï¼‰** |

---

### **6. ä»€ä¹ˆæ—¶å€™ç”¨å“ªç§ï¼Ÿ**
âœ… **é€‰æ‹©è¿›ç¨‹**
- éœ€è¦**éš”ç¦»æ€§**ï¼Œå¦‚è¿è¡Œä¸åŒçš„åº”ç”¨ç¨‹åºï¼ˆæµè§ˆå™¨ã€æ•°æ®åº“ï¼‰ã€‚  
- **ä¸é¢‘ç¹é€šä¿¡**ï¼Œå¦‚ `Docker` å®¹å™¨ç®¡ç†ã€‚  

âœ… **é€‰æ‹©çº¿ç¨‹**
- **è®¡ç®—å¯†é›†å‹ä»»åŠ¡**ï¼ˆå¦‚å¤šçº¿ç¨‹çŸ©é˜µè®¡ç®—ã€å›¾åƒå¤„ç†ï¼‰ã€‚  
- **æ•°æ®å…±äº«**ï¼Œä½†éœ€è¦åŒæ­¥ï¼ˆå¦‚ Web æœåŠ¡å™¨ï¼‰ã€‚  

âœ… **é€‰æ‹©åç¨‹**
- **é«˜å¹¶å‘ IO**ï¼ˆå¦‚ `async/await` å¤„ç†ç™¾ä¸‡ TCP è¿æ¥ï¼‰ã€‚  
- **äº‹ä»¶é©±åŠ¨æ¶æ„**ï¼ˆå¦‚ `Python asyncio`ã€`C++ boost::asio`ï¼‰ã€‚  

ğŸš€ **æ€»ç»“**ï¼š
- **è¿›ç¨‹é€‚åˆç‹¬ç«‹ä»»åŠ¡**ï¼Œå®‰å…¨ä½†å¼€é”€å¤§ã€‚  
- **çº¿ç¨‹é€‚åˆå¹¶è¡Œè®¡ç®—**ï¼Œä½†éœ€åŒæ­¥æœºåˆ¶ã€‚  
- **åç¨‹é€‚åˆé«˜å¹¶å‘ IO**ï¼Œä½†ä¸é€‚ç”¨äº CPU å¯†é›†ä»»åŠ¡ã€‚

## åç¨‹çš„æ ¸å¿ƒä¼˜åŠ¿
è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é—®é¢˜ï¼**åç¨‹çš„é«˜å¹¶å‘èƒ½åŠ›å¹¶ä¸ä¾èµ–äºå¤šçº¿ç¨‹æˆ–å¤šæ ¸å¹¶è¡Œï¼Œè€Œæ˜¯ä¾èµ–äºå¼‚æ­¥éé˜»å¡çš„æ‰§è¡Œæ¨¡å‹ã€‚**  

---

### **ä¸ºä»€ä¹ˆåç¨‹å¯ä»¥ç”¨äºé«˜å¹¶å‘ IOï¼Ÿ**
**åç¨‹çš„æ ¸å¿ƒæ€æƒ³**ï¼š  
- **ä¼ ç»Ÿçº¿ç¨‹æ¨¡å‹**ï¼šæ¯ä¸ª I/O æ“ä½œï¼ˆå¦‚ `read()`ã€`recv()`ï¼‰ä¼šå¯¼è‡´çº¿ç¨‹é˜»å¡ï¼Œç­‰å¾… I/O å®Œæˆã€‚è¿™ä¼šå¯¼è‡´çº¿ç¨‹è¿›å…¥ **å†…æ ¸æ€ç­‰å¾…**ï¼Œè€Œçº¿ç¨‹åˆ‡æ¢çš„ä»£ä»·å¾ˆé«˜ã€‚  
- **åç¨‹æ¨¡å‹**ï¼šåç¨‹æ˜¯**éé˜»å¡çš„**ï¼Œå½“é‡åˆ° I/O æ“ä½œæ—¶ï¼Œåç¨‹å¯ä»¥**ä¸»åŠ¨è®©å‡º CPUï¼ˆæŒ‚èµ·ï¼‰ï¼Œè€Œä¸æ˜¯é˜»å¡æ•´ä¸ªçº¿ç¨‹**ï¼Œä»è€Œè®©å…¶ä»–åç¨‹ç»§ç»­æ‰§è¡Œã€‚è¿™å¤§å¹…åº¦æé«˜äº†**å•çº¿ç¨‹çš„ååé‡**ã€‚  

**ç¤ºä¾‹å¯¹æ¯”**ï¼š
| **æ¨¡å‹** | **æ‰§è¡Œæ–¹å¼** | **çº¿ç¨‹æ•°é‡** | **é€‚ç”¨äº** |
|-----------|----------------|---------------|------------|
| **å¤šçº¿ç¨‹ IOï¼ˆé˜»å¡ï¼‰** | çº¿ç¨‹é˜»å¡ç­‰å¾… IO | éœ€è¦å¤§é‡çº¿ç¨‹ | å¹¶å‘æœ‰é™ï¼Œçº¿ç¨‹åˆ‡æ¢å¼€é”€å¤§ |
| **åç¨‹ IOï¼ˆéé˜»å¡ï¼‰** | çº¿ç¨‹ä¸ä¼šè¢«é˜»å¡ï¼Œåç¨‹åˆ‡æ¢ | **å•çº¿ç¨‹** | é«˜å¹¶å‘ IOï¼Œå¦‚ Web æœåŠ¡å™¨ |

---

### **åç¨‹å¦‚ä½•å®ç°é«˜å¹¶å‘ IOï¼Ÿ**
åœ¨ä¼ ç»Ÿçš„**å¤šçº¿ç¨‹ IO æ¨¡å‹**ä¸­ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½éœ€è¦ç‹¬ç«‹ç­‰å¾… IOï¼Œå¯¼è‡´**çº¿ç¨‹èµ„æºæ¶ˆè€—å¤§**ï¼Œè€Œåç¨‹é€šè¿‡**äº‹ä»¶é©±åŠ¨ï¼ˆå¦‚ `epoll`ã€`select`ï¼‰æˆ– `async/await` æ¥å¼‚æ­¥ç­‰å¾… IO**ï¼Œä»è€Œå®ç°é«˜å¹¶å‘ã€‚

#### **ä¾‹å­ 1ï¼šä¼ ç»Ÿå¤šçº¿ç¨‹ IOï¼ˆé˜»å¡ï¼‰**
```cpp
void handle_request(int socket) {
    char buffer[1024];
    recv(socket, buffer, sizeof(buffer), 0);  // é˜»å¡ç­‰å¾…æ•°æ®
    send(socket, "HTTP/1.1 200 OK\r\n", 17, 0);
}

void server() {
    while (true) {
        int client_socket = accept(server_socket, nullptr, nullptr);
        std::thread(handle_request, client_socket).detach();
    }
}
```
**ç¼ºç‚¹**ï¼š
- **æ¯ä¸ªè¯·æ±‚éƒ½åˆ›å»ºä¸€ä¸ªçº¿ç¨‹**ï¼Œçº¿ç¨‹åˆ‡æ¢çš„ä»£ä»·å¾ˆé«˜ã€‚
- **IO é˜»å¡ä¼šæµªè´¹ CPU èµ„æº**ã€‚

---

#### **ä¾‹å­ 2ï¼šåŸºäºåç¨‹çš„å¼‚æ­¥ IO**
```cpp
#include <iostream>
#include <asio.hpp>
#include <coroutine>

asio::awaitable<void> handle_request(asio::ip::tcp::socket socket) {
    char buffer[1024];
    co_await socket.async_read_some(asio::buffer(buffer), asio::use_awaitable);  // éé˜»å¡ IO
    co_await asio::async_write(socket, asio::buffer("HTTP/1.1 200 OK\r\n"), asio::use_awaitable);
}

void server(asio::io_context& io_context) {
    asio::ip::tcp::acceptor acceptor(io_context, {asio::ip::tcp::v4(), 8080});
    while (true) {
        asio::ip::tcp::socket socket(io_context);
        acceptor.async_accept(socket, [](std::error_code, asio::ip::tcp::socket s) {
            asio::co_spawn(io_context, handle_request(std::move(s)), asio::detached);
        });
    }
}
```
**ä¼˜åŠ¿**ï¼š
- **ä¸é˜»å¡çº¿ç¨‹**ï¼Œè€Œæ˜¯åˆ©ç”¨ `co_await` è®©åç¨‹æŒ‚èµ·ï¼Œç­‰å¾… IO äº‹ä»¶è§¦å‘åå†æ¢å¤æ‰§è¡Œã€‚  
- **ä¸€ä¸ªçº¿ç¨‹å°±èƒ½å¤„ç†æˆåƒä¸Šä¸‡çš„å¹¶å‘è¯·æ±‚**ï¼Œè€Œä¸éœ€è¦åˆ›å»ºå¤§é‡çº¿ç¨‹ã€‚  

---

### **åç¨‹çš„æ ¸å¿ƒä¼˜åŠ¿**
âœ… **é¿å…çº¿ç¨‹é˜»å¡**ï¼šåç¨‹ä¸ä¼šåƒæ™®é€šçº¿ç¨‹é‚£æ ·é˜»å¡åœ¨ `recv()` ä¹‹ç±»çš„ IO è°ƒç”¨ä¸Šï¼Œè€Œæ˜¯**æŒ‚èµ·å½“å‰æ‰§è¡Œï¼Œç­‰å¾… IO å®Œæˆåæ¢å¤æ‰§è¡Œ**ã€‚  
âœ… **å‡å°‘ä¸Šä¸‹æ–‡åˆ‡æ¢**ï¼šåç¨‹åˆ‡æ¢**åœ¨ç”¨æˆ·æ€å®Œæˆ**ï¼Œä¸éœ€è¦åƒçº¿ç¨‹é‚£æ ·è¿›å…¥ **å†…æ ¸æ€**ï¼Œæ‰€ä»¥**åˆ‡æ¢å¼€é”€æä½**ã€‚  
âœ… **æé«˜å¹¶å‘èƒ½åŠ›**ï¼šå› ä¸º**åç¨‹æ˜¯éé˜»å¡çš„**ï¼Œä¸€ä¸ªçº¿ç¨‹å¯ä»¥**åŒæ—¶ç®¡ç†æˆåƒä¸Šä¸‡ä¸ªåç¨‹**ï¼Œæå¤§åœ°æé«˜äº†**å•çº¿ç¨‹çš„å¹¶å‘èƒ½åŠ›**ã€‚  

**æ€»ç»“**ï¼š
- **åç¨‹çš„é«˜å¹¶å‘èƒ½åŠ›ä¸æ˜¯æ¥è‡ªå¤šæ ¸å¹¶è¡Œï¼Œè€Œæ˜¯é¿å…é˜»å¡ï¼Œæé«˜ CPU åˆ©ç”¨ç‡**ã€‚  
- **é€‚ç”¨äºé«˜ IO å¹¶å‘ï¼ˆå¦‚ Web æœåŠ¡å™¨ã€æ•°æ®åº“è¿æ¥æ± ï¼‰ï¼Œè€Œé CPU å¯†é›†å‹ä»»åŠ¡**ã€‚  
- **ç°ä»£è¯­è¨€ï¼ˆC++20ã€Pythonã€Goï¼‰éƒ½æ”¯æŒåç¨‹ï¼Œæå‡ IO å¯†é›†å‹ä»»åŠ¡çš„ååé‡**ã€‚  

æ‰€ä»¥ï¼Œ**åç¨‹é€‚ç”¨äºé«˜å¹¶å‘ IOï¼Œè€Œä¸æ˜¯è®¡ç®—å¯†é›†å‹ä»»åŠ¡**ã€‚ğŸš€



## éé˜»å¡IO vs. åç¨‹
### **1. éé˜»å¡ IO çš„é—®é¢˜**
éé˜»å¡ IO å…è®¸çº¿ç¨‹ç»§ç»­æ‰§è¡Œè€Œä¸ä¼šå›  IO æ“ä½œé˜»å¡ï¼Œä½†å®ƒé€šå¸¸éœ€è¦ **å›è°ƒå‡½æ•°** æˆ– **çŠ¶æ€æœº** æ¥ç®¡ç†å¼‚æ­¥äº‹ä»¶ï¼Œè¿™å¸¦æ¥äº†ä¸€äº›é—®é¢˜ã€‚

#### **1.1 ä»£ç ç»“æ„æ··ä¹±**
åŸºäºå›è°ƒçš„éé˜»å¡ IO ä¼šå¯¼è‡´ **å›è°ƒåœ°ç‹±ï¼ˆCallback Hellï¼‰**ï¼Œä½¿ä»£ç éš¾ä»¥é˜…è¯»å’Œç»´æŠ¤ã€‚

```cpp
void on_read(int fd, char* buffer) {
    printf("æ”¶åˆ°æ•°æ®: %s\n", buffer);
    send(fd, "HTTP/1.1 200 OK\r\n", 17, 0);  // ç»§ç»­å†™å…¥
}

void start_server() {
    int server_fd = socket(...);
    int client_fd = accept(server_fd, ...);
    
    // è®¾ç½®éé˜»å¡æ¨¡å¼
    fcntl(client_fd, F_SETFL, O_NONBLOCK);
    
    char buffer[1024];
    async_read(client_fd, buffer, sizeof(buffer), on_read);  // æ³¨å†Œå›è°ƒ
}
```

#### **1.2 çŠ¶æ€ç®¡ç†å¤æ‚**
å›è°ƒå‡½æ•°éœ€è¦æ‰‹åŠ¨ç®¡ç† **IO çŠ¶æ€**ï¼Œä»£ç å¯è¯»æ€§å·®ï¼Œå®¹æ˜“å‡ºé”™ã€‚

#### **1.3 å¼‚å¸¸å¤„ç†å›°éš¾**
ä¼ ç»Ÿçš„éé˜»å¡ IO ä¾èµ– **é”™è¯¯ç ** è¿›è¡Œå¼‚å¸¸å¤„ç†ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ `try-catch`ï¼Œå¯¼è‡´é”™è¯¯ä¼ æ’­å¤æ‚ã€‚

---

### **2. åç¨‹çš„ä¼˜åŠ¿**
åç¨‹ï¼ˆCoroutineï¼‰åŸºäºéé˜»å¡ IO **æä¾›æ›´è‡ªç„¶ã€å¯è¯»çš„ä»£ç ç»“æ„**ï¼Œè®©å¼‚æ­¥ç¼–ç¨‹åƒåŒæ­¥ä»£ç ä¸€æ ·ç›´è§‚ã€‚

#### **2.1 ä»£ç ç»“æ„æ¸…æ™°**
åç¨‹é€šè¿‡ `co_await` è¯­æ³•ï¼Œä½¿å¼‚æ­¥ä»£ç ç»“æ„ä¸åŒæ­¥ä»£ç ç±»ä¼¼ï¼Œé¿å…å›è°ƒåµŒå¥—ã€‚

```cpp
asio::awaitable<void> handle_request(asio::ip::tcp::socket socket) {
    char buffer[1024];
    std::size_t bytes = co_await socket.async_read_some(asio::buffer(buffer), asio::use_awaitable);
    co_await asio::async_write(socket, asio::buffer("HTTP/1.1 200 OK\r\n"), asio::use_awaitable);
}
```

#### **2.2 è‡ªåŠ¨çŠ¶æ€ç®¡ç†**
åç¨‹çš„ **è°ƒåº¦å™¨** è´Ÿè´£ç®¡ç† IO æ“ä½œçš„çŠ¶æ€ï¼Œå¼€å‘è€…ä¸éœ€è¦æ‰‹åŠ¨ç»´æŠ¤ IO äº‹ä»¶çš„å›è°ƒå’ŒçŠ¶æ€ã€‚

#### **2.3 æ›´ç®€å•çš„å¼‚å¸¸å¤„ç†**
åç¨‹æ”¯æŒ `try-catch` ç›´æ¥æ•è·å¼‚å¸¸ï¼Œè€Œä¸éœ€è¦å±‚å±‚ä¼ é€’é”™è¯¯ç ã€‚

```cpp
asio::awaitable<void> handle_request(asio::ip::tcp::socket socket) {
    try {
        char buffer[1024];
        std::size_t bytes = co_await socket.async_read_some(asio::buffer(buffer), asio::use_awaitable);
        co_await asio::async_write(socket, asio::buffer("HTTP/1.1 200 OK\r\n"), asio::use_awaitable);
    } catch (std::exception& e) {
        std::cerr << "é”™è¯¯: " << e.what() << std::endl;
    }
}
```

---

### **3. éé˜»å¡ IO vs. åç¨‹ï¼šä½•æ—¶ä½¿ç”¨ï¼Ÿ**
#### **3.1 é€‚ç”¨äºéé˜»å¡ IO çš„åœºæ™¯**
âœ… **åº•å±‚ç½‘ç»œåº“**ï¼šå¦‚ `epoll`ã€`select`ï¼Œéœ€è¦æœ€å¤§åŒ–æ€§èƒ½ã€‚  
âœ… **ç®€å•å¼‚æ­¥æ“ä½œ**ï¼šä»…æ¶‰åŠå°‘é‡ IO äº‹ä»¶ï¼Œä¸ä¼šå¯¼è‡´ä»£ç å¤æ‚åŒ–ã€‚  

#### **3.2 é€‚ç”¨äºåç¨‹çš„åœºæ™¯**
âœ… **å¤æ‚ä¸šåŠ¡é€»è¾‘**ï¼šå¦‚ Web æœåŠ¡å™¨ã€æ•°æ®åº“è¿æ¥æ± ç­‰ï¼Œé¿å…å›è°ƒåµŒå¥—ã€‚  
âœ… **éœ€è¦æ›´å¥½çš„é”™è¯¯å¤„ç†**ï¼šç”¨ `try-catch` ä»£æ›¿ä¼ ç»Ÿçš„é”™è¯¯ç å¤„ç†ã€‚  
âœ… **éœ€è¦ä»£ç æ›´æ˜“è¯»ã€æ›´å¯ç»´æŠ¤**ã€‚  

---

### **4. æ€»ç»“**
- **éé˜»å¡ IO æ˜¯ä¸€ç§æœºåˆ¶ï¼Œåç¨‹æ˜¯åŸºäºå®ƒçš„é«˜çº§æŠ½è±¡**ï¼Œä¸¤è€…ç›¸è¾…ç›¸æˆã€‚  
- **åç¨‹æå‡äº†å¼‚æ­¥ä»£ç çš„å¯è¯»æ€§ã€å¯ç»´æŠ¤æ€§ï¼Œå¹¶å‡å°‘äº†æ‰‹åŠ¨çŠ¶æ€ç®¡ç†çš„å¤æ‚æ€§**ã€‚  
- **åœ¨é«˜å¹¶å‘ IO åœºæ™¯ä¸‹ï¼Œåç¨‹èƒ½æå‡å¼€å‘æ•ˆç‡ï¼Œä½¿ä»£ç æ›´åŠ ç®€æ´ç›´è§‚**ã€‚ ğŸš€



# optional
C++17 å¼•å…¥äº† `std::optional<T>`ï¼Œç”¨äºè¡¨ç¤º **å¯èƒ½ä¸ºç©ºçš„å€¼**ï¼ˆé¿å… `nullptr` æˆ– `std::pair<bool, T>` è¿™ç±»ä¸ç›´è§‚çš„è¿”å›å€¼ï¼‰ã€‚  
ç”¨ `std::optional<T>` å¯ä»¥è®©ä»£ç æ›´æ¸…æ™°ï¼Œå‡å°‘ `if` è¯­å¥ã€‚

**ç¤ºä¾‹ï¼š**
```cpp
#include <iostream>
#include <optional>

std::optional<int> find_even(int x) {
    if (x % 2 == 0) return x;  // è¿”å›æœ‰æ•ˆå€¼
    return std::nullopt;       // è¡¨ç¤ºæ— æ•ˆå€¼
}

int main() {
    std::optional<int> result = find_even(5);
    
    if (result) {
        std::cout << "Found: " << *result << '\n';
    } else {
        std::cout << "Not found\n";
    }
}
```
**è¾“å‡ºï¼š**  
```
Not found
```
**ä½œç”¨ï¼š**
- **é¿å…ä½¿ç”¨ `nullptr` æˆ– `-1` è¿™ç§é”™è¯¯å€¼** ä»£è¡¨â€œæ— æ•°æ®â€ã€‚
- **æ¯” `std::pair<bool, T>` æ›´ç›´è§‚**ã€‚

---


# RVO/NRVOæœºåˆ¶
## **ğŸ“Œ RVOï¼ˆè¿”å›å€¼ä¼˜åŒ–ï¼‰å’Œ NRVOï¼ˆå‘½åè¿”å›å€¼ä¼˜åŒ–ï¼‰**
RVOï¼ˆReturn Value Optimizationï¼‰å’Œ NRVOï¼ˆNamed Return Value Optimizationï¼‰æ˜¯ C++ **ç¼–è¯‘å™¨ä¼˜åŒ–æœºåˆ¶**ï¼Œç”¨äº**é¿å…ä¸å¿…è¦çš„å¯¹è±¡æ‹·è´**ï¼Œæé«˜æ€§èƒ½ã€‚

---

## **1ï¸âƒ£ RVOï¼ˆReturn Value Optimizationï¼‰â€”â€”åŒ¿åå¯¹è±¡ä¼˜åŒ–**
**âœ… é€‚ç”¨äºï¼šè¿”å›ä¸´æ—¶å¯¹è±¡çš„æƒ…å†µ**

```cpp
class A {
public:
    A() { std::cout << "A æ„é€ " << std::endl; }
    A(const A&) { std::cout << "A æ‹·è´æ„é€ " << std::endl; }
    A(A&&) { std::cout << "A ç§»åŠ¨æ„é€ " << std::endl; }
    ~A() { std::cout << "A ææ„" << std::endl; }
};

// ğŸ”¹RVO ç¤ºä¾‹
A createA() {
    return A();  // è¿”å›ä¸´æ—¶å¯¹è±¡
}

int main() {
    A a = createA();  // è¿™é‡Œä¸ä¼šè°ƒç”¨æ‹·è´æ„é€ æˆ–ç§»åŠ¨æ„é€ 
}
```
### **ğŸ” è§£æ**
- `A()` åˆ›å»ºä¸€ä¸ª**ä¸´æ—¶å¯¹è±¡**ã€‚
- ç”±äºç¼–è¯‘å™¨æ”¯æŒ**RVO**ï¼Œç›´æ¥åœ¨ `a` æ‰€åœ¨çš„å†…å­˜ä½ç½®**æ„é€ å¯¹è±¡**ï¼Œä¸ä¼šè°ƒç”¨**æ‹·è´/ç§»åŠ¨æ„é€ **ï¼
- **å‡å°‘ä¸€æ¬¡å¯¹è±¡æ‹·è´/ç§»åŠ¨ï¼Œæé«˜æ•ˆç‡**ã€‚

### **ğŸ“Œ é¢„æœŸè¾“å‡º**
```
A æ„é€ 
A ææ„
```
- **æ²¡æœ‰**æ‹·è´æ„é€ æˆ–ç§»åŠ¨æ„é€ å‘ç”Ÿï¼ï¼ˆç¼–è¯‘å™¨ç›´æ¥åœ¨ `a` çš„ä½ç½®æ„é€  `A`ï¼‰

---

## **2ï¸âƒ£ NRVOï¼ˆNamed Return Value Optimizationï¼‰â€”â€”å…·åå¯¹è±¡ä¼˜åŒ–**
**âœ… é€‚ç”¨äºï¼šè¿”å›å…·åå¯¹è±¡çš„æƒ…å†µ**

```cpp
A createNamedA() {
    A a;    // å…·åå¯¹è±¡
    return a;  // NRVO ä¼šä¼˜åŒ–æ‰æ‹·è´
}

int main() {
    A a = createNamedA();  // è¿™é‡Œä¸ä¼šè°ƒç”¨æ‹·è´/ç§»åŠ¨æ„é€ 
}
```
### **ğŸ” è§£æ**
- `A a;` åˆ›å»ºäº†ä¸€ä¸ªå…·åå¯¹è±¡ `a`ã€‚
- **æ­£å¸¸æƒ…å†µä¸‹**ï¼Œ`return a;` ä¼šè°ƒç”¨æ‹·è´æ„é€ æˆ–ç§»åŠ¨æ„é€ ã€‚
- ä½†**NRVO ä¼šä¼˜åŒ–æ‰è¿™ä¸ªæ‹·è´/ç§»åŠ¨**ï¼Œç›´æ¥åœ¨ `a` çš„ä½ç½®æ„é€ å¯¹è±¡ã€‚

### **ğŸ“Œ é¢„æœŸè¾“å‡º**
```
A æ„é€ 
A ææ„
```
- **æ²¡æœ‰**æ‹·è´æ„é€ æˆ–ç§»åŠ¨æ„é€ å‘ç”Ÿï¼ï¼ˆç¼–è¯‘å™¨ä¼˜åŒ–ï¼‰

---

## **3ï¸âƒ£ ä½•æ—¶ä¼˜åŒ–ä¼šå¤±æ•ˆï¼Ÿ**
ğŸ“Œ **å¦‚æœ `return` è¯­å¥é‡Œè¿”å›çš„ä¸æ˜¯åŒä¸€ä¸ªå˜é‡ï¼ŒNRVO å¯èƒ½ä¼šå¤±æ•ˆï¼**
```cpp
A createNamedA(bool flag) {
    A a, b;
    if (flag)
        return a;  // å¯èƒ½ä¼šè§¦å‘æ‹·è´/ç§»åŠ¨
    else
        return b;  // å¯èƒ½ä¼šè§¦å‘æ‹·è´/ç§»åŠ¨
}
```
### **ğŸš¨ ä¸ºä»€ä¹ˆï¼Ÿ**
- ç¼–è¯‘å™¨**ä¸èƒ½ç¡®å®š**ç©¶ç«Ÿè¯¥ä¼˜åŒ– `a` è¿˜æ˜¯ `b`ï¼Œå¯èƒ½ä¼šè§¦å‘æ‹·è´/ç§»åŠ¨æ„é€ ã€‚
- **è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨ `std::move()`**
```cpp
return std::move(a);  // å¼ºåˆ¶ä½¿ç”¨ç§»åŠ¨æ„é€ 
```

---

## **4ï¸âƒ£ C++17 ä¸­ RVO çš„æ”¹è¿›**
åœ¨ **C++17** åŠä»¥åï¼Œ**RVO å˜æˆäº†å¼ºåˆ¶ä¼˜åŒ–**ï¼Œåªè¦è¿”å›çš„æ˜¯**ä¸´æ—¶å¯¹è±¡**ï¼Œå°±ä¸€å®šä¼šè¿›è¡Œä¼˜åŒ–ï¼  
å³ä½¿ `A` åªæœ‰æ‹·è´æ„é€ ï¼Œè€Œæ²¡æœ‰ç§»åŠ¨æ„é€ ï¼ŒRVO ä»ç„¶é€‚ç”¨ã€‚

```cpp
A createA() {
    return A();  // C++17 å¼ºåˆ¶ RVOï¼Œæ— éœ€ç§»åŠ¨æ„é€ 
}
```

---

## **âœ… æ€»ç»“**
| æœºåˆ¶ | é€‚ç”¨æƒ…å†µ | ä¼˜åŒ–æ–¹å¼ | C++17 å˜åŒ– |
|------|---------|---------|------------|
| **RVO** | è¿”å›**åŒ¿åå¯¹è±¡** | ç›´æ¥åœ¨ç›®æ ‡ä½ç½®æ„é€ ï¼Œ**æ¶ˆé™¤æ‹·è´/ç§»åŠ¨** | **å¼ºåˆ¶ä¼˜åŒ–** |
| **NRVO** | è¿”å›**å…·åå¯¹è±¡** | å¯èƒ½ä¼˜åŒ–æ‰æ‹·è´/ç§»åŠ¨ | ä¾èµ–ç¼–è¯‘å™¨ |

- **RVO**ï¼ˆè¿”å›ä¸´æ—¶å¯¹è±¡ï¼‰**å‡ ä¹æ€»æ˜¯é€‚ç”¨**ï¼ŒC++17 ä»¥åå¼ºåˆ¶æ‰§è¡Œã€‚
- **NRVO**ï¼ˆè¿”å›å…·åå¯¹è±¡ï¼‰**ä¾èµ–ç¼–è¯‘å™¨ä¼˜åŒ–**ï¼Œä½†å¦‚æœ `return` è¯­å¥å«æœ‰å¤šä¸ªå˜é‡ï¼Œä¼˜åŒ–å¯èƒ½ä¼šå¤±è´¥ã€‚

ğŸ”¹ **å»ºè®®ï¼š**
- **ä¼˜å…ˆè¿”å›ä¸´æ—¶å¯¹è±¡**ï¼Œè®© RVO è‡ªåŠ¨ä¼˜åŒ–ã€‚
- å¦‚æœè¿”å›å…·åå¯¹è±¡ï¼Œ**å°½é‡ä¿è¯å•ä¸€è¿”å›è·¯å¾„**ï¼Œè®©ç¼–è¯‘å™¨ä¼˜åŒ– NRVOã€‚
- C++14 åŠä»¥å‰ï¼Œå¯ä»¥æ‰‹åŠ¨ `std::move()` è§¦å‘ç§»åŠ¨æ„é€ ã€‚

ğŸš€ **æŒæ¡ RVO/NRVOï¼Œä¼˜åŒ– C++ ä»£ç ï¼Œå‡å°‘ä¸å¿…è¦çš„æ‹·è´ï¼Œæé«˜æ€§èƒ½ï¼**

## æ²¡æœ‰RVO/NRVOä¹‹å‰return valueä¼šå‘ç”Ÿä»€ä¹ˆ
å¦‚æœ **RVO/NRVO** æ²¡æœ‰è¢«ä¼˜åŒ–æ‰ï¼Œä»£ç ä¼šè§¦å‘ **æ‹·è´æ„é€ æˆ–ç§»åŠ¨æ„é€ **ã€‚ä¸‹é¢æˆ‘ä»¬åˆ†åˆ«åˆ†æ **åŒ¿åå¯¹è±¡è¿”å›** å’Œ **å…·åå¯¹è±¡è¿”å›** çš„æƒ…å†µã€‚

---

### **1ï¸âƒ£ åŒ¿åå¯¹è±¡è¿”å›ï¼ˆæ²¡æœ‰ RVOï¼‰**
**ä»£ç ï¼š**
```cpp
class A {
public:
    A() { std::cout << "A æ„é€ " << std::endl; }
    A(const A&) { std::cout << "A æ‹·è´æ„é€ " << std::endl; }
    A(A&&) { std::cout << "A ç§»åŠ¨æ„é€ " << std::endl; }
    ~A() { std::cout << "A ææ„" << std::endl; }
};

A createA() {
    return A();  // è¿”å›ä¸´æ—¶å¯¹è±¡
}

int main() {
    A a = createA();  
}
```
---
#### **ğŸ” æ‰§è¡Œæµç¨‹ï¼ˆå‡è®¾ RVO æ²¡æœ‰ä¼˜åŒ–æ‰ï¼‰**
1. `A()` **æ„é€ **ä¸€ä¸ªåŒ¿åå¯¹è±¡ã€‚
2. ç”±äº `createA()` **è¿”å›ä¸´æ—¶å¯¹è±¡**ï¼Œå¦‚æœæ²¡æœ‰ RVOï¼Œç¼–è¯‘å™¨éœ€è¦ï¼š
   - **æ‹·è´æ„é€  `A`ï¼ˆC++98ï¼‰** æˆ–
   - **ç§»åŠ¨æ„é€  `A`ï¼ˆC++11+ï¼Œå¦‚æœæ”¯æŒï¼‰**
3. `a` **ææ„**
4. å…ˆå‰åˆ›å»ºçš„åŒ¿åå¯¹è±¡ **ææ„**

---
#### **ğŸ“Œ é¢„æœŸè¾“å‡ºï¼ˆå‡è®¾ RVO æ²¡æœ‰ä¼˜åŒ–æ‰ï¼‰**
å¦‚æœç¼–è¯‘å™¨ **åªæ”¯æŒæ‹·è´æ„é€ ï¼ˆC++98ï¼‰**ï¼š
```
A æ„é€ 
A æ‹·è´æ„é€ 
A ææ„
A ææ„
```
å¦‚æœç¼–è¯‘å™¨ **æ”¯æŒç§»åŠ¨æ„é€ ï¼ˆC++11+ï¼‰**ï¼š
```
A æ„é€ 
A ç§»åŠ¨æ„é€ 
A ææ„
A ææ„
```
---
#### **ğŸ“Œ è¯´æ˜**
- **ç¬¬ä¸€è¡Œ**ï¼šåˆ›å»ºåŒ¿åå¯¹è±¡
- **ç¬¬äºŒè¡Œ**ï¼šè°ƒç”¨ **æ‹·è´æ„é€ æˆ–ç§»åŠ¨æ„é€ **ï¼ˆæ²¡æœ‰ RVOï¼‰
- **ç¬¬ä¸‰è¡Œ**ï¼šææ„ `a`
- **ç¬¬å››è¡Œ**ï¼šææ„ `createA()` é‡Œåˆ›å»ºçš„åŒ¿åå¯¹è±¡ï¼ˆä¸´æ—¶å¯¹è±¡ï¼‰

---

### **2ï¸âƒ£ å…·åå¯¹è±¡è¿”å›ï¼ˆæ²¡æœ‰ NRVOï¼‰**
**ä»£ç ï¼š**
```cpp
A createNamedA() {
    A a;  // å…·åå¯¹è±¡
    return a;  // NRVO ä¼˜åŒ–å¤±è´¥ï¼Œè§¦å‘æ‹·è´/ç§»åŠ¨æ„é€ 
}

int main() {
    A a = createNamedA();
}
```
---
#### **ğŸ” æ‰§è¡Œæµç¨‹ï¼ˆå‡è®¾ NRVO æ²¡æœ‰ä¼˜åŒ–æ‰ï¼‰**
1. `A a;` **æ„é€ ** `a`ã€‚
2. `return a;` éœ€è¦ï¼š
   - **æ‹·è´æ„é€ ï¼ˆC++98ï¼‰** æˆ–
   - **ç§»åŠ¨æ„é€ ï¼ˆC++11+ï¼‰**
3. `a` **ææ„**
4. `createNamedA()` é‡Œçš„ `a` **ææ„**

---
#### **ğŸ“Œ é¢„æœŸè¾“å‡ºï¼ˆå‡è®¾ NRVO æ²¡æœ‰ä¼˜åŒ–æ‰ï¼‰**
å¦‚æœ **åªæ”¯æŒæ‹·è´æ„é€ ï¼ˆC++98ï¼‰**ï¼š
```
A æ„é€ 
A æ‹·è´æ„é€ 
A ææ„
A ææ„
```
å¦‚æœ **æ”¯æŒç§»åŠ¨æ„é€ ï¼ˆC++11+ï¼‰**ï¼š
```
A æ„é€ 
A ç§»åŠ¨æ„é€ 
A ææ„
A ææ„
```
---
#### **ğŸ“Œ è¯´æ˜**
- **ç¬¬ä¸€è¡Œ**ï¼šåˆ›å»º `a`
- **ç¬¬äºŒè¡Œ**ï¼š`return a` **è°ƒç”¨æ‹·è´æ„é€ æˆ–ç§»åŠ¨æ„é€ **
- **ç¬¬ä¸‰è¡Œ**ï¼šææ„ `a`
- **ç¬¬å››è¡Œ**ï¼šææ„ `createNamedA()` é‡Œçš„ `a`

---

### **3ï¸âƒ£ ç»“è®º**
- **å¦‚æœæ²¡æœ‰ RVO/NRVO**ï¼š
  - **ä¼šé¢å¤–è°ƒç”¨ä¸€æ¬¡æ‹·è´æ„é€ æˆ–ç§»åŠ¨æ„é€ **ï¼Œå½±å“æ€§èƒ½ã€‚
  - C++98 åªèƒ½è°ƒç”¨ **æ‹·è´æ„é€ **ï¼ŒC++11+ **ä¼˜å…ˆä½¿ç”¨ç§»åŠ¨æ„é€ **ï¼ˆå¦‚æœ `A` æœ‰ç§»åŠ¨æ„é€ ï¼‰ã€‚
- **å¦‚æœ RVO/NRVO å¯ç”¨**ï¼š
  - **æ‹·è´/ç§»åŠ¨æ„é€ ä¸ä¼šå‘ç”Ÿ**ï¼Œç›´æ¥åœ¨ç›®æ ‡ä½ç½®æ„é€ å¯¹è±¡ï¼Œå‡å°‘å¼€é”€ã€‚

---
### **4ï¸âƒ£ å¦‚ä½•é¿å…æ‹·è´/ç§»åŠ¨æ„é€ ï¼Ÿ**
- **RVO** è‡ªåŠ¨ä¼˜åŒ–ä¸´æ—¶å¯¹è±¡çš„è¿”å›ã€‚
- **NRVO** åªé€‚ç”¨äºè¿”å›**å•ä¸€å…·åå˜é‡**ã€‚
- **C++17** å¼ºåˆ¶æ‰§è¡Œ **RVO**ï¼Œå³ä½¿æ²¡æœ‰ `move` ä¹Ÿä¸ä¼šè°ƒç”¨æ‹·è´/ç§»åŠ¨æ„é€ ï¼
- **æ‰‹åŠ¨ä½¿ç”¨ `std::move`**ï¼ˆå¦‚æœæ²¡æœ‰ RVOï¼‰ï¼š
```cpp
return std::move(a);  // å¼ºåˆ¶ä½¿ç”¨ç§»åŠ¨æ„é€ 
```

---
ğŸ’¡ **ç»“è®ºï¼šå¼€å¯ RVO/NRVO å¯ä»¥é¿å…é¢å¤–çš„æ‹·è´/ç§»åŠ¨ï¼Œæå‡ C++ ä»£ç æ€§èƒ½ï¼** ğŸš€



# å‡½æ•°æŒ‡é’ˆå’ŒæŒ‡é’ˆå‡½æ•°
**å‡½æ•°æŒ‡é’ˆï¼ˆFunction Pointerï¼‰** å’Œ **æŒ‡é’ˆå‡½æ•°ï¼ˆPointer Functionï¼‰** æ˜¯ C/C++ ä¸­å®¹æ˜“æ··æ·†çš„ä¸¤ä¸ªæ¦‚å¿µï¼ŒåŒºåˆ«åœ¨äºï¼š  

| **æ¦‚å¿µ**   | **å®šä¹‰** | **ç¤ºä¾‹** |
|------------|----------|-----------|
| **å‡½æ•°æŒ‡é’ˆ** | æŒ‡å‘å‡½æ•°çš„æŒ‡é’ˆ | `int (*fp)(int, int);` |
| **æŒ‡é’ˆå‡½æ•°** | è¿”å›æŒ‡é’ˆçš„å‡½æ•° | `int* func();` |

---

## **ğŸ”¹ 1. å‡½æ•°æŒ‡é’ˆï¼ˆFunction Pointerï¼‰**
**å‡½æ•°æŒ‡é’ˆæ˜¯ä¸€ä¸ªæŒ‡å‘å‡½æ•°çš„æŒ‡é’ˆï¼Œå¯ä»¥ç”¨äºè°ƒç”¨å‡½æ•°ã€‚**

### **âœ… è¯­æ³•**
```cpp
è¿”å›ç±»å‹ (*æŒ‡é’ˆå˜é‡å)(å‚æ•°åˆ—è¡¨);
```

### **âœ… ç¤ºä¾‹**
```cpp
#include <iostream>
using namespace std;

// ä¸€ä¸ªæ™®é€šçš„å‡½æ•°
int add(int a, int b) {
    return a + b;
}

int main() {
    // å®šä¹‰ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼ŒæŒ‡å‘ `add` å‡½æ•°
    int (*fp)(int, int) = add;
    
    // é€šè¿‡å‡½æ•°æŒ‡é’ˆè°ƒç”¨ `add`
    cout << "10 + 20 = " << fp(10, 20) << endl;
    return 0;
}
```
**ğŸ“Œ è¾“å‡ºï¼š**
```
10 + 20 = 30
```
**ğŸ“¢ è¯´æ˜ï¼š**
- `int (*fp)(int, int);` è¯´æ˜ `fp` æ˜¯ä¸€ä¸ª **æŒ‡å‘è¿”å› `int` ä¸”å¸¦æœ‰ä¸¤ä¸ª `int` å‚æ•°çš„å‡½æ•°çš„æŒ‡é’ˆ**ã€‚
- `fp = add;` è®© `fp` æŒ‡å‘ `add` å‡½æ•°ã€‚
- `fp(10, 20);` é€šè¿‡ `fp` è°ƒç”¨ `add`ã€‚

---

## **ğŸ”¹ 2. æŒ‡é’ˆå‡½æ•°ï¼ˆPointer Functionï¼‰**
**æŒ‡é’ˆå‡½æ•°æ˜¯ä¸€ä¸ªè¿”å›æŒ‡é’ˆçš„å‡½æ•°ï¼Œ** ä¹Ÿå°±æ˜¯ **è¿”å›ç±»å‹æ˜¯æŒ‡é’ˆ**ã€‚

### **âœ… è¯­æ³•**
```cpp
è¿”å›ç±»å‹ *å‡½æ•°å(å‚æ•°åˆ—è¡¨);
```

### **âœ… ç¤ºä¾‹**
```cpp
#include <iostream>
using namespace std;

// è¿”å›æŒ‡é’ˆçš„å‡½æ•°
int* getPointer() {
    static int x = 10;  // é™æ€å˜é‡ï¼Œå­˜å‚¨åœ¨å…¨å±€æ•°æ®åŒºï¼Œå‡½æ•°è¿”å›åä¾ç„¶æœ‰æ•ˆ
    return &x;
}

int main() {
    int* p = getPointer(); // æ¥æ”¶è¿”å›çš„æŒ‡é’ˆ
    cout << "Value: " << *p << endl;
    return 0;
}
```
**ğŸ“Œ è¾“å‡ºï¼š**
```
Value: 10
```
**ğŸ“¢ è¯´æ˜ï¼š**
- `int* getPointer();` **è¿”å› `int` æŒ‡é’ˆ**ã€‚
- `return &x;` è¿”å›é™æ€å˜é‡çš„åœ°å€ **(âš ï¸ ä¸èƒ½è¿”å›å±€éƒ¨å˜é‡çš„åœ°å€ï¼Œå¦åˆ™æ˜¯æ‚¬å‚æŒ‡é’ˆ)**ã€‚

---

## **ğŸ”¹ 3. ç»“åˆä½¿ç”¨**
å‡½æ•°æŒ‡é’ˆå’ŒæŒ‡é’ˆå‡½æ•°å¯ä»¥ç»“åˆä½¿ç”¨ï¼Œä¾‹å¦‚ï¼š
```cpp
int* (*funcPtr)();  // `funcPtr` æ˜¯ä¸€ä¸ªæŒ‡å‘ "è¿”å› int* çš„å‡½æ•°" çš„æŒ‡é’ˆ
funcPtr = getPointer;
int* p = funcPtr();  // é€šè¿‡å‡½æ•°æŒ‡é’ˆè°ƒç”¨
```

---

## **ğŸ”¹ æ€»ç»“**
| æ¦‚å¿µ | å®šä¹‰ | ä¾‹å­ |
|------|------|------|
| **å‡½æ•°æŒ‡é’ˆ** | æŒ‡å‘å‡½æ•°çš„æŒ‡é’ˆ | `int (*fp)(int, int);` |
| **æŒ‡é’ˆå‡½æ•°** | è¿”å›æŒ‡é’ˆçš„å‡½æ•° | `int* func();` |

ğŸš€ **å£è¯€è®°å¿†ï¼š**
- **"å‡½æ•°æŒ‡é’ˆ" æ˜¯æŒ‡å‘å‡½æ•°çš„æŒ‡é’ˆï¼Œ`(*fp)()`**ã€‚
- **"æŒ‡é’ˆå‡½æ•°" æ˜¯è¿”å›æŒ‡é’ˆçš„å‡½æ•°ï¼Œ`int* func()`**ã€‚

ğŸ’¡ **å»ºè®®ï¼š**
- **å‡½æ•°æŒ‡é’ˆ** å¸¸ç”¨äº **å›è°ƒå‡½æ•°ã€å‡½æ•°è¡¨ã€åŠ¨æ€å‡½æ•°è°ƒç”¨**ã€‚
- **æŒ‡é’ˆå‡½æ•°** ç”¨äº **è¿”å›æŒ‡é’ˆï¼Œå¦‚åŠ¨æ€åˆ†é…å†…å­˜ã€è¿”å›æ•°ç»„ç­‰**ã€‚

å¸Œæœ›è¿™ä¸ªè®²è§£å¯¹ä½ æœ‰æ‰€å¸®åŠ©ï¼ğŸ˜ƒ



# ä½ç½®æ— å…³ä»£ç  PIC
å¥½çš„ï¼æˆ‘ä»¬æ¥ç³»ç»Ÿè®²ä¸€ä¸‹ **ä½ç½®æ— å…³ä»£ç ï¼ˆPIC, Position-Independent Codeï¼‰** çš„æ¦‚å¿µã€åŠ¨æœºå’Œå®ç°æ–¹å¼ï¼Œé€‚åˆä½ é¢è¯•å’Œç³»ç»Ÿåº•å±‚ç†è§£ä½¿ç”¨ã€‚

---

### ğŸ”· ä¸€ã€ä»€ä¹ˆæ˜¯ä½ç½®æ— å…³ä»£ç ï¼ˆPICï¼‰ï¼Ÿ

**ä½ç½®æ— å…³ä»£ç **æ˜¯æŒ‡ï¼š**ä»£ç åœ¨å†…å­˜ä¸­åŠ è½½åˆ°ä»»ä½•åœ°å€åéƒ½èƒ½æ­£ç¡®æ‰§è¡Œï¼Œä¸ä¾èµ–äºè¢«åŠ è½½çš„ç»å¯¹åœ°å€**ã€‚

å®ƒæœ€å¸¸è§äºï¼š
- **åŠ¨æ€é“¾æ¥åº“ï¼ˆ`.so`ï¼‰**
- **å…±äº«åº“åŠ è½½ï¼ˆä¾‹å¦‚ `dlopen()`ï¼‰**

---

### ğŸ”· äºŒã€ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ä½ç½®æ— å…³ä»£ç ï¼Ÿ

#### âœ… 1. æ”¯æŒå…±äº«åº“è¢«å¤šä¸ªè¿›ç¨‹åŠ è½½
å¤šä¸ªè¿›ç¨‹å¯ä»¥åŠ è½½åŒä¸€ä¸ª `.so` æ–‡ä»¶ï¼Œè€Œä¸éœ€è¦ä¸ºæ¯ä¸ªè¿›ç¨‹é‡æ–°é‡å®šä½ä»£ç æ®µã€‚

#### âœ… 2. èŠ‚çœå†…å­˜ï¼ˆé¡µé¢å…±äº«ï¼‰
å¤šä¸ªè¿›ç¨‹å…±äº« `.so` ä»£ç æ®µçš„å†…å­˜é¡µï¼ˆtext segmentï¼‰ï¼Œå› ä¸ºä»£ç ä¸­æ²¡æœ‰å›ºå®šåœ°å€ï¼Œä¸ä¼šè§¦å‘å†™æ—¶å¤åˆ¶ï¼ˆCOWï¼‰ã€‚

#### âœ… 3. æ”¯æŒåœ°å€ç©ºé—´å¸ƒå±€éšæœºåŒ–ï¼ˆASLRï¼‰
æ“ä½œç³»ç»Ÿå¯ä»¥å°†å¯æ‰§è¡Œæ–‡ä»¶æˆ–åº“åŠ è½½åˆ°ä»»æ„ä½ç½®ï¼Œå¢åŠ å®‰å…¨æ€§ï¼Œé˜²æ­¢ç¼“å†²åŒºæº¢å‡ºæ”»å‡»åˆ©ç”¨å›ºå®šåœ°å€ã€‚

---

### ğŸ”· ä¸‰ã€ä½ç½®æ— å…³ä»£ç å¦‚ä½•å®ç°ï¼Ÿ

PIC çš„å…³é”®ç‚¹åœ¨äºï¼š**ä¸èƒ½åœ¨ä»£ç ä¸­ç¡¬ç¼–ç ä»»ä½•ç»å¯¹åœ°å€**ã€‚

#### âœ… 1. é€šè¿‡ç›¸å¯¹åœ°å€è®¿é—®
- ä½¿ç”¨ **åŸºå€ + åç§»é‡** çš„æ–¹å¼è®¿é—®å˜é‡æˆ–å‡½æ•°ã€‚
- ç¼–è¯‘å™¨é€šè¿‡ç”Ÿæˆ **PC-relative addressingï¼ˆç¨‹åºè®¡æ•°å™¨ç›¸å¯¹å¯»å€ï¼‰** å®ç°ã€‚

```asm
mov eax, [rip + offset]   ; x86_64 ä¸­è®¿é—®æŸå˜é‡çš„æ–¹å¼
```

å…¶ä¸­ `rip` æ˜¯ x86_64 æ¶æ„ä¸­çš„ **æŒ‡ä»¤æŒ‡é’ˆå¯„å­˜å™¨**ã€‚

#### âœ… 2. ä½¿ç”¨ GOTï¼ˆå…¨å±€åç§»è¡¨ï¼‰
- å¯¹äºå…¨å±€å˜é‡/å‡½æ•°ï¼Œç¼–è¯‘å™¨ä¸ä¼šç›´æ¥è®¿é—®ç¬¦å·åœ°å€ï¼Œè€Œæ˜¯é€šè¿‡ GOT è¡¨è·å–åœ°å€ã€‚

```c
extern int x;
printf("%d\n", x);  // å®é™…æ˜¯ä» GOT ä¸­å–å‡º x çš„åœ°å€ï¼Œå†è®¿é—®
```

#### âœ… 3. ä½¿ç”¨ PLTï¼ˆè¿‡ç¨‹é“¾æ¥è¡¨ï¼‰è°ƒç”¨å‡½æ•°
- å½“è°ƒç”¨å…±äº«åº“å‡½æ•°æ—¶ï¼Œä½¿ç”¨ PLT è¡¨è·³è½¬åˆ°å¯¹åº”å‡½æ•°åœ°å€ï¼Œå»¶è¿Ÿç»‘å®šï¼ˆlazy bindingï¼‰æœºåˆ¶ä¹Ÿä¾èµ–è¿™ä¸ªã€‚

---

### ğŸ”· å››ã€PIC çš„ä»£ä»·ï¼Ÿ

- ç›¸å¯¹åœ°å€è®¿é—®é€šå¸¸ **å¤šä¸€æ¬¡é—´æ¥è·³è½¬**ï¼›
- æ€§èƒ½ç•¥ä½äºç›´æ¥åœ°å€è®¿é—®ï¼ˆå°¤å…¶æ˜¯åœ¨è€å¹³å°ä¸Šï¼‰ï¼›
- ä½†åœ¨ç°ä»£ CPU å’Œä¼˜åŒ–å™¨ä¸‹ï¼Œå½±å“ä¸å¤§ã€‚

---

### ğŸ”· äº”ã€ä¾‹å­ï¼ˆGCC ä¸‹å¯ç”¨/ç¦ç”¨ PICï¼‰

```bash
# ç”Ÿæˆä½ç½®æ— å…³ä»£ç çš„åŠ¨æ€åº“ï¼ˆé»˜è®¤å¯ç”¨ï¼‰
g++ -fPIC -shared libfoo.cpp -o libfoo.so

# ç”Ÿæˆé™æ€åº“/å¯æ‰§è¡Œæ–‡ä»¶æ—¶é»˜è®¤ä¸å¯ç”¨ PIC
g++ main.cpp -o main         # é»˜è®¤é PIC
```

---

### ğŸ”· å…­ã€å°æ€»ç»“

| é¡¹ç›®            | è¯´æ˜ |
|----------------|------|
| ç›®çš„            | æ”¯æŒå…±äº«åŠ è½½ã€èŠ‚çœå†…å­˜ã€æé«˜å®‰å…¨æ€§ï¼ˆASLRï¼‰ |
| å®ç°æ–¹å¼        | ç›¸å¯¹å¯»å€ï¼ˆPC-relativeï¼‰ï¼ŒGOTã€PLT è¡¨ |
| ä½¿ç”¨åœºæ™¯        | åŠ¨æ€åº“ã€å…±äº«åº“ã€ç°ä»£ç³»ç»Ÿä¸­çš„æ‰€æœ‰åº“æ–‡ä»¶ |
| ç¼–è¯‘å¼€å…³        | `-fPIC`ï¼ˆç¼–è¯‘åŠ¨æ€åº“æ—¶å¿…é¡»ï¼‰ |

---

å¦‚æœä½ éœ€è¦ï¼Œæˆ‘å¯ä»¥é…ä¸€å¼ å›¾è¯´æ˜ GOT / PLT æ˜¯å¦‚ä½•å‚ä¸å‡½æ•°è°ƒç”¨çš„æµç¨‹ï¼Œè¦ä¸è¦ï¼Ÿæˆ–è€…ä½ æƒ³çœ‹æ±‡ç¼–çº§åˆ«ç¤ºä¾‹ä¹Ÿå¯ä»¥ï½